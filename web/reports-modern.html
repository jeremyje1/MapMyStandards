<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports & Analytics - A¬≥E | MapMyStandards.ai</title>
    <script src="/js/config.js"></script>
    <link rel="stylesheet" href="/css/accessibility.css">
    <script src="/js/ux.js"></script>
    <script src="/js/onboarding.js"></script>
    
    <style>
        :root {
            --primary-blue: #1e40af;
            --primary-blue-light: #3b82f6;
            --primary-blue-dark: #1e3a8a;
            --accent-green: #10b981;
            --accent-green-light: #34d399;
            --accent-green-dark: #059669;
            --accent-purple: #8b5cf6;
            --accent-purple-light: #a78bfa;
            --accent-orange: #f59e0b;
            --accent-orange-light: #fbbf24;
            --gradient-primary: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-light) 100%);
            --gradient-accent: linear-gradient(135deg, var(--accent-green) 0%, var(--accent-green-light) 100%);
            --gradient-purple: linear-gradient(135deg, var(--accent-purple) 0%, var(--accent-purple-light) 100%);
            --gradient-orange: linear-gradient(135deg, var(--accent-orange) 0%, var(--accent-orange-light) 100%);
            --text-dark: #1f2937;
            --text-medium: #6b7280;
            --text-light: #9ca3af;
            --bg-light: #f8fafc;
            --bg-white: #ffffff;
            --border-light: #e2e8f0;
            --border-medium: #cbd5e1;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
            --border-radius: 0.75rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: var(--gradient-primary);
            color: white;
            padding: 1.25rem 0;
            box-shadow: var(--shadow-lg);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.75rem;
            font-weight: 800;
            text-decoration: none;
            color: white;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo::before {
            content: "üéØ";
            font-size: 2rem;
        }

        .nav-links {
            display: flex;
            gap: 2.5rem;
            align-items: center;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            opacity: 0.9;
            transition: all 0.3s ease;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
        }

        .nav-links a:hover,
        .nav-links a.active {
            opacity: 1;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        .page-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .page-title {
            font-size: 3rem;
            font-weight: 800;
            background: var(--gradient-primary);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
        }

        .page-subtitle {
            font-size: 1.25rem;
            color: var(--text-medium);
            max-width: 800px;
            margin: 0 auto;
        }

        /* Metrics Dashboard */
        .metrics-section {
            margin-bottom: 3rem;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: var(--bg-white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            position: relative;
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-accent);
        }

        .metric-card:nth-child(2)::before {
            background: var(--gradient-primary);
        }

        .metric-card:nth-child(3)::before {
            background: var(--gradient-purple);
        }

        .metric-card:nth-child(4)::before {
            background: var(--gradient-orange);
        }

        .metric-card:nth-child(5)::before {
            background: var(--gradient-accent);
        }

        .metric-card:nth-child(6)::before {
            background: var(--gradient-primary);
        }

        .metric-content {
            padding: 2rem;
            text-align: center;
        }

        .metric-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            display: block;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
            line-height: 1;
        }

        .metric-label {
            color: var(--text-medium);
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .metric-trend {
            margin-top: 1rem;
            font-size: 0.75rem;
            padding: 0.375rem 0.75rem;
            background: #d1fae5;
            color: #065f46;
            border-radius: 9999px;
            display: inline-block;
        }

        /* Report Generation Section */
        .report-generation {
            background: var(--bg-white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            margin-bottom: 3rem;
        }

        .report-header {
            background: var(--gradient-accent);
            color: white;
            padding: 2rem;
            text-align: center;
        }
        .selected-summary { display:inline-flex; gap:0.5rem; align-items:center; background: rgba(255,255,255,0.15); border:1px solid rgba(255,255,255,0.3); padding:0.35rem 0.6rem; border-radius:9999px; font-weight:700; }

        .report-header h2 {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }

        .report-header p {
            opacity: 0.95;
            font-size: 1.125rem;
        }

        .report-content {
            padding: 3rem;
        }

        .report-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
        }

        .report-card {
            background: var(--bg-light);
            border-radius: var(--border-radius);
            padding: 2rem;
            border: 2px solid var(--border-light);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .report-card:hover {
            border-color: var(--accent-green);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .report-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .report-card:hover::before {
            transform: scaleX(1);
        }

        .report-icon {
            font-size: 3rem;
            margin-bottom: 1.5rem;
            display: block;
        }

        .report-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 1rem;
        }

        .report-description {
            color: var(--text-medium);
            line-height: 1.6;
            margin-bottom: 2rem;
            font-size: 1rem;
        }

        .report-features {
            margin-bottom: 2rem;
        }

        .feature-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .feature-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.875rem;
            color: var(--text-medium);
        }

        .feature-item::before {
            content: "‚úì";
            color: var(--accent-green);
            font-weight: bold;
            font-size: 1rem;
        }

        .report-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .btn {
            padding: 0.875rem 2rem;
            border-radius: 0.75rem;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-family: inherit;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: var(--gradient-accent);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--bg-white);
            color: var(--text-medium);
            border: 2px solid var(--border-medium);
        }

        .btn-secondary:hover {
            background: var(--bg-light);
            border-color: var(--accent-green);
            color: var(--text-dark);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Info Banner */
        .info-banner {
            display: none;
            background: #fffbeb;
            border: 1px solid #f59e0b33;
            color: #92400e;
            border-radius: 10px;
            padding: 12px 14px;
            margin: 14px 0 0 0;
            box-shadow: var(--shadow-sm);
        }
        .info-banner a {
            color: #7c2d12;
            text-decoration: underline;
            font-weight: 600;
        }

        /* Recent Reports Section */
        .recent-reports {
            background: var(--bg-white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-xl);
            overflow: hidden;
        }

        .recent-header {
            background: var(--gradient-purple);
            color: white;
            padding: 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .recent-header h2 {
            font-size: 1.75rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .recent-content {
            padding: 2rem;
        }

        .recent-list {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .recent-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2rem;
            border: 2px solid var(--border-light);
            border-radius: var(--border-radius);
            transition: all 0.3s ease;
            background: var(--bg-light);
        }

        .recent-item:hover {
            border-color: var(--accent-green);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .recent-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .recent-icon {
            font-size: 2.5rem;
            opacity: 0.8;
        }

        .recent-details {
            flex: 1;
        }

        .recent-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
        }

        .recent-meta {
            color: var(--text-medium);
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .recent-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-generating {
            background: #fef3c7;
            color: #92400e;
        }

        .status-ready {
            background: #d1fae5;
            color: #065f46;
        }

        .status-error {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Loading States */
        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
        }

        .spinner {
            width: 3rem;
            height: 3rem;
            border: 4px solid var(--border-light);
            border-top-color: var(--accent-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--text-medium);
            font-size: 1.125rem;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
                padding: 0 1rem;
            }

            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
                gap: 1rem;
            }

            .container {
                padding: 1rem;
            }

            .page-title {
                font-size: 2rem;
            }

            .metrics-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }

            .report-content {
                padding: 2rem;
            }

            .report-grid {
                grid-template-columns: 1fr;
            }

            .report-actions {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .recent-item {
                flex-direction: column;
                gap: 1.5rem;
                text-align: center;
            }

            .recent-info {
                flex-direction: column;
                text-align: center;
            }

            .recent-meta {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="/" class="logo">A¬≥E</a>
            <nav class="nav-links">
                <a href="/dashboard-modern">Dashboard</a>
                <a href="/upload-modern">Upload</a>
                <a href="/standards-modern">Standards</a>
                <a href="/reports-modern" class="active">Reports</a>
                <a href="#" onclick="logout()">Logout</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title">Reports & Analytics</h1>
            <p class="page-subtitle">Generate comprehensive accreditation reports, track compliance metrics, and analyze your institution's progress toward accreditation goals with AI-powered insights</p>
        </div>

        <!-- Metrics Dashboard -->
        <div class="metrics-section" id="metricsSection">
            <div class="loading-state">
                <div class="spinner"></div>
                <div class="loading-text">Loading analytics...</div>
            </div>
        </div>
        <div class="metrics-section" id="riskOverviewSection" style="display:none;">
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-content">
                        <span class="metric-icon">‚ö†Ô∏è</span>
                        <div class="metric-value" id="rvAvgRisk">‚Äî</div>
                        <div class="metric-label">Average Risk</div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-content">
                        <span class="metric-icon">ü§ù</span>
                        <div class="metric-value" id="rvAvgTrust">‚Äî</div>
                        <div class="metric-label">Average Trust</div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-content">
                        <span class="metric-icon">üìä</span>
                        <div class="metric-value" id="rvDist">‚Äî</div>
                        <div class="metric-label">Risk Distribution</div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-content">
                        <span class="metric-icon">üîé</span>
                        <div class="metric-value" id="rvTopFactors" style="font-size:1.25rem;line-height:1.2;">‚Äî</div>
                        <div class="metric-label">Top Factors</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Report Generation Section -->
        <div class="report-generation">
            <div class="report-header">
                <h2>üìä Generate Custom Reports</h2>
                <p>Create detailed compliance reports tailored to your accreditation needs</p>
                <div id="selectedSummary" class="selected-summary" style="display:none; margin-top:0.5rem;" role="status" aria-live="polite" aria-atomic="true">
                    <span>Selected standards:</span>
                    <span id="selectedCountReports">0</span>
                </div>
                <div id="noSelectionHint" style="display:none;margin-top:.5rem;font-weight:600;background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.3);padding:.35rem .6rem;border-radius:9999px;" role="status" aria-live="polite" aria-atomic="true">Tip: select standards on the <a href="/standards-modern" style="color:#fff;text-decoration:underline">Standards</a> page to enable more reports.</div>
            </div>
            <div class="report-content">
                <div id="noEvidenceBanner" class="info-banner" role="status" aria-live="polite" aria-atomic="true">
                    <strong>Heads up:</strong> no mapped evidence found yet. Upload documents on the <a href="/upload-modern">Upload</a> page to unlock narratives and the Evidence Mapping report.
                    <a href="/upload-modern" class="btn btn-primary" style="margin-left:.75rem;padding:.35rem .7rem;display:inline-block;line-height:1;" aria-label="Upload documents now">Upload now</a>
                </div>
                <div class="report-grid">
                    <div class="report-card">
                        <span class="report-icon">üìã</span>
                        <h3 class="report-title">Comprehensive Compliance Report</h3>
                        <p class="report-description">Complete institutional assessment with all standards compliance, evidence mapping, and detailed gap analysis.</p>
                        <div class="report-features">
                            <ul class="feature-list">
                                <li class="feature-item">Full standards compliance analysis</li>
                                <li class="feature-item">Evidence-to-standard mapping</li>
                                <li class="feature-item">Actionable recommendations</li>
                                <li class="feature-item">Executive summary</li>
                            </ul>
                        </div>
                        <div class="report-actions">
                            <button class="btn btn-primary" data-report-btn="comprehensive" onclick="generateReport('comprehensive')" title="Requires at least 1 selected standard" aria-label="Generate comprehensive report">
                                üöÄ Generate Report
                            </button>
                        </div>
                    </div>

                    <div class="report-card">
                        <span class="report-icon">üìà</span>
                        <h3 class="report-title">QEP Impact Assessment</h3>
                        <p class="report-description">Quality Enhancement Plan impact analysis with measurable outcomes and effectiveness metrics.</p>
                        <div class="report-features">
                            <ul class="feature-list">
                                <li class="feature-item">QEP outcome measurement</li>
                                <li class="feature-item">Impact analysis</li>
                                <li class="feature-item">Effectiveness metrics</li>
                                <li class="feature-item">Improvement recommendations</li>
                            </ul>
                        </div>
                        <div class="report-actions">
                            <button class="btn btn-primary" data-report-btn="qep" onclick="generateReport('qep')" title="Requires at least 1 selected standard" aria-label="Generate QEP report">
                                üéØ Generate QEP Report
                            </button>
                        </div>
                    </div>

                    <div class="report-card">
                        <span class="report-icon">üó∫Ô∏è</span>
                        <h3 class="report-title">Evidence Mapping Summary</h3>
                        <p class="report-description">Detailed mapping of institutional evidence to accreditation standards with comprehensive coverage analysis.</p>
                        <div class="report-features">
                            <ul class="feature-list">
                                <li class="feature-item">Document-to-standard mapping</li>
                                <li class="feature-item">Coverage gap identification</li>
                                <li class="feature-item">Evidence quality assessment</li>
                                <li class="feature-item">Collection recommendations</li>
                            </ul>
                        </div>
                        <div class="report-actions">
                            <button class="btn btn-primary" data-report-btn="evidence" onclick="generateReport('evidence')" title="Runs without selection; uses all mapped evidence" aria-label="Generate evidence mapping summary">
                                üîç Generate Mapping Report
                            </button>
                        </div>
                    </div>

                    <div class="report-card">
                        <span class="report-icon">‚ö†Ô∏è</span>
                        <h3 class="report-title">Gap Analysis Report</h3>
                        <p class="report-description">Identify compliance gaps and receive actionable recommendations for addressing deficiencies before review.</p>
                        <div class="report-features">
                            <ul class="feature-list">
                                <li class="feature-item">Compliance gap identification</li>
                                <li class="feature-item">Risk assessment</li>
                                <li class="feature-item">Priority recommendations</li>
                                <li class="feature-item">Implementation timeline</li>
                            </ul>
                        </div>
                        <div class="report-actions">
                            <button class="btn btn-primary" data-report-btn="gaps" onclick="generateReport('gaps')" title="Requires at least 1 selected standard" aria-label="Generate gap analysis">
                                üîß Generate Gap Analysis
                            </button>
                        </div>
                    </div>

                    <div class="report-card" id="narrativeSection">
                        <span class="report-icon">üìù</span>
                        <h3 class="report-title">CiteGuard Narrative</h3>
                        <p class="report-description">Generate an accreditation narrative with inline citations derived from your mapped evidence.</p>
                        <div style="margin: 0 0 0.75rem 0">
                            <label for="narrativeIntroModern" style="display:block;font-size:0.85rem;color:#374151;margin-bottom:4px">Optional introduction</label>
                            <textarea id="narrativeIntroModern" rows="3" placeholder="Add an introductory paragraph or context (optional)..." style="width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:6px;resize:vertical"></textarea>
                            <div style="color:#9ca3af;font-size:0.75rem;margin-top:4px">Tip: Select standards on the Standards page; we‚Äôll use them here automatically.</div>
                            <div id="selectedCountModern" style="color:#6b7280;font-size:0.8rem;margin-top:4px"></div>
                        </div>
                        <div class="report-actions">
                            <button id="btnGenNarrModern" class="btn btn-primary" title="Requires at least 1 selected standard">Generate</button>
                            <button id="btnExportNarrModern" class="btn btn-secondary" disabled>Export DOCX</button>
                        </div>
                        <div id="narrStatusModern" style="margin-top:8px;font-size:0.8rem;color:#6b7280;display:none"></div>
                        <div id="narrPreviewModern" style="display:none;margin-top:12px;padding:12px;border:1px solid #e5e7eb;border-radius:6px;background:#fff;max-height:320px;overflow:auto">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                                <strong>Preview</strong>
                                <span style="color:#9ca3af;font-size:0.7rem">Citations appear as [cite:filename]</span>
                            </div>
                            <div id="narrHtmlModern" style="font-size:0.85rem;line-height:1.3"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Reports -->
        <div class="recent-reports">
            <div class="recent-header">
                <h2>üìÑ Recent Reports</h2>
                <button class="btn btn-secondary" onclick="refreshReports()">
                    üîÑ Refresh
                </button>
            </div>
            <div class="recent-content">
                <div id="recentReportsList">
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <div class="loading-text">Loading recent reports...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        (function bootstrapTokenFromUrl(){
            try {
                const u = new URL(window.location.href);
                const t = u.searchParams.get('token') || u.searchParams.get('api_key') || u.searchParams.get('access_token');
                if (t) {
                    localStorage.setItem('a3e_api_key', t);
                    sessionStorage.setItem('a3e_api_key', t);
                    localStorage.setItem('access_token', t);
                    localStorage.setItem('jwt_token', t);
                    u.searchParams.delete('token');
                    u.searchParams.delete('api_key');
                    u.searchParams.delete('access_token');
                    history.replaceState({}, '', u.toString());
                }
            } catch (_) {}
        })();
        function getAuthToken() {
            return localStorage.getItem('a3e_api_key') ||
                   sessionStorage.getItem('a3e_api_key') ||
                   localStorage.getItem('token') ||
                   localStorage.getItem('access_token') ||
                   localStorage.getItem('jwt_token') ||
                   localStorage.getItem('authToken') ||
                   '';
        }

        function getApiBase() {
            return (window.mmsAPI && window.mmsAPI.getBaseUrl && window.mmsAPI.getBaseUrl()) ||
                   (location.hostname.includes('api.mapmystandards.ai') ? '' : 'https://api.mapmystandards.ai');
        }
        let dashboardData = null;
        let reportStatuses = new Map();

        // Onboarding helpers
        function getOnboardingSettings(){
            try { return JSON.parse(localStorage.getItem('mms:onboarding')||'{}') || {}; } catch(_) { return {}; }
        }
        function personalizeReportsHeader(){
            try{
                const s = getOnboardingSettings();
                const title = document.querySelector('.report-header h2');
                const sub = document.querySelector('.report-header p');
                if (title && (s.primary_accreditor || s.organization || s.institution_name)) {
                    title.textContent = `üìä ${s.primary_accreditor ? (s.primary_accreditor + ' ') : ''}Reports`;
                }
                if (sub && (s.organization || s.institution_name)) {
                    sub.textContent = `Tailored for ${(s.organization||s.institution_name)}${s.primary_accreditor ? ' ‚Ä¢ ' + s.primary_accreditor : ''}`;
                }
            }catch(_){ }
        }
        function maybeShowAccrSwitchBanner(){
            try{
                let banner = document.getElementById('reportsAccrSwitchBanner');
                if (!banner) {
                    const hdr = document.querySelector('.report-header');
                    if (hdr) {
                        const div = document.createElement('div');
                        div.id = 'reportsAccrSwitchBanner';
                        div.style.cssText = 'display:none;background:#fffbeb;border:1px solid #f59e0b33;color:#92400e;border-radius:10px;padding:8px 10px;margin:8px 0;';
                        div.innerHTML = `<strong>Heads up:</strong> Your onboarding accreditor differs from the current Standards selection. <button id="reportsApplyAccr" class="btn btn-primary" style="margin-left:.5rem;padding:.25rem .6rem;line-height:1">Use onboarding accreditor</button>`;
                        hdr.insertAdjacentElement('afterend', div);
                        const btn = div.querySelector('#reportsApplyAccr');
                        if (btn) btn.addEventListener('click', ()=>{ try{ const s = getOnboardingSettings(); if (s.primary_accreditor){ localStorage.setItem('mms:currentAccreditor', String(s.primary_accreditor).toUpperCase()); window.location.href = '/standards-modern'; } }catch(_){ } });
                    }
                    banner = document.getElementById('reportsAccrSwitchBanner');
                }
                const s = getOnboardingSettings();
                const onboardingAccr = String(s.primary_accreditor||'').toUpperCase();
                const current = String(localStorage.getItem('mms:currentAccreditor')||'').toUpperCase();
                banner.style.display = (onboardingAccr && current && onboardingAccr !== current) ? 'block' : 'none';
            }catch(_){ }
        }

        // Logout function
        function logout() {
            localStorage.clear();
            window.location.href = '/login';
        }

        // Toast utility for cross-page messaging
        function showToast(message){
            const div = document.createElement('div');
            div.textContent = message;
            div.style.position = 'fixed';
            div.style.right = '16px';
            div.style.bottom = '16px';
            div.style.background = '#10b981';
            div.style.color = '#fff';
            div.style.padding = '10px 14px';
            div.style.borderRadius = '8px';
            div.style.boxShadow = '0 6px 16px rgba(0,0,0,0.2)';
            div.style.zIndex = '9999';
            document.body.appendChild(div);
            setTimeout(()=>{ div.remove(); }, 4500);
        }

        // Load dashboard metrics
        async function loadDashboardMetrics() {
            try {
                const token = getAuthToken();
                const response = await fetch(getApiBase() + '/api/user/intelligence-simple/dashboard/metrics', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result && result.data && result.data.core_metrics) {
                        dashboardData = result.data;
                        displayDashboardMetrics(dashboardData);
                    } else {
                        displayMetricsError('Invalid data');
                    }
                } else if (response.status === 401 || response.status === 403) {
                    displayMetricsAuthRequired();
                } else {
                    displayMetricsError('HTTP ' + response.status);
                }
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                displayMetricsError('Network error');
            }
        }

        function displayDashboardMetrics(data) {
            if (!data || !data.core_metrics || !data.performance_metrics) {
                return displayMetricsError('Invalid');
            }
            const metrics = data.core_metrics || {};
            const performance = data.performance_metrics || {};
            const account = data.account_info || {};
            
            const html = `
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-content">
                            <span class="metric-icon">üéØ</span>
                            <div class="metric-value">${(performance.compliance_score ?? '‚Äî')}${(performance.compliance_score != null ? '%' : '')}</div>
                            <div class="metric-label">Compliance Score</div>
                            <div class="metric-trend">‚ÜóÔ∏è +3% this month</div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-content">
                            <span class="metric-icon">üìÑ</span>
                            <div class="metric-value">${metrics.documents_analyzed ?? 0}</div>
                            <div class="metric-label">Documents Analyzed</div>
                            <div class="metric-trend">‚ÜóÔ∏è +12 this week</div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-content">
                            <span class="metric-icon">üìä</span>
                            <div class="metric-value">${metrics.standards_mapped ?? 0}</div>
                            <div class="metric-label">Standards Mapped</div>
                            <div class="metric-trend">‚ÜóÔ∏è +23 this month</div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-content">
                            <span class="metric-icon">üìà</span>
                            <div class="metric-value">${metrics.reports_generated ?? 0}</div>
                            <div class="metric-label">Reports Generated</div>
                            <div class="metric-trend">‚ÜóÔ∏è +2 this week</div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-content">
                            <span class="metric-icon">‚è∞</span>
                            <div class="metric-value">${Math.round(performance.time_saved_hours ?? 0)}h</div>
                            <div class="metric-label">Time Saved</div>
                            <div class="metric-trend">‚ÜóÔ∏è +24h this month</div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-content">
                            <span class="metric-icon">üí∞</span>
                            <div class="metric-value">$${Math.round(performance.money_saved_usd ?? 0).toLocaleString()}</div>
                            <div class="metric-label">Money Saved</div>
                            <div class="metric-trend">‚ÜóÔ∏è +$3.2K this month</div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('metricsSection').innerHTML = html;
            // After core metrics, load risk overview
            try { refreshRiskOverview(); } catch(_) {}
        }

        function displayMetricsAuthRequired() {
            document.getElementById('metricsSection').innerHTML = `
                <div class="metric-card" style="padding:1.5rem;text-align:center">
                    <div style="font-size:2rem">üîí</div>
                    <div style="font-weight:700;margin-top:.5rem">Sign in to view metrics</div>
                    <div style="color:#6b7280;margin-top:.25rem">Your session may have expired.</div>
                    <a class="btn btn-secondary" href="/login" style="margin-top:1rem">Sign In</a>
                </div>`;
        }

        function displayMetricsError(reason) {
            document.getElementById('metricsSection').innerHTML = `
                <div class="metric-card" style="padding:1.5rem;text-align:center">
                    <div style="font-size:2rem">‚ö†Ô∏è</div>
                    <div style="font-weight:700;margin-top:.5rem">Unable to load metrics</div>
                    <div style="color:#6b7280;margin-top:.25rem">${reason ? String(reason) : 'Please refresh and try again.'}</div>
                </div>`;
        }

        // Risk Overview aggregate
        async function refreshRiskOverview(){
            const token = getAuthToken();
            const base = getApiBase();
            const sec = document.getElementById('riskOverviewSection');
            try {
                const res = await fetch(base + '/api/user/intelligence-simple/risk/aggregate', {
                    headers: { 'Authorization': `Bearer ${token}` }, credentials: 'include'
                });
                const j = res.ok ? await res.json() : null;
                const data = j && (j.data || j) || null;
                if (!data) throw new Error('no data');
                const ar = Math.round(((data.average_risk || 0) * 100));
                const at = Math.round(((data.average_trust || 0) * 100));
                document.getElementById('rvAvgRisk').textContent = ar + '%';
                const trustEl = document.getElementById('rvAvgTrust');
                trustEl.textContent = at + '%';
                trustEl.title = 'Average trust score across all mapped evidence. Higher is better.';
                const dist = data.risk_distribution || {};
                const distStr = ['Low','Medium','High'].map(k=>`${k}:${dist[k.toLowerCase()]??0}`).join(' ¬∑ ');
                document.getElementById('rvDist').textContent = distStr;
                const tf = (data.top_factors||[]).slice(0,3).map(f=>f.name||f.factor_name).join(', ') || '‚Äî';
                document.getElementById('rvTopFactors').textContent = tf;
                sec.style.display = 'block';
            } catch (_) {
                sec.style.display = 'none';
            }
        }

        function getSelectedStandards(){
            try{ const arr = JSON.parse(localStorage.getItem('mms:selectedStandards')||'[]'); return Array.isArray(arr)? arr : []; }catch(_){ return []; }
        }

        function updateSelectedSummary(){
            try{
                const arr = getSelectedStandards();
                const wrap = document.getElementById('selectedSummary');
                const num = document.getElementById('selectedCountReports');
                if(!wrap || !num) return;
                const n = Array.isArray(arr) ? arr.length : 0;
                const hint = document.getElementById('noSelectionHint');
                if(n > 0){
                    wrap.style.display = 'inline-flex'; num.textContent = String(n);
                    if (hint) hint.style.display = 'none';
                } else {
                    wrap.style.display = 'none'; num.textContent = '0';
                    if (hint) hint.style.display = '';
                }
                // Gate buttons except Evidence Mapping which can work without selection
                document.querySelectorAll('[data-report-btn]')
                    .forEach(btn => {
                        const type = btn.getAttribute('data-report-btn');
                        const requiresSelection = (type !== 'evidence');
                        btn.disabled = requiresSelection && n === 0;
                        btn.title = btn.disabled ? 'Select at least one standard on the Standards page' : btn.title || '';
                        try { if (window.MMS_UX && MMS_UX.attachTooltip && !btn.__mms_tip) { MMS_UX.attachTooltip(btn, btn.title || 'Generate report'); btn.__mms_tip = true; } } catch(_){ }
                    });
            }catch(_){ }
        }

        function getSelectedStandardsModern(){
            try{ const arr = JSON.parse(localStorage.getItem('mms:selectedStandards')||'[]'); return Array.isArray(arr)? arr : []; }catch(_){ return []; }
        }
        function updateNarrativeButtons(){
            const sel = getSelectedStandardsModern();
            const hasAny = Array.isArray(sel) && sel.length>0;
            const gen = document.getElementById('btnGenNarrModern');
            if (gen) gen.disabled = !hasAny;
            const cnt = document.getElementById('selectedCountModern');
            if (cnt) cnt.innerHTML = hasAny ? (`<span style="color:#059669">‚úì</span> ${sel.length} selected`) : ('<span style="color:#dc2626">‚ö†Ô∏è</span> No standards selected');
        }
    async function handleGenerateNarrativeModern(){
            const btnGen = document.getElementById('btnGenNarrModern');
            const btnExport = document.getElementById('btnExportNarrModern');
            const status = document.getElementById('narrStatusModern');
            const preview = document.getElementById('narrPreviewModern');
            const htmlDiv = document.getElementById('narrHtmlModern');
            const token = getAuthToken();
            const stds = getSelectedStandardsModern();
            const intro = (document.getElementById('narrativeIntroModern')?.value || '').trim();
            try{
                if (!Array.isArray(stds) || !stds.length) { updateNarrativeButtons(); return; }
                btnGen.disabled = true; btnExport.disabled = true; status.style.display='block';
                status.innerHTML = 'Generating narrative‚Ä¶'; preview.style.display='none';
                // Build a richer narrative using v1 comprehensive endpoint for the first selected standard
                const evidenceMapRes = await fetch(getApiBase() + '/api/user/intelligence-simple/standards/evidence-map', { headers:{ 'Authorization': `Bearer ${token}` }, credentials:'include' });
                let evidenceDocs = [];
                if (evidenceMapRes.ok) {
                    const m = await evidenceMapRes.json();
                    const mapping = m?.mapping || {};
                    const sid = String(stds[0]);
                    const items = Array.isArray(mapping[sid]) ? mapping[sid] : [];
                    evidenceDocs = items.slice(0, 8).map(it => ({ title: it.filename || 'Evidence', summary: (it.text || it.snippet || '').slice(0, 140) }));
                }
                const s = getOnboardingSettings();
                const standardMeta = { standard_id: String(stds[0]||''), standard_title: String(stds[0]||'Selected Standard'), accreditor: (s.primary_accreditor||'') };
                const inst = { name: (s.organization||s.institution_name||localStorage.getItem('org_name')||'Your Institution'), type: (s.institution_type||localStorage.getItem('org_type')||'Institution'), enrollment_size: (s.institution_size||s.enrollment||null), mission_focus: (s.mission_focus||null), programs: (s.programs||s.program_list||[]) };
                const v1 = await fetch(getApiBase() + '/api/v1/narratives/comprehensive', {
                    method:'POST', headers:{ 'Authorization': `Bearer ${token}`, 'Content-Type':'application/json' },
                    body: JSON.stringify({ standard_id: standardMeta.standard_id, standard_title: standardMeta.standard_title, accreditor: standardMeta.accreditor, evidence_documents: evidenceDocs, institution_data: inst })
                });
                if (!v1.ok) throw new Error('HTTP '+v1.status);
                const v1data = await v1.json();
                const narrative = v1data?.narrative || '';
                const meta = v1data?.metadata || {};
                let html = '';
                if (intro) html += `<p>${intro.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</p>`;
                html += narrative ? `<p>${narrative.replace(/\n/g,'</p><p>')}</p>` : '<p>No mapped evidence available yet. Upload documents to generate a narrative.</p>';
                if (meta && meta.structured_sections) {
                    html += '<hr><h4>Structured Sections</h4>';
                    try { Object.entries(meta.structured_sections).forEach(([k,v])=>{ html += `<h5>${k}</h5><p>${String(v||'')}</p>`; }); } catch(_) {}
                }
                htmlDiv.innerHTML = html; preview.style.display='block';
                status.innerHTML = '<span style="color:#059669">‚úì Narrative generated</span>';
                btnExport.disabled = !html;
                btnExport.__lastHtml = html;
            }catch(e){ status.innerHTML = `<span style="color:#dc2626">‚ùå Error: ${e.message||e}</span>`; }
            finally{ btnGen.disabled = false; setTimeout(()=>{ if(status.innerHTML.includes('Narrative generated')) status.style.display='none'; }, 2500); }
        }
    async function handleExportNarrativeModern(){
            const btnGen = document.getElementById('btnGenNarrModern');
            const btnExport = document.getElementById('btnExportNarrModern');
            const status = document.getElementById('narrStatusModern');
            const token = getAuthToken();
            try{
                btnGen.disabled = true; btnExport.disabled = true; status.style.display='block'; status.textContent='Preparing DOCX‚Ä¶';
                const html = document.getElementById('btnExportNarrModern').__lastHtml || document.getElementById('narrHtmlModern').innerHTML || '';
                const res = await fetch(getApiBase() + '/api/user/intelligence-simple/narrative/export.docx', { method:'POST', headers:{ 'Authorization': `Bearer ${token}`, 'Content-Type':'application/json' }, body: JSON.stringify({ html }) });
                if (!res.ok) throw new Error('HTTP '+res.status);
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `narrative_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.docx`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
                status.innerHTML = '<span style="color:#059669">‚úì Export complete</span>';
            }catch(e){ status.innerHTML = `<span style=\"color:#dc2626\">‚ùå Export failed: ${e.message||e}</span>`; }
            finally{ btnGen.disabled = false; btnExport.disabled = false; setTimeout(()=>{ if(status.innerHTML.includes('Export complete')) status.style.display='none'; }, 2500); }
        }

        async function generateReport(type) {
            const token = getAuthToken();
            if (type !== 'evidence'){
                const sel = getSelectedStandards();
                if (!Array.isArray(sel) || sel.length === 0){
                    alert('Please select at least one standard on the Standards page.');
                    return;
                }
            }
            
            // Show loading state on button
            const buttons = document.querySelectorAll('.btn-primary');
            const clickedButton = event.target;
            const originalText = clickedButton.innerHTML;
            
            clickedButton.disabled = true;
            clickedButton.innerHTML = '<span class="spinner" style="width: 1rem; height: 1rem; border-width: 2px; margin-right: 0.5rem;"></span> Generating...';

            try {
                if (type === 'evidence') {
                    // Evidence Mapping report from last analyzed doc (demo: build from metrics);
                    // In a fuller UI, we'd pick a document and its analysis payload.
                    const payload = { filename: 'latest_document', analysis: { mappings: [] } };
                    const response = await fetch(getApiBase() + '/api/user/intelligence-simple/evidence/report', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) {
                        const result = await response.json();
                        const w = window.open('', '_blank');
                        if (w) { w.document.write(result.html || '<p>No content</p>'); }
                        alert('‚úÖ Evidence Mapping report generated. Opened in a new tab.');
                    } else {
                        const error = await response.json().catch(()=>({}));
                        alert(`‚ùå Error: ${error.detail || 'Failed to generate evidence report'}`);
                    }
                } else if (type === 'comprehensive' || type === 'gaps' || type === 'qep') {
                    // Generate narrative HTML and offer DOCX export
                    const stds = getSelectedStandards();
                    const gen = await fetch(getApiBase() + '/api/user/intelligence-simple/narrative/generate', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ standard_ids: stds, body: '' })
                    });
                    if (!gen.ok) throw new Error('narrative failed');
                    const gj = await gen.json();
                    const html = gj.html || '<p>No narrative yet. Upload evidence first.</p>';
                    const w = window.open('', '_blank');
                    if (w) { w.document.write(html); }
                    // Prompt to export DOCX
                    // Non-blocking export option: auto export if page is focused; otherwise show a toast
                    if (document.hasFocus()) {
                        const docx = await fetch(getApiBase() + '/api/user/intelligence-simple/narrative/export.docx', {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ html })
                        });
                        if (docx.ok) {
                            const blob = await docx.blob();
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url; a.download = 'accreditation_narrative.docx';
                            document.body.appendChild(a); a.click(); a.remove();
                            URL.revokeObjectURL(url);
                        } else {
                            showToast('DOCX export failed');
                        }
                    } else {
                        showToast('Narrative opened. Use Export to DOCX from the new tab.');
                    }
                }
            } catch (error) {
                console.error('Error generating report:', error);
                alert('‚ö†Ô∏è Network error occurred while generating report.\nPlease check your connection and try again.');
            } finally {
                // Reset button state
                clickedButton.disabled = false;
                clickedButton.innerHTML = originalText;
            }
        }

        async function loadRecentReports() {
            if (!(window.MMS_CONFIG && MMS_CONFIG.FEATURE_FLAGS && MMS_CONFIG.FEATURE_FLAGS.enableRecentReports)) {
                const container = document.querySelector('.recent-reports');
                if (container) container.style.display = 'none';
                return;
            }
            try {
                const token = getAuthToken();
                const response = await fetch(getApiBase() + '/api/reports/recent', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    displayRecentReports(result.data || []);
                } else {
                    // Show empty state (no demo fallback)
                    displayRecentReports([]);
                }
            } catch (error) {
                console.error('Error loading recent reports:', error);
                displayRecentReports([]);
            }
        }

        function displayRecentReports(reports) {
            if (reports.length === 0) {
                document.getElementById('recentReportsList').innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--text-medium);">
                        <span style="font-size: 3rem; display: block; margin-bottom: 1rem;">üìÑ</span>
                        <h3 style="margin-bottom: 0.5rem;">No reports generated yet</h3>
                        <p>Generate your first report using the options above.</p>
                    </div>
                `;
                return;
            }

            const html = reports.map(report => {
                const statusClass = report.status === 'completed' ? 'status-ready' : 
                                  report.status === 'failed' ? 'status-error' : 'status-generating';
                const statusText = report.status === 'completed' ? 'Ready' :
                                 report.status === 'failed' ? 'Failed' : 'Generating';
                
                return `
                    <div class="recent-item">
                        <div class="recent-info">
                            <span class="recent-icon">${getReportIcon(report.type)}</span>
                            <div class="recent-details">
                                <h4 class="recent-title">${report.title}</h4>
                                <div class="recent-meta">
                                    <span>Generated ${report.created_at || 'recently'}</span>
                                    <span>‚Ä¢</span>
                                    <span>${report.file_size || '2.3 MB'}</span>
                                    <span>‚Ä¢</span>
                                    <span>${report.pages || 15} pages</span>
                                </div>
                            </div>
                        </div>
                        <div class="recent-actions">
                            <span class="status-badge ${statusClass}">${statusText}</span>
                            ${report.status === 'completed' ? 
                                `<button class="btn btn-secondary" onclick="downloadReport('${report.id}')">üì• Download</button>` :
                                `<button class="btn btn-secondary" disabled>‚è≥ Processing</button>`
                            }
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('recentReportsList').innerHTML = `<div class="recent-list">${html}</div>`;
        }

        // removed mock recent reports in production

        function getReportIcon(type) {
            const icons = {
                'comprehensive': 'üìã',
                'qep': 'üìà',
                'evidence': 'üó∫Ô∏è',
                'gaps': '‚ö†Ô∏è'
            };
            return icons[type] || 'üìÑ';
        }

        function downloadReport(reportId) {
            // Simulate download
            alert(`üì• Downloading report ${reportId}...\n\nIn a real implementation, this would trigger a file download.`);
        }

        function refreshReports() {
            document.getElementById('recentReportsList').innerHTML = `
                <div class="loading-state">
                    <div class="spinner"></div>
                    <div class="loading-text">Refreshing reports...</div>
                </div>
            `;
            
            setTimeout(() => {
                loadRecentReports();
            }, 1500);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Cross-page toast and refresh flag
            const t = localStorage.getItem('mms:toast');
            if (t) { showToast(t); localStorage.removeItem('mms:toast'); }
            if (localStorage.getItem('mms:refreshMetrics') === '1') {
                localStorage.removeItem('mms:refreshMetrics');
            }
            try { personalizeReportsHeader(); maybeShowAccrSwitchBanner(); } catch(_) {}
            loadDashboardMetrics();
            setTimeout(() => {
                loadRecentReports();
            }, 2000);
            // Try risk overview after initial load as well
            setTimeout(() => { try { refreshRiskOverview(); } catch(_) {} }, 1200);
            updateSelectedSummary();
            try { updateNarrativeButtons(); } catch(_) {}
            try { document.getElementById('btnGenNarrModern')?.addEventListener('click', handleGenerateNarrativeModern); } catch(_) {}
            try { document.getElementById('btnExportNarrModern')?.addEventListener('click', handleExportNarrativeModern); } catch(_) {}
            try { checkEvidenceMappingBanner(); } catch(_) {}
        });
        window.addEventListener('mms:onboarding-updated', ()=>{ try { personalizeReportsHeader(); maybeShowAccrSwitchBanner(); } catch(_) {} });
        window.addEventListener('mms:selected-standards-updated', ()=>{ try { updateSelectedSummary(); updateNarrativeButtons(); } catch(_) {} });
        window.addEventListener('storage', (e)=>{
            try {
                if(e.key === 'mms:selectedStandards' || e.key === 'selectedStandards') { updateSelectedSummary(); updateNarrativeButtons(); }
                if(e.key === 'mms:lastUploadAt' || e.key === 'mms:lastAnalysisCompleteAt') { checkEvidenceMappingBanner(); }
                if(e.key === 'mms:onboarding' || e.key === 'mms:currentAccreditor') { personalizeReportsHeader(); maybeShowAccrSwitchBanner(); }
            } catch(_) {}
        });

        async function checkEvidenceMappingBanner(){
            const banner = document.getElementById('noEvidenceBanner');
            if (!banner) return;
            try{
                const token = getAuthToken();
                const res = await fetch(getApiBase() + '/api/user/intelligence-simple/standards/evidence-map', {
                    headers: { 'Authorization': `Bearer ${token}` }, credentials: 'include'
                });
                if(!res.ok){ banner.style.display = 'none'; return; }
                const data = await res.json();
                const docCount = (data?.counts && typeof data.counts.documents === 'number') ? data.counts.documents : (Array.isArray(data?.documents) ? data.documents.length : 0);
                const mappedKeys = data?.mapping ? Object.keys(data.mapping) : [];
                const mappedCount = Array.isArray(mappedKeys) ? mappedKeys.length : 0;
                const show = (docCount <= 0) || (mappedCount <= 0);
                banner.style.display = show ? 'block' : 'none';
            }catch(_){ banner.style.display = 'none'; }
        }
    </script>
</body>
<script>
    (async function(){
        try{
            const raw = (window.MMS_CONFIG && MMS_CONFIG.API_BASE_URL) || '';
            const base = raw.startsWith('http') ? raw.replace(/\/$/, '') : ('/' + raw.replace(/^\/+|\/$/g, ''));
            const prefix = base.endsWith('/api') ? '' : '/api';
            const helpUrl = base + prefix + '/user/intelligence-simple/ui/help';
            const res = await fetch(helpUrl, { credentials:'include' });
            if(res.ok){
                const h = await res.json();
                const sec = document.getElementById('riskOverviewSection');
                if (sec) {
                    const coverage = sec.querySelector('[data-metric="coverage"]');
                    const avgTrust = sec.querySelector('[data-metric="avg_trust"]');
                    const avgRisk = sec.querySelector('[data-metric="avg_risk"]');
                    if (coverage && h.formulas.coverage_rate) MMS_UX.attachTooltip(coverage, `${h.formulas.coverage_rate.label}: ${h.formulas.coverage_rate.formula}`);
                    if (avgTrust && h.formulas.avg_trust) MMS_UX.attachTooltip(avgTrust, `${h.formulas.avg_trust.label}: ${h.formulas.avg_trust.formula}`);
                    if (avgRisk && h.formulas.avg_risk) MMS_UX.attachTooltip(avgRisk, `${h.formulas.avg_risk.label}: ${h.formulas.avg_risk.formula}`);
                }
            }
        } catch {}
        if (window.MMS_CONFIG && MMS_CONFIG.FEATURE_FLAGS && MMS_CONFIG.FEATURE_FLAGS.enableTutorialBanner !== false) {
            const bannerMount = document.createElement('div');
            bannerMount.id = 'tutorialBanner';
            const container = document.querySelector('.container, main, body');
            if (container) container.insertAdjacentElement('afterbegin', bannerMount);
            MMS_UX.renderTutorialBanner(bannerMount);
        }
    })();
</script>
</html>