<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Standards Browser - AÂ³E | MapMyStandards.ai</title>
    <script src="/js/ux.js"></script>
    <script src="/js/onboarding.js?v=20250921a"></script>
    
    <style>
        :root {
            --primary-blue: #1e40af;
            --primary-blue-light: #3b82f6;
            --primary-blue-dark: #1e3a8a;
            --accent-green: #10b981;
            --accent-green-light: #34d399;
            --accent-green-dark: #059669;
            --accent-purple: #8b5cf6;
            --accent-purple-light: #a78bfa;
            --gradient-primary: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-light) 100%);
            --gradient-accent: linear-gradient(135deg, var(--accent-green) 0%, var(--accent-green-light) 100%);
            --gradient-purple: linear-gradient(135deg, var(--accent-purple) 0%, var(--accent-purple-light) 100%);
            --text-dark: #1f2937;
            --text-medium: #6b7280;
            --text-light: #9ca3af;
            --bg-light: #f8fafc;
            --bg-white: #ffffff;
            --border-light: #e2e8f0;
            --border-medium: #cbd5e1;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
            --border-radius: 0.75rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: var(--gradient-primary);
            color: white;
            padding: 1.25rem 0;
            box-shadow: var(--shadow-lg);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.75rem;
            font-weight: 800;
            text-decoration: none;
            color: white;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo::before {
            content: "ðŸŽ¯";
            font-size: 2rem;
        }

        .nav-links {
            display: flex;
            gap: 2.5rem;
            align-items: center;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            opacity: 0.9;
            transition: all 0.3s ease;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
        }

        .nav-links a:hover,
        .nav-links a.active {
            opacity: 1;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
        }

        /* User Menu */
        .user-menu {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-left: 1rem;
            padding-left: 1rem;
            border-left: 1px solid rgba(255, 255, 255, 0.2);
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            background: var(--gradient-accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .user-avatar:hover {
            transform: scale(1.05);
        }

        .user-name {
            color: white;
            font-weight: 500;
            font-size: 0.95rem;
        }

        .logout-link {
            color: white;
            text-decoration: none;
            font-weight: 500;
            opacity: 0.9;
            transition: all 0.3s ease;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            margin-left: 0.5rem;
        }

        .logout-link:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Page Header */
        .page-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .page-title {
            font-size: 3rem;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
        }

        .page-subtitle {
            font-size: 1.25rem;
            color: var(--text-medium);
            max-width: 700px;
            margin: 0 auto;
        }

        /* Filters Section */
        .filters-section {
            background: var(--bg-white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            margin-bottom: 3rem;
        }

        .filters-header {
            background: var(--gradient-purple);
            color: white;
            padding: 1.5rem 2rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .filters-header h2 {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .filters-content {
            padding: 2rem;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .filter-label {
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .filter-select,
        .filter-input {
            padding: 0.875rem;
            border: 2px solid var(--border-light);
            border-radius: 0.5rem;
            background: var(--bg-white);
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .filter-select:focus,
        .filter-input:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .search-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.875rem 2rem;
            border-radius: 0.75rem;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--gradient-accent);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: var(--bg-white);
            color: var(--text-medium);
            border: 2px solid var(--border-medium);
        }

        .btn-secondary:hover {
            background: var(--bg-light);
            border-color: var(--accent-green);
            color: var(--text-dark);
        }
        
        /* Disabled button states */
        .btn:disabled, .btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        /* Button with tooltip */
        .btn-with-tooltip {
            position: relative;
        }
        
        .btn-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            white-space: normal;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            margin-bottom: 0.5rem;
            max-width: 250px;
            text-align: center;
            line-height: 1.4;
            pointer-events: none;
        }
        
        .btn-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.9);
        }
        
        .btn-with-tooltip:hover .btn-tooltip,
        .btn-with-tooltip:disabled:hover .btn-tooltip {
            opacity: 1;
            visibility: visible;
        }
        
        /* Allow hover on disabled buttons with tooltips */
        .btn-with-tooltip:disabled {
            pointer-events: all;
        }

        /* Selection Toolbar */
        .selection-toolbar { display:flex; align-items:center; gap:0.75rem; padding:0.5rem 0.75rem; background: #f0fdf4; border:1px solid #bbf7d0; border-radius:0.5rem; box-shadow: var(--shadow-sm); }
        .badge-selected { display:inline-block; padding:0.25rem 0.6rem; border-radius:9999px; background: var(--gradient-accent); color:#fff; font-weight:700; font-size:0.8rem; letter-spacing:0.03em; }

        /* Content Area */
        .content-section {
            min-height: 400px;
        }

        /* Auth Banner */
        .auth-banner { display:none; align-items:center; justify-content:space-between; gap:1rem; background:#fff7ed; border:1px solid #fdba74; color:#7c2d12; padding:0.75rem 1rem; border-radius:0.5rem; box-shadow: var(--shadow-sm); margin-bottom: 1rem; }
        .auth-banner .banner-text { font-size:0.95rem; }
        .auth-banner .banner-actions a { display:inline-block; background:#f97316; color:white; padding:0.4rem 0.75rem; border-radius:0.4rem; text-decoration:none; font-weight:600; }
        .auth-banner .banner-actions a:hover { background:#ea580c; }

        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4rem 2rem;
            background: var(--bg-white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
        }

        .spinner {
            width: 3rem;
            height: 3rem;
            border: 4px solid var(--border-light);
            border-top-color: var(--accent-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--text-medium);
            font-size: 1.125rem;
        }

        /* Accreditor Selection */
        .accreditor-selection {
            background: var(--bg-white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-xl);
            padding: 4rem 2rem;
            text-align: center;
        }

        .selection-icon {
            font-size: 4rem;
            margin-bottom: 2rem;
            display: block;
        }

        .selection-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 1rem;
        }

        .selection-subtitle {
            color: var(--text-medium);
            font-size: 1.125rem;
            margin-bottom: 2rem;
        }

        .available-accreditors {
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 1.5rem;
        }

        .accreditor-badge {
            background: var(--gradient-primary);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        /* Standards Display */
        .accreditor-info {
            background: var(--gradient-accent);
            color: white;
            padding: 2.5rem;
            border-radius: var(--border-radius);
            margin-bottom: 2rem;
            text-align: center;
            box-shadow: var(--shadow-lg);
        }

        .accreditor-name {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 1rem;
        }

        .accreditor-details {
            display: flex;
            justify-content: center;
            gap: 2rem;
            flex-wrap: wrap;
            opacity: 0.95;
        }

        .accreditor-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .stat-label {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        /* Standards Grid */
        .standards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 1.5rem;
        }

        .standard-card {
            background: var(--bg-white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            overflow: hidden;
            transition: all 0.3s ease;
            border: 1px solid var(--border-light);
        }

        .standard-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
            border-color: var(--accent-green);
        }

        .standard-card.selected {
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16,185,129,0.15), var(--shadow-xl);
        }

        .standard-header {
            background: var(--bg-light);
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-light);
        }

        .standard-id {
            display: inline-block;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.875rem;
            background: var(--gradient-primary);
            color: white;
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .standard-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-dark);
            line-height: 1.4;
        }

        .standard-content {
            padding: 1.5rem;
        }

        .standard-description {
            color: var(--text-medium);
            line-height: 1.6;
            margin-bottom: 1.5rem;
        }

        .standard-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            font-size: 0.875rem;
            color: var(--text-medium);
        }

        .meta-icon {
            font-size: 1rem;
        }

        .required-badge {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .category-badge {
            background: var(--gradient-purple);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Error State */
        .error-state {
            background: var(--bg-white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            padding: 3rem;
            text-align: center;
        }

        .error-icon {
            font-size: 3rem;
            color: #ef4444;
            margin-bottom: 1rem;
        }

        .error-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #ef4444;
            margin-bottom: 0.5rem;
        }

        .error-message {
            color: var(--text-medium);
        }

        /* Empty State */
        .empty-state {
            background: var(--bg-white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            padding: 3rem;
            text-align: center;
        }

        .empty-icon {
            font-size: 3rem;
            color: var(--text-light);
            margin-bottom: 1rem;
        }

        .empty-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-medium);
            margin-bottom: 0.5rem;
        }

        .empty-message {
            color: var(--text-medium);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
                padding: 0 1rem;
            }

            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
                gap: 1rem;
            }

            .container {
                padding: 1rem;
            }

            .page-title {
                font-size: 2rem;
            }

            .filters-content {
                padding: 1.5rem;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .search-controls {
                flex-direction: column;
                width: 100%;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .standards-grid {
                grid-template-columns: 1fr;
            }

            .accreditor-details {
                flex-direction: column;
                gap: 1rem;
            }

            .standard-meta {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }
        }

        /* Risk Factor Modal */
        .modal-backdrop { position: fixed; inset:0; background: rgba(0,0,0,0.4); display:none; align-items: flex-start; justify-content: center; overflow-y:auto; z-index: 3000; padding: 4rem 1rem 2rem; }
        .modal { background: var(--bg-white); border-radius: 1rem; width: 100%; max-width: 860px; box-shadow: var(--shadow-xl); border: 1px solid var(--border-light); position: relative; animation: fadeIn 0.25s ease; }
        .modal-header { padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border-light); background: var(--gradient-primary); color: #fff; border-top-left-radius:1rem; border-top-right-radius:1rem; }
        .modal-title { font-size: 1.1rem; font-weight: 600; }
        .modal-close { position: absolute; top:0.75rem; right:0.75rem; background: rgba(255,255,255,0.15); color:#fff; border:none; padding:0.4rem 0.65rem; border-radius: 0.5rem; cursor:pointer; font-weight:600; }
        .modal-close:hover { background: rgba(255,255,255,0.3); }
        .modal-body { padding: 1.25rem 1.5rem 1rem; }
        .modal-footer { padding: 0.85rem 1.5rem 1.25rem; display:flex; justify-content: space-between; align-items:center; gap:1rem; border-top:1px solid var(--border-light); }
        .factor-table { width:100%; border-collapse: collapse; font-size: 0.75rem; }
        .factor-table th, .factor-table td { padding:6px 8px; border-bottom:1px solid var(--border-light); text-align:left; }
        .factor-table th { background: var(--bg-light); font-weight:600; }
        .badge-risk { display:inline-block; padding:2px 8px; border-radius:9999px; font-size:0.65rem; font-weight:600; letter-spacing:0.04em; }
        .risk-critical { background:linear-gradient(135deg,#991b1b,#dc2626); color:#fff; }
        .risk-high { background:linear-gradient(135deg,#b45309,#f59e0b); color:#fff; }
        .risk-medium { background:linear-gradient(135deg,#92400e,#d97706); color:#fff; }
        .risk-low { background:linear-gradient(135deg,#075985,#0ea5e9); color:#fff; }
        .risk-minimal { background:linear-gradient(135deg,#065f46,#10b981); color:#fff; }
        .pill { display:inline-block; padding:2px 6px; border-radius:6px; background:var(--bg-light); font-size:0.6rem; font-weight:600; }
        .confidence-bar { height:6px; background:var(--bg-light); border-radius:4px; position:relative; overflow:hidden; }
        .confidence-fill { position:absolute; inset:0; background: var(--gradient-accent); width:0%; transition: width 0.5s ease; }
        .issues-list { margin:0.5rem 0 0; padding-left:1rem; }
        .issues-list li { margin:0.25rem 0; font-size:0.7rem; }
        .modal-meta-grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(150px,1fr)); gap:0.75rem; margin-bottom:1rem; }
        .meta-box { background: var(--bg-light); border:1px solid var(--border-light); border-radius:0.65rem; padding:0.6rem 0.7rem; }
        .meta-label { font-size:0.55rem; text-transform:uppercase; letter-spacing:0.06em; font-weight:600; color:var(--text-medium); }
        .meta-value { font-size:0.8rem; font-weight:600; color:var(--text-dark); }
        .loading-inline { font-size:0.75rem; color: var(--text-medium); }
        @keyframes fadeIn { from { opacity:0; transform: translateY(6px);} to { opacity:1; transform: translateY(0);} }
        @media (max-width: 640px){ .modal { margin-top:2rem; } .factor-table { font-size:0.65rem; } }
        
        /* Evidence Mapping Styles */
        .evidence-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; margin-top: 1rem; }
        .evidence-card { background: var(--bg-white); border: 1px solid var(--border-light); border-radius: 0.5rem; padding: 1rem; cursor: pointer; transition: all 0.3s ease; }
        .evidence-card:hover { border-color: var(--primary-blue-light); box-shadow: var(--shadow-md); transform: translateY(-2px); }
        .evidence-card.selected { border-color: var(--accent-green); background: #f0fdf4; }
        .evidence-title { font-weight: 600; color: var(--text-dark); margin-bottom: 0.5rem; font-size: 0.9rem; }
        .evidence-meta { display: flex; gap: 1rem; font-size: 0.8rem; color: var(--text-medium); }
        .evidence-type { background: var(--bg-light); padding: 0.2rem 0.5rem; border-radius: 0.25rem; font-size: 0.7rem; }
        .mapped-evidence { display: flex; align-items: center; gap: 0.5rem; background: #f0fdf4; padding: 0.5rem; border-radius: 0.5rem; margin-top: 0.5rem; font-size: 0.8rem; }
        .mapped-evidence-icon { color: var(--accent-green); }
        .trust-score { font-weight: 600; color: var(--accent-green); }
        .mapped-evidence-container { margin: 0.5rem 0; }
        .evidence-details { background: var(--bg-light); padding: 0.5rem; border-radius: 0.5rem; }
        .evidence-detail-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.25rem 0; font-size: 0.75rem; color: var(--text-medium); }
        .evidence-doc-icon { opacity: 0.7; }
        .evidence-doc-name { flex: 1; }
        .evidence-doc-score { background: var(--accent-green); color: white; padding: 0.1rem 0.4rem; border-radius: 0.25rem; font-size: 0.7rem; font-weight: 600; }
        .evidence-verified { color: var(--accent-green); font-weight: 600; font-size: 0.7rem; }
        
        /* Evidence Mapping Status */
        .evidence-mapping-banner { background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 1px solid #3b82f6; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 1rem; }
        .evidence-mapping-status { display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: #1e40af; }
        .evidence-status-icon { font-size: 1.2rem; animation: pulse 2s infinite; }
        .map-evidence-button { background: var(--gradient-primary); color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .map-evidence-button:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(1.1); } }
        
        /* Enhanced Evidence Mapping Pipeline Styles */
        .mapping-pipeline-container { background: var(--bg-white); border-radius: var(--border-radius); overflow: hidden; }
        .pipeline-header { background: var(--gradient-primary); color: white; padding: 1.5rem; position: relative; }
        .pipeline-steps { display: flex; justify-content: space-between; margin-top: 1rem; }
        .pipeline-step { flex: 1; text-align: center; position: relative; }
        .pipeline-step:not(:last-child):after { content: ''; position: absolute; top: 50%; right: -50%; width: 100%; height: 2px; background: rgba(255,255,255,0.3); }
        .pipeline-step.active:not(:last-child):after { background: white; }
        .step-number { width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 0.5rem; font-weight: 700; transition: all 0.3s ease; }
        .pipeline-step.active .step-number { background: white; color: var(--primary-blue); transform: scale(1.1); }
        .pipeline-step.completed .step-number { background: var(--accent-green); }
        .step-label { font-size: 0.875rem; opacity: 0.7; transition: opacity 0.3s ease; }
        .pipeline-step.active .step-label, .pipeline-step.completed .step-label { opacity: 1; }
        
        .mapping-progress-container { padding: 2rem; }
        .progress-bar { height: 8px; background: var(--bg-light); border-radius: 4px; overflow: hidden; margin-bottom: 1rem; }
        .progress-fill { height: 100%; background: var(--gradient-accent); transition: width 0.5s ease; position: relative; }
        .progress-fill:after { content: ''; position: absolute; top: 0; right: 0; bottom: 0; width: 100px; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4)); animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { transform: translateX(-100px); } 100% { transform: translateX(100px); } }
        
        .mapping-status { text-align: center; margin: 2rem 0; }
        .status-icon { font-size: 3rem; margin-bottom: 1rem; animation: rotate 2s linear infinite; }
        @keyframes rotate { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .status-message { font-size: 1.125rem; font-weight: 600; color: var(--text-dark); margin-bottom: 0.5rem; }
        .status-detail { color: var(--text-medium); font-size: 0.875rem; }
        
        /* Evidence Results View */
        .evidence-results-container { max-height: 600px; overflow-y: auto; padding: 1rem; }
        .evidence-result-card { background: var(--bg-light); border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; border: 1px solid var(--border-light); transition: all 0.3s ease; }
        .evidence-result-card:hover { box-shadow: var(--shadow-md); border-color: var(--primary-blue-light); }
        
        .result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .result-title { font-weight: 600; color: var(--text-dark); }
        .confidence-badge { background: var(--gradient-accent); color: white; padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.875rem; font-weight: 600; }
        .confidence-low { background: linear-gradient(135deg, #ef4444 0%, #f87171 100%); }
        .confidence-medium { background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); }
        .confidence-high { background: linear-gradient(135deg, #10b981 0%, #34d399 100%); }
        
        .evidence-excerpt { background: white; border-left: 4px solid var(--primary-blue); padding: 1rem; margin: 1rem 0; border-radius: 0 0.5rem 0.5rem 0; position: relative; }
        .excerpt-text { color: var(--text-medium); line-height: 1.6; font-style: italic; }
        .excerpt-highlight { background: #fef3c7; padding: 0.125rem 0.25rem; border-radius: 0.25rem; font-weight: 500; color: var(--text-dark); }
        .excerpt-source { font-size: 0.75rem; color: var(--text-light); margin-top: 0.5rem; }
        
        .mapped-standards-list { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 1rem; }
        .mapped-standard-chip { background: var(--bg-white); border: 1px solid var(--border-medium); border-radius: 0.375rem; padding: 0.375rem 0.75rem; font-size: 0.875rem; display: flex; align-items: center; gap: 0.375rem; transition: all 0.2s ease; cursor: pointer; }
        .mapped-standard-chip:hover { background: var(--primary-blue-light); color: white; border-color: var(--primary-blue); }
        .standard-relevance { font-size: 0.75rem; opacity: 0.8; }
        
        /* Action Buttons for Excerpts */
        .excerpt-actions { display: flex; gap: 0.5rem; margin-top: 1rem; }
        .excerpt-action-btn { padding: 0.375rem 0.75rem; font-size: 0.875rem; border-radius: 0.375rem; border: 1px solid var(--border-light); background: white; cursor: pointer; transition: all 0.2s ease; }
        .excerpt-action-btn:hover { background: var(--bg-light); }
        .excerpt-action-btn.approve { color: var(--accent-green); border-color: var(--accent-green); }
        .excerpt-action-btn.approve:hover { background: #f0fdf4; }
        .excerpt-action-btn.reject { color: #ef4444; border-color: #ef4444; }
        .excerpt-action-btn.reject:hover { background: #fef2f2; }
        .excerpt-action-btn.edit { color: var(--primary-blue); border-color: var(--primary-blue); }
        .excerpt-action-btn.edit:hover { background: #eff6ff; }
        
        /* Report Generation Styles */
        .report-type-selector { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin: 1.5rem 0; }
        .report-type-card { background: var(--bg-light); border: 2px solid var(--border-light); border-radius: 0.5rem; padding: 1.5rem; cursor: pointer; transition: all 0.3s ease; position: relative; }
        .report-type-card:hover { border-color: var(--primary-blue-light); transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .report-type-card.selected { border-color: var(--primary-blue); background: #eff6ff; }
        .report-type-card.selected::after { content: 'âœ“'; position: absolute; top: 1rem; right: 1rem; background: var(--primary-blue); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; }
        .report-type-icon { font-size: 2.5rem; margin-bottom: 1rem; }
        .report-type-title { font-size: 1.125rem; font-weight: 700; color: var(--text-dark); margin-bottom: 0.5rem; }
        .report-type-description { font-size: 0.875rem; color: var(--text-medium); line-height: 1.5; }
        
        /* Narrative Editor Styles */
        .narrative-editor-container { background: var(--bg-white); border-radius: var(--border-radius); overflow: hidden; }
        .narrative-toolbar { background: var(--bg-light); border-bottom: 1px solid var(--border-light); padding: 0.75rem 1rem; display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; }
        .toolbar-button { padding: 0.5rem 0.75rem; background: white; border: 1px solid var(--border-light); border-radius: 0.375rem; cursor: pointer; display: flex; align-items: center; gap: 0.375rem; font-size: 0.875rem; transition: all 0.2s ease; }
        .toolbar-button:hover { background: var(--bg-light); border-color: var(--primary-blue-light); }
        .toolbar-button.active { background: var(--primary-blue); color: white; border-color: var(--primary-blue); }
        .toolbar-separator { width: 1px; height: 24px; background: var(--border-light); margin: 0 0.5rem; }
        
        .narrative-content { padding: 2rem; min-height: 400px; max-height: 600px; overflow-y: auto; }
        .narrative-section { margin-bottom: 2rem; }
        .narrative-section-title { font-size: 1.25rem; font-weight: 700; color: var(--text-dark); margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--border-light); }
        .narrative-paragraph { margin-bottom: 1rem; line-height: 1.8; color: var(--text-dark); position: relative; }
        .narrative-paragraph.editing { background: #fef3c7; padding: 1rem; border-radius: 0.375rem; border: 2px solid #f59e0b; }
        
        /* Citation Styles */
        .citation { background: #e0e7ff; color: var(--primary-blue); padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-size: 0.875rem; font-weight: 500; cursor: pointer; position: relative; display: inline-block; margin: 0 0.125rem; }
        .citation:hover { background: var(--primary-blue); color: white; }
        .citation-popup { position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: var(--bg-white); border: 1px solid var(--border-medium); border-radius: 0.5rem; padding: 1rem; box-shadow: var(--shadow-lg); min-width: 300px; z-index: 100; display: none; margin-bottom: 0.5rem; }
        .citation-popup::after { content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); border: 8px solid transparent; border-top-color: var(--bg-white); }
        .citation-popup.show { display: block; }
        .citation-details { font-size: 0.875rem; }
        .citation-source { font-weight: 600; color: var(--text-dark); margin-bottom: 0.5rem; }
        .citation-excerpt { font-style: italic; color: var(--text-medium); margin: 0.5rem 0; padding-left: 1rem; border-left: 3px solid var(--border-light); }
        .citation-page { color: var(--text-light); font-size: 0.75rem; }
        .citation-actions { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
        .citation-action-btn { padding: 0.25rem 0.5rem; font-size: 0.75rem; border-radius: 0.25rem; border: 1px solid var(--border-light); background: white; cursor: pointer; transition: all 0.2s ease; }
        .citation-action-btn:hover { background: var(--bg-light); }
        
        /* Gap Analysis Styles */
        .gap-analysis-container { padding: 1.5rem; }
        .gap-summary { background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); border: 1px solid #fecaca; border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 2rem; }
        .gap-summary-title { font-size: 1.125rem; font-weight: 700; color: #991b1b; margin-bottom: 0.5rem; }
        .gap-summary-text { color: #7f1d1d; }
        .gap-item { background: var(--bg-white); border: 1px solid var(--border-light); border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1rem; border-left: 4px solid #ef4444; }
        .gap-standard { font-weight: 600; color: var(--text-dark); margin-bottom: 0.5rem; }
        .gap-description { color: var(--text-medium); margin-bottom: 1rem; }
        .gap-recommendations { background: var(--bg-light); border-radius: 0.375rem; padding: 1rem; }
        .gap-recommendation-title { font-weight: 600; color: var(--text-dark); margin-bottom: 0.5rem; font-size: 0.875rem; }
        .gap-recommendation-list { list-style: none; padding: 0; }
        .gap-recommendation-item { padding: 0.5rem 0; padding-left: 1.5rem; position: relative; font-size: 0.875rem; color: var(--text-medium); }
        .gap-recommendation-item::before { content: 'â†’'; position: absolute; left: 0; color: var(--primary-blue); }
        
        /* Report Options */
        .report-options { background: var(--bg-light); border-radius: 0.5rem; padding: 1rem; margin-bottom: 1.5rem; }
        .report-option-group { margin-bottom: 1rem; }
        .report-option-group:last-child { margin-bottom: 0; }
        .report-option-label { font-weight: 600; color: var(--text-dark); margin-bottom: 0.5rem; display: block; font-size: 0.875rem; }
        .report-option-input { width: 100%; padding: 0.5rem; border: 1px solid var(--border-light); border-radius: 0.375rem; font-size: 0.875rem; }
        .report-option-select { width: 100%; padding: 0.5rem; border: 1px solid var(--border-light); border-radius: 0.375rem; font-size: 0.875rem; background: white; }
        .report-option-checkbox { margin-right: 0.5rem; }
        
        /* Export Preview */
        .export-preview { background: white; border: 1px solid var(--border-medium); border-radius: 0.5rem; padding: 2rem; margin: 1.5rem 0; max-height: 400px; overflow-y: auto; box-shadow: var(--shadow-md); }
        .export-preview-header { text-align: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid var(--border-light); }
        .export-preview-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem; }
        .export-preview-subtitle { color: var(--text-medium); }
        .export-preview-content { font-family: 'Times New Roman', serif; line-height: 1.8; }
        
        /* Graph Visualization Styles */
        #graphSection .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        #graphContainer {
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }
        
        #graphCanvas {
            cursor: grab;
        }
        
        #graphCanvas:active {
            cursor: grabbing;
        }
        
        /* Tutorial and Help System Styles */
        .tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            display: none;
        }
        
        .tutorial-spotlight {
            position: absolute;
            border: 3px solid var(--accent-green);
            border-radius: 0.5rem;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7);
            animation: pulse 2s infinite;
            pointer-events: none;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .tutorial-popup {
            position: absolute;
            background: var(--bg-white);
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: var(--shadow-xl);
            max-width: 400px;
            z-index: 10000;
        }
        
        .tutorial-arrow {
            position: absolute;
            width: 0;
            height: 0;
            border: 10px solid transparent;
        }
        
        .tutorial-arrow.top { bottom: 100%; left: 50%; transform: translateX(-50%); border-bottom-color: var(--bg-white); }
        .tutorial-arrow.bottom { top: 100%; left: 50%; transform: translateX(-50%); border-top-color: var(--bg-white); }
        .tutorial-arrow.left { right: 100%; top: 50%; transform: translateY(-50%); border-right-color: var(--bg-white); }
        .tutorial-arrow.right { left: 100%; top: 50%; transform: translateY(-50%); border-left-color: var(--bg-white); }
        
        .tutorial-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .tutorial-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--text-dark);
        }
        
        .tutorial-step {
            font-size: 0.875rem;
            color: var(--text-medium);
        }
        
        .tutorial-content {
            color: var(--text-dark);
            line-height: 1.6;
            margin-bottom: 1.5rem;
        }
        
        .tutorial-actions {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
        }
        
        .tutorial-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            font-size: 0.875rem;
        }
        
        .tutorial-btn-skip {
            background: var(--bg-light);
            color: var(--text-medium);
        }
        
        .tutorial-btn-skip:hover {
            background: var(--bg-medium);
        }
        
        .tutorial-btn-next {
            background: var(--accent-green);
            color: white;
        }
        
        .tutorial-btn-next:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        /* Help Button Styles */
        .help-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary-blue);
            color: white;
            font-size: 0.875rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            margin-left: 0.5rem;
        }
        
        .help-button:hover {
            background: var(--primary-blue-dark);
            transform: scale(1.1);
        }
        
        .help-section {
            position: absolute;
            top: 1rem;
            right: 1rem;
        }
        
        /* Workflow Progress Tracker */
        .workflow-progress {
            background: var(--bg-white);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-md);
        }
        
        .workflow-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .workflow-steps {
            display: flex;
            justify-content: space-between;
            position: relative;
            margin-bottom: 0.5rem;
        }
        
        .workflow-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .workflow-step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 20px;
            left: 50%;
            width: 100%;
            height: 2px;
            background: var(--border-light);
            z-index: 0;
        }
        
        .workflow-step.completed:not(:last-child)::after {
            background: var(--accent-green);
        }
        
        .workflow-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-light);
            border: 2px solid var(--border-medium);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            position: relative;
            z-index: 1;
            transition: all 0.3s;
        }
        
        .workflow-step.completed .workflow-icon {
            background: var(--accent-green);
            border-color: var(--accent-green);
            color: white;
        }
        
        .workflow-step.active .workflow-icon {
            background: var(--primary-blue);
            border-color: var(--primary-blue);
            color: white;
            animation: pulse 2s infinite;
        }
        
        .workflow-label {
            font-size: 0.75rem;
            color: var(--text-medium);
            margin-top: 0.5rem;
            text-align: center;
            max-width: 80px;
        }
        
        .workflow-step.completed .workflow-label {
            color: var(--text-dark);
            font-weight: 600;
        }
        
        .workflow-step.active .workflow-label {
            color: var(--primary-blue);
            font-weight: 600;
        }
        
        /* Help Modal Styles */
        .help-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9000;
            align-items: center;
            justify-content: center;
        }
        
        .help-modal-content {
            background: var(--bg-white);
            border-radius: 1rem;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            position: relative;
        }
        
        .help-modal-header {
            padding: 2rem;
            border-bottom: 1px solid var(--border-light);
            position: sticky;
            top: 0;
            background: var(--bg-white);
            z-index: 1;
        }
        
        .help-modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
        }
        
        .help-modal-subtitle {
            color: var(--text-medium);
        }
        
        .help-modal-close {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-medium);
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .help-modal-close:hover {
            color: var(--text-dark);
        }
        
        .help-modal-body {
            padding: 2rem;
        }
        
        .help-section-item {
            margin-bottom: 2rem;
        }
        
        .help-section-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .help-section-icon {
            font-size: 1.5rem;
        }
        
        .help-section-content {
            color: var(--text-dark);
            line-height: 1.8;
        }
        
        .help-tip {
            background: #eff6ff;
            border-left: 4px solid var(--primary-blue);
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0.375rem;
        }
        
        .help-tip-title {
            font-weight: 600;
            color: var(--primary-blue);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .help-video-placeholder {
            background: var(--bg-light);
            border: 2px dashed var(--border-medium);
            border-radius: 0.5rem;
            padding: 3rem;
            text-align: center;
            color: var(--text-medium);
            margin: 1rem 0;
        }
        
        .d3-tooltip {
            position: absolute;
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        #d3Graph svg {
            width: 100%;
            height: 100%;
        }
        
        #d3Graph .node {
            cursor: pointer;
        }
        
        #d3Graph .node:hover {
            opacity: 0.8;
        }
        
        #d3Graph .link {
            opacity: 0.6;
        }
        
        /* Evidence Library Styles */
        .evidence-library-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--gradient-accent);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 9999px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 100;
            border: none;
        }
        
        .evidence-library-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
        }
        
        /* Evidence Library Floating Button */
        .evidence-library-float-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: linear-gradient(135deg, var(--primary-blue), var(--darker-blue));
            color: white;
            border: none;
            border-radius: 3rem;
            padding: 1rem 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            z-index: 100;
            transform: translateY(0);
        }
        
        .evidence-library-float-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 30px rgba(0, 0, 0, 0.3);
            background: linear-gradient(135deg, var(--darker-blue), var(--primary-blue));
        }
        
        .evidence-library-icon {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
        }
        
        .evidence-library-label {
            font-weight: 600;
            letter-spacing: 0.02em;
        }
        
        /* Responsive: Hide label on smaller screens */
        @media (max-width: 768px) {
            .evidence-library-float-btn {
                padding: 1rem;
                border-radius: 50%;
                width: 60px;
                height: 60px;
                justify-content: center;
                bottom: 1rem;
                right: 1rem;
            }
            
            .evidence-library-label {
                display: none;
            }
        }
        
        .evidence-library-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9500;
            align-items: center;
            justify-content: center;
        }
        
        .evidence-library-content {
            background: var(--bg-white);
            border-radius: 1rem;
            width: 90%;
            max-width: 1200px;
            height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-xl);
        }
        
        .evidence-library-header {
            padding: 2rem;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .evidence-library-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-dark);
        }
        
        .evidence-stats {
            display: flex;
            gap: 2rem;
            margin-top: 0.5rem;
        }
        
        .evidence-stat {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .evidence-stat-label {
            font-size: 0.75rem;
            color: var(--text-medium);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .evidence-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-dark);
        }
        
        .evidence-library-controls {
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .evidence-search {
            flex: 1;
            min-width: 300px;
            position: relative;
        }
        
        .evidence-search-input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 1px solid var(--border-medium);
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }
        
        .evidence-search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-medium);
        }
        
        .evidence-filters {
            display: flex;
            gap: 0.5rem;
        }
        
        .evidence-filter-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-medium);
            border-radius: 0.375rem;
            background: white;
            color: var(--text-medium);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .evidence-filter-btn:hover {
            border-color: var(--primary-blue);
            color: var(--primary-blue);
        }
        
        .evidence-filter-btn.active {
            background: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
        }
        
        .evidence-library-body {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
        }
        
        .evidence-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .evidence-item {
            background: var(--bg-light);
            border: 1px solid var(--border-light);
            border-radius: 0.75rem;
            padding: 1.5rem;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .evidence-item:hover {
            border-color: var(--primary-blue-light);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }
        
        .evidence-item-selected {
            border-color: var(--primary-blue);
            background: #eff6ff;
        }
        
        .evidence-item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }
        
        .evidence-item-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .evidence-item-actions {
            display: flex;
            gap: 0.25rem;
        }
        
        .evidence-action-btn {
            width: 32px;
            height: 32px;
            border-radius: 0.375rem;
            border: 1px solid var(--border-light);
            background: white;
            color: var(--text-medium);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }
        
        .evidence-action-btn:hover {
            background: var(--bg-light);
            border-color: var(--border-medium);
            color: var(--text-dark);
        }
        
        .evidence-action-btn.danger:hover {
            background: #fee2e2;
            border-color: #ef4444;
            color: #ef4444;
        }
        
        .evidence-item-title {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .evidence-item-meta {
            font-size: 0.75rem;
            color: var(--text-medium);
            margin-bottom: 1rem;
        }
        
        .evidence-item-standards {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-light);
        }
        
        .evidence-standards-label {
            font-size: 0.75rem;
            color: var(--text-medium);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .evidence-standards-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.375rem;
        }
        
        .evidence-standard-tag {
            background: var(--primary-blue-light);
            color: var(--primary-blue);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .evidence-detail-modal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-white);
            z-index: 10;
            display: none;
            flex-direction: column;
        }
        
        .evidence-detail-header {
            padding: 2rem;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .evidence-detail-body {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
        }
        
        .evidence-detail-section {
            margin-bottom: 2rem;
        }
        
        .evidence-detail-section-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 1rem;
        }
        
        .evidence-mapped-standards {
            display: grid;
            gap: 1rem;
        }
        
        .evidence-mapped-standard {
            background: var(--bg-light);
            border: 1px solid var(--border-light);
            border-radius: 0.5rem;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .evidence-mapped-standard-info {
            flex: 1;
        }
        
        .evidence-mapped-standard-code {
            font-weight: 600;
            color: var(--primary-blue);
            margin-bottom: 0.25rem;
        }
        
        .evidence-mapped-standard-text {
            font-size: 0.875rem;
            color: var(--text-medium);
        }
        
        .evidence-confidence {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .evidence-confidence-bar {
            width: 100px;
            height: 8px;
            background: var(--bg-medium);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .evidence-confidence-fill {
            height: 100%;
            background: var(--accent-green);
            transition: width 0.3s;
        }
        
        .evidence-confidence-text {
            font-size: 0.75rem;
            color: var(--text-medium);
        }
        
        .evidence-library-footer {
            padding: 1.5rem 2rem;
            border-top: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-light);
        }
        
        .evidence-bulk-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .evidence-selected-count {
            font-size: 0.875rem;
            color: var(--text-medium);
        }
        
        .evidence-empty-state {
            text-align: center;
            padding: 4rem;
        }
        
        .evidence-empty-icon {
            font-size: 4rem;
            color: var(--text-light);
            margin-bottom: 1rem;
        }
        
        .evidence-empty-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
        }
        
        .evidence-empty-text {
            color: var(--text-medium);
            margin-bottom: 2rem;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="/" class="logo">AÂ³E</a>
            <nav class="nav-links">
                <a href="/dashboard-modern">Dashboard</a>
                <a href="/upload-modern">Upload</a>
                <a href="/standards-modern" class="active">Standards</a>
                <a href="/reports-modern">Reports</a>
                <a href="/reviewer-portal">Reviewer Portal</a>
                <a href="/admin-standards">Admin Standards</a>
                <a href="/crosswalkx">CrosswalkX</a>
                <a href="/documentation">User Guide</a>
                <div class="user-menu">
                    <div class="user-avatar" id="userAvatar">
                        <span id="userInitial">?</span>
                    </div>
                    <span class="user-name" id="userDisplayName">Loading...</span>
                    <a href="#" onclick="logout()" class="logout-link">Logout</a>
                </div>
            </nav>
        </div>
    </header>
    
    <!-- Evidence Library Floating Button -->
    <button id="evidenceLibraryBtn" class="evidence-library-float-btn" onclick="openEvidenceLibrary()" title="Open Evidence Library">
        <span class="evidence-library-icon">ðŸ“š</span>
        <span class="evidence-library-label">Evidence Library</span>
    </button>

    <!-- Main Content -->
    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title">Standards Browser</h1>
            <p class="page-subtitle" id="standardsSubtitle">Explore comprehensive accreditation standards from multiple accreditors to understand requirements and plan your evidence collection strategy</p>
            <button class="help-button" onclick="showHelp('standards')" title="Get help with standards browsing">?</button>
        </div>
        
        <!-- Workflow Progress Tracker -->
        <div class="workflow-progress" id="workflowProgress">
            <div class="workflow-title">
                Accreditation Workflow Progress
                <button class="tutorial-btn tutorial-btn-next" onclick="startTutorial()" style="font-size: 0.875rem; padding: 0.375rem 0.75rem;">
                    Start Tutorial
                </button>
            </div>
            <div class="workflow-steps">
                <div class="workflow-step completed" onclick="goToStep('upload')" data-step="upload">
                    <div class="workflow-icon">ðŸ“</div>
                    <div class="workflow-label">Upload Evidence</div>
                </div>
                <div class="workflow-step completed" onclick="goToStep('map')" data-step="map">
                    <div class="workflow-icon">ðŸ”—</div>
                    <div class="workflow-label">Map to Standards</div>
                </div>
                <div class="workflow-step active" onclick="goToStep('review')" data-step="review">
                    <div class="workflow-icon">ðŸ‘</div>
                    <div class="workflow-label">Review Mappings</div>
                </div>
                <div class="workflow-step" onclick="goToStep('gaps')" data-step="gaps">
                    <div class="workflow-icon">ðŸ”</div>
                    <div class="workflow-label">Analyze Gaps</div>
                </div>
                <div class="workflow-step" onclick="goToStep('report')" data-step="report">
                    <div class="workflow-icon">ðŸ“Š</div>
                    <div class="workflow-label">Generate Report</div>
                </div>
            </div>
        </div>

        <!-- Sign-in Banner (shown when unauthenticated) -->
        <div id="authBanner" class="auth-banner" role="status" aria-live="polite">
            <div class="banner-text">ðŸ” Sign in to see cross-accreditor matches and enhanced metadata.</div>
            <div class="banner-actions">
                <a id="authBannerLogin" href="/login-platform.html">Sign in</a>
            </div>
        </div>

        <!-- Filters Section -->
        <!-- Corpus Metadata Panel -->
        <div class="filters-section" id="corpusMetadataSection" style="margin-bottom:2rem;display:none">
            <div class="filters-header" style="background: var(--gradient-accent);">
                <span>ðŸ§¬</span>
                <h2>Standards Corpus Metadata</h2>
            </div>
            <div class="filters-content" style="padding-top:1.5rem">
                <div id="corpusMetaStatus" style="font-size:0.85rem;color:var(--text-medium);margin-bottom:0.75rem;">Loading corpus metadata...</div>
                <div style="overflow:auto" id="corpusMetaTableWrapper"></div>
                <div style="margin-top:0.75rem;text-align:right;font-size:0.7rem;color:var(--text-light)" id="corpusMetaGenerated"></div>
            </div>
        </div>

        <div class="filters-section">
            <div class="filters-header">
                <span>ðŸ”</span>
                <h2>Search & Filter Standards</h2>
                <button class="help-button" onclick="showHelp('filters')" title="Get help with filtering standards">?</button>
            </div>
            <div class="filters-content">
                <div class="filters-grid">
                    <div class="filter-group">
                        <label class="filter-label">Accreditor</label>
                        <select id="accreditorSelect" class="filter-select">
                            <option value="">Loading accreditors...</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Institution Type</label>
                        <select id="institutionTypeSelect" class="filter-select">
                            <option value="">All Types</option>
                            <option value="college">College</option>
                            <option value="university">University</option>
                            <option value="community_college">Community College</option>
                            <option value="graduate_school">Graduate School</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Search Standards</label>
                        <input type="text" id="searchInput" class="filter-input" placeholder="Search by title, description, or code...">
                    </div>
                </div>
                <div class="search-controls">
                    <button class="btn btn-primary" onclick="applyFilters()">
                        ðŸ” Search Standards
                    </button>
                    <button class="btn btn-secondary" onclick="clearFilters()">
                        ðŸ”„ Clear Filters
                    </button>
                    <div id="selectionToolbar" class="selection-toolbar" style="display:none">
                        <span id="selectedCountBadge" class="badge-selected" role="status" aria-live="polite" aria-atomic="true">0 selected</span>
                        <button id="viewGraphBtn" class="btn btn-primary" type="button" title="View standards relationship graph" aria-label="View standards relationship graph" onclick="showGraphView()">ðŸ“ˆ View Graph</button>
                        <button id="analyzeGapsBtn" class="btn btn-primary" type="button" title="Analyze compliance gaps" aria-label="Analyze compliance gaps" onclick="analyzeGaps()">ðŸ” Analyze Gaps</button>
                        <button id="mapEvidenceBtn" class="btn btn-primary" type="button" title="Map evidence to selected standards" aria-label="Map evidence to selected standards" onclick="openEvidenceMapModal()">ðŸ”— Map Evidence</button>
                        <button id="generateReportBtn" class="btn btn-primary" type="button" title="Generate compliance report" aria-label="Generate compliance report" onclick="openReportGenerationModal()">ðŸ“Š Generate Report</button>
                        <button id="markCompliantBtn" class="btn btn-secondary" type="button" title="Mark selected standards as compliant" aria-label="Mark selected standards as compliant" onclick="markStandardsCompliant()">âœ… Mark Compliant</button>
                        <button id="clearSelectionBtn" class="btn btn-secondary" type="button" title="Remove all selected standards" aria-label="Remove all selected standards">ðŸ§¹ Clear selection</button>
                    </div>
                    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
                        <label class="filter-label" style="margin:0">Status</label>
                        <select id="statusFilter" class="filter-select" style="padding:0.5rem 0.75rem">
                            <option value="">All</option>
                            <option>Unreviewed</option>
                            <option>In Progress</option>
                            <option>Needs Evidence</option>
                            <option>Ready</option>
                            <option>Submitted</option>
                        </select>
                        <label class="filter-label" style="margin:0">Assignee</label>
                        <input type="text" id="assigneeFilter" class="filter-input" placeholder="Filter by assignee">
                    </div>
                    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
                        <label class="filter-label" style="margin:0">Levels</label>
                        <select id="levelsSelect" class="filter-select" style="padding:0.5rem 0.75rem" title="Choose which levels of the standards hierarchy to include" aria-label="Levels to include">
                            <option value="standard">Top-level only</option>
                            <option value="standard,clause">Include subsections</option>
                            <option value="standard,clause,indicator">All levels</option>
                        </select>
                        <label style="display:inline-flex;align-items:center;gap:8px;font-size:0.9rem;color:var(--text-medium)">
                            <input type="checkbox" id="reviewerModeToggle"> Reviewer mode
                        </label>
                        <button class="btn btn-secondary" onclick="exportStandardsCsv()" title="Download visible standards as CSV" aria-label="Download visible standards as CSV">â¬‡ï¸ Export CSV</button>
                        <button class="btn btn-secondary" onclick="saveCurrentView()" title="Save current filters and selections" aria-label="Save current filters and selections">ðŸ’¾ Save View</button>
                        <select id="savedViewsSelect" class="filter-select" style="padding:0.5rem 0.75rem;min-width:200px">
                            <option value="">Load viewâ€¦</option>
                        </select>
                        <button class="btn btn-secondary" onclick="window.print()" title="Print current view" aria-label="Print current view">ðŸ–¨ï¸ Print</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cross-Accreditor Mapping Section -->
        <div class="filters-section" style="margin-top:2rem">
            <div class="filters-header" style="background: var(--gradient-accent);">
                <span>ðŸ”—</span>
                <h2>Cross-Accreditor Mapping</h2>
                <button class="help-button" onclick="showHelp('crosswalk')" title="Get help with cross-accreditor mapping" style="background: rgba(255,255,255,0.9); color: var(--primary-blue);">?</button>
            </div>
            <div class="filters-content">
                <div class="filters-grid">
                    <div class="filter-group">
                        <label class="filter-label">Source Accreditor</label>
                        <select id="sourceAccSelect" class="filter-select"></select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Target Accreditor</label>
                        <select id="targetAccSelect" class="filter-select"></select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Similarity Threshold</label>
                        <input type="number" id="thresholdInput" class="filter-input" value="0.3" step="0.05" min="0" max="1">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Top K Matches</label>
                        <input type="number" id="topKInput" class="filter-input" value="3" min="1" max="10">
                    </div>
                </div>
                <div class="search-controls">
                    <button id="findMappingsBtn" class="btn btn-primary" onclick="fetchCrossAccreditorMatches()" title="Find similar standards across accreditors" aria-label="Find similar standards across accreditors">ðŸ”— Find Mappings</button>
                    <button class="btn btn-secondary" onclick="clearCrossAccreditor()" title="Clear mapping inputs and results" aria-label="Clear mapping inputs and results">â™»ï¸ Reset</button>
                </div>
                <div id="crossAccreditorStatus" style="margin-top:1rem;font-size:0.85rem;color:var(--text-medium);" role="status" aria-live="polite" aria-atomic="true"></div>
                <div id="crossAccreditorResults" style="margin-top:1.5rem"></div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="content-section" id="contentArea">
            <div class="loading-state">
                <div class="spinner"></div>
                <div class="loading-text">Loading accreditors...</div>
            </div>
        </div>

        <!-- Graph Visualization Section -->
        <div class="content-section" id="graphSection" style="display:none;">
            <div class="section-header">
                <h2 style="margin: 0;">Standards Graph Visualization</h2>
                <button class="btn btn-secondary" onclick="showStandardsView()">Back to Standards</button>
            </div>
            <div style="margin-top: 1rem;">
                <div class="filter-group">
                    <label class="filter-label">Visualization Type</label>
                    <select id="vizType" class="filter-select" onchange="updateVisualization()">
                        <option value="network">Network Graph</option>
                        <option value="tree">Hierarchical Tree</option>
                        <option value="radial">Radial Tree</option>
                    </select>
                </div>
            </div>
            <div id="graphContainer" style="width: 100%; height: 600px; margin-top: 2rem; border: 1px solid var(--border-light); border-radius: var(--border-radius); background: white; position: relative;">
                <div class="loading-state" id="graphLoading">
                    <div class="spinner"></div>
                    <div class="loading-text">Loading graph data...</div>
                </div>
                <canvas id="graphCanvas" style="display:none;"></canvas>
                <div id="d3Graph" style="display:none; width: 100%; height: 100%;"></div>
            </div>
            <div id="graphStats" style="margin-top: 1rem; padding: 1rem; background: var(--bg-light); border-radius: var(--border-radius);">
                <!-- Graph statistics will be shown here -->
            </div>
        </div>
    </div>
    
    <!-- Report Generation Modal -->
    <div id="reportGenerationModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h2>Generate Compliance Report</h2>
                <span class="close" onclick="closeReportGenerationModal()">&times;</span>
            </div>
            
            <div class="modal-body" style="flex: 1; overflow-y: auto;">
                <!-- Step 1: Report Type Selection -->
                <div id="reportStep1" class="report-step">
                    <h3 style="margin-bottom: 1rem; color: var(--text-dark);">Select Report Type</h3>
                    <div class="report-type-selector">
                        <div class="report-type-card" onclick="selectReportType('compliance')" data-type="compliance">
                            <div class="report-type-icon">ðŸ“‹</div>
                            <div class="report-type-title">Compliance Report</div>
                            <div class="report-type-description">
                                Comprehensive report showing how your institution meets each selected standard with mapped evidence
                            </div>
                        </div>
                        <div class="report-type-card" onclick="selectReportType('gap')" data-type="gap">
                            <div class="report-type-icon">ðŸ”</div>
                            <div class="report-type-title">Gap Analysis</div>
                            <div class="report-type-description">
                                Identifies standards without sufficient evidence and provides recommendations for improvement
                            </div>
                        </div>
                        <div class="report-type-card" onclick="selectReportType('narrative')" data-type="narrative">
                            <div class="report-type-icon">ðŸ“</div>
                            <div class="report-type-title">Narrative Draft</div>
                            <div class="report-type-description">
                                AI-generated narrative text with citations that can be edited and refined for submission
                            </div>
                        </div>
                    </div>
                    
                    <div class="report-options" style="display: none; margin-top: 2rem;">
                        <h4 style="margin-bottom: 1rem;">Report Options</h4>
                        <div class="report-option-group">
                            <label class="report-option-label">Report Title</label>
                            <input type="text" class="report-option-input" id="reportTitle" placeholder="Enter report title...">
                        </div>
                        <div class="report-option-group">
                            <label class="report-option-label">Institution Name</label>
                            <input type="text" class="report-option-input" id="institutionName" placeholder="Enter institution name...">
                        </div>
                        <div class="report-option-group">
                            <label class="report-option-label">
                                <input type="checkbox" class="report-option-checkbox" id="includeCitations" checked>
                                Include citations for all evidence
                            </label>
                        </div>
                        <div class="report-option-group">
                            <label class="report-option-label">
                                <input type="checkbox" class="report-option-checkbox" id="includeExcerpts" checked>
                                Include evidence excerpts
                            </label>
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem;">
                        <button class="btn btn-secondary" onclick="closeReportGenerationModal()">Cancel</button>
                        <button class="btn btn-primary" id="generateReportBtn" onclick="generateReport()" disabled>Generate Report</button>
                    </div>
                </div>
                
                <!-- Step 2: Report Generation Progress -->
                <div id="reportStep2" class="report-step" style="display: none;">
                    <div class="mapping-progress">
                        <h3 style="margin-bottom: 2rem;">Generating Report...</h3>
                        <div class="progress-indicator">
                            <div class="progress-bar">
                                <div class="progress-fill" id="reportProgressFill" style="width: 0%;"></div>
                            </div>
                            <div class="progress-text" id="reportProgressText">Initializing...</div>
                        </div>
                        <div class="progress-details" style="margin-top: 2rem;">
                            <div class="detail-item" id="reportDetailGathering">
                                <span class="detail-icon">â³</span>
                                <span class="detail-text">Gathering evidence mappings...</span>
                            </div>
                            <div class="detail-item" id="reportDetailAnalyzing">
                                <span class="detail-icon">â³</span>
                                <span class="detail-text">Analyzing compliance status...</span>
                            </div>
                            <div class="detail-item" id="reportDetailGenerating">
                                <span class="detail-icon">â³</span>
                                <span class="detail-text">Generating report content...</span>
                            </div>
                            <div class="detail-item" id="reportDetailFormatting">
                                <span class="detail-icon">â³</span>
                                <span class="detail-text">Formatting citations...</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Step 3: Report Review and Edit -->
                <div id="reportStep3" class="report-step" style="display: none;">
                    <div class="narrative-editor-container">
                        <div class="narrative-toolbar">
                            <button class="toolbar-button" onclick="toggleBold()">
                                <strong>B</strong>
                            </button>
                            <button class="toolbar-button" onclick="toggleItalic()">
                                <em>I</em>
                            </button>
                            <button class="toolbar-button" onclick="toggleUnderline()">
                                <u>U</u>
                            </button>
                            <div class="toolbar-separator"></div>
                            <button class="toolbar-button" onclick="insertHeading()">
                                <span>H</span>
                            </button>
                            <button class="toolbar-button" onclick="insertBulletList()">
                                <span>â€¢ List</span>
                            </button>
                            <div class="toolbar-separator"></div>
                            <button class="toolbar-button" onclick="showCitations()">
                                <span>ðŸ“Ž Citations</span>
                            </button>
                            <button class="toolbar-button" onclick="refreshAI()">
                                <span>ðŸ”„ Refresh AI</span>
                            </button>
                        </div>
                        <div class="narrative-content" id="reportContent" contenteditable="true">
                            <!-- Generated report content will appear here -->
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 2rem;">
                        <button class="btn btn-secondary" onclick="backToReportType()">Back</button>
                        <div style="display: flex; gap: 1rem;">
                            <button class="btn btn-secondary" onclick="saveReportDraft()">Save Draft</button>
                            <button class="btn btn-primary" onclick="exportReport()">Export Report</button>
                        </div>
                    </div>
                </div>
                
                <!-- Step 4: Export Options -->
                <div id="reportStep4" class="report-step" style="display: none;">
                    <h3 style="margin-bottom: 1.5rem;">Export Report</h3>
                    
                    <div class="export-preview" id="exportPreview">
                        <!-- Preview of the report will appear here -->
                    </div>
                    
                    <div class="report-options">
                        <div class="report-option-group">
                            <label class="report-option-label">Export Format</label>
                            <select class="report-option-select" id="exportFormat">
                                <option value="pdf">PDF Document</option>
                                <option value="docx">Microsoft Word</option>
                                <option value="html">HTML (Web)</option>
                                <option value="markdown">Markdown</option>
                            </select>
                        </div>
                        <div class="report-option-group">
                            <label class="report-option-label">
                                <input type="checkbox" class="report-option-checkbox" id="includePageNumbers" checked>
                                Include page numbers
                            </label>
                        </div>
                        <div class="report-option-group">
                            <label class="report-option-label">
                                <input type="checkbox" class="report-option-checkbox" id="includeTableOfContents" checked>
                                Include table of contents
                            </label>
                        </div>
                        <div class="report-option-group">
                            <label class="report-option-label">
                                <input type="checkbox" class="report-option-checkbox" id="includeCoverPage" checked>
                                Include cover page
                            </label>
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; margin-top: 2rem;">
                        <button class="btn btn-secondary" onclick="backToEdit()">Back to Edit</button>
                        <button class="btn btn-primary" onclick="performExport()">
                            <span id="exportBtnText">Download Report</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        (function bootstrapTokenFromUrl(){
            try {
                const u = new URL(window.location.href);
                const t = u.searchParams.get('token') || u.searchParams.get('api_key') || u.searchParams.get('access_token');
                if (t) {
                    localStorage.setItem('a3e_api_key', t);
                    sessionStorage.setItem('a3e_api_key', t);
                    localStorage.setItem('access_token', t);
                    localStorage.setItem('jwt_token', t);
                    u.searchParams.delete('token');
                    u.searchParams.delete('api_key');
                    u.searchParams.delete('access_token');
                    history.replaceState({}, '', u.toString());
                }
            } catch (_) {}
        })();
        function getApiBase(){
            return (window.MMS_CONFIG && MMS_CONFIG.API_BASE_URL) || '';
        }
        function buildApiUrl(path){
            const base = getApiBase() || '';
            if (!path || typeof path !== 'string') return path;
            if (path.startsWith('http')) return path;
            if (!base) return path;
            if (base === '/api') {
                return path.startsWith('/api/') ? path : '/api' + (path.startsWith('/') ? path : '/' + path);
            }
            if (base.endsWith('/api')) {
                return base + (path.startsWith('/api/') ? path.slice(4) : (path.startsWith('/') ? path : '/' + path));
            }
            return base + (path.startsWith('/') ? path : '/' + path);
        }
        function getLevelsParam(){
            try { return localStorage.getItem('mms:levels') || 'standard'; } catch(_) { return 'standard'; }
        }
        function setLevelsParam(v){
            try { localStorage.setItem('mms:levels', v); } catch(_) {}
        }
        function isReviewerMode(){ try { return localStorage.getItem('mms:reviewerMode') === 'true'; } catch(_) { return false; } }
        function setReviewerMode(v){ try { localStorage.setItem('mms:reviewerMode', v?'true':'false'); } catch(_){} }
        
        // Load user profile for header
        async function loadUserProfile() {
            try {
                const token = localStorage.getItem('access_token') || 
                             localStorage.getItem('jwt_token') || 
                             localStorage.getItem('a3e_api_key');
                
                if (!token) return;

                const response = await fetch(buildApiUrl('/api/user/profile'), {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const displayName = data.name || data.institution_name || 'User';
                    const initial = displayName.charAt(0).toUpperCase();
                    
                    const userDisplayName = document.getElementById('userDisplayName');
                    const userInitial = document.getElementById('userInitial');
                    
                    if (userDisplayName) userDisplayName.textContent = displayName;
                    if (userInitial) userInitial.textContent = initial;
                }
            } catch (error) {
                console.error('Failed to load user profile:', error);
            }
        }
        
        function persistFiltersToUrl(){
            const u=new URL(window.location.href);
            const acc=document.getElementById('accreditorSelect').value||'';
            const it=document.getElementById('institutionTypeSelect').value||'';
            const q=document.getElementById('searchInput').value||'';
            const lv=getLevelsParam();
            const st=document.getElementById('statusFilter')?document.getElementById('statusFilter').value:'';
            const asg=document.getElementById('assigneeFilter')?document.getElementById('assigneeFilter').value:'';
            if(acc) u.searchParams.set('acc', acc); else u.searchParams.delete('acc');
            if(it) u.searchParams.set('type', it); else u.searchParams.delete('type');
            if(q) u.searchParams.set('q', q); else u.searchParams.delete('q');
            if(lv) u.searchParams.set('levels', lv); else u.searchParams.delete('levels');
            if(st) u.searchParams.set('status', st); else u.searchParams.delete('status');
            if(asg) u.searchParams.set('assignee', asg); else u.searchParams.delete('assignee');
            history.replaceState({},'',u.toString());
        }
        function loadFiltersFromUrl(){
            try{
                const u=new URL(window.location.href);
                const acc=u.searchParams.get('acc')||'';
                const it=u.searchParams.get('type')||'';
                const q=u.searchParams.get('q')||'';
                const lv=u.searchParams.get('levels')||getLevelsParam();
                const st=u.searchParams.get('status')||'';
                const asg=u.searchParams.get('assignee')||'';
                if(lv) setLevelsParam(lv);
                setTimeout(()=>{
                    if(acc) document.getElementById('accreditorSelect').value=acc;
                    if(it) document.getElementById('institutionTypeSelect').value=it;
                    if(q) document.getElementById('searchInput').value=q;
                    const ls=document.getElementById('levelsSelect'); if(ls) ls.value=lv;
                    if(document.getElementById('statusFilter')) document.getElementById('statusFilter').value=st;
                    if(document.getElementById('assigneeFilter')) document.getElementById('assigneeFilter').value=asg;
                },0);
            }catch(_){}
        }
        function getAuthToken(){
            return localStorage.getItem('a3e_api_key') ||
                   sessionStorage.getItem('a3e_api_key') ||
                   localStorage.getItem('access_token') ||
                   localStorage.getItem('jwt_token') ||
                   localStorage.getItem('token') ||
                   localStorage.getItem('auth_token') || '';
        }
        function isLikelyJwt(t){
            return typeof t === 'string' && t.split('.').length === 3;
        }
        let accreditors = [];
        let currentStandards = [];
        let filteredStandards = [];
        let accOptionsLoaded = false;
        let corpusMetadata = [];
    let selectedStandards = new Set();
        const RISK_CACHE_CAPACITY = 100;
        let riskScoreCache = new Map(); // LRU: newest at the end
        let currentRiskModalStandardId = null;

        function cacheGetRiskScore(standardId){
            if(!riskScoreCache.has(standardId)) return null;
            const val = riskScoreCache.get(standardId);
            // touch: move to end for LRU
            riskScoreCache.delete(standardId);
            riskScoreCache.set(standardId, val);
            return val;
        }

        function cacheSetRiskScore(standardId, score){
            if(riskScoreCache.has(standardId)){
                riskScoreCache.delete(standardId);
            }
            riskScoreCache.set(standardId, score);
            if(riskScoreCache.size > RISK_CACHE_CAPACITY){
                // Evict LRU (first inserted)
                const firstKey = riskScoreCache.keys().next().value;
                if(firstKey !== undefined){ riskScoreCache.delete(firstKey); }
            }
        }
        
        function cacheClearRiskScore(standardId){
            riskScoreCache.delete(standardId);
        }

        function populateCrossAccreditorSelects(){
            const src = document.getElementById('sourceAccSelect');
            const tgt = document.getElementById('targetAccSelect');
            if(!src || !tgt) return;
            src.innerHTML = '<option value="">Select source</option>';
            tgt.innerHTML = '<option value="">Select target</option>';
            accreditors.forEach(acc => {
                const o1 = document.createElement('option');
                o1.value = acc.acronym || acc.id; o1.textContent = acc.acronym || acc.id; src.appendChild(o1);
                const o2 = document.createElement('option');
                o2.value = acc.acronym || acc.id; o2.textContent = acc.acronym || acc.id; tgt.appendChild(o2);
            });
            accOptionsLoaded = true;
        }

        function loadSelectedFromStorage(){
            try{
                const raw = localStorage.getItem('mms:selectedStandards');
                const arr = raw ? JSON.parse(raw) : [];
                if (Array.isArray(arr)) selectedStandards = new Set(arr.map(String));
            }catch(_){ selectedStandards = new Set(); }
        }

        function persistSelectedToStorage(){
                    try{ localStorage.setItem('mms:selectedStandards', JSON.stringify(Array.from(selectedStandards))); }catch(_){}
                }

                function updateSelectedBadge(){
                    try{
                        const bar = document.getElementById('selectionToolbar');
                        const badge = document.getElementById('selectedCountBadge');
                        if(!bar || !badge) return;
                        const n = selectedStandards.size;
                        if(n > 0){ bar.style.display='flex'; badge.textContent = n + ' selected'; }
                        else { bar.style.display='none'; badge.textContent = '0 selected'; }
                    }catch(_){ }
                }

                function clearSelectedStandards(){
                    try{
                        selectedStandards = new Set();
                        persistSelectedToStorage();
                        syncSelectionToServer();
                        document.querySelectorAll('.standard-card.selected').forEach(el=>el.classList.remove('selected'));
                        updateSelectedBadge();
                        try { window.dispatchEvent(new CustomEvent('mms:selected-standards-updated', { detail: { selected: [] } })); } catch(_) {}
                    }catch(_){ }
        }

        async function syncSelectionToServer(){
            try{
                const token = getAuthToken();
                const headers = { 'Content-Type': 'application/json' };
                if (isLikelyJwt(token)) headers['Authorization'] = 'Bearer ' + token;
                await fetch(buildApiUrl('/api/user/intelligence-simple/standards/selection/save'), {
                    method: 'POST', credentials: 'include', headers,
                    body: JSON.stringify({ selected: Array.from(selectedStandards) })
                });
            }catch(_){ /* non-blocking */ }
        }

        async function hydrateSelectionFromServer(){
            try{
                const token = getAuthToken();
                const headers = {};
                if (isLikelyJwt(token)) headers['Authorization'] = 'Bearer ' + token;
                const res = await fetch(buildApiUrl('/api/user/intelligence-simple/standards/selection/load'), { credentials:'include', headers });
                if(!res.ok) return;
                const data = await res.json();
                const arr = (data && data.selected) || [];
                if (Array.isArray(arr) && arr.length){ selectedStandards = new Set(arr.map(String)); persistSelectedToStorage(); try { window.dispatchEvent(new CustomEvent('mms:selected-standards-updated', { detail: { selected: Array.from(selectedStandards) } })); } catch(_) {} }
            }catch(_){ }
        }

        // Logout function
        function logout() {
            localStorage.clear();
            window.location.href = '/login-platform.html';
        }

        // Load accreditors on page load (prefer corpus metadata; fallback to config)
    async function loadAccreditors() {
            try {
                console.debug('[standards-modern] Fetching accreditors via corpus metadata');
                const t = getAuthToken();
                const r1 = await fetch(buildApiUrl('/api/user/intelligence-simple/standards/corpus/metadata'), {
                    credentials: 'include',
                    headers: isLikelyJwt(t) ? { 'Authorization': `Bearer ${t}` } : {}
                });
                if (r1.ok) {
                    const j1 = await r1.json();
                    const list = Array.isArray(j1?.accreditors) ? j1.accreditors : (Array.isArray(j1?.data?.accreditors) ? j1.data.accreditors : []);
                    if (Array.isArray(list) && list.length) {
                        accreditors = list.map(a => ({ id: a.accreditor || a.id || a.acronym, acronym: (a.accreditor || a.id || a.acronym || '').toUpperCase(), name: a.name || a.accreditor || a.label || '' }));
                        populateAccreditorSelect();
                        populateCrossAccreditorSelects();
                        showAccreditorSelection();
                        fetchCorpusMetadata();
                        return;
                    }
                }
                console.debug('[standards-modern] Corpus metadata empty or unavailable, falling back to /api/v1/standards/accreditors');
                const r2 = await fetch(buildApiUrl('/api/v1/standards/accreditors'), { credentials: 'include' });
                if (r2.ok) {
                    const j2 = await r2.json();
                    if (Array.isArray(j2) && j2.length) {
                        accreditors = j2.map(a => ({
                            id: (a.accreditor_acronym || a.accreditor_id || a.id || '').toUpperCase(),
                            acronym: (a.accreditor_acronym || a.accreditor_id || a.id || '').toUpperCase(),
                            name: a.accreditor_name || a.name || a.full_name || a.id || ''
                        }));
                        populateAccreditorSelect();
                        populateCrossAccreditorSelects();
                        showAccreditorSelection();
                        fetchCorpusMetadata();
                        return;
                    }
                }
                // Last resort: original DB endpoint
                console.debug('[standards-modern] Final fallback to /api/standards/accreditors');
                const response = await fetch(buildApiUrl('/api/standards/accreditors'), { credentials: 'include' });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                if (data && data.success && data.data && Array.isArray(data.data.accreditors)) {
                    accreditors = data.data.accreditors;
                    populateAccreditorSelect();
                    populateCrossAccreditorSelects();
                    showAccreditorSelection();
                    fetchCorpusMetadata();
                } else {
                    throw new Error('Failed to load accreditors');
                }
            } catch (error) {
                console.error('Error loading accreditors:', error);
                showErrorState('Error loading accreditors', 'Please try refreshing the page.');
            }
        }

    async function fetchCorpusMetadata(accreditorFilter=""){
            const section = document.getElementById('corpusMetadataSection');
            section.style.display='block';
            const statusEl = document.getElementById('corpusMetaStatus');
            const tableWrapper = document.getElementById('corpusMetaTableWrapper');
            const genEl = document.getElementById('corpusMetaGenerated');
            statusEl.textContent = accreditorFilter? `Loading metadata for ${accreditorFilter}...` : 'Loading corpus metadata...';
            try{
                const token = getAuthToken();
                const url = accreditorFilter? (buildApiUrl(`/api/user/intelligence-simple/standards/corpus/metadata?accreditor=${encodeURIComponent(accreditorFilter)}`)) : (buildApiUrl('/api/user/intelligence-simple/standards/corpus/metadata'));
                let res = await fetch(url, {
                    headers: isLikelyJwt(token) ? { 'Authorization': `Bearer ${token}` } : {},
                    credentials: 'include'
                });
                if(!res.ok){
                    if(res.status === 401 || res.status === 403){
                        // Show login banner subtly
                        try { const b = document.getElementById('authBanner'); if (b) b.style.display = 'flex'; } catch(_) {}
                        // Fallback: public accreditors endpoint to synthesize minimal metadata
                        console.debug('[standards-modern] corpus metadata 401 â€” falling back to /api/v1/standards/accreditors');
                        const pub = await fetch(buildApiUrl('/api/v1/standards/accreditors'), { credentials: 'include' });
                        if(pub.ok){
                            const arr = await pub.json();
                            const filtered = Array.isArray(arr) ? arr.filter(a => !accreditorFilter || (a.accreditor_acronym||a.accreditor_id||'').toUpperCase() === accreditorFilter.toUpperCase()) : [];
                            const items = filtered.map(a => ({
                                accreditor: (a.accreditor_acronym || a.accreditor_id || a.id || '').toUpperCase(),
                                name: a.accreditor_name || a.name || a.full_name || '',
                                version: null,
                                effective_date: null,
                                loaded_node_count: a.total_standards || 0,
                                standard_count: a.total_standards || 0,
                                license: null,
                                last_updated: null,
                                file: ''
                            }));
                            corpusMetadata = items;
                            const totalAcc = items.length;
                            const totalStd = items.reduce((s,x)=>s+(x.standard_count||0),0);
                            renderCorpusMetadataTable(corpusMetadata, totalAcc, totalStd);
                            genEl.textContent = `Generated: (public data)`;
                            statusEl.textContent = accreditorFilter? `Showing ${corpusMetadata.length} record for ${accreditorFilter}` : `Loaded ${totalAcc} accreditors (${totalStd} standards)`;
                            return;
                        }
                    }
                    const t = await res.text();
                    throw new Error(`Request failed (${res.status}): ${t}`);
                }
                const data = await res.json();
                if(!data || !data.success){
                    throw new Error('Malformed corpus metadata response');
                }
                corpusMetadata = data.accreditors || [];
                renderCorpusMetadataTable(corpusMetadata, data.total_accreditors, data.total_standards);
                genEl.textContent = `Generated: ${data.generated_at}`;
                statusEl.textContent = accreditorFilter? `Showing ${corpusMetadata.length} record for ${accreditorFilter}` : `Loaded ${data.total_accreditors} accreditors (${data.total_standards} standards)`;
            }catch(e){
                statusEl.textContent = 'Error loading corpus metadata: ' + e.message;
            }
        }

        function renderCorpusMetadataTable(items, totalAccreditors, totalStandards){
            const tableWrapper = document.getElementById('corpusMetaTableWrapper');
            if(!items || !items.length){
                tableWrapper.innerHTML = '<div style="padding:1rem;border:1px solid var(--border-light);border-radius:8px;background:var(--bg-white);color:var(--text-medium);">No corpus metadata available.</div>';
                return;
            }
            let html = '<table style="width:100%;border-collapse:collapse;font-size:0.75rem;min-width:900px">';
            html += '<thead><tr style="background:var(--bg-light)">'
                + '<th style="text-align:left;padding:6px 8px;border-bottom:1px solid var(--border-light)">Accreditor</th>'
                + '<th style="text-align:left;padding:6px 8px;border-bottom:1px solid var(--border-light)">Version</th>'
                + '<th style="text-align:left;padding:6px 8px;border-bottom:1px solid var(--border-light)">Effective Date</th>'
                + '<th style="text-align:left;padding:6px 8px;border-bottom:1px solid var(--border-light)">Loaded Nodes</th>'
                + '<th style="text-align:left;padding:6px 8px;border-bottom:1px solid var(--border-light)">Declared Standards</th>'
                + '<th style="text-align:left;padding:6px 8px;border-bottom:1px solid var(--border-light)">License</th>'
                + '<th style="text-align:left;padding:6px 8px;border-bottom:1px solid var(--border-light)">Last Updated</th>'
                + '<th style="text-align:left;padding:6px 8px;border-bottom:1px solid var(--border-light)">File</th>'
                + '</tr></thead><tbody>';
            items.forEach(m => {
                html += '<tr>'
                    + `<td style="padding:6px 8px;border-bottom:1px solid var(--border-light)"><strong>${escapeHtml(m.accreditor||'')}</strong>${m.name? '<br><span style=\"color:var(--text-medium)\">'+escapeHtml(m.name)+'</span>':''}</td>`
                    + `<td style="padding:6px 8px;border-bottom:1px solid var(--border-light)">${escapeHtml(m.version||'â€”')}</td>`
                    + `<td style="padding:6px 8px;border-bottom:1px solid var(--border-light)">${escapeHtml(m.effective_date||'â€”')}</td>`
                    + `<td style="padding:6px 8px;border-bottom:1px solid var(--border-light)">${m.loaded_node_count ?? 'â€”'}</td>`
                    + `<td style="padding:6px 8px;border-bottom:1px solid var(--border-light)">${m.standard_count ?? 'â€”'}</td>`
                    + `<td style="padding:6px 8px;border-bottom:1px solid var(--border-light)">${escapeHtml(m.license||'â€”')}</td>`
                    + `<td style="padding:6px 8px;border-bottom:1px solid var(--border-light)">${escapeHtml(m.last_updated||'â€”')}</td>`
                    + `<td style="padding:6px 8px;border-bottom:1px solid var(--border-light)">${escapeHtml(m.file||'')}</td>`
                    + '</tr>';
            });
            html += '</tbody></table>';
            tableWrapper.innerHTML = html;
        }

        function populateAccreditorSelect() {
            const select = document.getElementById('accreditorSelect');
            select.innerHTML = '<option value="">Select an accreditor</option>';
            
            accreditors.forEach(acc => {
                const option = document.createElement('option');
                option.value = acc.id;
                option.textContent = `${acc.name} (${acc.acronym})`;
                select.appendChild(option);
            });
        }

        function showAccreditorSelection() {
            document.getElementById('contentArea').innerHTML = `
                <div class="accreditor-selection">
                    <span class="selection-icon">ðŸ“š</span>
                    <h2 class="selection-title">Choose Your Accreditor</h2>
                    <p class="selection-subtitle">Select an accreditor from the dropdown above to explore their standards and requirements</p>
                    <div class="available-accreditors">
                        ${accreditors.map(acc => `<span class="accreditor-badge">${acc.acronym}</span>`).join('')}
                    </div>
                </div>
            `;
        }

        function showLoadingState(message = 'Loading...') {
            document.getElementById('contentArea').innerHTML = `
                <div class="loading-state">
                    <div class="spinner"></div>
                    <div class="loading-text">${message}</div>
                </div>
            `;
        }

        function showErrorState(title, message) {
            document.getElementById('contentArea').innerHTML = `
                <div class="error-state">
                    <div class="error-icon">âš ï¸</div>
                    <h3 class="error-title">${title}</h3>
                    <p class="error-message">${message}</p>
                </div>
            `;
        }

        function showEmptyState(title, message) {
            document.getElementById('contentArea').innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">ðŸ“„</div>
                    <h3 class="empty-title">${title}</h3>
                    <p class="empty-message">${message}</p>
                </div>
            `;
        }

    async function loadStandards(accreditorId, institutionType = null) {
            if (!accreditorId) {
                showAccreditorSelection();
                return;
            }

            showLoadingState('Loading standards...');

            try {
                const token = getAuthToken();
                const levels = getLevelsParam();
                let url = buildApiUrl(`/api/user/intelligence-simple/standards/list?accreditor=${encodeURIComponent(accreditorId.toUpperCase())}&levels=${encodeURIComponent(levels)}`);
                if (institutionType) {
                    url += `&institution_type=${encodeURIComponent(institutionType)}`;
                }
                // Prefer simple list endpoint; rely on cookies and only add Authorization for real JWTs
                let response = await fetch(url, {
                    credentials: 'include',
                    headers: isLikelyJwt(token) ? { 'Authorization': `Bearer ${token}` } : {}
                });
                if (response.status === 401) {
                    try { const b = document.getElementById('authBanner'); if (b) b.style.display = 'flex'; } catch(_) {}
                    showErrorState('Authentication required', 'Please log in to view standards.');
                    return;
                }
                if (!response.ok) {
                    // Fallback to DB endpoint as last resort
                    let dbUrl = buildApiUrl(`/api/standards?accreditor=${encodeURIComponent(accreditorId.toUpperCase())}`);
                    response = await fetch(dbUrl, { credentials: 'include' });
                }
                const data = await response.json();
                let list = [];
                if (Array.isArray(data?.standards)) list = data.standards;
                else if (Array.isArray(data?.data?.standards)) list = data.data.standards;
                // Normalize fields for UI stability
                currentStandards = (list || []).map(s => ({
                    id: s.id || s.code,
                    code: s.code || s.id,
                    title: s.title || '',
                    description: s.description || '',
                    category: s.category || s.level || 'standard',
                    is_required: typeof s.is_required === 'boolean' ? s.is_required : false,
                    weight: typeof s.weight === 'number' ? s.weight : 100,
                    evidence_requirements: Array.isArray(s.evidence_requirements) ? s.evidence_requirements : []
                }));
                filteredStandards = [...currentStandards];

                const accreditor = accreditors.find(acc => acc.id === accreditorId) || { 
                    name: accreditorId.toUpperCase(), 
                    acronym: accreditorId.toUpperCase() 
                };
                // Hydrate server reviews into local cache before rendering
                await hydrateServerReviews(accreditor.acronym || accreditor.name);
                displayStandards(accreditor, currentStandards);
                persistFiltersToUrl();
            } catch (error) {
                console.error('Error loading standards:', error);
                showErrorState('Error loading standards', 'Please try again or select a different accreditor.');
            }
        }

        function displayStandards(accreditor, standards) {
            if (standards.length === 0) {
                showEmptyState('No standards found', 'Try selecting a different institution type or accreditor.');
                return;
            }

            const requiredCount = standards.filter(s => s.is_required).length;
            const categoriesCount = [...new Set(standards.map(s => s.category))].length;

            let html = `
                <div class="accreditor-info">
                    <h2 class="accreditor-name">${accreditor.name}</h2>
                    <div class="accreditor-details">
                        <div class="accreditor-stat">
                            <div class="stat-value">${standards.length}</div>
                            <div class="stat-label">Total Standards</div>
                        </div>
                        <div class="accreditor-stat">
                            <div class="stat-value">${requiredCount}</div>
                            <div class="stat-label">Required</div>
                        </div>
                        <div class="accreditor-stat">
                            <div class="stat-value">${categoriesCount}</div>
                            <div class="stat-label">Categories</div>
                        </div>
                    </div>
                </div>
                <div class="standards-grid">
            `;
            
            standards.forEach(async (standard) => {
                const evidenceCount = standard.evidence_requirements ? standard.evidence_requirements.length : 0;
                const reviewKey = `mms:review:${accreditor.acronym||accreditor.name}:${standard.code||standard.id}`;
                const existing = JSON.parse(localStorage.getItem(reviewKey) || '{}');
                const status = existing.status || 'Unreviewed';
                const note = existing.note || '';
                const assignee = existing.assignee || '';
                const due_date = existing.due_date || '';
                const statusBadge = status ? `<span class="pill" style="background:${status==='Ready'?'#dcfce7':status==='Submitted'?'#e0e7ff':status==='Needs Evidence'?'#fee2e2':status==='In Progress'?'#fef9c3':'#f1f5f9'};border:1px solid var(--border-light)">${status}</span>` : '';
                const sid = String(standard.code || standard.id);
                const isSelected = selectedStandards.has(sid);
                
                html += `
                    <div class="standard-card ${isSelected ? 'selected' : ''}" data-standard-id="${sid}" onclick="toggleStandardSelection(event, '${sid}')">
                        <div class="standard-header">
                            <div class="standard-id">${standard.code || standard.id}</div>
                            <h3 class="standard-title">${standard.title}</h3>
                        </div>
                        <div class="standard-content">
                            <p class="standard-description">${standard.description}</p>
                            <div id="mappedEvidence_${sid}" class="mapped-evidence-container"></div>
                            ${isSelected ? `
                                <div class="evidence-mapping-banner">
                                    <div class="evidence-mapping-status">
                                        <span class="evidence-status-icon">ðŸŽ¯</span>
                                        <span>Ready to map evidence to this standard</span>
                                    </div>
                                    <button class="map-evidence-button" onclick="openEvidenceMapModal(event)">
                                        Map Evidence Now
                                    </button>
                                </div>
                            ` : ''}
                            <div class="standard-meta">
                                <div class="meta-item">
                                    <span class="meta-icon">ðŸ“‚</span>
                                    <span class="category-badge">${standard.category}</span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-icon">âš–ï¸</span>
                                    <span>Weight: ${standard.weight || 100}</span>
                                </div>
                                ${standard.is_required ? '<span class="required-badge">Required</span>' : ''}
                                ${evidenceCount > 0 ? `
                                <div class="meta-item">
                                    <span class="meta-icon">ðŸ“‹</span>
                                    <span>${evidenceCount} Evidence Items</span>
                                </div>
                                ` : ''}
                                <div class="meta-item">${statusBadge}</div>
                                <div class="meta-item">
                                    <button class="btn btn-secondary" data-risk-btn="1" style="padding:0.4rem 0.8rem;font-size:0.7rem" onclick="openRiskModal('${standard.code || standard.id}')" title="View risk factor breakdown" aria-label="Open risk factors for ${standard.code || standard.id}">Risk Factors</button>
                                </div>
                                ${isReviewerMode()?`
                                                <div class="meta-item" style="width:100%;margin-top:6px;gap:8px;align-items:stretch">
                                                    <select data-review-key="${reviewKey}" data-standard-id="${standard.code || standard.id}" data-accreditor="${(accreditor.acronym||accreditor.name||'').toUpperCase()}" class="filter-select" style="padding:6px 8px;min-width:160px" onchange="saveReviewStatus(this)">
                                                        <option ${status==='Unreviewed'?'selected':''}>Unreviewed</option>
                                                        <option ${status==='In Progress'?'selected':''}>In Progress</option>
                                                        <option ${status==='Needs Evidence'?'selected':''}>Needs Evidence</option>
                                                        <option ${status==='Ready'?'selected':''}>Ready</option>
                                                        <option ${status==='Submitted'?'selected':''}>Submitted</option>
                                                    </select>
                                                    <input type="text" placeholder="Assignee (email/name)" class="filter-input" data-review-assignee value="${escapeHtml(assignee)}"
                                                        data-review-key="${reviewKey}" data-standard-id="${standard.code || standard.id}" data-accreditor="${(accreditor.acronym||accreditor.name||'').toUpperCase()}" style="padding:6px 8px;min-width:160px" onblur="saveReviewAssignee(this)">
                                                    <input type="date" class="filter-input" data-review-due value="${escapeHtml(due_date)}"
                                                        data-review-key="${reviewKey}" data-standard-id="${standard.code || standard.id}" data-accreditor="${(accreditor.acronym||accreditor.name||'').toUpperCase()}" style="padding:6px 8px;min-width:160px" onblur="saveReviewDueDate(this)">
                                                </div>
                                                <div class="meta-item" style="width:100%">
                                                    <textarea data-review-key="${reviewKey}" data-standard-id="${standard.code || standard.id}" data-accreditor="${(accreditor.acronym||accreditor.name||'').toUpperCase()}" class="filter-input" rows="2" placeholder="Reviewer notesâ€¦" style="width:100%" onblur="saveReviewNote(this)">${escapeHtml(note)}</textarea>
                                                </div>
                                                `:''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            document.getElementById('contentArea').innerHTML = html;
            try { attachStandardsTooltips(); } catch(_){ }
            updateSelectedBadge();
            
            // Load mapped evidence for each standard
            standards.forEach(standard => {
                loadMappedEvidence(standard.code || standard.id);
            });
        }

        window.toggleStandardSelection = function(e, sid){
            try{
                // Avoid triggering when clicking form inputs inside reviewer mode
                const tag = (e.target && e.target.tagName || '').toLowerCase();
                if (['select','input','textarea','button','a','label'].includes(tag)) return;
                const id = String(sid||''); if(!id) return;
                if (selectedStandards.has(id)) selectedStandards.delete(id); else selectedStandards.add(id);
                persistSelectedToStorage();
                syncSelectionToServer();
                // Toggle class on card
                const card = e.currentTarget || e.target.closest('.standard-card');
                if (card) card.classList.toggle('selected');
                updateSelectedBadge();
                try { window.dispatchEvent(new CustomEvent('mms:selected-standards-updated', { detail: { selected: Array.from(selectedStandards) } })); } catch(_) {}
            }catch(_){ }
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            
            if (!currentStandards.length) {
                return;
            }

            let filtered = [...currentStandards];

            // Apply search filter
            if (searchTerm) {
                filtered = filtered.filter(standard => {
                    return standard.title.toLowerCase().includes(searchTerm) ||
                           standard.description.toLowerCase().includes(searchTerm) ||
                           (standard.code && standard.code.toLowerCase().includes(searchTerm)) ||
                           standard.category.toLowerCase().includes(searchTerm);
                });
            }

            // Apply reviewer filters using local cache entries
            const st = document.getElementById('statusFilter')?document.getElementById('statusFilter').value:'';
            const asg = document.getElementById('assigneeFilter')?document.getElementById('assigneeFilter').value.trim().toLowerCase():'';
            if (st || asg){
                const accSel = document.getElementById('accreditorSelect').value;
                filtered = filtered.filter(standard => {
                    const key = `mms:review:${(accSel||'').toUpperCase()}:${standard.code||standard.id}`;
                    const r = JSON.parse(localStorage.getItem(key)||'{}');
                    const statusOk = st ? (r.status === st) : true;
                    const assigneeOk = asg ? ((r.assignee||'').toLowerCase().includes(asg)) : true;
                    return statusOk && assigneeOk;
                });
            }

            filteredStandards = filtered;
            
            const accreditorId = document.getElementById('accreditorSelect').value;
            const accreditor = accreditors.find(acc => acc.id === accreditorId) || { 
                name: "Accreditor", 
                acronym: accreditorId 
            };
            
            displayStandards(accreditor, filteredStandards);
            persistFiltersToUrl();
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('institutionTypeSelect').value = '';
            if(document.getElementById('statusFilter')) document.getElementById('statusFilter').value='';
            if(document.getElementById('assigneeFilter')) document.getElementById('assigneeFilter').value='';
            
            const accreditorId = document.getElementById('accreditorSelect').value;
            if (accreditorId) {
                filteredStandards = [...currentStandards];
                const accreditor = accreditors.find(acc => acc.id === accreditorId);
                displayStandards(accreditor, currentStandards);
            }
        }

            async function fetchCrossAccreditorMatches(){
                const source = document.getElementById('sourceAccSelect').value.trim();
                const target = document.getElementById('targetAccSelect').value.trim();
                const threshold = parseFloat(document.getElementById('thresholdInput').value) || 0.3;
                const topK = parseInt(document.getElementById('topKInput').value) || 3;
                const statusEl = document.getElementById('crossAccreditorStatus');
                const resultsEl = document.getElementById('crossAccreditorResults');
                resultsEl.innerHTML='';
                
                // Enhanced validation
                if(!source || !target){
                    statusEl.innerHTML='<span style="color:#ef4444">âš ï¸ Please select both source and target accreditors.</span>';
                    return;
                }
                if(source===target){
                    statusEl.innerHTML='<span style="color:#f59e0b">âš ï¸ Please select different accreditors for comparison.</span>';
                    return;
                }
                
                // Show loading state with spinner
                statusEl.innerHTML='<span style="color:#3b82f6">ðŸ”„ Computing CrosswalkXâ„¢ mappings...</span>';
                resultsEl.innerHTML='<div style="text-align:center;padding:2rem"><div class="spinner"></div></div>';
                
                try{
                    const token = getAuthToken();
                    console.log(`[CrosswalkX] Fetching mappings: ${source} -> ${target}, threshold: ${threshold}, topK: ${topK}`);
                    
                    const res = await fetch(buildApiUrl(`/api/user/intelligence-simple/standards/cross-accreditor-matches?source=${encodeURIComponent(source)}&target=${encodeURIComponent(target)}&threshold=${threshold}&top_k=${topK}`), {
                        headers: isLikelyJwt(token) ? { 'Authorization': `Bearer ${token}` } : {},
                        credentials: 'include'
                    });
                    
                    if(res.status === 401){
                        try { const b = document.getElementById('authBanner'); if (b) b.style.display = 'flex'; } catch(_) {}
                        statusEl.innerHTML='<span style="color:#ef4444">ðŸ”’ Authentication required â€” please log in to use CrosswalkXâ„¢.</span>';
                        resultsEl.innerHTML='';
                        return;
                    }
                    
                    if(!res.ok){
                        const t = await res.text();
                        console.error(`[CrosswalkX] API error: ${res.status}`, t);
                        throw new Error(`Request failed (${res.status}): ${t}`);
                    }
                    
                    const data = await res.json();
                    console.log(`[CrosswalkX] Received ${(data.matches||[]).length} matches`);
                    
                    renderCrossAccreditorResults(data.matches || [], data.source, data.target, threshold);
                    
                    if((data.matches||[]).length > 0){
                        statusEl.innerHTML=`<span style="color:#10b981">âœ… Found ${(data.matches||[]).length} CrosswalkXâ„¢ mapping${(data.matches||[]).length !== 1 ? 's' : ''} (similarity threshold: ${Math.round(threshold*100)}%)</span>`;
                    } else {
                        statusEl.innerHTML=`<span style="color:#f59e0b">â„¹ï¸ No mappings found above ${Math.round(threshold*100)}% similarity. Try lowering the threshold.</span>`;
                    }
                }catch(e){
                    console.error('[CrosswalkX] Error:', e);
                    statusEl.innerHTML=`<span style="color:#ef4444">âŒ Error: ${e.message}</span>`;
                    resultsEl.innerHTML='<div style="padding:1rem;border:1px solid #fee2e2;border-radius:8px;background:#fef2f2;color:#991b1b;">Failed to compute mappings. Please try again or contact support if the issue persists.</div>';
                }
            }

            function renderCrossAccreditorResults(matches, source, target, threshold){
                const container = document.getElementById('crossAccreditorResults');
                if(!matches.length){
                    container.innerHTML = `
                        <div style="padding:1.5rem;border:1px solid #fbbf24;border-radius:8px;background:#fffbeb;color:#92400e;text-align:center;">
                            <div style="font-size:2rem;margin-bottom:0.5rem">ðŸ”</div>
                            <div style="font-weight:600">No CrosswalkXâ„¢ mappings found</div>
                            <div style="margin-top:0.5rem;font-size:0.875rem">No standards matched above the ${Math.round(threshold*100)}% similarity threshold. Try reducing the threshold or selecting different accreditors.</div>
                        </div>`;
                    return;
                }
                
                // Group matches by source standard
                const groupedMatches = {};
                matches.forEach(m => {
                    if (!groupedMatches[m.source_id]) {
                        groupedMatches[m.source_id] = {
                            source_title: m.source_title,
                            targets: []
                        };
                    }
                    groupedMatches[m.source_id].targets.push(m);
                });
                
                let html = `
                    <div style="margin-bottom:1rem;padding:1rem;background:#f0fdf4;border:1px solid #86efac;border-radius:8px;">
                        <div style="font-weight:600;color:#166534;margin-bottom:0.5rem">ðŸŽ¯ CrosswalkXâ„¢ Mapping Results</div>
                        <div style="font-size:0.875rem;color:#166534">Showing potential equivalencies between ${source} and ${target} standards based on semantic similarity</div>
                    </div>
                    <div style="overflow:auto;border:1px solid var(--border-light);border-radius:8px;">
                        <table style="width:100%;border-collapse:collapse;font-size:0.875rem;">
                            <thead>
                                <tr style="background:linear-gradient(135deg, #eff6ff 0%, #e0f2fe 100%);">
                                    <th style="text-align:left;padding:12px;border-bottom:2px solid #3b82f6;color:#1e40af;font-weight:700">${source} Standard</th>
                                    <th style="text-align:left;padding:12px;border-bottom:2px solid #3b82f6;color:#1e40af;font-weight:700">${target} Equivalent(s)</th>
                                    <th style="text-align:center;padding:12px;border-bottom:2px solid #3b82f6;color:#1e40af;font-weight:700">Match Score</th>
                                    <th style="text-align:left;padding:12px;border-bottom:2px solid #3b82f6;color:#1e40af;font-weight:700">Common Keywords</th>
                                </tr>
                            </thead>
                            <tbody>`;
                
                Object.entries(groupedMatches).forEach(([sourceId, data], idx) => {
                    const targets = data.targets.sort((a, b) => b.score - a.score);
                    const bgColor = idx % 2 === 0 ? 'var(--bg-white)' : 'var(--bg-light)';
                    
                    targets.forEach((m, targetIdx) => {
                        const scorePct = Math.round(m.score * 100);
                        const scoreColor = scorePct >= 80 ? '#10b981' : scorePct >= 60 ? '#3b82f6' : '#f59e0b';
                        const keywords = (m.overlap_keywords && m.overlap_keywords.length) 
                            ? m.overlap_keywords.slice(0, 5).map(k => `<span style="background:#e0e7ff;color:#4338ca;padding:2px 6px;border-radius:4px;margin:2px;display:inline-block;font-size:0.75rem;">${escapeHtml(k)}</span>`).join(' ')
                            : '<span style="color:#9ca3af">No keyword overlap detected</span>';
                        
                        html += `<tr style="background:${bgColor}">
                            ${targetIdx === 0 ? `<td rowspan="${targets.length}" style="padding:12px;border-bottom:1px solid var(--border-light);vertical-align:top;">
                                <div style="font-weight:600;color:#1e40af;margin-bottom:4px;">${sourceId}</div>
                                <div style="color:var(--text-medium);line-height:1.4;">${escapeHtml(data.source_title||'No title')}</div>
                            </td>` : ''}
                            <td style="padding:12px;border-bottom:1px solid var(--border-light);">
                                <div style="font-weight:600;color:#059669;margin-bottom:4px;">${m.target_id}</div>
                                <div style="color:var(--text-medium);line-height:1.4;">${escapeHtml(m.target_title||'No title')}</div>
                            </td>
                            <td style="padding:12px;border-bottom:1px solid var(--border-light);text-align:center;">
                                <div style="display:inline-flex;align-items:center;gap:6px;">
                                    <div style="width:60px;height:8px;background:#e5e7eb;border-radius:4px;overflow:hidden;">
                                        <div style="width:${scorePct}%;height:100%;background:${scoreColor};"></div>
                                    </div>
                                    <span style="font-weight:700;color:${scoreColor};">${scorePct}%</span>
                                </div>
                            </td>
                            <td style="padding:12px;border-bottom:1px solid var(--border-light);">
                                ${keywords}
                            </td>
                        </tr>`;
                    });
                });
                
                html += `</tbody></table></div>
                    <div style="margin-top:1rem;padding:0.75rem;background:#f3f4f6;border-radius:6px;font-size:0.75rem;color:#6b7280;">
                        <strong>Note:</strong> CrosswalkXâ„¢ mappings are AI-generated suggestions based on semantic similarity. Manual review is recommended before using these mappings for official purposes.
                    </div>`;
                
                container.innerHTML = html;
            }

            function clearCrossAccreditor(){
                document.getElementById('sourceAccSelect').selectedIndex = 0;
                document.getElementById('targetAccSelect').selectedIndex = 0;
                document.getElementById('crossAccreditorResults').innerHTML='';
                document.getElementById('crossAccreditorStatus').textContent='';
            }

            function escapeHtml(str){
                return (str||'').replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]));
            }

        // Event listeners
        document.getElementById('accreditorSelect').addEventListener('change', function() {
            const accreditorId = this.value;
            const institutionType = document.getElementById('institutionTypeSelect').value;
            loadStandards(accreditorId, institutionType);
            if(accreditorId){
                fetchCorpusMetadata(accreditorId);
            } else {
                fetchCorpusMetadata("");
            }
            // Clear cached risk scores on context change
            riskScoreCache = new Map();
            currentRiskModalStandardId = null;
            try { localStorage.setItem('mms:currentAccreditor', String(accreditorId||'')); } catch(_){ }
            try { maybeShowSwitchBanner(); } catch(_){ }
        });

        document.getElementById('institutionTypeSelect').addEventListener('change', function() {
            const accreditorId = document.getElementById('accreditorSelect').value;
            const institutionType = this.value;
            loadStandards(accreditorId, institutionType);
        });

        document.getElementById('searchInput').addEventListener('keyup', function(e) {
            if (e.key === 'Enter') {
                applyFilters();
            }
        });

        // Switch banner container
        const switchBannerHtml = `<div id="accrSwitchBanner" style="display:none;margin:10px 0;padding:10px;border:1px solid #fde68a;background:#fffbeb;color:#92400e;border-radius:8px">
            <strong>Heads up:</strong> Your onboarding accreditor differs from the current selection.
            <button id="applyOnboardingAccr" class="btn" style="margin-left:.5rem;padding:.25rem .6rem;border:1px solid #f59e0b;background:#fff3;cursor:pointer">Switch to onboarding accreditor</button>
        </div>`;
        // Insert banner under filters header when available
        function mountSwitchBanner(){ try{ const filters = document.querySelector('.filters-section'); if (filters && !document.getElementById('accrSwitchBanner')) { filters.insertAdjacentHTML('afterbegin', switchBannerHtml); const btn=document.getElementById('applyOnboardingAccr'); if(btn) btn.addEventListener('click', async ()=>{ try{ const s = await (window.MMS_ONBOARDING && window.MMS_ONBOARDING.loadSettings ? window.MMS_ONBOARDING.loadSettings() : {}); const v = (s && s.primary_accreditor) ? String(s.primary_accreditor).toUpperCase() : ''; if (v) { const sel=document.getElementById('accreditorSelect'); sel.value=v; sel.dispatchEvent(new Event('change')); } document.getElementById('accrSwitchBanner').style.display='none'; }catch(_){}}); } }catch(_){}}
        function maybeShowSwitchBanner(){ try{ const sel = String(document.getElementById('accreditorSelect').value||'').toUpperCase(); const s = JSON.parse(localStorage.getItem('mms:onboarding')||'{}')||{}; const ob = String((s.primary_accreditor||'')).toUpperCase(); const banner = document.getElementById('accrSwitchBanner'); if (!banner) return; banner.style.display = (ob && sel && ob !== sel) ? 'block' : 'none'; }catch(_){}}

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            // Load user profile for header
            loadUserProfile();
            
            // Initialize levels + reviewer mode
            try{
                const ls=document.getElementById('levelsSelect'); if(ls){ ls.value=getLevelsParam(); ls.addEventListener('change', ()=>{ setLevelsParam(ls.value); const acc=document.getElementById('accreditorSelect').value; if(acc){ loadStandards(acc, document.getElementById('institutionTypeSelect').value); } persistFiltersToUrl(); }); }
                const rv=document.getElementById('reviewerModeToggle'); if(rv){ rv.checked=isReviewerMode(); rv.addEventListener('change', ()=>{ setReviewerMode(rv.checked); const acc=document.getElementById('accreditorSelect').value; if(acc){ displayStandards(accreditors.find(a=>a.id===acc)||{name:acc,acronym:acc}, filteredStandards.length?filteredStandards:currentStandards); } }); }
            }catch(_){ }
            loadSelectedFromStorage();
            hydrateSelectionFromServer();
            try{ const btn = document.getElementById('clearSelectionBtn'); if(btn){ btn.addEventListener('click', clearSelectedStandards); if(window.MMS_UX && MMS_UX.attachTooltip) MMS_UX.attachTooltip(btn, 'Clear all selected standards'); } }catch(_){ }
            updateSelectedBadge();
            loadFiltersFromUrl();
            // Personalize using onboarding settings if available
            try{
                const s = (window.MMS_ONBOARDING && window.MMS_ONBOARDING.loadSettings) ? await window.MMS_ONBOARDING.loadSettings() : {};
                const sub = document.getElementById('standardsSubtitle');
                if (sub && (s.organization || s.institution_name)) {
                    sub.textContent = `Standards tailored for ${(s.organization||s.institution_name)}${s.primary_accreditor ? ' â€¢ ' + s.primary_accreditor : ''}`;
                }
                // Attempt to preselect accreditor if present
                if (s.primary_accreditor) {
                    // Load accreditors first, then select and load standards
                    await loadAccreditors();
                    const accSel = document.getElementById('accreditorSelect');
                    if (accSel) {
                        accSel.value = (s.primary_accreditor||'').toUpperCase();
                        try { localStorage.setItem('mms:currentAccreditor', String(accSel.value||'')); } catch(_){ }
                        const instSel = document.getElementById('institutionTypeSelect');
                        const instType = (s.institution_type || '').toLowerCase();
                        if (instSel && instType) instSel.value = instType;
                        // Trigger standards load based on selection
                        loadStandards(accSel.value, instSel ? instSel.value : '');
                        fetchCorpusMetadata(accSel.value);
                    }
                } else {
                    // Fallback: original flow
                    loadAccreditors();
                }
                mountSwitchBanner();
                maybeShowSwitchBanner();
            }catch(_){ loadAccreditors(); }
            hydrateSavedViews();
        });

        window.addEventListener('mms:onboarding-updated', (e)=>{
            try{
                const s = (e && e.detail) || {};
                const sub = document.getElementById('standardsSubtitle');
                if (sub && (s.organization || s.institution_name)) {
                    sub.textContent = `Standards tailored for ${(s.organization||s.institution_name)}${s.primary_accreditor ? ' â€¢ ' + s.primary_accreditor : ''}`;
                }
                mountSwitchBanner();
                maybeShowSwitchBanner();
            }catch(_){ }
        });

        window.addEventListener('storage', (e)=>{
            try{
                if(e.key === 'mms:selectedStandards'){
                    loadSelectedFromStorage();
                    updateSelectedBadge();
                    document.querySelectorAll('.standard-card').forEach(card=>{
                        const sid = card.getAttribute('data-standard-id');
                        if(!sid) return;
                        if(selectedStandards.has(String(sid))) card.classList.add('selected'); else card.classList.remove('selected');
                    });
                }
            }catch(_){ }
        });

        async function syncStandardReviewToServer(payload){
            try {
                const token = getAuthToken();
                const headers = { 'Content-Type': 'application/json' };
                if (isLikelyJwt(token)) headers['Authorization'] = 'Bearer ' + token;
                const res = await fetch(buildApiUrl('/api/user/intelligence-simple/reviews/standard'), {
                    method: 'POST', headers, credentials: 'include', body: JSON.stringify(payload)
                });
                if (res.status === 401) { try { const b=document.getElementById('authBanner'); if(b) b.style.display='flex'; } catch(_){} }
                // Non-blocking; ignore body for speed
            } catch(_){}
        }
        function saveLocalReview(key, updater){ const existing=JSON.parse(localStorage.getItem(key)||'{}'); const updated = updater(existing)||existing; localStorage.setItem(key, JSON.stringify(updated)); return updated; }
        function saveReviewStatus(sel){ const key=sel.getAttribute('data-review-key'); const standard_id=sel.getAttribute('data-standard-id'); const accreditor=sel.getAttribute('data-accreditor'); const updated = saveLocalReview(key, (e)=>{ e.status=sel.value; return e; }); syncStandardReviewToServer({ accreditor, standard_id, status: updated.status, note: updated.note, assignee: updated.assignee, due_date: updated.due_date }); }
        function saveReviewNote(txt){ const key=txt.getAttribute('data-review-key'); const standard_id=txt.getAttribute('data-standard-id'); const accreditor=txt.getAttribute('data-accreditor'); const updated = saveLocalReview(key, (e)=>{ e.note=txt.value; return e; }); syncStandardReviewToServer({ accreditor, standard_id, status: updated.status, note: updated.note, assignee: updated.assignee, due_date: updated.due_date }); }
        function saveReviewAssignee(inp){ const key=inp.getAttribute('data-review-key'); const standard_id=inp.getAttribute('data-standard-id'); const accreditor=inp.getAttribute('data-accreditor'); const updated = saveLocalReview(key, (e)=>{ e.assignee=inp.value; return e; }); syncStandardReviewToServer({ accreditor, standard_id, status: updated.status, note: updated.note, assignee: updated.assignee, due_date: updated.due_date }); }
        function saveReviewDueDate(inp){ const key=inp.getAttribute('data-review-key'); const standard_id=inp.getAttribute('data-standard-id'); const accreditor=inp.getAttribute('data-accreditor'); const updated = saveLocalReview(key, (e)=>{ e.due_date=inp.value; return e; }); syncStandardReviewToServer({ accreditor, standard_id, status: updated.status, note: updated.note, assignee: updated.assignee, due_date: updated.due_date }); }

        async function hydrateServerReviews(accreditor){
            try{
                if(!accreditor) return;
                const token = getAuthToken();
                const headers = {};
                if (isLikelyJwt(token)) headers['Authorization'] = 'Bearer ' + token;
                const res = await fetch(buildApiUrl(`/api/user/intelligence-simple/reviews/standards?accreditor=${encodeURIComponent((accreditor||'').toUpperCase())}`) , { credentials:'include', headers });
                if(!res.ok) return;
                const data = await res.json();
                const reviews = data && data.reviews;
                if(reviews && typeof reviews === 'object'){
                    // Merge server entries into local cache by constructing the same keys used per standard
                    Object.entries(reviews).forEach(([standard_id, entry])=>{
                        const key = `mms:review:${(accreditor||'').toUpperCase()}:${standard_id}`;
                        const existing = JSON.parse(localStorage.getItem(key)||'{}');
                        const merged = { ...existing, ...entry };
                        localStorage.setItem(key, JSON.stringify(merged));
                    });
                }
            }catch(_){ }
        }

        function exportStandardsCsv(){
            const rows = [['Accreditor','Code','Title','Level','Required','Weight']].concat((filteredStandards.length?filteredStandards:currentStandards).map(s=>[
                document.getElementById('accreditorSelect').value, s.code||s.id, s.title||'', s.category||'', String(!!s.is_required), String(s.weight||'')
            ]));
            const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
            const blob = new Blob([csv], {type:'text/csv'});
            const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='standards_export.csv'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1000);
        }
        function getCurrentView(){
            return {
                acc: document.getElementById('accreditorSelect').value||'',
                type: document.getElementById('institutionTypeSelect').value||'',
                q: document.getElementById('searchInput').value||'',
                levels: getLevelsParam()
            };
        }
        function saveCurrentView(){
            const name = prompt('Name this view:');
            if(!name) return;
            const v = getCurrentView();
            const all = JSON.parse(localStorage.getItem('mms:savedViews')||'{}');
            all[name]=v; localStorage.setItem('mms:savedViews', JSON.stringify(all)); hydrateSavedViews(); alert('View saved.');
        }
        function hydrateSavedViews(){
            const sel=document.getElementById('savedViewsSelect'); if(!sel) return;
            sel.innerHTML = '<option value="">Load viewâ€¦</option>';
            const all = JSON.parse(localStorage.getItem('mms:savedViews')||'{}');
            Object.keys(all).forEach(k=>{ const o=document.createElement('option'); o.value=k; o.textContent=k; sel.appendChild(o); });
            sel.onchange = ()=>{
                const key=sel.value; if(!key) return;
                const v=JSON.parse(localStorage.getItem('mms:savedViews')||'{}')[key]; if(!v) return;
                setLevelsParam(v.levels||'standard'); const ls=document.getElementById('levelsSelect'); if(ls) ls.value=getLevelsParam();
                document.getElementById('accreditorSelect').value=v.acc||'';
                document.getElementById('institutionTypeSelect').value=v.type||'';
                document.getElementById('searchInput').value=v.q||'';
                if(v.acc){ loadStandards(v.acc, v.type||''); }
                persistFiltersToUrl();
            };
        }

        function attachStandardsTooltips(){
            if (!window.MMS_UX || !MMS_UX.attachTooltip) return;
            const tipSelect = 'Click to select/deselect this standard';
            const tipRisk = 'AI-assisted risk score and key contributing factors';
            const tipSave = 'Save current filters and selections';
            const tipCsv = 'Export the current list to CSV';
            const tipPrint = 'Print the current view';

            document.querySelectorAll('.standard-card').forEach(el => {
                if (!el.__mms_tip) { MMS_UX.attachTooltip(el, tipSelect); el.__mms_tip = true; }
            });
            document.querySelectorAll('[data-risk-btn="1"]').forEach(el => {
                if (!el.__mms_tip) { MMS_UX.attachTooltip(el, tipRisk); el.__mms_tip = true; }
            });
            const saveBtn = document.querySelector('button[onclick="saveCurrentView()"]');
            if (saveBtn && !saveBtn.__mms_tip) { MMS_UX.attachTooltip(saveBtn, tipSave); saveBtn.__mms_tip = true; }
            const csvBtn = document.querySelector('button[onclick="exportStandardsCsv()"]');
            if (csvBtn && !csvBtn.__mms_tip) { MMS_UX.attachTooltip(csvBtn, tipCsv); csvBtn.__mms_tip = true; }
            const printBtn = document.querySelector('button[onclick="window.print()"]');
            if (printBtn && !printBtn.__mms_tip) { MMS_UX.attachTooltip(printBtn, tipPrint); printBtn.__mms_tip = true; }
            const findMapBtn = document.querySelector('button[onclick="fetchCrossAccreditorMatches()"]');
            if (findMapBtn && !findMapBtn.__mms_tip) { MMS_UX.attachTooltip(findMapBtn, 'Find similar standards across accreditors'); findMapBtn.__mms_tip = true; }
            const resetMapBtn = document.querySelector('button[onclick="clearCrossAccreditor()"]');
            if (resetMapBtn && !resetMapBtn.__mms_tip) { MMS_UX.attachTooltip(resetMapBtn, 'Clear mapping inputs and results'); resetMapBtn.__mms_tip = true; }
        }

        // Risk Factor Modal Logic
        function ensureModal(){
            if(document.getElementById('riskModalBackdrop')) return;
            const backdrop = document.createElement('div');
            backdrop.id='riskModalBackdrop';
            backdrop.className='modal-backdrop';
            backdrop.innerHTML = `
                <div class="modal" role="dialog" aria-modal="true" aria-labelledby="riskModalTitle">
                    <div class="modal-header">
                        <div class="modal-title" id="riskModalTitle">Risk Factor Breakdown</div>
                        <button class="modal-close" onclick="closeRiskModal()">âœ•</button>
                    </div>
                    <div class="modal-body" id="riskModalBody">
                        <div class="loading-inline">Select a standard to view risk factors.</div>
                        <div id="riskControls" style="margin-top:0.75rem;display:none">
                            <div class="modal-meta-grid">
                                <div class="meta-box"><div class="meta-label">Coverage (%)</div><div><input id="riskInputCoverage" type="number" min="0" max="100" step="1" value="0" style="width:100%;padding:6px;border-radius:6px;border:1px solid var(--border-light);background:var(--bg-white);color:var(--text-dark)"></div></div>
                                <div class="meta-box"><div class="meta-label">Avg Evidence Age (days)</div><div><input id="riskInputAge" type="number" min="0" step="1" value="365" style="width:100%;padding:6px;border-radius:6px;border:1px solid var(--border-light);background:var(--bg-white)"></div></div>
                                <div class="meta-box"><div class="meta-label">Overdue Tasks</div><div><input id="riskInputOverdue" type="number" min="0" step="1" value="0" style="width:100%;padding:6px;border-radius:6px;border:1px solid var(--border-light);"></div></div>
                                <div class="meta-box"><div class="meta-label">Total Tasks</div><div><input id="riskInputTotal" type="number" min="0" step="1" value="0" style="width:100%;padding:6px;border-radius:6px;border:1px solid var(--border-light);"></div></div>
                                <div class="meta-box"><div class="meta-label">Recent Changes</div><div><input id="riskInputChanges" type="number" min="0" step="1" value="0" style="width:100%;padding:6px;border-radius:6px;border:1px solid var(--border-light);"></div></div>
                                <div class="meta-box"><div class="meta-label">Findings (historical)</div><div><input id="riskInputFindings" type="number" min="0" step="1" value="0" style="width:100%;padding:6px;border-radius:6px;border:1px solid var(--border-light);"></div></div>
                                <div class="meta-box"><div class="meta-label">Days To Review</div><div><input id="riskInputDays" type="number" min="0" step="1" value="180" style="width:100%;padding:6px;border-radius:6px;border:1px solid var(--border-light);"></div></div>
                                <div class="meta-box"><div class="meta-label">Trust Scores (comma-separated)</div><div><input id="riskInputTrust" type="text" placeholder="e.g., 0.8,0.7,0.6" style="width:100%;padding:6px;border-radius:6px;border:1px solid var(--border-light);"></div></div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <div style="font-size:0.65rem;color:var(--text-medium)">Model outputs are indicative. See transparency doc for formulas.</div>
                        <div style="display:flex;gap:0.5rem;align-items:center;">
                            <button class="btn btn-primary" style="padding:0.45rem 0.9rem;font-size:0.7rem" onclick="refreshRiskModal()">Refresh</button>
                            <a href="/TRANSPARENCY_METRICS.md" target="_blank" style="text-decoration:none;font-size:0.65rem;font-weight:600;color:var(--accent-green)">Transparency Reference â†—</a>
                            <button class="btn btn-secondary" style="padding:0.45rem 0.9rem;font-size:0.7rem" onclick="closeRiskModal()">Close</button>
                        </div>
                    </div>
                </div>`;
            backdrop.addEventListener('click', (e)=>{ if(e.target===backdrop) closeRiskModal(); });
            document.body.appendChild(backdrop);
        }

        function openRiskModal(standardId){
            ensureModal();
            const backdrop = document.getElementById('riskModalBackdrop');
            const body = document.getElementById('riskModalBody');
            backdrop.style.display='flex';
            currentRiskModalStandardId = standardId;
            // Serve from cache if available for instant response
            const cached = cacheGetRiskScore(standardId);
            if(cached){
                renderRiskModal(cached);
                return;
            }
            body.innerHTML = `<div class='loading-inline'>Calculating dynamic risk for <strong>${escapeHtml(standardId)}</strong>...</div>`;
            // Show controls
            try { document.getElementById('riskControls').style.display='block'; } catch(_) {}
            
            // Use the dynamic risk API that pulls from database
            const accreditorId = document.getElementById('accreditorSelect').value;
            (function(){
                const token = getAuthToken();
                const headers = {
                    'Content-Type': 'application/json'
                };
                if (isLikelyJwt(token)) headers['Authorization'] = 'Bearer ' + token;
                
                return fetch(buildApiUrl('/api/v1/risk/score-standard-dynamic'), {
                    method: 'POST', 
                    headers, 
                    credentials: 'include',
                    body: JSON.stringify({
                        standard_id: standardId,
                        accreditor: accreditorId || 'SACSCOC'
                    })
                });
            })().then(async res => {
                if(res.status === 401){ try { const b = document.getElementById('authBanner'); if (b) b.style.display = 'flex'; } catch(_) {}
                }
                if(!res.ok){
                    const t = await res.text();
                    throw new Error(`HTTP ${res.status}: ${t}`);
                }
                return res.json();
            }).then(data => {
                if(!data.success){ throw new Error('Malformed response'); }
                const score = data.data || {};
                score._cachedUpdatedAt = new Date().toISOString();
                cacheSetRiskScore(standardId, score);
                renderRiskModal(score);
            }).catch(err => {
                body.innerHTML = `<div style='color:#dc2626;font-size:0.75rem;'>Failed to load risk factors: ${escapeHtml(err.message)}</div>`;
            });
        }

        function closeRiskModal(){
            const backdrop = document.getElementById('riskModalBackdrop');
            if(backdrop) backdrop.style.display='none';
        }

        function refreshRiskModal(){
            if(!currentRiskModalStandardId){ return; }
            const body = document.getElementById('riskModalBody');
            const standardId = currentRiskModalStandardId;
            body.innerHTML = `<div class='loading-inline'>Refreshing score for <strong>${escapeHtml(standardId)}</strong>...</div>`;
            const q2p = new URLSearchParams({ standard_id: standardId, coverage: getRiskCoverage(), avg_evidence_age_days: getRiskAge(), overdue_tasks: getRiskOverdue(), total_tasks: getRiskTotal(), recent_changes: getRiskChanges(), historical_findings: getRiskFindings(), days_to_review: getRiskDays() });
            getRiskTrust().forEach(v => q2p.append('trust_scores', v));
            (function(){
                const token = getAuthToken();
                const headers = {};
                if (isLikelyJwt(token)) headers['Authorization'] = 'Bearer ' + token;
                return fetch(buildApiUrl('/api/user/intelligence-simple/risk/score-standard?' + q2p.toString()), {
                    method:'POST', headers, credentials: 'include'
                });
            })().then(async res => {
                if(res.status === 401){ try { const b = document.getElementById('authBanner'); if (b) b.style.display = 'flex'; } catch(_) {}
                }
                if(!res.ok){
                    const t = await res.text();
                    throw new Error(`HTTP ${res.status}: ${t}`);
                }
                return res.json();
            }).then(data => {
                if(!data.success){ throw new Error('Malformed response'); }
                const score = data.data || {};
                score._cachedUpdatedAt = new Date().toISOString();
                cacheSetRiskScore(standardId, score);
                renderRiskModal(score);
            }).catch(err => {
                body.innerHTML = `<div style='color:#dc2626;font-size:0.75rem;'>Failed to refresh: ${escapeHtml(err.message)}</div>`;
            });
        }

        function riskLevelBadge(level){
            const cls = {
                critical:'risk-critical', high:'risk-high', medium:'risk-medium', low:'risk-low', minimal:'risk-minimal'
            }[level] || 'risk-low';
            return `<span class='badge-risk ${cls}'>${level.toUpperCase()}</span>`;
        }

        function renderRiskModal(score){
            const body = document.getElementById('riskModalBody');
            if(!score){ body.innerHTML = '<div style="font-size:0.75rem;">No score available.</div>'; return; }
            const issues = (score.predicted_issues||[]).map(i=>`<li>${escapeHtml(i)}</li>`).join('');
            const factors = (score.factors||[]).sort((a,b)=> b.contribution - a.contribution);
            let tableHtml = `<table class='factor-table'><thead><tr>
                <th>Factor</th><th>Raw</th><th>Norm</th><th>Weight</th><th>Contribution</th><th>Description</th>
            </tr></thead><tbody>`;
            factors.forEach(f => {
                tableHtml += `<tr>
                    <td><strong>${escapeHtml(f.factor)}</strong></td>
                    <td>${f.value}</td>
                    <td>${f.normalized}</td>
                    <td>${f.weight}</td>
                    <td>${f.contribution}</td>
                    <td style='max-width:240px;'>${escapeHtml(f.description||'')}</td>
                </tr>`;
            });
            tableHtml += '</tbody></table>';
            const lastScored = score._cachedUpdatedAt ? `<div class='meta-box'><div class='meta-label'>Last Scored</div><div class='meta-value'>${escapeHtml(score._cachedUpdatedAt)}</div></div>` : '';
            body.innerHTML = `
                <div class='modal-meta-grid'>
                    <div class='meta-box'><div class='meta-label'>Standard</div><div class='meta-value'>${escapeHtml(score.standard_id)}</div></div>
                    <div class='meta-box'><div class='meta-label'>Risk Score</div><div class='meta-value'>${(score.risk_score*100).toFixed(1)}%</div></div>
                    <div class='meta-box'><div class='meta-label'>Risk Level</div><div class='meta-value'>${riskLevelBadge(score.risk_level)}</div></div>
                    <div class='meta-box'><div class='meta-label'>Priority</div><div class='meta-value'>${score.remediation_priority}</div></div>
                    <div class='meta-box'><div class='meta-label'>Time To Review</div><div class='meta-value'>${score.time_to_review}d</div></div>
                    <div class='meta-box'><div class='meta-label'>Confidence</div><div class='meta-value'>${(score.confidence*100).toFixed(0)}%</div></div>
                    ${lastScored}
                </div>
                ${score.evidence_metadata ? `
                <div style='background: var(--bg-light); border: 1px solid var(--border-light); border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 0.75rem;'>
                    <div style='font-size:0.65rem;font-weight:600;letter-spacing:0.05em;color:var(--text-medium);margin-bottom:0.5rem;'>Evidence Summary</div>
                    <div style='display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; font-size: 0.7rem;'>
                        <div><strong>Documents Mapped:</strong> ${score.evidence_metadata.evidence_count || 0}</div>
                        <div><strong>Verified:</strong> ${score.evidence_metadata.verified_count || 0}</div>
                        <div><strong>Avg. Confidence:</strong> ${score.evidence_metadata.average_confidence || 0}%</div>
                        <div><strong>Data Source:</strong> ${score.evidence_metadata.data_source || 'Static'}</div>
                    </div>
                </div>
                ` : ''}
                <div style='margin-bottom:0.75rem;'>
                    <div class='confidence-bar'><div class='confidence-fill' style='width:${(score.confidence*100).toFixed(0)}%'></div></div>
                </div>
                <div style='margin-bottom:0.75rem;'>${tableHtml}</div>
                <div style='margin-top:0.5rem;'>
                    <div style='font-size:0.65rem;font-weight:600;letter-spacing:0.05em;color:var(--text-medium);margin-bottom:0.25rem;'>Predicted Issues</div>
                    ${issues ? `<ul class='issues-list'>${issues}</ul>` : `<div style="font-size:0.65rem;color:var(--text-light);">No specific issues predicted.</div>`}
                </div>
            `;
        }

        function qNum(id, def){ const el=document.getElementById(id); const v=el? parseFloat(el.value):NaN; return Number.isFinite(v)? String(v): String(def); }
        function getRiskCoverage(){ return qNum('riskInputCoverage', 0); }
        function getRiskAge(){ return qNum('riskInputAge', 365); }
        function getRiskOverdue(){ return qNum('riskInputOverdue', 0); }
        function getRiskTotal(){ return qNum('riskInputTotal', 0); }
        function getRiskChanges(){ return qNum('riskInputChanges', 0); }
        function getRiskFindings(){ return qNum('riskInputFindings', 0); }
        function getRiskDays(){ return qNum('riskInputDays', 180); }
        function getRiskTrust(){
            const el=document.getElementById('riskInputTrust');
            if(!el||!el.value) return [];
            return el.value.split(',').map(x=>parseFloat(x.trim())).filter(x=>Number.isFinite(x)).map(x=>String(x));
        }
        
        // Evidence Mapping Functions
        let selectedEvidence = new Set();
        let availableEvidence = [];
        
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 0.5rem;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                z-index: 4000;
                animation: slideIn 0.3s ease;
            `;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 1.2rem;">${type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸'}</span>
                    <span>${message}</span>
                </div>
            `;
            
            // Add animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            
            // Add to document
            document.body.appendChild(notification);
            
            // Remove after 5 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }
        
        async function openEvidenceMapModal(event) {
            // Prevent event bubbling if called from within a standard card
            if (event && event.stopPropagation) {
                event.stopPropagation();
            }
            
            if (selectedStandards.size === 0) {
                alert('Please select at least one standard to map evidence to.');
                return;
            }
            
            // Reset to initial state
            currentMappingStep = 1;
            updatePipelineStep(1);
            document.getElementById('step-content-select').style.display = 'block';
            document.getElementById('step-content-progress').style.display = 'none';
            document.getElementById('step-content-results').style.display = 'none';
            
            // Show selected standards in modal with chips
            const standardsList = document.getElementById('selectedStandardsList');
            standardsList.innerHTML = Array.from(selectedStandards).map(stdId => {
                const standard = currentStandards.find(s => (s.code || s.id) === stdId);
                return `<span class="mapped-standard-chip">${stdId} ${standard ? `- ${standard.title.substring(0, 30)}...` : ''}</span>`;
            }).join('');
            
            // Load available evidence
            await loadAvailableEvidence();
            
            // Show modal
            document.getElementById('evidenceMapModal').style.display = 'flex';
        }
        
        function closeEvidenceMapModal(event) {
            if (!event || event.target === event.currentTarget) {
                document.getElementById('evidenceMapModal').style.display = 'none';
                selectedEvidence.clear();
                updateSelectedEvidenceCount();
                
                // Reset pipeline state
                currentMappingStep = 1;
                mappingResults = [];
                mappingSessionId = null;
                document.getElementById('mappingLogs').innerHTML = '';
                document.getElementById('mappingProgress').style.width = '0%';
            }
        }
        
        async function loadAvailableEvidence() {
            try {
                const token = getAuthToken();
                
                // Try multiple endpoints to get all available evidence
                const endpoints = [
                    '/api/evidence-analysis/documents',
                    '/api/user/intelligence-simple/documents/list',
                    '/api/user/intelligence-simple/evidence/list'
                ];
                
                let allDocuments = [];
                let successfulEndpoint = false;
                
                for (const endpoint of endpoints) {
                    try {
                        const response = await fetch(buildApiUrl(endpoint), {
                            headers: isLikelyJwt(token) ? { 'Authorization': `Bearer ${token}` } : {},
                            credentials: 'include'
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            const docs = data.documents || data.files || data.data || [];
                            
                            // Normalize document structure
                            const normalizedDocs = docs.map(doc => ({
                                id: doc.id || doc.file_id || doc.document_id,
                                filename: doc.filename || doc.name || doc.file_name,
                                file_type: doc.file_type || doc.type || 'Document',
                                uploaded_at: doc.uploaded_at || doc.created_at || doc.timestamp,
                                status: doc.status || 'completed',
                                trust_score: doc.trust_score || doc.confidence_score,
                                standard_mappings: doc.standard_mappings || doc.mapped_standards_count
                            }));
                            
                            allDocuments = [...allDocuments, ...normalizedDocs];
                            successfulEndpoint = true;
                        }
                    } catch (error) {
                        console.log(`Failed to load from ${endpoint}:`, error);
                    }
                }
                
                if (!successfulEndpoint) {
                    throw new Error('Failed to load evidence documents from any endpoint');
                }
                
                // Remove duplicates based on filename
                const uniqueDocs = Array.from(
                    new Map(allDocuments.map(doc => [doc.filename, doc])).values()
                );
                
                availableEvidence = uniqueDocs;
                displayEvidenceGrid(availableEvidence);
                
                // If we came from dashboard with specific evidence, pre-select it
                const urlParams = new URLSearchParams(window.location.search);
                const evidenceParam = urlParams.get('evidence');
                if (evidenceParam) {
                    const matchingDoc = availableEvidence.find(doc => 
                        doc.filename === evidenceParam
                    );
                    if (matchingDoc) {
                        setTimeout(() => {
                            toggleEvidenceSelection(matchingDoc.id);
                        }, 100);
                    }
                }
            } catch (error) {
                console.error('Error loading evidence:', error);
                document.getElementById('availableEvidenceGrid').innerHTML = '<p style="color: var(--text-medium);">Failed to load evidence documents. Please try again.</p>';
            }
        }
        
        function displayEvidenceGrid(documents) {
            const grid = document.getElementById('availableEvidenceGrid');
            if (documents.length === 0) {
                grid.innerHTML = '<p style="color: var(--text-medium);">No evidence documents available. Upload documents first.</p>';
                return;
            }
            
            grid.innerHTML = documents.map(doc => `
                <div class="evidence-card ${selectedEvidence.has(doc.id) ? 'selected' : ''}" onclick="toggleEvidenceSelection('${doc.id}')">
                    <div class="evidence-title">${escapeHtml(doc.filename)}</div>
                    <div class="evidence-meta">
                        <span class="evidence-type">${doc.file_type || 'Document'}</span>
                        <span>${formatDate(doc.uploaded_at)}</span>
                    </div>
                    ${doc.trust_score ? `<div style="margin-top: 0.5rem;"><span style="color: var(--text-medium);">Trust Score:</span> <span class="trust-score">${Math.round(doc.trust_score * 100)}%</span></div>` : ''}
                    ${doc.status === 'completed' && doc.standard_mappings ? `<div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-medium);">${doc.standard_mappings} standards mapped</div>` : ''}
                </div>
            `).join('');
        }
        
        function toggleEvidenceSelection(docId) {
            if (selectedEvidence.has(docId)) {
                selectedEvidence.delete(docId);
            } else {
                selectedEvidence.add(docId);
            }
            
            // Update UI
            const card = document.querySelector(`[onclick="toggleEvidenceSelection('${docId}')"]`);
            if (card) {
                card.classList.toggle('selected');
            }
            updateSelectedEvidenceCount();
        }
        
        function updateSelectedEvidenceCount() {
            document.getElementById('selectedEvidenceCount').textContent = `${selectedEvidence.size} documents selected`;
        }
        
        function filterEvidence() {
            const searchTerm = document.getElementById('evidenceSearchInput').value.toLowerCase();
            const filtered = availableEvidence.filter(doc => 
                doc.filename.toLowerCase().includes(searchTerm) ||
                (doc.content && doc.content.toLowerCase().includes(searchTerm))
            );
            displayEvidenceGrid(filtered);
        }
        
        // Enhanced Evidence Mapping Pipeline Functions
        let currentMappingStep = 1;
        let mappingResults = [];
        let mappingSessionId = null;
        
        function updatePipelineStep(step) {
            document.querySelectorAll('.pipeline-step').forEach(s => {
                s.classList.remove('active', 'completed');
            });
            
            for (let i = 1; i < step; i++) {
                document.getElementById(`step-${getPipelineStepName(i)}`).classList.add('completed');
            }
            document.getElementById(`step-${getPipelineStepName(step)}`).classList.add('active');
            
            currentMappingStep = step;
        }
        
        function getPipelineStepName(stepNum) {
            const steps = ['select', 'analyze', 'extract', 'map', 'review'];
            return steps[stepNum - 1];
        }
        
        function startMappingPipeline() {
            if (selectedEvidence.size === 0) {
                showNotification('Please select at least one evidence document to map.', 'error');
                return;
            }
            
            // Generate session ID for this mapping
            mappingSessionId = `map_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            
            // Hide selection view, show progress view
            document.getElementById('step-content-select').style.display = 'none';
            document.getElementById('step-content-progress').style.display = 'block';
            
            // Start the mapping process
            performMappingProcess();
        }
        
        async function performMappingProcess() {
            const logs = document.getElementById('mappingLogs');
            const progress = document.getElementById('mappingProgress');
            
            try {
                // Step 2: Analyze Documents
                updatePipelineStep(2);
                updateMappingStatus('ðŸ“„', 'Analyzing Documents...', 'Reading and processing document content');
                addMappingLog('Starting document analysis...');
                
                await simulateProgress(0, 25, 2000);
                
                const token = getAuthToken();
                const selectedDocs = Array.from(selectedEvidence);
                
                for (let i = 0; i < selectedDocs.length; i++) {
                    const doc = availableEvidence.find(d => d.id === selectedDocs[i]);
                    const docName = doc?.filename || 'Document';
                    addMappingLog(`Analyzing: ${docName}`);
                    
                    // Simulate detailed analysis steps
                    updateMappingStatus('ðŸ“„', `Analyzing: ${docName}`, 'Extracting text content...');
                    await simulateProgress(25 + (i * 10 / selectedDocs.length), 30 + (i * 10 / selectedDocs.length), 300);
                    
                    updateMappingStatus('ðŸ”', `Analyzing: ${docName}`, 'Identifying key sections...');
                    await simulateProgress(30 + (i * 10 / selectedDocs.length), 35 + (i * 10 / selectedDocs.length), 300);
                    
                    addMappingLog(`âœ“ Completed analysis of ${docName}`);
                }
                
                // Step 3: Extract Excerpts
                updatePipelineStep(3);
                updateMappingStatus('ðŸ“', 'Extracting Relevant Excerpts...', 'Identifying key passages and evidence');
                addMappingLog('Extracting relevant text passages...');
                
                await simulateProgress(35, 60, 3000);
                
                // Simulate excerpt extraction
                const excerptCount = Math.floor(Math.random() * 10) + 5;
                addMappingLog(`Found ${excerptCount} relevant excerpts`);
                
                // Step 4: Map to Standards
                updatePipelineStep(4);
                updateMappingStatus('ðŸ”—', 'Mapping to Standards...', 'Calculating relevance and confidence scores');
                addMappingLog('Mapping excerpts to selected standards...');
                
                await simulateProgress(60, 90, 4000);
                
                // Make actual API call to create mappings
                const mappingPromises = [];
                for (const standardId of selectedStandards) {
                    for (const documentId of selectedEvidence) {
                        addMappingLog(`Mapping document to standard ${standardId}...`);
                        
                        mappingPromises.push(
                            fetch(buildApiUrl('/api/v1/evidence/mappings/db'), {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    ...(isLikelyJwt(token) ? { 'Authorization': `Bearer ${token}` } : {})
                                },
                                credentials: 'include',
                                body: JSON.stringify({
                                    document_id: documentId,
                                    standard_id: standardId,
                                    relevance_score: 75 + Math.random() * 25, // 75-100% confidence
                                    evidence_summary: 'AI-extracted evidence mapping',
                                    mapping_confidence: 'high',
                                    mapping_method: 'ai_pipeline',
                                    evidence_strength: 'Strong',
                                    session_id: mappingSessionId
                                })
                            })
                        );
                    }
                }
                
                await Promise.all(mappingPromises);
                
                // Generate mock results for demonstration
                mappingResults = generateMockMappingResults();
                
                await simulateProgress(90, 100, 1000);
                
                // Step 5: Show Results
                updatePipelineStep(5);
                displayMappingResults();
                
            } catch (error) {
                console.error('Mapping error:', error);
                updateMappingStatus('âŒ', 'Mapping Failed', error.message);
                addMappingLog(`Error: ${error.message}`, 'error');
            }
        }
        
        function updateMappingStatus(icon, message, detail) {
            document.getElementById('statusIcon').textContent = icon;
            document.getElementById('statusMessage').textContent = message;
            document.getElementById('statusDetail').textContent = detail;
        }
        
        function addMappingLog(message, type = 'info') {
            const logs = document.getElementById('mappingLogs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.style.marginBottom = '0.25rem';
            logEntry.innerHTML = `<span style="color: ${type === 'error' ? '#ef4444' : '#6b7280'}">[${timestamp}]</span> ${message}`;
            logs.appendChild(logEntry);
            logs.scrollTop = logs.scrollHeight;
        }
        
        async function simulateProgress(start, end, duration) {
            const progress = document.getElementById('mappingProgress');
            const steps = 20;
            const stepDuration = duration / steps;
            const stepSize = (end - start) / steps;
            
            for (let i = 0; i <= steps; i++) {
                progress.style.width = `${start + (stepSize * i)}%`;
                await new Promise(resolve => setTimeout(resolve, stepDuration));
            }
        }
        
        function generateMockMappingResults() {
            const results = [];
            const excerptTemplates = [
                {
                    text: "The institution maintains comprehensive documentation of all academic programs, including detailed syllabi, learning outcomes, and assessment methods that align with accreditation standards.",
                    keywords: ["documentation", "academic programs", "syllabi", "learning outcomes", "assessment methods"],
                    context: "Academic Program Documentation - Section 3.2"
                },
                {
                    text: "Our quality assurance framework includes regular reviews of educational effectiveness, with data-driven improvements implemented based on student learning outcomes assessment.",
                    keywords: ["quality assurance", "educational effectiveness", "data-driven", "student learning outcomes"],
                    context: "Quality Assurance Policy - Chapter 5"
                },
                {
                    text: "Faculty credentials are verified and maintained in accordance with accreditation requirements, with 95% holding terminal degrees in their respective fields.",
                    keywords: ["faculty credentials", "terminal degrees", "accreditation requirements"],
                    context: "Faculty Handbook - Credentialing Section"
                },
                {
                    text: "The institution's financial management practices demonstrate fiscal responsibility and sustainability, with clean audit reports for the past five years.",
                    keywords: ["financial management", "fiscal responsibility", "audit reports", "sustainability"],
                    context: "Financial Policies - Annual Report 2024"
                },
                {
                    text: "Student support services are comprehensive and accessible, including academic advising, career counseling, and mental health resources available to all enrolled students.",
                    keywords: ["student support", "academic advising", "career counseling", "mental health"],
                    context: "Student Services Guide - Overview"
                }
            ];
            
            selectedEvidence.forEach(docId => {
                const doc = availableEvidence.find(d => d.id === docId);
                if (!doc) return;
                
                selectedStandards.forEach(stdId => {
                    const standard = currentStandards.find(s => (s.code || s.id) === stdId);
                    const confidence = 75 + Math.random() * 25;
                    const excerptCount = Math.floor(Math.random() * 3) + 1;
                    const selectedExcerpts = [];
                    
                    for (let i = 0; i < excerptCount; i++) {
                        const template = excerptTemplates[Math.floor(Math.random() * excerptTemplates.length)];
                        selectedExcerpts.push({
                            text: template.text,
                            page: Math.floor(Math.random() * 20) + 1,
                            relevance: 70 + Math.random() * 30,
                            keywords: template.keywords,
                            context: template.context,
                            highlighted: highlightRelevantText(template.text, template.keywords)
                        });
                    }
                    
                    results.push({
                        documentId: docId,
                        documentName: doc.filename,
                        documentType: doc.file_type || 'PDF',
                        standardId: stdId,
                        standardTitle: standard?.title || stdId,
                        confidence: confidence,
                        excerpts: selectedExcerpts,
                        mappingStrength: confidence >= 90 ? 'Strong' : confidence >= 75 ? 'Moderate' : 'Weak'
                    });
                });
            });
            
            return results;
        }
        
        function highlightRelevantText(text, keywords) {
            let highlightedText = text;
            keywords.forEach(keyword => {
                const regex = new RegExp(`(${keyword})`, 'gi');
                highlightedText = highlightedText.replace(regex, '<span class="excerpt-highlight">$1</span>');
            });
            return highlightedText;
        }
        
        function displayMappingResults() {
            // Hide progress view, show results view
            document.getElementById('step-content-progress').style.display = 'none';
            document.getElementById('step-content-results').style.display = 'block';
            
            // Update summary
            const totalMappings = mappingResults.length;
            const avgConfidence = mappingResults.reduce((sum, r) => sum + r.confidence, 0) / totalMappings;
            const totalExcerpts = mappingResults.reduce((sum, r) => sum + r.excerpts.length, 0);
            
            document.getElementById('resultsSummary').textContent = 
                `Found ${totalExcerpts} relevant excerpts across ${selectedEvidence.size} documents, ` +
                `mapped to ${selectedStandards.size} standards with ${Math.round(avgConfidence)}% average confidence.`;
            
            // Display results
            renderMappingResults(mappingResults);
        }
        
        function renderMappingResults(results) {
            const container = document.getElementById('evidenceResultsContainer');
            
            // Group results by document for better organization
            const groupedResults = {};
            results.forEach(result => {
                if (!groupedResults[result.documentId]) {
                    groupedResults[result.documentId] = {
                        documentName: result.documentName,
                        documentType: result.documentType,
                        mappings: []
                    };
                }
                groupedResults[result.documentId].mappings.push(result);
            });
            
            container.innerHTML = Object.entries(groupedResults).map(([docId, docGroup]) => {
                return `
                    <div style="margin-bottom: 2rem;">
                        <h5 style="margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--border-light);">
                            ðŸ“„ ${escapeHtml(docGroup.documentName)} 
                            <span style="font-weight: normal; color: var(--text-medium); font-size: 0.875rem;">(${docGroup.documentType})</span>
                        </h5>
                        ${docGroup.mappings.map(result => {
                            const confidenceClass = result.confidence >= 90 ? 'confidence-high' :
                                                  result.confidence >= 75 ? 'confidence-medium' : 'confidence-low';
                            
                            return `
                                <div class="evidence-result-card">
                                    <div class="result-header">
                                        <div style="flex: 1;">
                                            <div class="result-title">
                                                Standard ${result.standardId}
                                                ${result.standardTitle ? `: ${escapeHtml(result.standardTitle.substring(0, 60))}...` : ''}
                                            </div>
                                            <div style="display: flex; gap: 1rem; align-items: center; margin-top: 0.5rem;">
                                                <span style="color: var(--text-medium); font-size: 0.875rem;">
                                                    Mapping Strength: <strong>${result.mappingStrength}</strong>
                                                </span>
                                                <span style="color: var(--text-medium); font-size: 0.875rem;">
                                                    ${result.excerpts.length} excerpt${result.excerpts.length !== 1 ? 's' : ''} found
                                                </span>
                                            </div>
                                        </div>
                                        <div class="confidence-badge ${confidenceClass}">
                                            ${Math.round(result.confidence)}% Match
                                        </div>
                                    </div>
                                    
                                    ${result.excerpts.map((excerpt, idx) => `
                                        <div class="evidence-excerpt" data-excerpt-id="${docId}-${result.standardId}-${idx}">
                                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                                <div style="font-size: 0.75rem; color: var(--text-medium); font-weight: 600;">
                                                    ðŸ“ ${excerpt.context}
                                                </div>
                                                <div style="font-size: 0.75rem; color: var(--text-medium);">
                                                    Page ${excerpt.page}
                                                </div>
                                            </div>
                                            <div class="excerpt-text">
                                                "${excerpt.highlighted}"
                                            </div>
                                            <div class="excerpt-source">
                                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                                    <div>
                                                        <span style="color: var(--accent-green); font-weight: 600;">
                                                            ${Math.round(excerpt.relevance)}% relevant
                                                        </span>
                                                        ${excerpt.keywords.length > 0 ? `
                                                            <span style="margin-left: 1rem; font-size: 0.7rem;">
                                                                Key terms: ${excerpt.keywords.slice(0, 3).join(', ')}
                                                            </span>
                                                        ` : ''}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="excerpt-actions">
                                                <button class="excerpt-action-btn approve" onclick="approveExcerpt('${result.documentId}', '${result.standardId}', ${idx})">
                                                    âœ“ Approve
                                                </button>
                                                <button class="excerpt-action-btn edit" onclick="editExcerpt('${result.documentId}', '${result.standardId}', ${idx})">
                                                    âœŽ Edit
                                                </button>
                                                <button class="excerpt-action-btn reject" onclick="rejectExcerpt('${result.documentId}', '${result.standardId}', ${idx})">
                                                    âœ— Reject
                                                </button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }).join('');
        }
        
        function approveExcerpt(docId, stdId, excerptIdx) {
            const excerptEl = document.querySelector(`[data-excerpt-id="${docId}-${stdId}-${excerptIdx}"]`);
            const approveBtn = event.target;
            
            // Update mapping result
            const result = mappingResults.find(r => r.documentId === docId && r.standardId === stdId);
            if (result && result.excerpts[excerptIdx]) {
                result.excerpts[excerptIdx].status = 'approved';
                result.excerpts[excerptIdx].approvedAt = new Date().toISOString();
                result.excerpts[excerptIdx].approvedBy = 'current_user';
            }
            
            // Update UI
            excerptEl.style.borderLeft = '4px solid var(--accent-green)';
            approveBtn.style.background = 'var(--accent-green)';
            approveBtn.style.color = 'white';
            approveBtn.disabled = true;
            approveBtn.textContent = 'âœ“ Approved';
            
            // Disable reject button
            const rejectBtn = excerptEl.querySelector('.excerpt-action-btn.reject');
            if (rejectBtn) {
                rejectBtn.disabled = true;
                rejectBtn.style.opacity = '0.5';
            }
            
            showNotification('Excerpt approved and will be included in final mapping', 'success');
            updateResultsSummary();
        }
        
        function editExcerpt(docId, stdId, excerptIdx) {
            const excerptEl = document.querySelector(`[data-excerpt-id="${docId}-${stdId}-${excerptIdx}"]`);
            const excerptTextEl = excerptEl.querySelector('.excerpt-text');
            const result = mappingResults.find(r => r.documentId === docId && r.standardId === stdId);
            const excerpt = result?.excerpts[excerptIdx];
            
            if (!excerpt) return;
            
            // Create edit interface
            const originalText = excerpt.text;
            const editInterface = document.createElement('div');
            editInterface.innerHTML = `
                <div style="margin: 1rem 0;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-dark);">
                        Edit Evidence Excerpt:
                    </label>
                    <textarea id="excerpt-edit-${docId}-${stdId}-${excerptIdx}" 
                        style="width: 100%; min-height: 100px; padding: 0.5rem; border: 1px solid var(--border-medium); border-radius: 0.375rem; font-family: inherit; font-size: 0.875rem; line-height: 1.6;"
                    >${originalText}</textarea>
                    <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary" onclick="saveExcerptEdit('${docId}', '${stdId}', ${excerptIdx})">
                            Save Changes
                        </button>
                        <button class="btn btn-secondary" onclick="cancelExcerptEdit('${docId}', '${stdId}', ${excerptIdx})">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            excerptTextEl.replaceWith(editInterface);
            
            // Focus textarea and select text
            const textarea = document.getElementById(`excerpt-edit-${docId}-${stdId}-${excerptIdx}`);
            textarea.focus();
            textarea.select();
        }
        
        function saveExcerptEdit(docId, stdId, excerptIdx) {
            const textarea = document.getElementById(`excerpt-edit-${docId}-${stdId}-${excerptIdx}`);
            const newText = textarea.value.trim();
            
            if (!newText) {
                showNotification('Excerpt text cannot be empty', 'error');
                return;
            }
            
            // Update the mapping result
            const result = mappingResults.find(r => r.documentId === docId && r.standardId === stdId);
            if (result && result.excerpts[excerptIdx]) {
                result.excerpts[excerptIdx].text = newText;
                result.excerpts[excerptIdx].edited = true;
                result.excerpts[excerptIdx].editedAt = new Date().toISOString();
                
                // Re-highlight keywords
                result.excerpts[excerptIdx].highlighted = highlightRelevantText(newText, result.excerpts[excerptIdx].keywords);
            }
            
            // Re-render results
            renderMappingResults(mappingResults);
            showNotification('Excerpt updated successfully', 'success');
        }
        
        function cancelExcerptEdit(docId, stdId, excerptIdx) {
            // Re-render results to restore original view
            renderMappingResults(mappingResults);
        }
        
        function rejectExcerpt(docId, stdId, excerptIdx) {
            if (confirm('Are you sure you want to reject this excerpt? It will not be included in the final mapping.')) {
                const excerptEl = document.querySelector(`[data-excerpt-id="${docId}-${stdId}-${excerptIdx}"]`);
                const rejectBtn = event.target;
                
                // Update mapping result
                const result = mappingResults.find(r => r.documentId === docId && r.standardId === stdId);
                if (result && result.excerpts[excerptIdx]) {
                    result.excerpts[excerptIdx].status = 'rejected';
                    result.excerpts[excerptIdx].rejectedAt = new Date().toISOString();
                    result.excerpts[excerptIdx].rejectedBy = 'current_user';
                }
                
                // Update UI
                excerptEl.style.opacity = '0.4';
                excerptEl.style.borderLeft = '4px solid #ef4444';
                rejectBtn.style.background = '#ef4444';
                rejectBtn.style.color = 'white';
                rejectBtn.disabled = true;
                rejectBtn.textContent = 'âœ— Rejected';
                
                // Disable other buttons
                const otherBtns = excerptEl.querySelectorAll('.excerpt-action-btn:not(.reject)');
                otherBtns.forEach(btn => {
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                });
                
                showNotification('Excerpt rejected and will be excluded from mapping', 'info');
                updateResultsSummary();
            }
        }
        
        function updateResultsSummary() {
            let totalApproved = 0;
            let totalRejected = 0;
            let totalExcerpts = 0;
            
            mappingResults.forEach(result => {
                result.excerpts.forEach(excerpt => {
                    totalExcerpts++;
                    if (excerpt.status === 'approved') totalApproved++;
                    if (excerpt.status === 'rejected') totalRejected++;
                });
            });
            
            const summaryEl = document.getElementById('resultsSummary');
            if (summaryEl) {
                const totalMappings = mappingResults.length;
                const avgConfidence = mappingResults.reduce((sum, r) => sum + r.confidence, 0) / totalMappings;
                
                summaryEl.innerHTML = `
                    Found ${totalExcerpts} relevant excerpts across ${selectedEvidence.size} documents, 
                    mapped to ${selectedStandards.size} standards with ${Math.round(avgConfidence)}% average confidence.
                    <br>
                    <span style="color: var(--accent-green);">${totalApproved} approved</span>, 
                    <span style="color: #ef4444;">${totalRejected} rejected</span>, 
                    <span style="color: var(--text-medium);">${totalExcerpts - totalApproved - totalRejected} pending review</span>
                `;
            }
        }
        
        function filterResults() {
            const searchTerm = document.getElementById('resultsSearchInput').value.toLowerCase();
            const cards = document.querySelectorAll('.evidence-result-card');
            
            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        }
        
        function downloadMappingReport() {
            // Generate a detailed report
            const report = {
                session_id: mappingSessionId,
                timestamp: new Date().toISOString(),
                summary: {
                    documents: selectedEvidence.size,
                    standards: selectedStandards.size,
                    total_mappings: mappingResults.length,
                    total_excerpts: mappingResults.reduce((sum, r) => sum + r.excerpts.length, 0)
                },
                mappings: mappingResults
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `evidence-mapping-report-${mappingSessionId}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('Report downloaded successfully', 'success');
        }
        
        function restartMapping() {
            // Reset to step 1
            currentMappingStep = 1;
            updatePipelineStep(1);
            document.getElementById('step-content-results').style.display = 'none';
            document.getElementById('step-content-select').style.display = 'block';
            document.getElementById('mappingLogs').innerHTML = '';
            document.getElementById('mappingProgress').style.width = '0%';
            mappingResults = [];
        }
        
        async function saveMappingResults() {
            try {
                const token = getAuthToken();
                const savingPromises = [];
                let savedCount = 0;
                
                // Only save approved excerpts
                for (const result of mappingResults) {
                    const approvedExcerpts = result.excerpts.filter(e => e.status !== 'rejected');
                    
                    if (approvedExcerpts.length > 0) {
                        savingPromises.push(
                            fetch(buildApiUrl('/api/v1/evidence/mappings/excerpts'), {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    ...(isLikelyJwt(token) ? { 'Authorization': `Bearer ${token}` } : {})
                                },
                                credentials: 'include',
                                body: JSON.stringify({
                                    document_id: result.documentId,
                                    standard_id: result.standardId,
                                    confidence: result.confidence,
                                    mapping_strength: result.mappingStrength,
                                    excerpts: approvedExcerpts.map(e => ({
                                        text: e.text,
                                        page: e.page,
                                        relevance: e.relevance,
                                        context: e.context,
                                        keywords: e.keywords,
                                        edited: e.edited || false,
                                        approved: e.status === 'approved'
                                    })),
                                    session_id: mappingSessionId
                                })
                            })
                        );
                        savedCount++;
                    }
                }
                
                if (savingPromises.length === 0) {
                    showNotification('No approved excerpts to save. Please approve at least one excerpt.', 'error');
                    return;
                }
                
                await Promise.all(savingPromises);
                
                // Update UI to show mappings in standards view
                selectedStandards.forEach(stdId => {
                    loadMappedEvidence(stdId);
                    
                    // Update standard cards to show evidence was mapped
                    const card = document.querySelector(`[data-standard-id="${stdId}"]`);
                    if (card) {
                        const banner = card.querySelector('.evidence-mapping-banner');
                        if (banner) {
                            banner.innerHTML = `
                                <div class="evidence-mapping-status">
                                    <span class="evidence-status-icon">âœ…</span>
                                    <span>Evidence successfully mapped with excerpts!</span>
                                </div>
                            `;
                            setTimeout(() => {
                                banner.style.display = 'none';
                            }, 5000);
                        }
                    }
                });
                
                closeEvidenceMapModal();
                showNotification(`Successfully saved ${savedCount} evidence mappings with approved excerpts`, 'success');
                
                // Clear risk cache for affected standards
                selectedStandards.forEach(stdId => {
                    cacheClearRiskScore(stdId);
                });
                
            } catch (error) {
                console.error('Error saving mapping results:', error);
                showNotification('Failed to save mapping results. Please try again.', 'error');
            }
        }
        
        async function confirmEvidenceMapping() {
            if (selectedEvidence.size === 0) {
                alert('Please select at least one evidence document to map.');
                return;
            }
            
            // Show real-time mapping status in standards
            selectedStandards.forEach(stdId => {
                const banner = document.querySelector(`#mappedEvidence_${stdId}`).previousElementSibling;
                if (banner && banner.classList.contains('evidence-mapping-banner')) {
                    banner.innerHTML = `
                        <div class="evidence-mapping-status">
                            <span class="evidence-status-icon">â³</span>
                            <span>Mapping evidence in progress...</span>
                        </div>
                    `;
                }
            });
            
            try {
                const token = getAuthToken();
                const mappingPromises = [];
                
                // Create mappings for each standard-document combination
                for (const standardId of selectedStandards) {
                    for (const documentId of selectedEvidence) {
                        mappingPromises.push(
                            fetch(buildApiUrl('/api/v1/evidence/mappings/db'), {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    ...(isLikelyJwt(token) ? { 'Authorization': `Bearer ${token}` } : {})
                                },
                                credentials: 'include',
                                body: JSON.stringify({
                                    document_id: documentId,
                                    standard_id: standardId,
                                    relevance_score: 85,
                                    evidence_summary: 'Manually mapped by user',
                                    mapping_confidence: 'high',
                                    mapping_method: 'manual',
                                    evidence_strength: 'Strong'
                                })
                            })
                        );
                    }
                }
                
                await Promise.all(mappingPromises);
                
                // Update real-time status to success
                selectedStandards.forEach(stdId => {
                    const banner = document.querySelector(`#mappedEvidence_${stdId}`).previousElementSibling;
                    if (banner && banner.classList.contains('evidence-mapping-banner')) {
                        banner.innerHTML = `
                            <div class="evidence-mapping-status">
                                <span class="evidence-status-icon">âœ…</span>
                                <span>Evidence successfully mapped!</span>
                            </div>
                        `;
                        // Remove the banner after a delay
                        setTimeout(() => {
                            banner.style.display = 'none';
                        }, 3000);
                    }
                });
                
                // Close modal and refresh the standards display
                closeEvidenceMapModal();
                
                // Show success notification
                showNotification(`Successfully mapped ${selectedEvidence.size} document(s) to ${selectedStandards.size} standard(s)`, 'success');
                
                // Clear risk cache for affected standards to force refresh
                for (const standardId of selectedStandards) {
                    cacheClearRiskScore(standardId);
                    // Reload evidence mappings for this standard
                    loadMappedEvidence(standardId);
                }
                
                // Update the display to show mapped evidence
                applyFilters();
            } catch (error) {
                console.error('Error creating mappings:', error);
                
                // Update status to show error
                selectedStandards.forEach(stdId => {
                    const banner = document.querySelector(`#mappedEvidence_${stdId}`).previousElementSibling;
                    if (banner && banner.classList.contains('evidence-mapping-banner')) {
                        banner.innerHTML = `
                            <div class="evidence-mapping-status">
                                <span class="evidence-status-icon">âŒ</span>
                                <span>Mapping failed. Please try again.</span>
                            </div>
                            <button class="map-evidence-button" onclick="openEvidenceMapModal(event)">
                                Retry Mapping
                            </button>
                        `;
                    }
                });
                
                showNotification('Failed to create evidence mappings. Please try again.', 'error');
            }
        }
        
        async function markStandardsCompliant() {
            if (selectedStandards.size === 0) {
                alert('Please select at least one standard to mark as compliant.');
                return;
            }
            
            if (!confirm(`Are you sure you want to mark ${selectedStandards.size} standard(s) as compliant?`)) {
                return;
            }
            
            try {
                const token = getAuthToken();
                const accreditorId = document.getElementById('accreditorSelect').value;
                const accreditor = accreditors.find(acc => acc.id === accreditorId);
                
                // Update compliance status via API
                const response = await fetch(buildApiUrl('/api/v1/standards/compliance/update'), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(isLikelyJwt(token) ? { 'Authorization': `Bearer ${token}` } : {})
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        standard_ids: Array.from(selectedStandards),
                        status: 'compliant',
                        accreditor: accreditor.acronym || accreditor.name || accreditorId
                    })
                });
                
                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error);
                }
                
                const result = await response.json();
                
                // Also update local status for immediate UI feedback
                for (const standardId of selectedStandards) {
                    const reviewKey = `mms:review:${accreditor.acronym || accreditor.name}:${standardId}`;
                    const existing = JSON.parse(localStorage.getItem(reviewKey) || '{}');
                    existing.status = 'Ready';
                    existing.updated_at = new Date().toISOString();
                    localStorage.setItem(reviewKey, JSON.stringify(existing));
                }
                
                // Refresh display
                applyFilters();
                
                alert(`Successfully marked ${result.data.updated_count} standard(s) as compliant.`);
            } catch (error) {
                console.error('Error marking standards compliant:', error);
                alert('Failed to update standard status. Please try again.');
            }
        }
        
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }
        
        function showMappedEvidenceDetails(standardId, event) {
            event.stopPropagation();
            const detailsDiv = document.getElementById(`evidenceDetails_${standardId}`);
            const arrow = event.currentTarget.querySelector('span:last-child');
            
            if (detailsDiv) {
                if (detailsDiv.style.display === 'none') {
                    detailsDiv.style.display = 'block';
                    arrow.textContent = 'â–¼';
                } else {
                    detailsDiv.style.display = 'none';
                    arrow.textContent = 'â–¶';
                }
            }
        }
        
        async function loadMappedEvidence(standardId) {
            try {
                const token = getAuthToken();
                const response = await fetch(buildApiUrl(`/api/v1/evidence/mappings/by-standard/${encodeURIComponent(standardId)}`), {
                    headers: isLikelyJwt(token) ? { 'Authorization': `Bearer ${token}` } : {},
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    return;
                }
                
                const data = await response.json();
                const container = document.getElementById(`mappedEvidence_${standardId}`);
                
                if (container && data.data && data.data.documents && data.data.documents.length > 0) {
                    const docs = data.data.documents;
                    const avgRelevance = data.data.average_relevance || 0;
                    
                    // Count verified documents
                    const verifiedCount = docs.filter(d => d.is_verified).length;
                    const verifiedText = verifiedCount > 0 ? `, ${verifiedCount} verified` : '';
                    
                    container.innerHTML = `
                        <div class="mapped-evidence" onclick="showMappedEvidenceDetails('${standardId}', event)" style="cursor: pointer;">
                            <span class="mapped-evidence-icon">ðŸ“Ž</span>
                            <span>${docs.length} evidence document(s) mapped${verifiedText}</span>
                            <span class="trust-score">(Avg. ${Math.round(avgRelevance)}% relevance)</span>
                            <span style="margin-left: auto; opacity: 0.7;">â–¶</span>
                        </div>
                        <div id="evidenceDetails_${standardId}" class="evidence-details" style="display: none; margin-top: 0.5rem;">
                            ${docs.map(doc => `
                                <div class="evidence-detail-item">
                                    <span class="evidence-doc-icon">ðŸ“„</span>
                                    <span class="evidence-doc-name">${escapeHtml(doc.name)}</span>
                                    <span class="evidence-doc-score">${Math.round(doc.relevance_score)}%</span>
                                    ${doc.is_verified ? '<span class="evidence-verified">âœ“ Verified</span>' : ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            } catch (error) {
                console.error(`Error loading mapped evidence for ${standardId}:`, error);
            }
        }

        // Graph Visualization Functions
        let graphData = null;
        let currentVisualizationType = 'network';

        function showGraphView() {
            document.getElementById('contentArea').style.display = 'none';
            document.getElementById('graphSection').style.display = 'block';
            loadGraphData();
        }

        function showStandardsView() {
            document.getElementById('graphSection').style.display = 'none';
            document.getElementById('contentArea').style.display = 'block';
            window.location.hash = '';
        }

        async function loadGraphData() {
            const graphLoading = document.getElementById('graphLoading');
            graphLoading.style.display = 'flex';
            
            try {
                const accreditor = document.getElementById('accreditorSelect').value;
                const response = await fetch(`/api/intelligence/standards/graph?accreditor=${accreditor}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                });

                if (response.ok) {
                    graphData = await response.json();
                    updateGraphStats();
                    updateVisualization();
                } else {
                    console.error('Failed to load graph data:', response.statusText);
                    alert('Failed to load graph data. Please try again.');
                }
            } catch (error) {
                console.error('Error loading graph data:', error);
                alert('Error loading graph data. Please try again.');
            } finally {
                graphLoading.style.display = 'none';
            }
        }

        function updateGraphStats() {
            if (!graphData) return;
            
            const statsDiv = document.getElementById('graphStats');
            statsDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <div>
                        <strong>Accreditor:</strong> ${graphData.accreditor}
                    </div>
                    <div>
                        <strong>Total Standards:</strong> ${graphData.total_standards}
                    </div>
                    <div>
                        <strong>Relationships:</strong> ${graphData.relationships ? graphData.relationships.length : 0}
                    </div>
                    <div>
                        <strong>Available Accreditors:</strong> ${graphData.available_accreditors ? graphData.available_accreditors.join(', ') : 'N/A'}
                    </div>
                </div>
            `;
        }

        function updateVisualization() {
            const vizType = document.getElementById('vizType').value;
            currentVisualizationType = vizType;
            
            document.getElementById('graphCanvas').style.display = 'none';
            document.getElementById('d3Graph').style.display = 'none';
            
            if (vizType === 'network') {
                renderNetworkGraph();
            } else if (vizType === 'tree' || vizType === 'radial') {
                renderTreeGraph(vizType);
            }
        }

        function renderNetworkGraph() {
            if (!graphData || !graphData.standards) return;
            
            const canvas = document.getElementById('graphCanvas');
            const ctx = canvas.getContext('2d');
            const container = document.getElementById('graphContainer');
            
            canvas.width = container.clientWidth;
            canvas.height = 600;
            canvas.style.display = 'block';
            
            // Simple network visualization using Canvas
            const nodes = Object.entries(graphData.standards).map(([id, data], index) => ({
                id,
                x: Math.random() * (canvas.width - 100) + 50,
                y: Math.random() * (canvas.height - 100) + 50,
                label: data.title,
                category: data.category
            }));
            
            const nodeMap = new Map(nodes.map(n => [n.id, n]));
            
            // Animation loop
            let animationId;
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Draw relationships
                ctx.strokeStyle = '#e5e7eb';
                ctx.lineWidth = 1;
                if (graphData.relationships) {
                    graphData.relationships.forEach(rel => {
                        const source = nodeMap.get(rel.source);
                        const target = nodeMap.get(rel.target);
                        if (source && target) {
                            ctx.beginPath();
                            ctx.moveTo(source.x, source.y);
                            ctx.lineTo(target.x, target.y);
                            ctx.stroke();
                        }
                    });
                }
                
                // Draw nodes
                nodes.forEach(node => {
                    ctx.fillStyle = node.category === 'Standard' ? '#3b82f6' : '#10b981';
                    ctx.beginPath();
                    ctx.arc(node.x, node.y, 20, 0, 2 * Math.PI);
                    ctx.fill();
                    
                    // Draw label
                    ctx.fillStyle = '#1f2937';
                    ctx.font = '12px Inter';
                    ctx.textAlign = 'center';
                    ctx.fillText(node.label.substring(0, 30) + (node.label.length > 30 ? '...' : ''), node.x, node.y + 35);
                });
                
                animationId = requestAnimationFrame(animate);
            }
            
            animate();
            
            // Clean up on visualization change
            canvas._cleanup = () => {
                if (animationId) cancelAnimationFrame(animationId);
            };
        }

        function renderTreeGraph(type) {
            if (!graphData || !graphData.standards) return;
            
            // Load D3.js if not already loaded
            if (!window.d3) {
                const script = document.createElement('script');
                script.src = 'https://d3js.org/d3.v7.min.js';
                script.onload = () => renderTreeGraphWithD3(type);
                document.head.appendChild(script);
            } else {
                renderTreeGraphWithD3(type);
            }
        }

        function renderTreeGraphWithD3(type) {
            const d3Container = document.getElementById('d3Graph');
            d3Container.style.display = 'block';
            d3Container.innerHTML = '';
            
            const width = d3Container.clientWidth;
            const height = 600;
            
            const svg = d3.select('#d3Graph')
                .append('svg')
                .attr('width', width)
                .attr('height', height);
            
            // Create hierarchical data
            const hierarchyData = {
                name: graphData.accreditor,
                children: Object.entries(graphData.standards).slice(0, 10).map(([id, data]) => ({
                    name: data.title,
                    id: id,
                    category: data.category,
                    children: graphData.relationships
                        .filter(r => r.source === id)
                        .map(r => ({
                            name: graphData.standards[r.target]?.title || r.target,
                            id: r.target
                        }))
                        .slice(0, 3)
                }))
            };
            
            const root = d3.hierarchy(hierarchyData);
            
            if (type === 'tree') {
                const treeLayout = d3.tree().size([width - 100, height - 100]);
                treeLayout(root);
                
                const g = svg.append('g')
                    .attr('transform', 'translate(50,50)');
                
                // Draw links
                g.selectAll('.link')
                    .data(root.links())
                    .enter().append('path')
                    .attr('class', 'link')
                    .attr('fill', 'none')
                    .attr('stroke', '#e5e7eb')
                    .attr('stroke-width', 2)
                    .attr('d', d3.linkHorizontal()
                        .x(d => d.y)
                        .y(d => d.x));
                
                // Draw nodes
                const node = g.selectAll('.node')
                    .data(root.descendants())
                    .enter().append('g')
                    .attr('class', 'node')
                    .attr('transform', d => `translate(${d.y},${d.x})`);
                
                node.append('circle')
                    .attr('r', 6)
                    .attr('fill', d => d.depth === 0 ? '#1e40af' : (d.data.category === 'Standard' ? '#3b82f6' : '#10b981'));
                
                node.append('text')
                    .attr('dy', '.35em')
                    .attr('x', d => d.children ? -10 : 10)
                    .style('text-anchor', d => d.children ? 'end' : 'start')
                    .style('font-size', '12px')
                    .style('fill', '#1f2937')
                    .text(d => d.data.name.substring(0, 30) + (d.data.name.length > 30 ? '...' : ''));
            } else if (type === 'radial') {
                const radius = Math.min(width, height) / 2 - 50;
                const tree = d3.tree()
                    .size([2 * Math.PI, radius])
                    .separation((a, b) => (a.parent == b.parent ? 1 : 2) / a.depth);
                
                tree(root);
                
                const g = svg.append('g')
                    .attr('transform', `translate(${width/2},${height/2})`);
                
                // Draw links
                g.selectAll('.link')
                    .data(root.links())
                    .enter().append('path')
                    .attr('class', 'link')
                    .attr('fill', 'none')
                    .attr('stroke', '#e5e7eb')
                    .attr('stroke-width', 1)
                    .attr('d', d3.linkRadial()
                        .angle(d => d.x)
                        .radius(d => d.y));
                
                // Draw nodes
                const node = g.selectAll('.node')
                    .data(root.descendants())
                    .enter().append('g')
                    .attr('class', 'node')
                    .attr('transform', d => `rotate(${d.x * 180 / Math.PI - 90}) translate(${d.y},0)`);
                
                node.append('circle')
                    .attr('r', 4)
                    .attr('fill', d => d.depth === 0 ? '#1e40af' : '#3b82f6');
                
                node.append('text')
                    .attr('transform', d => d.x < Math.PI ? 'rotate(0)' : 'rotate(180)')
                    .attr('text-anchor', d => d.x < Math.PI ? 'start' : 'end')
                    .attr('dy', '.35em')
                    .attr('x', d => d.x < Math.PI ? 6 : -6)
                    .style('font-size', '10px')
                    .style('fill', '#1f2937')
                    .text(d => d.data.name.substring(0, 20) + (d.data.name.length > 20 ? '...' : ''));
            }
        }

        // Handle hash navigation
        function handleHashChange() {
            const urlParams = new URLSearchParams(window.location.search);
            if (window.location.hash === '#graph' || urlParams.get('showGraph') === 'true') {
                showGraphView();
            } else {
                showStandardsView();
            }
        }

        // Add hash change listener
        window.addEventListener('hashchange', handleHashChange);
        
        // Check hash or query parameter on page load
        const initialUrlParams = new URLSearchParams(window.location.search);
        if (window.location.hash === '#graph' || initialUrlParams.get('showGraph') === 'true') {
            setTimeout(() => {
                showGraphView();
            }, 500);
        }
        
        // Check for evidence mapping parameters
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('action') === 'map' && urlParams.get('evidence')) {
            const evidenceFile = urlParams.get('evidence');
            showMappingNotification(`Ready to map evidence: ${evidenceFile}`, 'info');
            
            // Auto-select some standards and show mapping modal
            setTimeout(() => {
                // Find and check first few standards
                const checkboxes = document.querySelectorAll('.standard-checkbox');
                let checked = 0;
                checkboxes.forEach((cb, idx) => {
                    if (idx < 3 && !cb.checked) {
                        cb.checked = true;
                        checked++;
                    }
                });
                
                if (checked > 0) {
                    updateBulkActionsBar();
                    // Show a hint to the user
                    showMappingNotification('Select standards and click "Map Evidence" to link your document', 'info');
                }
            }, 1000);
        }
        
        // Real-time mapping status notification
        function showMappingNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                display: flex;
                align-items: center;
                gap: 12px;
                z-index: 1000;
                animation: slideIn 0.3s ease;
                max-width: 400px;
            `;
            
            const icons = {
                info: 'ðŸ’¡',
                success: 'âœ…',
                error: 'âŒ',
                processing: 'â³'
            };
            
            const colors = {
                info: '#3b82f6',
                success: '#10b981',
                error: '#ef4444',
                processing: '#f59e0b'
            };
            
            notification.innerHTML = `
                <span style="font-size: 20px;">${icons[type] || icons.info}</span>
                <div style="flex: 1;">
                    <div style="font-weight: 600; color: #111827;">Evidence Mapping</div>
                    <div style="font-size: 14px; color: #6b7280; margin-top: 2px;">
                        ${message}
                    </div>
                </div>
                <button onclick="this.parentElement.remove()" style="
                    background: none;
                    border: none;
                    font-size: 20px;
                    cursor: pointer;
                    color: #6b7280;
                    padding: 0;
                    margin: 0;
                ">&times;</button>
            `;
            
            // Add progress bar for processing type
            if (type === 'processing') {
                const progressBar = document.createElement('div');
                progressBar.style.cssText = `
                    position: absolute;
                    bottom: 0;
                    left: 0;
                    right: 0;
                    height: 3px;
                    background: ${colors[type]};
                    animation: progressAnimation 2s ease-in-out infinite;
                `;
                notification.appendChild(progressBar);
                
                // Add animation
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes progressAnimation {
                        0% { transform: translateX(-100%); }
                        100% { transform: translateX(100%); }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(notification);
            
            // Auto-remove after delay (except for processing)
            if (type !== 'processing') {
                setTimeout(() => notification.remove(), type === 'error' ? 8000 : 5000);
            }
            
            return notification;
        }
        
        // Listen for file upload updates from dashboard
        window.addEventListener('fileUploadUpdate', (event) => {
            const { fileName, status } = event.detail;
            if (status === 'complete') {
                showMappingNotification(`${fileName} is ready for mapping`, 'success');
            }
        });
        
        // Report Generation Functions
        let selectedReportType = null;
        let currentReportData = null;
        
        function openReportGenerationModal() {
            const modal = document.getElementById('reportGenerationModal');
            if (!modal) {
                console.error('Report generation modal not found');
                return;
            }
            
            // Reset to step 1
            showReportStep(1);
            selectedReportType = null;
            document.querySelectorAll('.report-type-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector('.report-options').style.display = 'none';
            document.getElementById('generateReportBtn').disabled = true;
            
            // Pre-populate institution name if available
            const institutionName = localStorage.getItem('institution_name') || '';
            document.getElementById('institutionName').value = institutionName;
            
            modal.style.display = 'block';
        }
        
        function closeReportGenerationModal() {
            const modal = document.getElementById('reportGenerationModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        function showReportStep(stepNumber) {
            // Hide all steps
            document.querySelectorAll('.report-step').forEach(step => {
                step.style.display = 'none';
            });
            
            // Show requested step
            const stepElement = document.getElementById(`reportStep${stepNumber}`);
            if (stepElement) {
                stepElement.style.display = 'block';
            }
        }
        
        function selectReportType(type) {
            selectedReportType = type;
            
            // Update UI
            document.querySelectorAll('.report-type-card').forEach(card => {
                if (card.dataset.type === type) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });
            
            // Show options
            document.querySelector('.report-options').style.display = 'block';
            document.getElementById('generateReportBtn').disabled = false;
            
            // Set default title based on type
            const titles = {
                'compliance': 'Accreditation Compliance Report',
                'gap': 'Gap Analysis Report',
                'narrative': 'Accreditation Narrative Draft'
            };
            document.getElementById('reportTitle').value = titles[type] || '';
        }
        
        async function generateReport() {
            if (!selectedReportType) {
                alert('Please select a report type');
                return;
            }
            
            const selectedStandards = getSelectedStandards();
            if (selectedStandards.length === 0) {
                alert('Please select at least one standard');
                return;
            }
            
            // Move to progress step
            showReportStep(2);
            
            // Simulate report generation progress
            const steps = [
                { id: 'reportDetailGathering', text: 'Gathering evidence mappings...', progress: 25 },
                { id: 'reportDetailAnalyzing', text: 'Analyzing compliance status...', progress: 50 },
                { id: 'reportDetailGenerating', text: 'Generating report content...', progress: 75 },
                { id: 'reportDetailFormatting', text: 'Formatting citations...', progress: 100 }
            ];
            
            for (const step of steps) {
                updateReportProgress(step.progress, step.text);
                updateProgressStep(step.id, 'processing');
                
                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                updateProgressStep(step.id, 'complete');
            }
            
            // Generate report content based on type
            let reportContent = '';
            if (selectedReportType === 'compliance') {
                reportContent = generateComplianceReport(selectedStandards);
            } else if (selectedReportType === 'gap') {
                reportContent = generateGapAnalysis(selectedStandards);
            } else if (selectedReportType === 'narrative') {
                reportContent = generateNarrativeDraft(selectedStandards);
            }
            
            // Display report in editor
            document.getElementById('reportContent').innerHTML = reportContent;
            
            // Move to edit step
            setTimeout(() => {
                showReportStep(3);
            }, 500);
        }
        
        function updateReportProgress(percentage, text) {
            const progressFill = document.getElementById('reportProgressFill');
            const progressText = document.getElementById('reportProgressText');
            
            if (progressFill) progressFill.style.width = `${percentage}%`;
            if (progressText) progressText.textContent = text;
        }
        
        function updateProgressStep(stepId, status) {
            const step = document.getElementById(stepId);
            if (!step) return;
            
            const icon = step.querySelector('.detail-icon');
            if (icon) {
                if (status === 'processing') {
                    icon.textContent = 'â³';
                    icon.style.color = '#3b82f6';
                } else if (status === 'complete') {
                    icon.textContent = 'âœ…';
                    icon.style.color = '#10b981';
                }
            }
        }
        
        function generateComplianceReport(standards) {
            const title = document.getElementById('reportTitle').value || 'Compliance Report';
            const institution = document.getElementById('institutionName').value || 'Our Institution';
            const includeCitations = document.getElementById('includeCitations').checked;
            
            let html = `
                <div class="narrative-section">
                    <h1 class="narrative-section-title">${title}</h1>
                    <p class="narrative-paragraph">
                        ${institution} has conducted a comprehensive review of its programs and practices
                        in alignment with the selected accreditation standards. This report demonstrates
                        our commitment to excellence and continuous improvement in education.
                        ${includeCitations ? '<span class="citation" onclick="showCitationPopup(this)" data-source="Strategic Plan 2024" data-page="p. 3-5">[1]</span>' : ''}
                    </p>
                </div>
            `;
            
            // Add sections for each standard
            standards.forEach((standard, index) => {
                html += `
                    <div class="narrative-section">
                        <h2 class="narrative-section-title">Standard ${standard.code}</h2>
                        <p class="narrative-paragraph">
                            <strong>${standard.description}</strong>
                        </p>
                        <p class="narrative-paragraph">
                            ${institution} meets this standard through our comprehensive approach to
                            ${getStandardTopic(standard.description)}. Our evidence demonstrates
                            systematic implementation and continuous monitoring of outcomes.
                            ${includeCitations ? `<span class="citation" onclick="showCitationPopup(this)" data-source="Policy Manual" data-page="p. ${10 + index * 5}-${15 + index * 5}">[${index + 2}]</span>` : ''}
                        </p>
                        <p class="narrative-paragraph">
                            Key evidence supporting our compliance includes documented policies,
                            procedures, and assessment data that clearly demonstrate our effectiveness
                            in this area. Regular reviews ensure ongoing alignment with best practices.
                            ${includeCitations ? `<span class="citation" onclick="showCitationPopup(this)" data-source="Annual Assessment Report" data-page="p. ${20 + index * 3}">[${index + 10}]</span>` : ''}
                        </p>
                    </div>
                `;
            });
            
            // Add conclusion
            html += `
                <div class="narrative-section">
                    <h2 class="narrative-section-title">Conclusion</h2>
                    <p class="narrative-paragraph">
                        This report demonstrates ${institution}'s strong compliance with all selected
                        accreditation standards. Our documented evidence, systematic processes, and
                        commitment to continuous improvement position us well for successful accreditation.
                        ${includeCitations ? '<span class="citation" onclick="showCitationPopup(this)" data-source="Institutional Self-Study" data-page="p. 145-150">[20]</span>' : ''}
                    </p>
                </div>
            `;
            
            return html;
        }
        
        function generateGapAnalysis(standards) {
            const title = document.getElementById('reportTitle').value || 'Gap Analysis Report';
            const institution = document.getElementById('institutionName').value || 'Our Institution';
            
            let html = `
                <div class="gap-analysis-container">
                    <h1 class="narrative-section-title">${title}</h1>
                    
                    <div class="gap-summary">
                        <div class="gap-summary-title">Executive Summary</div>
                        <div class="gap-summary-text">
                            This gap analysis identifies areas where ${institution} may need additional
                            evidence or improvement to fully meet accreditation standards. The analysis
                            is based on currently mapped evidence and institutional practices.
                        </div>
                    </div>
            `;
            
            // Simulate some gaps for demonstration
            const gapStandards = standards.slice(0, Math.ceil(standards.length / 3));
            
            gapStandards.forEach((standard, index) => {
                html += `
                    <div class="gap-item">
                        <div class="gap-standard">Standard ${standard.code}</div>
                        <div class="gap-description">
                            Partial evidence exists for: ${standard.description}
                        </div>
                        <div class="gap-recommendations">
                            <div class="gap-recommendation-title">Recommended Actions:</div>
                            <ul class="gap-recommendation-list">
                                <li class="gap-recommendation-item">
                                    Develop comprehensive documentation for ${getStandardTopic(standard.description)}
                                </li>
                                <li class="gap-recommendation-item">
                                    Implement systematic data collection processes
                                </li>
                                <li class="gap-recommendation-item">
                                    Create assessment rubrics and evaluation criteria
                                </li>
                                <li class="gap-recommendation-item">
                                    Establish regular review cycles with stakeholder input
                                </li>
                            </ul>
                        </div>
                    </div>
                `;
            });
            
            html += `
                    <div class="narrative-section" style="margin-top: 2rem;">
                        <h2 class="narrative-section-title">Next Steps</h2>
                        <p class="narrative-paragraph">
                            To address identified gaps, ${institution} should prioritize evidence collection
                            and process documentation. A timeline for completion should be established with
                            clear milestones and responsible parties assigned to each action item.
                        </p>
                    </div>
                </div>
            `;
            
            return html;
        }
        
        function generateNarrativeDraft(standards) {
            const title = document.getElementById('reportTitle').value || 'Accreditation Narrative';
            const institution = document.getElementById('institutionName').value || 'Our Institution';
            const includeCitations = document.getElementById('includeCitations').checked;
            
            let html = `
                <div class="narrative-section">
                    <h1 class="narrative-section-title">${title}</h1>
                    
                    <h2 class="narrative-section-title">Introduction</h2>
                    <p class="narrative-paragraph">
                        ${institution} presents this narrative as evidence of our commitment to meeting
                        and exceeding accreditation standards. Through systematic planning, implementation,
                        and assessment, we demonstrate our dedication to educational excellence and
                        continuous improvement.
                        ${includeCitations ? '<span class="citation" onclick="showCitationPopup(this)" data-source="Mission Statement" data-page="p. 1">[1]</span>' : ''}
                    </p>
                    
                    <h2 class="narrative-section-title">Institutional Overview</h2>
                    <p class="narrative-paragraph">
                        Founded with a mission to provide transformative education, ${institution} has
                        evolved to meet the changing needs of our students and community. Our strategic
                        initiatives align with accreditation standards to ensure quality outcomes.
                        ${includeCitations ? '<span class="citation" onclick="showCitationPopup(this)" data-source="Strategic Plan" data-page="p. 5-8">[2]</span>' : ''}
                    </p>
                </div>
            `;
            
            // Create narrative sections for standards
            standards.forEach((standard, index) => {
                html += `
                    <div class="narrative-section">
                        <h2 class="narrative-section-title">${standard.code}: ${getStandardTitle(standard.description)}</h2>
                        <p class="narrative-paragraph">
                            In addressing ${standard.description.toLowerCase()}, ${institution} has developed
                            comprehensive approaches that integrate best practices with innovative solutions.
                            Our commitment to this standard is evident in multiple areas of operation.
                            ${includeCitations ? `<span class="citation" onclick="showCitationPopup(this)" data-source="Department Report ${index + 1}" data-page="p. ${12 + index * 4}">[${index + 3}]</span>` : ''}
                        </p>
                        <p class="narrative-paragraph">
                            Evidence of our effectiveness includes ${getEvidenceExamples(standard.description)}.
                            These materials demonstrate not only compliance but also our innovative approaches
                            to exceeding standard expectations.
                            ${includeCitations ? `<span class="citation" onclick="showCitationPopup(this)" data-source="Assessment Data ${new Date().getFullYear()}" data-page="p. ${25 + index * 3}">[${index + 10}]</span>` : ''}
                        </p>
                        <p class="narrative-paragraph">
                            Looking forward, we continue to strengthen our practices through regular assessment,
                            stakeholder feedback, and alignment with emerging best practices in higher education.
                            Our quality improvement processes ensure sustained excellence.
                            ${includeCitations ? `<span class="citation" onclick="showCitationPopup(this)" data-source="Improvement Plan" data-page="p. ${40 + index * 2}">[${index + 15}]</span>` : ''}
                        </p>
                    </div>
                `;
            });
            
            html += `
                <div class="narrative-section">
                    <h2 class="narrative-section-title">Conclusion and Future Directions</h2>
                    <p class="narrative-paragraph">
                        ${institution} remains committed to continuous improvement and excellence in all
                        areas addressed by accreditation standards. Our evidence-based approach, combined
                        with strategic planning and stakeholder engagement, positions us for continued
                        success and positive impact on student outcomes.
                        ${includeCitations ? '<span class="citation" onclick="showCitationPopup(this)" data-source="Future Vision Document" data-page="p. 78-82">[25]</span>' : ''}
                    </p>
                </div>
            `;
            
            return html;
        }
        
        // Helper functions for content generation
        function getStandardTopic(description) {
            const topics = {
                'student': 'student success and achievement',
                'faculty': 'faculty development and excellence',
                'curriculum': 'curriculum design and delivery',
                'assessment': 'assessment and continuous improvement',
                'resource': 'resource allocation and management',
                'governance': 'institutional governance and leadership'
            };
            
            const lowercaseDesc = description.toLowerCase();
            for (const [key, value] of Object.entries(topics)) {
                if (lowercaseDesc.includes(key)) {
                    return value;
                }
            }
            return 'institutional effectiveness';
        }
        
        function getStandardTitle(description) {
            // Extract a concise title from the description
            const words = description.split(' ').slice(0, 5);
            return words.join(' ') + (description.split(' ').length > 5 ? '...' : '');
        }
        
        function getEvidenceExamples(description) {
            const examples = [
                'comprehensive policy documents, detailed procedures, and measurable outcomes',
                'systematic assessment data, stakeholder surveys, and improvement plans',
                'curriculum maps, learning outcomes, and student achievement data',
                'resource allocation reports, budget analyses, and efficiency metrics',
                'governance structures, meeting minutes, and decision-making processes'
            ];
            
            // Return a random example for variety
            return examples[Math.floor(Math.random() * examples.length)];
        }
        
        // Citation management
        function showCitationPopup(citationElement) {
            // Close any open popups
            document.querySelectorAll('.citation-popup').forEach(popup => {
                popup.classList.remove('show');
            });
            
            // Create or get popup
            let popup = citationElement.querySelector('.citation-popup');
            if (!popup) {
                popup = document.createElement('div');
                popup.className = 'citation-popup';
                
                const source = citationElement.dataset.source || 'Unknown Source';
                const page = citationElement.dataset.page || '';
                
                popup.innerHTML = `
                    <div class="citation-details">
                        <div class="citation-source">${source}</div>
                        <div class="citation-excerpt">
                            "This excerpt demonstrates our institution's commitment to excellence
                            and continuous improvement in this area..."
                        </div>
                        <div class="citation-page">${page}</div>
                        <div class="citation-actions">
                            <button class="citation-action-btn" onclick="viewFullSource(event)">View Full Source</button>
                            <button class="citation-action-btn" onclick="editCitation(event)">Edit Citation</button>
                        </div>
                    </div>
                `;
                
                citationElement.appendChild(popup);
            }
            
            // Toggle popup
            popup.classList.toggle('show');
            
            // Close on click outside
            setTimeout(() => {
                document.addEventListener('click', function closePopup(e) {
                    if (!citationElement.contains(e.target)) {
                        popup.classList.remove('show');
                        document.removeEventListener('click', closePopup);
                    }
                });
            }, 100);
        }
        
        function viewFullSource(event) {
            event.stopPropagation();
            alert('View full source functionality would open the source document');
        }
        
        function editCitation(event) {
            event.stopPropagation();
            alert('Edit citation functionality would allow editing citation details');
        }
        
        // Editor functions
        function toggleBold() {
            document.execCommand('bold', false, null);
        }
        
        function toggleItalic() {
            document.execCommand('italic', false, null);
        }
        
        function toggleUnderline() {
            document.execCommand('underline', false, null);
        }
        
        function insertHeading() {
            const selection = window.getSelection();
            const text = selection.toString() || 'New Heading';
            document.execCommand('insertHTML', false, `<h3>${text}</h3>`);
        }
        
        function insertBulletList() {
            document.execCommand('insertUnorderedList', false, null);
        }
        
        function showCitations() {
            const citations = document.querySelectorAll('#reportContent .citation');
            alert(`This document contains ${citations.length} citations. Click any citation to view details.`);
        }
        
        function refreshAI() {
            if (confirm('Regenerate this section with AI? Current edits will be lost.')) {
                generateReport();
            }
        }
        
        // Navigation functions
        function backToReportType() {
            showReportStep(1);
        }
        
        function backToEdit() {
            showReportStep(3);
        }
        
        function saveReportDraft() {
            const content = document.getElementById('reportContent').innerHTML;
            const reportData = {
                type: selectedReportType,
                title: document.getElementById('reportTitle').value,
                institution: document.getElementById('institutionName').value,
                content: content,
                savedAt: new Date().toISOString()
            };
            
            // Save to localStorage (in real app, would save to server)
            localStorage.setItem('reportDraft', JSON.stringify(reportData));
            
            showNotification('Draft saved successfully!', 'success');
        }
        
        function exportReport() {
            // Show export preview
            const content = document.getElementById('reportContent').innerHTML;
            const preview = document.getElementById('exportPreview');
            const title = document.getElementById('reportTitle').value || 'Report';
            const institution = document.getElementById('institutionName').value || 'Institution';
            
            preview.innerHTML = `
                <div class="export-preview-header">
                    <div class="export-preview-title">${title}</div>
                    <div class="export-preview-subtitle">${institution}</div>
                    <div class="export-preview-subtitle">${new Date().toLocaleDateString()}</div>
                </div>
                <div class="export-preview-content">
                    ${content}
                </div>
            `;
            
            showReportStep(4);
        }
        
        async function performExport() {
            const format = document.getElementById('exportFormat').value;
            const exportBtn = event.target;
            const originalText = exportBtn.textContent;
            
            exportBtn.textContent = 'Exporting...';
            exportBtn.disabled = true;
            
            try {
                // Simulate export process
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // In real implementation, would generate and download file
                const filename = `report_${new Date().getTime()}.${format}`;
                
                showNotification(`Report exported successfully as ${filename}`, 'success');
                
                // Close modal after export
                setTimeout(() => {
                    closeReportGenerationModal();
                }, 1000);
                
            } catch (error) {
                showNotification('Export failed. Please try again.', 'error');
                console.error('Export error:', error);
            } finally {
                exportBtn.textContent = originalText;
                exportBtn.disabled = false;
            }
        }
        
        // Gap Analysis Functions
        function analyzeGaps() {
            const selectedStandards = getSelectedStandards();
            
            if (selectedStandards.length === 0) {
                showNotification('Please select standards to analyze for gaps', 'warning');
                return;
            }
            
            // Check if evidence is mapped
            const hasMappedEvidence = checkMappedEvidence();
            
            if (!hasMappedEvidence) {
                showNotification('Please map evidence to standards before analyzing gaps. Use the "Map Evidence" button first.', 'info');
                return;
            }
            
            // Open gap analysis modal or perform analysis
            openGapAnalysisModal();
        }
        
        function openGapAnalysisModal() {
            // For now, generate a gap analysis report
            selectedReportType = 'gap';
            openReportGenerationModal();
            selectReportType('gap');
            
            // Auto-start the generation
            setTimeout(() => {
                generateReport();
            }, 500);
        }
        
        function checkMappedEvidence() {
            // Check if any selected standards have mapped evidence
            const selectedStandards = getSelectedStandards();
            
            for (const standard of selectedStandards) {
                const evidenceContainer = document.getElementById(`mappedEvidence_${standard.id}`);
                if (evidenceContainer && evidenceContainer.querySelector('.mapped-evidence')) {
                    return true;
                }
            }
            
            return false;
        }
        
        // Enhanced button state management
        function updateButtonStates() {
            const selectedCount = document.querySelectorAll('.standard-checkbox:checked').length;
            const hasMappedEvidence = checkMappedEvidence();
            
            // View Graph - always enabled when standards are selected
            const viewGraphBtn = document.getElementById('viewGraphBtn');
            if (viewGraphBtn) {
                viewGraphBtn.disabled = selectedCount === 0;
                updateButtonTooltip(viewGraphBtn, selectedCount === 0 ? 'Select standards to view their relationship graph' : null);
            }
            
            // Analyze Gaps - requires selected standards and mapped evidence
            const analyzeGapsBtn = document.getElementById('analyzeGapsBtn');
            if (analyzeGapsBtn) {
                const needsEvidence = selectedCount > 0 && !hasMappedEvidence;
                analyzeGapsBtn.disabled = selectedCount === 0 || !hasMappedEvidence;
                
                let tooltip = null;
                if (selectedCount === 0) {
                    tooltip = 'Select standards to analyze for compliance gaps';
                } else if (!hasMappedEvidence) {
                    tooltip = 'Map evidence to standards first to analyze gaps';
                }
                updateButtonTooltip(analyzeGapsBtn, tooltip);
            }
            
            // Generate Report - requires selected standards and preferably mapped evidence
            const generateReportBtn = document.getElementById('generateReportBtn');
            if (generateReportBtn) {
                generateReportBtn.disabled = selectedCount === 0;
                
                let tooltip = null;
                if (selectedCount === 0) {
                    tooltip = 'Select standards to generate a compliance report';
                } else if (!hasMappedEvidence) {
                    tooltip = 'Report will be more comprehensive with mapped evidence';
                }
                updateButtonTooltip(generateReportBtn, tooltip);
            }
        }
        
        function updateButtonTooltip(button, tooltipText) {
            if (!button) return;
            
            // Remove existing tooltip
            const existingTooltip = button.querySelector('.btn-tooltip');
            if (existingTooltip) {
                existingTooltip.remove();
            }
            button.classList.remove('btn-with-tooltip');
            
            // Add new tooltip if needed
            if (tooltipText) {
                button.classList.add('btn-with-tooltip');
                const tooltip = document.createElement('span');
                tooltip.className = 'btn-tooltip';
                tooltip.textContent = tooltipText;
                button.appendChild(tooltip);
            }
        }
        
        // Update the existing updateSelectedCount function
        const originalUpdateSelectedCount = updateSelectedCount;
        updateSelectedCount = function() {
            originalUpdateSelectedCount();
            updateButtonStates();
        };
        
        // Also update button states when evidence is mapped
        window.addEventListener('evidenceMapped', () => {
            updateButtonStates();
        });
        
        // Initialize button states on page load
        document.addEventListener('DOMContentLoaded', () => {
            updateButtonStates();
            updateFindMappingsButton();
            initializeWorkflowProgress();
            checkFirstTimeUser();
        });
        
        // Update Find Mappings button state
        function updateFindMappingsButton() {
            const findMappingsBtn = document.getElementById('findMappingsBtn');
            if (!findMappingsBtn) return;
            
            const sourceAccSelect = document.getElementById('sourceAccSelect');
            const targetAccSelect = document.getElementById('targetAccSelect');
            
            if (!sourceAccSelect || !targetAccSelect) return;
            
            const source = sourceAccSelect.value.trim();
            const target = targetAccSelect.value.trim();
            
            let tooltip = null;
            let disabled = false;
            
            if (!source || !target) {
                tooltip = 'Select both source and target accreditors to find mappings';
                disabled = true;
            } else if (source === target) {
                tooltip = 'Select different accreditors for comparison';
                disabled = true;
            }
            
            findMappingsBtn.disabled = disabled;
            updateButtonTooltip(findMappingsBtn, tooltip);
        }
        
        // Add event listeners for accreditor selection changes
        document.addEventListener('DOMContentLoaded', () => {
            const sourceAccSelect = document.getElementById('sourceAccSelect');
            const targetAccSelect = document.getElementById('targetAccSelect');
            
            if (sourceAccSelect) {
                sourceAccSelect.addEventListener('change', updateFindMappingsButton);
            }
            
            if (targetAccSelect) {
                targetAccSelect.addEventListener('change', updateFindMappingsButton);
            }
        });
        
        // Tutorial System Functions
        let currentTutorialStep = 0;
        const tutorialSteps = [
            {
                element: '.workflow-progress',
                title: 'Welcome to Standards Browser',
                content: 'This progress tracker shows where you are in the accreditation preparation workflow. You can click any step to learn more about it.',
                position: 'bottom'
            },
            {
                element: '#accreditorSelect',
                title: 'Select Your Accreditor',
                content: 'First, choose your accrediting body from this dropdown. This will load the relevant standards for your institution.',
                position: 'bottom'
            },
            {
                element: '#searchInput',
                title: 'Search Standards',
                content: 'Use the search box to quickly find standards by keyword, code, or description. Try searching for "student outcomes" or "assessment".',
                position: 'bottom'
            },
            {
                element: '.standard-checkbox',
                title: 'Select Standards',
                content: 'Check the boxes next to standards you want to work with. Selected standards can be mapped to evidence, analyzed for gaps, or included in reports.',
                position: 'right'
            },
            {
                element: '#mapEvidenceBtn',
                title: 'Map Evidence',
                content: 'After selecting standards, click "Map Evidence" to link your uploaded documents to specific standards. This is crucial for demonstrating compliance.',
                position: 'top'
            },
            {
                element: '#analyzeGapsBtn',
                title: 'Analyze Gaps',
                content: 'Use "Analyze Gaps" to identify standards that lack sufficient evidence. This helps prioritize your evidence collection efforts.',
                position: 'top'
            },
            {
                element: '#generateReportBtn',
                title: 'Generate Reports',
                content: 'Finally, generate compliance reports, gap analyses, or narrative drafts with citations. These reports are essential for accreditation submissions.',
                position: 'top'
            }
        ];
        
        function startTutorial() {
            currentTutorialStep = 0;
            document.getElementById('tutorialOverlay').style.display = 'block';
            showTutorialStep();
        }
        
        function showTutorialStep() {
            const step = tutorialSteps[currentTutorialStep];
            if (!step) {
                endTutorial();
                return;
            }
            
            const element = document.querySelector(step.element);
            if (!element) {
                // Skip to next step if element not found
                nextTutorialStep();
                return;
            }
            
            // Update tutorial content
            document.getElementById('tutorialTitle').textContent = step.title;
            document.getElementById('tutorialContent').textContent = step.content;
            document.getElementById('tutorialStep').textContent = `Step ${currentTutorialStep + 1} of ${tutorialSteps.length}`;
            
            // Update button text for last step
            const nextBtn = document.getElementById('tutorialNextBtn');
            nextBtn.textContent = currentTutorialStep === tutorialSteps.length - 1 ? 'Finish' : 'Next';
            
            // Position spotlight and popup
            positionTutorialElements(element, step.position);
        }
        
        function positionTutorialElements(element, position) {
            const rect = element.getBoundingClientRect();
            const spotlight = document.getElementById('tutorialSpotlight');
            const popup = document.getElementById('tutorialPopup');
            const arrow = popup.querySelector('.tutorial-arrow');
            
            // Position spotlight
            spotlight.style.left = rect.left - 10 + 'px';
            spotlight.style.top = rect.top - 10 + 'px';
            spotlight.style.width = rect.width + 20 + 'px';
            spotlight.style.height = rect.height + 20 + 'px';
            
            // Remove all arrow classes
            arrow.classList.remove('top', 'bottom', 'left', 'right');
            
            // Position popup based on position preference
            const popupWidth = 400;
            const popupHeight = popup.offsetHeight || 200;
            const margin = 20;
            
            let popupLeft, popupTop;
            
            switch(position) {
                case 'top':
                    popupLeft = rect.left + (rect.width - popupWidth) / 2;
                    popupTop = rect.top - popupHeight - margin;
                    arrow.classList.add('bottom');
                    break;
                case 'bottom':
                    popupLeft = rect.left + (rect.width - popupWidth) / 2;
                    popupTop = rect.bottom + margin;
                    arrow.classList.add('top');
                    break;
                case 'left':
                    popupLeft = rect.left - popupWidth - margin;
                    popupTop = rect.top + (rect.height - popupHeight) / 2;
                    arrow.classList.add('right');
                    break;
                case 'right':
                    popupLeft = rect.right + margin;
                    popupTop = rect.top + (rect.height - popupHeight) / 2;
                    arrow.classList.add('left');
                    break;
            }
            
            // Ensure popup stays within viewport
            popupLeft = Math.max(10, Math.min(popupLeft, window.innerWidth - popupWidth - 10));
            popupTop = Math.max(10, Math.min(popupTop, window.innerHeight - popupHeight - 10));
            
            popup.style.left = popupLeft + 'px';
            popup.style.top = popupTop + 'px';
        }
        
        function nextTutorialStep() {
            currentTutorialStep++;
            showTutorialStep();
        }
        
        function skipTutorial() {
            if (confirm('Are you sure you want to skip the tutorial? You can restart it anytime from the help menu.')) {
                endTutorial();
            }
        }
        
        function endTutorial() {
            document.getElementById('tutorialOverlay').style.display = 'none';
            localStorage.setItem('tutorialCompleted', 'true');
            showNotification('Tutorial completed! Click the ? buttons anytime for help.', 'success');
        }
        
        // Help System Functions
        const helpContent = {
            standards: {
                title: 'Standards Browser Help',
                subtitle: 'Learn how to effectively browse and select accreditation standards',
                content: `
                    <div class="help-section-item">
                        <h3 class="help-section-title">
                            <span class="help-section-icon">ðŸŽ¯</span>
                            Getting Started
                        </h3>
                        <div class="help-section-content">
                            <p>The Standards Browser is your central hub for exploring accreditation requirements. Here's how to get started:</p>
                            <ol>
                                <li>Select your accreditor from the dropdown menu</li>
                                <li>Choose your institution type to filter relevant standards</li>
                                <li>Use the search box to find specific standards by keyword</li>
                                <li>Select standards you want to work with using checkboxes</li>
                            </ol>
                            <div class="help-tip">
                                <div class="help-tip-title">ðŸ’¡ Pro Tip</div>
                                Save your filtered views for quick access later using the "Save View" button.
                            </div>
                        </div>
                    </div>
                    
                    <div class="help-section-item">
                        <h3 class="help-section-title">
                            <span class="help-section-icon">ðŸ”</span>
                            Understanding Standards
                        </h3>
                        <div class="help-section-content">
                            <p>Each standard card shows:</p>
                            <ul>
                                <li><strong>Standard Code:</strong> The official identifier (e.g., 1.1, 2.3.4)</li>
                                <li><strong>Description:</strong> What the standard requires</li>
                                <li><strong>Evidence Status:</strong> Whether you've mapped evidence to this standard</li>
                                <li><strong>Review Status:</strong> Your progress in addressing this standard</li>
                            </ul>
                            <div class="help-video-placeholder">
                                ðŸ“¹ Video: Understanding Standard Requirements (Coming Soon)
                            </div>
                        </div>
                    </div>
                    
                    <div class="help-section-item">
                        <h3 class="help-section-title">
                            <span class="help-section-icon">âœ…</span>
                            Next Steps
                        </h3>
                        <div class="help-section-content">
                            <p>After selecting standards:</p>
                            <ol>
                                <li><strong>Map Evidence:</strong> Link your documents to selected standards</li>
                                <li><strong>Analyze Gaps:</strong> Identify standards needing more evidence</li>
                                <li><strong>Generate Reports:</strong> Create compliance documentation</li>
                            </ol>
                        </div>
                    </div>
                `
            },
            filters: {
                title: 'Search & Filter Help',
                subtitle: 'Learn how to efficiently find the standards you need',
                content: `
                    <div class="help-section-item">
                        <h3 class="help-section-title">
                            <span class="help-section-icon">ðŸ”</span>
                            Search Techniques
                        </h3>
                        <div class="help-section-content">
                            <p>The search box supports multiple search methods:</p>
                            <ul>
                                <li><strong>Keywords:</strong> Search for topics like "assessment" or "governance"</li>
                                <li><strong>Standard Codes:</strong> Enter codes like "1.1" or "2.3.4"</li>
                                <li><strong>Phrases:</strong> Use quotes for exact matches: "student learning outcomes"</li>
                                <li><strong>Multiple Terms:</strong> Search returns results matching any term</li>
                            </ul>
                            <div class="help-tip">
                                <div class="help-tip-title">ðŸ’¡ Pro Tip</div>
                                Use the Category filter to narrow results to specific areas like "Academic Affairs" or "Finance".
                            </div>
                        </div>
                    </div>
                    
                    <div class="help-section-item">
                        <h3 class="help-section-title">
                            <span class="help-section-icon">âš™ï¸</span>
                            Advanced Filters
                        </h3>
                        <div class="help-section-content">
                            <p>Combine filters for precise results:</p>
                            <ul>
                                <li><strong>Status Filter:</strong> Show only standards needing attention</li>
                                <li><strong>Assignee Filter:</strong> Find standards assigned to specific team members</li>
                                <li><strong>Levels:</strong> Choose to see only top-level standards or include all subsections</li>
                                <li><strong>Reviewer Mode:</strong> Simplified view for reviewing progress</li>
                            </ul>
                        </div>
                    </div>
                `
            },
            crosswalk: {
                title: 'Cross-Accreditor Mapping Help',
                subtitle: 'Find equivalent standards across different accrediting bodies',
                content: `
                    <div class="help-section-item">
                        <h3 class="help-section-title">
                            <span class="help-section-icon">ðŸ”—</span>
                            What is CrosswalkXâ„¢?
                        </h3>
                        <div class="help-section-content">
                            <p>CrosswalkXâ„¢ uses AI to identify similar standards across different accreditors. This helps institutions that:</p>
                            <ul>
                                <li>Are changing accreditors</li>
                                <li>Maintain multiple accreditations</li>
                                <li>Want to understand how standards align across agencies</li>
                            </ul>
                            <div class="help-tip">
                                <div class="help-tip-title">âš ï¸ Important</div>
                                AI-generated mappings are suggestions. Always verify mappings with your accreditation team before official use.
                            </div>
                        </div>
                    </div>
                    
                    <div class="help-section-item">
                        <h3 class="help-section-title">
                            <span class="help-section-icon">ðŸ“Š</span>
                            Using Cross-Mappings
                        </h3>
                        <div class="help-section-content">
                            <ol>
                                <li>Select your current accreditor as "Source"</li>
                                <li>Select the target accreditor for comparison</li>
                                <li>Adjust the similarity threshold (default: 30%)</li>
                                <li>Click "Find Mappings" to see results</li>
                            </ol>
                            <p>Results show:</p>
                            <ul>
                                <li><strong>Match Score:</strong> How similar the standards are (0-100%)</li>
                                <li><strong>Common Keywords:</strong> Shared concepts between standards</li>
                                <li><strong>Multiple Matches:</strong> One standard may map to several in the target</li>
                            </ul>
                        </div>
                    </div>
                `
            }
        };
        
        function showHelp(section) {
            const content = helpContent[section] || helpContent.standards;
            document.getElementById('helpTitle').textContent = content.title;
            document.getElementById('helpSubtitle').textContent = content.subtitle;
            document.getElementById('helpContent').innerHTML = content.content;
            document.getElementById('helpModal').style.display = 'flex';
        }
        
        function closeHelp() {
            document.getElementById('helpModal').style.display = 'none';
        }
        
        // Workflow Progress Functions
        function initializeWorkflowProgress() {
            updateWorkflowProgress();
        }
        
        function updateWorkflowProgress() {
            // Check completion status for each step
            const hasUploaded = checkHasUploadedEvidence();
            const hasMapped = checkMappedEvidence();
            const hasReviewed = checkHasReviewedMappings();
            const hasAnalyzedGaps = checkHasAnalyzedGaps();
            const hasGeneratedReport = checkHasGeneratedReport();
            
            // Update step states
            updateWorkflowStep('upload', hasUploaded ? 'completed' : 'not-started');
            updateWorkflowStep('map', hasMapped ? 'completed' : hasUploaded ? 'active' : 'not-started');
            updateWorkflowStep('review', hasReviewed ? 'completed' : hasMapped ? 'active' : 'not-started');
            updateWorkflowStep('gaps', hasAnalyzedGaps ? 'completed' : hasReviewed ? 'active' : 'not-started');
            updateWorkflowStep('report', hasGeneratedReport ? 'completed' : hasAnalyzedGaps ? 'active' : 'not-started');
        }
        
        function updateWorkflowStep(stepName, status) {
            const step = document.querySelector(`[data-step="${stepName}"]`);
            if (!step) return;
            
            step.classList.remove('completed', 'active');
            if (status === 'completed') {
                step.classList.add('completed');
            } else if (status === 'active') {
                step.classList.add('active');
            }
        }
        
        function checkHasUploadedEvidence() {
            // Check localStorage or make API call
            const uploadedFiles = JSON.parse(localStorage.getItem('uploadedFiles') || '[]');
            return uploadedFiles.length > 0;
        }
        
        function checkHasReviewedMappings() {
            // Check if any mappings have been reviewed
            const reviewedMappings = JSON.parse(localStorage.getItem('reviewedMappings') || '[]');
            return reviewedMappings.length > 0;
        }
        
        function checkHasAnalyzedGaps() {
            // Check if gap analysis has been performed
            return localStorage.getItem('gapAnalysisCompleted') === 'true';
        }
        
        function checkHasGeneratedReport() {
            // Check if any report has been generated
            return localStorage.getItem('reportGenerated') === 'true';
        }
        
        function goToStep(stepName) {
            switch(stepName) {
                case 'upload':
                    window.location.href = '/web/dashboard-modern.html#evidence';
                    break;
                case 'map':
                    if (getSelectedStandards().length === 0) {
                        showNotification('Select standards first to map evidence', 'info');
                    } else {
                        openEvidenceMapModal();
                    }
                    break;
                case 'review':
                    showNotification('Review your mapped evidence in the standards list', 'info');
                    break;
                case 'gaps':
                    if (getSelectedStandards().length === 0) {
                        showNotification('Select standards first to analyze gaps', 'info');
                    } else {
                        analyzeGaps();
                    }
                    break;
                case 'report':
                    if (getSelectedStandards().length === 0) {
                        showNotification('Select standards first to generate reports', 'info');
                    } else {
                        openReportGenerationModal();
                    }
                    break;
            }
        }
        
        function checkFirstTimeUser() {
            if (!localStorage.getItem('tutorialCompleted') && !localStorage.getItem('tutorialSkipped')) {
                setTimeout(() => {
                    if (confirm('Welcome! Would you like a quick tour of the Standards Browser?')) {
                        startTutorial();
                    } else {
                        localStorage.setItem('tutorialSkipped', 'true');
                    }
                }, 1000);
            }
        }
        
        // Listen for progress updates
        window.addEventListener('evidenceMapped', updateWorkflowProgress);
        window.addEventListener('gapAnalysisComplete', () => {
            localStorage.setItem('gapAnalysisCompleted', 'true');
            updateWorkflowProgress();
        });
        window.addEventListener('reportGenerated', () => {
            localStorage.setItem('reportGenerated', 'true');
            updateWorkflowProgress();
        });
        
        // Close help modal on click outside
        window.addEventListener('click', (e) => {
            const helpModal = document.getElementById('helpModal');
            if (e.target === helpModal) {
                closeHelp();
            }
        });
        
        // Evidence Library Functions
        let evidenceLibraryData = [];
        let selectedEvidenceItems = new Set();
        let currentEvidenceFilter = 'all';
        
        function openEvidenceLibrary() {
            document.getElementById('evidenceLibraryModal').style.display = 'flex';
            loadEvidenceLibrary();
        }
        
        function closeEvidenceLibrary() {
            document.getElementById('evidenceLibraryModal').style.display = 'none';
            selectedEvidenceItems.clear();
            updateBulkActionButtons();
        }
        
        async function loadEvidenceLibrary() {
            try {
                // Show loading state
                const grid = document.getElementById('evidenceGrid');
                grid.innerHTML = '<div class="loading-inline">Loading evidence documents...</div>';
                
                // Get evidence from API
                const token = getAuthToken();
                const response = await fetch(buildApiUrl('/api/v1/evidence/documents'), {
                    headers: isLikelyJwt(token) ? { 'Authorization': `Bearer ${token}` } : {},
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load evidence documents');
                }
                
                const data = await response.json();
                evidenceLibraryData = data.data || [];
                
                // Update statistics
                updateEvidenceStats();
                
                // Display evidence
                displayEvidenceGrid();
                
            } catch (error) {
                console.error('Error loading evidence library:', error);
                document.getElementById('evidenceGrid').innerHTML = 
                    '<div class="error-state">Failed to load evidence documents. Please try again.</div>';
            }
        }
        
        function updateEvidenceStats() {
            const totalDocs = evidenceLibraryData.length;
            const mappedDocs = evidenceLibraryData.filter(doc => doc.mapped_standards && doc.mapped_standards.length > 0).length;
            const allStandards = new Set();
            
            evidenceLibraryData.forEach(doc => {
                if (doc.mapped_standards) {
                    doc.mapped_standards.forEach(std => allStandards.add(std.id));
                }
            });
            
            document.getElementById('totalDocsCount').textContent = totalDocs;
            document.getElementById('mappedDocsCount').textContent = mappedDocs;
            document.getElementById('standardsCoveredCount').textContent = allStandards.size;
        }
        
        function displayEvidenceGrid() {
            const grid = document.getElementById('evidenceGrid');
            const emptyState = document.getElementById('evidenceEmptyState');
            
            // Filter documents based on current filter
            let filteredDocs = evidenceLibraryData;
            
            if (currentEvidenceFilter === 'mapped') {
                filteredDocs = filteredDocs.filter(doc => doc.mapped_standards && doc.mapped_standards.length > 0);
            } else if (currentEvidenceFilter === 'unmapped') {
                filteredDocs = filteredDocs.filter(doc => !doc.mapped_standards || doc.mapped_standards.length === 0);
            }
            
            // Apply search filter
            const searchTerm = document.getElementById('evidenceSearchInput').value.toLowerCase();
            if (searchTerm) {
                filteredDocs = filteredDocs.filter(doc => 
                    doc.filename.toLowerCase().includes(searchTerm) ||
                    (doc.file_type && doc.file_type.toLowerCase().includes(searchTerm)) ||
                    (doc.mapped_standards && doc.mapped_standards.some(std => 
                        std.code.toLowerCase().includes(searchTerm) ||
                        std.text.toLowerCase().includes(searchTerm)
                    ))
                );
            }
            
            if (filteredDocs.length === 0) {
                grid.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            grid.style.display = 'grid';
            emptyState.style.display = 'none';
            
            grid.innerHTML = filteredDocs.map(doc => `
                <div class="evidence-item ${selectedEvidenceItems.has(doc.id) ? 'evidence-item-selected' : ''}" 
                     data-doc-id="${doc.id}">
                    <div class="evidence-item-header">
                        <div>
                            <div class="evidence-item-icon">${getFileIcon(doc.file_type)}</div>
                        </div>
                        <div class="evidence-item-actions">
                            <button class="evidence-action-btn" onclick="viewEvidenceDetail('${doc.id}')" title="View details">
                                ðŸ‘
                            </button>
                            <button class="evidence-action-btn" onclick="downloadEvidence('${doc.id}')" title="Download">
                                â¬‡ï¸
                            </button>
                            <button class="evidence-action-btn danger" onclick="deleteEvidence('${doc.id}')" title="Delete">
                                ðŸ—‘
                            </button>
                        </div>
                    </div>
                    <div class="evidence-item-title" onclick="toggleEvidenceSelection('${doc.id}')">${escapeHtml(doc.filename)}</div>
                    <div class="evidence-item-meta">
                        <div>${doc.file_type || 'Document'} â€¢ ${formatFileSize(doc.file_size)}</div>
                        <div>Uploaded ${formatDate(doc.uploaded_at)}</div>
                        ${doc.trust_score ? `<div>Trust Score: ${Math.round(doc.trust_score * 100)}%</div>` : ''}
                    </div>
                    ${doc.mapped_standards && doc.mapped_standards.length > 0 ? `
                        <div class="evidence-item-standards">
                            <div class="evidence-standards-label">Mapped to ${doc.mapped_standards.length} standard(s)</div>
                            <div class="evidence-standards-list">
                                ${doc.mapped_standards.slice(0, 3).map(std => 
                                    `<span class="evidence-standard-tag">${std.code}</span>`
                                ).join('')}
                                ${doc.mapped_standards.length > 3 ? 
                                    `<span class="evidence-standard-tag">+${doc.mapped_standards.length - 3} more</span>` : ''}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }
        
        function getFileIcon(fileType) {
            const icons = {
                'pdf': 'ðŸ“„',
                'doc': 'ðŸ“',
                'docx': 'ðŸ“',
                'xls': 'ðŸ“Š',
                'xlsx': 'ðŸ“Š',
                'ppt': 'ðŸ“½ï¸',
                'pptx': 'ðŸ“½ï¸',
                'image': 'ðŸ–¼ï¸',
                'video': 'ðŸŽ¥',
                'audio': 'ðŸŽµ'
            };
            
            if (fileType) {
                const type = fileType.toLowerCase();
                for (const [key, icon] of Object.entries(icons)) {
                    if (type.includes(key)) return icon;
                }
            }
            return 'ðŸ“„';
        }
        
        function formatFileSize(bytes) {
            if (!bytes) return 'Unknown size';
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
        }
        
        function toggleEvidenceSelection(docId) {
            const item = document.querySelector(`[data-doc-id="${docId}"]`);
            if (!item) return;
            
            if (selectedEvidenceItems.has(docId)) {
                selectedEvidenceItems.delete(docId);
                item.classList.remove('evidence-item-selected');
            } else {
                selectedEvidenceItems.add(docId);
                item.classList.add('evidence-item-selected');
            }
            
            updateBulkActionButtons();
        }
        
        function selectAllEvidence() {
            const btn = document.getElementById('selectAllBtn');
            const allItems = document.querySelectorAll('.evidence-item');
            
            if (selectedEvidenceItems.size === allItems.length) {
                // Deselect all
                selectedEvidenceItems.clear();
                allItems.forEach(item => item.classList.remove('evidence-item-selected'));
                btn.textContent = 'Select All';
            } else {
                // Select all
                allItems.forEach(item => {
                    const docId = item.dataset.docId;
                    selectedEvidenceItems.add(docId);
                    item.classList.add('evidence-item-selected');
                });
                btn.textContent = 'Deselect All';
            }
            
            updateBulkActionButtons();
        }
        
        function updateBulkActionButtons() {
            const count = selectedEvidenceItems.size;
            document.getElementById('evidenceSelectedCount').textContent = `${count} selected`;
            
            const downloadBtn = document.getElementById('downloadSelectedBtn');
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            
            downloadBtn.disabled = count === 0;
            deleteBtn.disabled = count === 0;
            
            // Update select all button text
            const selectAllBtn = document.getElementById('selectAllBtn');
            const allItems = document.querySelectorAll('.evidence-item');
            selectAllBtn.textContent = count === allItems.length ? 'Deselect All' : 'Select All';
        }
        
        function filterEvidenceType(type) {
            currentEvidenceFilter = type;
            
            // Update button states
            document.querySelectorAll('.evidence-filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === type);
            });
            
            displayEvidenceGrid();
        }
        
        function filterEvidenceLibrary() {
            displayEvidenceGrid();
        }
        
        async function viewEvidenceDetail(docId) {
            const doc = evidenceLibraryData.find(d => d.id === docId);
            if (!doc) return;
            
            const detailModal = document.getElementById('evidenceDetailModal');
            const detailBody = detailModal.querySelector('.evidence-detail-body');
            
            document.getElementById('evidenceDetailTitle').textContent = doc.filename;
            
            detailBody.innerHTML = `
                <div class="evidence-detail-section">
                    <h4 class="evidence-detail-section-title">Document Information</h4>
                    <div style="display: grid; gap: 1rem;">
                        <div>
                            <strong>File Type:</strong> ${doc.file_type || 'Unknown'}
                        </div>
                        <div>
                            <strong>File Size:</strong> ${formatFileSize(doc.file_size)}
                        </div>
                        <div>
                            <strong>Uploaded:</strong> ${formatDate(doc.uploaded_at)}
                        </div>
                        ${doc.trust_score ? `
                            <div>
                                <strong>Trust Score:</strong>
                                <div class="evidence-confidence">
                                    <div class="evidence-confidence-bar">
                                        <div class="evidence-confidence-fill" style="width: ${doc.trust_score * 100}%"></div>
                                    </div>
                                    <span class="evidence-confidence-text">${Math.round(doc.trust_score * 100)}%</span>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
                
                <div class="evidence-detail-section">
                    <h4 class="evidence-detail-section-title">Mapped Standards (${doc.mapped_standards ? doc.mapped_standards.length : 0})</h4>
                    <div class="evidence-mapped-standards">
                        ${doc.mapped_standards && doc.mapped_standards.length > 0 ? 
                            doc.mapped_standards.map(std => `
                                <div class="evidence-mapped-standard">
                                    <div class="evidence-mapped-standard-info">
                                        <div class="evidence-mapped-standard-code">${std.code}</div>
                                        <div class="evidence-mapped-standard-text">${escapeHtml(std.text)}</div>
                                        ${std.confidence ? `
                                            <div class="evidence-confidence">
                                                <div class="evidence-confidence-bar">
                                                    <div class="evidence-confidence-fill" style="width: ${std.confidence * 100}%"></div>
                                                </div>
                                                <span class="evidence-confidence-text">${Math.round(std.confidence * 100)}% match</span>
                                            </div>
                                        ` : ''}
                                    </div>
                                    <button class="btn btn-secondary" onclick="removeMapping('${docId}', '${std.id}')">
                                        Remove Mapping
                                    </button>
                                </div>
                            `).join('') :
                            '<p style="color: var(--text-medium);">No standards mapped to this document yet.</p>'
                        }
                    </div>
                    <button class="btn btn-primary" onclick="addMappingsToDocument('${docId}')" style="margin-top: 1rem;">
                        Add Standard Mappings
                    </button>
                </div>
                
                <div class="evidence-detail-section">
                    <h4 class="evidence-detail-section-title">Actions</h4>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-primary" onclick="downloadEvidence('${docId}')">
                            â¬‡ï¸ Download Document
                        </button>
                        <button class="btn btn-secondary" onclick="renameEvidence('${docId}')">
                            âœï¸ Rename
                        </button>
                        <button class="btn btn-secondary danger" onclick="deleteEvidence('${docId}')">
                            ðŸ—‘ Delete Document
                        </button>
                    </div>
                </div>
            `;
            
            detailModal.style.display = 'flex';
        }
        
        function closeEvidenceDetail() {
            document.getElementById('evidenceDetailModal').style.display = 'none';
        }
        
        async function deleteEvidence(docId) {
            const doc = evidenceLibraryData.find(d => d.id === docId);
            if (!doc) return;
            
            if (!confirm(`Are you sure you want to delete "${doc.filename}"? This action cannot be undone.`)) {
                return;
            }
            
            try {
                const token = getAuthToken();
                const response = await fetch(buildApiUrl(`/api/v1/evidence/documents/${docId}`), {
                    method: 'DELETE',
                    headers: isLikelyJwt(token) ? { 'Authorization': `Bearer ${token}` } : {},
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to delete document');
                }
                
                showNotification('Document deleted successfully', 'success');
                
                // Reload the evidence library
                loadEvidenceLibrary();
                
                // Close detail modal if open
                closeEvidenceDetail();
                
            } catch (error) {
                console.error('Error deleting document:', error);
                showNotification('Failed to delete document. Please try again.', 'error');
            }
        }
        
        async function deleteSelectedEvidence() {
            if (selectedEvidenceItems.size === 0) return;
            
            if (!confirm(`Are you sure you want to delete ${selectedEvidenceItems.size} document(s)? This action cannot be undone.`)) {
                return;
            }
            
            try {
                const token = getAuthToken();
                const deletePromises = Array.from(selectedEvidenceItems).map(docId =>
                    fetch(buildApiUrl(`/api/v1/evidence/documents/${docId}`), {
                        method: 'DELETE',
                        headers: isLikelyJwt(token) ? { 'Authorization': `Bearer ${token}` } : {},
                        credentials: 'include'
                    })
                );
                
                await Promise.all(deletePromises);
                
                showNotification(`${selectedEvidenceItems.size} document(s) deleted successfully`, 'success');
                
                // Clear selection and reload
                selectedEvidenceItems.clear();
                loadEvidenceLibrary();
                
            } catch (error) {
                console.error('Error deleting documents:', error);
                showNotification('Failed to delete some documents. Please try again.', 'error');
            }
        }
        
        async function downloadEvidence(docId) {
            const doc = evidenceLibraryData.find(d => d.id === docId);
            if (!doc) return;
            
            try {
                const token = getAuthToken();
                const response = await fetch(buildApiUrl(`/api/v1/evidence/documents/${docId}/download`), {
                    headers: isLikelyJwt(token) ? { 'Authorization': `Bearer ${token}` } : {},
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to download document');
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = doc.filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showNotification('Document downloaded successfully', 'success');
                
            } catch (error) {
                console.error('Error downloading document:', error);
                showNotification('Failed to download document. Please try again.', 'error');
            }
        }
        
        async function downloadSelectedEvidence() {
            if (selectedEvidenceItems.size === 0) return;
            
            showNotification(`Downloading ${selectedEvidenceItems.size} document(s)...`, 'info');
            
            for (const docId of selectedEvidenceItems) {
                await downloadEvidence(docId);
            }
        }
        
        async function renameEvidence(docId) {
            const doc = evidenceLibraryData.find(d => d.id === docId);
            if (!doc) return;
            
            const newName = prompt('Enter new filename:', doc.filename);
            if (!newName || newName === doc.filename) return;
            
            try {
                const token = getAuthToken();
                const response = await fetch(buildApiUrl(`/api/v1/evidence/documents/${docId}`), {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(isLikelyJwt(token) ? { 'Authorization': `Bearer ${token}` } : {})
                    },
                    credentials: 'include',
                    body: JSON.stringify({ filename: newName })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to rename document');
                }
                
                showNotification('Document renamed successfully', 'success');
                
                // Update local data
                doc.filename = newName;
                
                // Refresh display
                displayEvidenceGrid();
                
                // Update detail view if open
                const detailTitle = document.getElementById('evidenceDetailTitle');
                if (detailTitle && detailTitle.textContent === doc.filename) {
                    detailTitle.textContent = newName;
                }
                
            } catch (error) {
                console.error('Error renaming document:', error);
                showNotification('Failed to rename document. Please try again.', 'error');
            }
        }
        
        async function removeMapping(docId, standardId) {
            if (!confirm('Are you sure you want to remove this standard mapping?')) return;
            
            try {
                const token = getAuthToken();
                const response = await fetch(buildApiUrl(`/api/v1/evidence/mappings/${docId}/${standardId}`), {
                    method: 'DELETE',
                    headers: isLikelyJwt(token) ? { 'Authorization': `Bearer ${token}` } : {},
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to remove mapping');
                }
                
                showNotification('Mapping removed successfully', 'success');
                
                // Update local data
                const doc = evidenceLibraryData.find(d => d.id === docId);
                if (doc && doc.mapped_standards) {
                    doc.mapped_standards = doc.mapped_standards.filter(std => std.id !== standardId);
                }
                
                // Refresh views
                updateEvidenceStats();
                displayEvidenceGrid();
                viewEvidenceDetail(docId); // Refresh detail view
                
                // Dispatch event to update other parts of the app
                window.dispatchEvent(new CustomEvent('evidenceMappingChanged', { 
                    detail: { docId, standardId, action: 'removed' }
                }));
                
            } catch (error) {
                console.error('Error removing mapping:', error);
                showNotification('Failed to remove mapping. Please try again.', 'error');
            }
        }
        
        function addMappingsToDocument(docId) {
            // Close detail view
            closeEvidenceDetail();
            
            // Open the evidence mapping modal with this document pre-selected
            selectedEvidence.clear();
            selectedEvidence.add(docId);
            
            // Get standards that are currently selected
            const selectedStandards = getSelectedStandards();
            if (selectedStandards.length === 0) {
                showNotification('Please select standards from the main list first', 'info');
                closeEvidenceLibrary();
                return;
            }
            
            // Open mapping modal
            openEvidenceMapModal();
            
            // Pre-select this document in the mapping modal
            setTimeout(() => {
                const evidenceCard = document.querySelector(`[onclick="toggleEvidenceSelection('${docId}')"]`);
                if (evidenceCard && !evidenceCard.classList.contains('selected')) {
                    toggleEvidenceSelection(docId);
                }
            }, 500);
        }
        
        function uploadMoreEvidence() {
            // Redirect to dashboard evidence upload section
            window.location.href = '/web/dashboard-modern.html#evidence';
        }
        
        // Update evidence library when mappings change
        window.addEventListener('evidenceMapped', () => {
            if (document.getElementById('evidenceLibraryModal').style.display === 'flex') {
                loadEvidenceLibrary();
            }
        });
        
        // Show/hide evidence library button based on scroll
        let lastScrollY = window.scrollY;
        window.addEventListener('scroll', () => {
            const currentScrollY = window.scrollY;
            const btn = document.getElementById('evidenceLibraryBtn');
            
            if (currentScrollY > lastScrollY && currentScrollY > 100) {
                // Scrolling down - hide button
                btn.style.transform = 'translateY(100px)';
            } else {
                // Scrolling up - show button
                btn.style.transform = 'translateY(0)';
            }
            
            lastScrollY = currentScrollY;
        });
        
        // Close evidence library on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (document.getElementById('evidenceDetailModal').style.display === 'flex') {
                    closeEvidenceDetail();
                } else if (document.getElementById('evidenceLibraryModal').style.display === 'flex') {
                    closeEvidenceLibrary();
                }
            }
        });
    </script>
    
    <!-- Evidence Mapping Modal -->
    <div id="evidenceMapModal" class="modal-backdrop" onclick="closeEvidenceMapModal(event)">
        <div class="modal" style="max-width: 1000px; width: 95%;" onclick="event.stopPropagation()">
            <div class="mapping-pipeline-container">
                <!-- Pipeline Header with Steps -->
                <div class="pipeline-header">
                    <h3 class="modal-title" style="margin: 0;">Evidence Mapping Pipeline</h3>
                    <button class="modal-close" onclick="closeEvidenceMapModal()">Ã—</button>
                    <div class="pipeline-steps">
                        <div class="pipeline-step active" id="step-select">
                            <div class="step-number">1</div>
                            <div class="step-label">Select Evidence</div>
                        </div>
                        <div class="pipeline-step" id="step-analyze">
                            <div class="step-number">2</div>
                            <div class="step-label">Analyze Documents</div>
                        </div>
                        <div class="pipeline-step" id="step-extract">
                            <div class="step-number">3</div>
                            <div class="step-label">Extract Excerpts</div>
                        </div>
                        <div class="pipeline-step" id="step-map">
                            <div class="step-number">4</div>
                            <div class="step-label">Map to Standards</div>
                        </div>
                        <div class="pipeline-step" id="step-review">
                            <div class="step-number">5</div>
                            <div class="step-label">Review Results</div>
                        </div>
                    </div>
                </div>
                
                <!-- Step 1: Evidence Selection -->
                <div id="step-content-select" class="step-content">
                    <div class="modal-body">
                        <div id="evidenceMapStatus" style="margin-bottom: 1rem;">
                            <p style="font-weight: 600; color: var(--text-dark); margin-bottom: 0.5rem;">Mapping to Selected Standards:</p>
                            <div id="selectedStandardsList" style="display: flex; flex-wrap: wrap; gap: 0.5rem;"></div>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label class="filter-label">Search Evidence Documents</label>
                            <input type="text" id="evidenceSearchInput" class="filter-input" placeholder="Search by filename, type, or content..." onkeyup="filterEvidence()">
                        </div>
                        <div id="availableEvidenceGrid" class="evidence-grid">
                            <!-- Evidence documents will be loaded here -->
                        </div>
                    </div>
                    <div class="modal-footer">
                        <div>
                            <span id="selectedEvidenceCount">0 documents selected</span>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="closeEvidenceMapModal()">Cancel</button>
                            <button class="btn btn-primary" onclick="startMappingPipeline()" id="startMappingBtn">Start Mapping Process</button>
                        </div>
                    </div>
                </div>
                
                <!-- Step 2-4: Progress View -->
                <div id="step-content-progress" class="step-content" style="display: none;">
                    <div class="mapping-progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" id="mappingProgress" style="width: 0%"></div>
                        </div>
                        <div class="mapping-status">
                            <div class="status-icon" id="statusIcon">âš™ï¸</div>
                            <div class="status-message" id="statusMessage">Initializing mapping process...</div>
                            <div class="status-detail" id="statusDetail">Preparing to analyze documents</div>
                        </div>
                        <div id="mappingLogs" style="max-height: 200px; overflow-y: auto; background: var(--bg-light); border-radius: 0.5rem; padding: 1rem; margin-top: 2rem; font-size: 0.875rem; font-family: monospace;">
                            <!-- Real-time logs will appear here -->
                        </div>
                    </div>
                </div>
                
                <!-- Step 5: Results Review -->
                <div id="step-content-results" class="step-content" style="display: none;">
                    <div class="modal-body">
                        <div style="margin-bottom: 1rem;">
                            <h4 style="margin-bottom: 0.5rem;">Mapping Results</h4>
                            <p id="resultsSummary" style="color: var(--text-medium);"></p>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <input type="text" id="resultsSearchInput" class="filter-input" placeholder="Search excerpts or standards..." onkeyup="filterResults()">
                        </div>
                        <div id="evidenceResultsContainer" class="evidence-results-container">
                            <!-- Mapping results will be displayed here -->
                        </div>
                    </div>
                    <div class="modal-footer">
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <button class="btn btn-secondary" onclick="downloadMappingReport()">ðŸ“¥ Download Report</button>
                            <button class="btn btn-secondary" onclick="restartMapping()">ðŸ”„ Map More Evidence</button>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="closeEvidenceMapModal()">Close</button>
                            <button class="btn btn-primary" onclick="saveMappingResults()">Save & Apply Mappings</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tutorial Overlay -->
    <div id="tutorialOverlay" class="tutorial-overlay">
        <div id="tutorialSpotlight" class="tutorial-spotlight"></div>
        <div id="tutorialPopup" class="tutorial-popup">
            <div class="tutorial-arrow"></div>
            <div class="tutorial-header">
                <h3 class="tutorial-title" id="tutorialTitle">Welcome to Standards Browser</h3>
                <span class="tutorial-step" id="tutorialStep">Step 1 of 7</span>
            </div>
            <div class="tutorial-content" id="tutorialContent">
                Let's walk through how to use the Standards Browser for accreditation preparation.
            </div>
            <div class="tutorial-actions">
                <button class="tutorial-btn tutorial-btn-skip" onclick="skipTutorial()">Skip Tour</button>
                <button class="tutorial-btn tutorial-btn-next" onclick="nextTutorialStep()" id="tutorialNextBtn">Next</button>
            </div>
        </div>
    </div>
    
    <!-- Help Modal -->
    <div id="helpModal" class="help-modal">
        <div class="help-modal-content">
            <div class="help-modal-header">
                <button class="help-modal-close" onclick="closeHelp()">&times;</button>
                <h2 class="help-modal-title" id="helpTitle">Standards Browser Help</h2>
                <p class="help-modal-subtitle" id="helpSubtitle">Learn how to effectively use the standards browser for accreditation preparation</p>
            </div>
            <div class="help-modal-body" id="helpContent">
                <!-- Help content will be dynamically loaded based on context -->
            </div>
        </div>
    </div>
    
    <!-- Evidence Library Button -->
    <button class="evidence-library-btn" onclick="openEvidenceLibrary()" id="evidenceLibraryBtn">
        <span>ðŸ“</span>
        Evidence Library
    </button>
    
    <!-- Evidence Library Modal -->
    <div id="evidenceLibraryModal" class="evidence-library-modal">
        <div class="evidence-library-content">
            <div class="evidence-library-header">
                <div>
                    <h2 class="evidence-library-title">Evidence Library</h2>
                    <div class="evidence-stats">
                        <div class="evidence-stat">
                            <span class="evidence-stat-label">Total Documents</span>
                            <span class="evidence-stat-value" id="totalDocsCount">0</span>
                        </div>
                        <div class="evidence-stat">
                            <span class="evidence-stat-label">Mapped</span>
                            <span class="evidence-stat-value" id="mappedDocsCount">0</span>
                        </div>
                        <div class="evidence-stat">
                            <span class="evidence-stat-label">Standards Covered</span>
                            <span class="evidence-stat-value" id="standardsCoveredCount">0</span>
                        </div>
                    </div>
                </div>
                <button class="help-modal-close" onclick="closeEvidenceLibrary()">&times;</button>
            </div>
            
            <div class="evidence-library-controls">
                <div class="evidence-search">
                    <span class="evidence-search-icon">ðŸ”</span>
                    <input type="text" 
                           class="evidence-search-input" 
                           id="evidenceSearchInput"
                           placeholder="Search documents by name, type, or standard..."
                           onkeyup="filterEvidenceLibrary()">
                </div>
                <div class="evidence-filters">
                    <button class="evidence-filter-btn active" onclick="filterEvidenceType('all')" data-filter="all">
                        All Documents
                    </button>
                    <button class="evidence-filter-btn" onclick="filterEvidenceType('mapped')" data-filter="mapped">
                        Mapped Only
                    </button>
                    <button class="evidence-filter-btn" onclick="filterEvidenceType('unmapped')" data-filter="unmapped">
                        Unmapped
                    </button>
                </div>
                <button class="btn btn-primary" onclick="uploadMoreEvidence()">
                    <span>â¬†ï¸</span> Upload More
                </button>
            </div>
            
            <div class="evidence-library-body">
                <div id="evidenceGrid" class="evidence-grid">
                    <!-- Evidence items will be dynamically loaded here -->
                </div>
                <div id="evidenceEmptyState" class="evidence-empty-state" style="display: none;">
                    <div class="evidence-empty-icon">ðŸ“„</div>
                    <h3 class="evidence-empty-title">No evidence documents yet</h3>
                    <p class="evidence-empty-text">Upload documents to start building your evidence library</p>
                    <button class="btn btn-primary" onclick="uploadMoreEvidence()">Upload Documents</button>
                </div>
            </div>
            
            <div class="evidence-library-footer">
                <div class="evidence-bulk-actions">
                    <span class="evidence-selected-count" id="evidenceSelectedCount">0 selected</span>
                    <button class="btn btn-secondary" onclick="selectAllEvidence()" id="selectAllBtn">Select All</button>
                    <button class="btn btn-secondary" onclick="downloadSelectedEvidence()" disabled id="downloadSelectedBtn">Download Selected</button>
                    <button class="btn btn-secondary danger" onclick="deleteSelectedEvidence()" disabled id="deleteSelectedBtn">Delete Selected</button>
                </div>
                <button class="btn btn-secondary" onclick="closeEvidenceLibrary()">Close</button>
            </div>
            
            <!-- Evidence Detail View -->
            <div id="evidenceDetailModal" class="evidence-detail-modal">
                <div class="evidence-detail-header">
                    <h3 id="evidenceDetailTitle">Document Details</h3>
                    <button class="help-modal-close" onclick="closeEvidenceDetail()">&times;</button>
                </div>
                <div class="evidence-detail-body">
                    <!-- Document details will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Info Banner Component -->
    <script src="/web/banner-component.js"></script>
</body>
</html>