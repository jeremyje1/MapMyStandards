<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Dashboard | MapMyStandards A³E</title>
        <!-- Use locally built Tailwind in production -->
        <link rel="stylesheet" href="/static/css/tailwind.css?v=1">
        <script>
            // Prefer local CSS; if /static alias fails, try /web path, then CDN as last resort
            (function(){
                const link = document.querySelector('link[href^="/static/css/tailwind.css"]');
                if (!link) return;
                let attemptedWeb = false;
                link.addEventListener('error', function onStaticCssError(){
                    if (!attemptedWeb) {
                        attemptedWeb = true;
                        const alt = document.createElement('link');
                        alt.rel = 'stylesheet';
                        alt.href = '/web/static/css/tailwind.css';
                        alt.addEventListener('load', function(){
                            console.info('Loaded Tailwind from /web fallback');
                        });
                        alt.addEventListener('error', function(){
                            const s = document.createElement('script');
                            s.src = 'https://cdn.tailwindcss.com';
                            document.head.appendChild(s);
                            console.warn('Fallback to Tailwind CDN (dev only). Build CSS for production.');
                        });
                        document.head.appendChild(alt);
                    } else {
                        const cdnLink = document.createElement('link');
                        cdnLink.rel = 'stylesheet';
                        cdnLink.href = 'https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css';
                        document.head.appendChild(cdnLink);
                        console.warn('Fallback to Tailwind CDN CSS (last resort).');
                    }
                });
            })();
        </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background-color: #f9fafb;
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .ai-badge {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #3b82f6;
        }
        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        .success-message {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #166534;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-semibold text-gray-900">MapMyStandards A³E</h1>
                    <span class="ai-badge ml-3">AI Powered</span>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600" id="userEmail">Loading...</span>
                    <button id="openSettingsBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md text-sm hover:bg-blue-700 transition-colors">
                        Settings
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        <!-- Loading State -->
        <div id="loadingState" class="text-center py-8">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-gray-600">Loading your AI-powered compliance dashboard...</p>
        </div>

        <!-- Error State -->
        <div id="errorState" class="hidden">
            <div class="error-message">
                <h3 class="font-semibold">Unable to load dashboard</h3>
                <p id="errorMessage">Please check your connection and try again.</p>
                <button onclick="loadDashboard()" class="mt-2 bg-red-600 text-white px-4 py-2 rounded">Retry</button>
            </div>
        </div>

        <!-- Main Dashboard Content -->
        <div id="dashboardContent" class="hidden">
            <!-- Settings Modal -->
            <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-30">
                <div class="bg-white rounded-lg shadow-lg w-full max-w-lg p-6 relative">
                    <button id="closeSettingsBtn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                    <h3 class="text-lg font-semibold mb-4">Account Settings</h3>
                    <form id="settingsForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Organization</label>
                            <input type="text" id="orgInput" class="mt-1 w-full border rounded px-3 py-2" placeholder="Your institution" />
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">State / Region</label>
                                <input type="text" id="stateInput" class="mt-1 w-full border rounded px-3 py-2" placeholder="CA, TX, FL..." />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Institution Size</label>
                                <select id="sizeSelect" class="mt-1 w-full border rounded px-3 py-2">
                                    <option value="">Select...</option>
                                    <option value="under_1000">Under 1,000</option>
                                    <option value="1k_5k">1,000 – 5,000</option>
                                    <option value="5k_15k">5,000 – 15,000</option>
                                    <option value="15k_plus">15,000+</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Primary Accreditor</label>
                            <select id="accreditorSelect" class="mt-1 w-full border rounded px-3 py-2"></select>
                            <p class="text-xs text-gray-500 mt-1">Used by Standards Graph™ and mapping defaults.</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Term System</label>
                                <select id="termSelect" class="mt-1 w-full border rounded px-3 py-2">
                                    <option value="">Select...</option>
                                    <option>semester</option>
                                    <option>quarter</option>
                                    <option>trimester</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">LMS</label>
                                <input type="text" id="lmsInput" class="mt-1 w-full border rounded px-3 py-2" placeholder="Canvas, Moodle, Blackboard, Microsoft" />
                            </div>
                        </div>
                        <div class="text-xs text-gray-500">
                            All features are enabled for your account.
                        </div>
                        <div class="flex items-center justify-end gap-3 pt-2">
                            <button type="button" id="cancelSettingsBtn" class="px-4 py-2 rounded border">Cancel</button>
                            <button type="submit" class="px-4 py-2 rounded bg-blue-600 text-white">Save</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Mapping Details Modal -->
            <div id="mappingDetailsModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-40">
                <div class="bg-white rounded-lg shadow-lg w-full max-w-2xl p-6 relative">
                    <button id="closeMappingDetailsBtn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                    <h3 class="text-lg font-semibold mb-2">Mapping Details</h3>
                    <div id="mappingDetailsContent" class="text-sm text-gray-800">
                        <div class="text-center py-6 text-gray-500">Loading…</div>
                    </div>
                </div>
            </div>
            <!-- Data Status Guidance -->
            <div id="dataStatusPanel" class="hidden bg-yellow-50 border border-yellow-200 text-yellow-900 rounded-lg p-4 mb-6">
                <div class="flex items-start">
                    <div class="mr-3"><i class="fas fa-info-circle"></i></div>
                    <div>
                        <div class="font-semibold mb-1">Complete setup to personalize your dashboard</div>
                        <ul id="missingInputsList" class="list-disc list-inside text-sm"></ul>
                        <div class="mt-2">
                            <a href="https://platform.mapmystandards.ai/onboarding" class="inline-block bg-yellow-600 text-white px-3 py-1 rounded text-xs hover:bg-yellow-700">Go to Settings</a>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Welcome Banner -->
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg p-6 mb-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-xl font-semibold mb-2" id="welcomeMessage">Welcome to your AI Dashboard!</h2>
                        <p class="opacity-90" id="institutionInfo">Your compliance intelligence platform is ready.</p>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-bold" id="complianceScore">--</div>
                        <div class="text-sm opacity-90">Compliance Score</div>
                    </div>
                </div>
            </div>

            <!-- Key Metrics -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="metric-card">
                    <div class="flex items-center">
                        <div class="p-2 bg-blue-100 rounded-lg">
                            <i class="fas fa-chart-line text-blue-600"></i>
                        </div>
                        <div class="ml-4">
                            <div class="text-2xl font-bold text-gray-900" id="metricCompliance">--</div>
                            <div class="text-sm text-gray-600">Overall Compliance</div>
                        </div>
                    </div>
                </div>

                <div class="metric-card">
                    <div class="flex items-center">
                        <div class="p-2 bg-green-100 rounded-lg">
                            <i class="fas fa-file-alt text-green-600"></i>
                        </div>
                        <div class="ml-4">
                            <div class="text-2xl font-bold text-gray-900" id="metricDocuments">--</div>
                            <div class="text-sm text-gray-600">Documents Analyzed</div>
                        </div>
                    </div>
                </div>

                <div class="metric-card">
                    <div class="flex items-center">
                        <div class="p-2 bg-purple-100 rounded-lg">
                            <i class="fas fa-sitemap text-purple-600"></i>
                        </div>
                        <div class="ml-4">
                            <div class="text-2xl font-bold text-gray-900" id="metricStandards">--</div>
                            <div class="text-sm text-gray-600">Standards Mapped</div>
                        </div>
                    </div>
                </div>

                <div class="metric-card">
                    <div class="flex items-center">
                        <div class="p-2 bg-red-100 rounded-lg">
                            <i class="fas fa-exclamation-triangle text-red-600"></i>
                        </div>
                        <div class="ml-4">
                            <div class="text-2xl font-bold text-gray-900" id="metricGaps">--</div>
                            <div class="text-sm text-gray-600">Gaps Identified</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Actions -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-6 rounded-lg shadow card-hover">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-brain text-blue-600"></i>
                            </div>
                        </div>
                        <div class="ml-4 flex-1">
                            <h3 class="text-lg font-medium text-gray-900">AI Evidence Analysis</h3>
                            <p class="text-gray-600 text-sm mt-1">Upload documents for intelligent standards mapping</p>
                            <div class="mt-4">
                                <input type="file" id="evidenceFile" accept=".pdf,.doc,.docx,.txt" class="hidden" multiple>
                                <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded p-4 text-sm text-gray-600" role="button" aria-label="Upload area" tabindex="0">
                                    Drag & drop files here or
                                    <button type="button" onclick="beginGenericUpload()" class="ml-1 bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700" aria-label="Upload and analyze">
                                        Browse files
                                    </button>
                                    <div class="text-xs text-gray-500 mt-1">PDF, Word, Text. You can drop multiple files.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow card-hover">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-project-diagram text-purple-600"></i>
                            </div>
                        </div>
                        <div class="ml-4 flex-1">
                            <h3 class="text-lg font-medium text-gray-900">Standards Graph™</h3>
                            <p class="text-gray-600 text-sm mt-1">Explore standards relationships</p>
                            <button onclick="loadStandardsGraph()" class="inline-flex items-center text-blue-600 hover:text-blue-800 text-sm font-medium mt-3">
                                View Graph 
                                <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                            <div class="mt-3 flex items-center gap-2">
                                <input id="standardsSearchGlobal" type="text" placeholder="Search standard, clause, indicator" class="border rounded px-2 py-1 text-sm w-64" />
                                <button id="standardsSearchBtn" class="px-2 py-1 text-sm border rounded">Search</button>
                            </div>
                            <div id="standardsSearchResults" class="mt-2 text-sm text-gray-700 max-h-40 overflow-y-auto"></div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow card-hover">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-exclamation-circle text-red-600"></i>
                            </div>
                        </div>
                        <div class="ml-4 flex-1">
                            <h3 class="text-lg font-medium text-gray-900">Gap Analysis</h3>
                            <p class="text-gray-600 text-sm mt-1">AI-powered compliance gap detection</p>
                            <button onclick="loadGapAnalysis()" class="inline-flex items-center text-blue-600 hover:text-blue-800 text-sm font-medium mt-3">
                                Analyze Gaps 
                                <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow card-hover">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <div class="w-12 h-12 bg-indigo-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-book-open text-indigo-600"></i>
                            </div>
                        </div>
                        <div class="ml-4 flex-1">
                            <h3 class="text-lg font-medium text-gray-900">Narrative (CiteGuard)</h3>
                            <p class="text-gray-600 text-sm mt-1">Generate and export your accreditation narrative</p>
                            <button onclick="openNarrative()" class="inline-flex items-center text-blue-600 hover:text-blue-800 text-sm font-medium mt-3">
                                Open Narrative 
                                <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Suggested Uploads (dynamic by settings.document_types) -->
            <div id="suggestedUploads" class="hidden mb-8">
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-semibold">Suggested Uploads</h3>
                        <div class="text-xs text-gray-500">Based on your onboarding</div>
                    </div>
                    <div id="suggestedUploadsChips" class="flex flex-wrap gap-2"></div>
                    <div class="text-xs text-gray-500 mt-3">Pick a type to upload a matching document; more types can be added in Settings.</div>
                </div>
            </div>

            <!-- Analysis Results -->
            <div id="analysisResults" class="hidden mb-8">
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">Latest Analysis Results</h3>
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <button id="markAllReviewedBtn" class="text-sm bg-green-600 text-white px-3 py-1 rounded">Mark all reviewed</button>
                        </div>
                        <div class="space-x-2">
                            <button id="exportCsvBtn" class="text-sm bg-gray-700 text-white px-3 py-1 rounded">Export CSV</button>
                            <button id="exportReportBtn" class="text-sm bg-gray-800 text-white px-3 py-1 rounded">Export Report</button>
                        </div>
                    </div>
                    <div id="analysisContent"></div>
                </div>
            </div>

            <!-- Standards Graph Section -->
            <div id="standardsGraphSection" class="hidden mb-8">
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">Standards Graph™ - <span id="currentAccreditor"></span></h3>
                    <div id="standardsContent">
                        <div class="text-center py-8">
                            <div class="loading-spinner mx-auto mb-4"></div>
                            <p class="text-gray-600">Loading standards graph...</p>
                        </div>
                    </div>
                    <div id="categoryCoverage" class="mt-4 text-sm text-gray-700"></div>
                    <div class="mt-4">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-medium">Interactive Graph</h4>
                            <div class="flex items-center gap-4">
                                <label class="inline-flex items-center gap-2 text-xs text-gray-700">
                                    <input type="checkbox" id="toggleReuseLinks" class="rounded border-gray-300" />
                                    <span>Show reuse links</span>
                                </label>
                                <label class="inline-flex items-center gap-2 text-xs text-gray-700">
                                    <input type="checkbox" id="toggleCrossAccOnly" class="rounded border-gray-300" />
                                    <span>Cross-accreditor only</span>
                                </label>
                            </div>
                        </div>
                        <svg id="standardsGraphSvg" width="100%" height="360" role="img" aria-label="Interactive standards graph"></svg>
                        <div class="text-xs text-gray-500 mt-1 flex items-center gap-4">
                            <span>Hover nodes to highlight links. Click accreditor chips to switch frameworks. Toggle reuse to see dashed links where evidence is shared.</span>
                            <span class="inline-flex items-center gap-2">
                                <span class="inline-block w-6 border-t-2 border-dashed" style="border-color:#16a34a"></span>
                                <span>Reuse edge</span>
                                <span class="inline-block w-2 h-2 rounded-full" style="background:#3b82f6"></span>
                                <span>Standard node</span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gap Analysis Section -->
            <div id="gapAnalysisSection" class="hidden mb-8">
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">GapRisk Predictor™ Analysis</h3>
                    <div id="gapContent">
                        <div class="text-center py-8">
                            <div class="loading-spinner mx-auto mb-4"></div>
                            <p class="text-gray-600">Analyzing compliance gaps...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Narrative (CiteGuard-lite) Section -->
            <div id="narrativeSection" class="hidden mb-8">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-semibold">CiteGuard Narrative</h3>
                        <div class="flex items-center gap-2">
                            <button id="generateNarrativeBtn" class="text-sm bg-blue-600 text-white px-3 py-1 rounded">Generate</button>
                            <button id="exportNarrativeDocxBtn" class="text-sm bg-gray-800 text-white px-3 py-1 rounded">Export DOCX</button>
                        </div>
                    </div>
                    <div id="narrativeContent" class="prose prose-sm max-w-none"></div>
                </div>
            </div>

            <!-- Risk Transparency Section -->
            <div id="riskTransparencySection" class="hidden mb-8">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-semibold">Risk Model Transparency</h3>
                        <a href="#" id="editRiskWeightsLink" class="text-sm text-blue-600">Adjust weights</a>
                    </div>
                    <div id="riskFactorsContent" class="text-sm text-gray-800"></div>
                </div>
            </div>

            <!-- CrosswalkX Section -->
            <div id="crosswalkSection" class="hidden mb-8">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-lg font-semibold">CrosswalkX – Evidence Reuse Matrix</h3>
                        <div class="text-xs text-gray-500" id="crosswalkSummary"></div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-xs" id="crosswalkTable" aria-label="Crosswalk matrix"></table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast: Upload confirmation -->
    <div id="uploadToast" class="hidden fixed bottom-4 right-4 z-50 px-4 py-2 rounded shadow-lg text-white text-sm" style="background:#16a34a;">
        Upload complete. Metrics refreshed.
    </div>
    <!-- Tooltip for Standards Graph -->
    <div id="graphTooltip" class="hidden fixed z-50 max-w-sm bg-white border border-gray-200 shadow-lg rounded p-3 text-xs text-gray-800"></div>

    <script>
        // Determine API base URL depending on where this page is hosted
        const API_BASE = (function() {
            try {
                const stored = localStorage.getItem('api_base');
                if (stored) return stored.replace(/\/$/, '');
            } catch {}
            const host = location.hostname;
            if (host.includes('platform.mapmystandards.ai')) return 'https://api.mapmystandards.ai';
            // Same-origin by default (works when served from API domain)
            return '';
        })();
    let dashboardData = null;
    let userSettings = null;

        // Load dashboard on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            const token = localStorage.getItem('access_token') || localStorage.getItem('jwt_token');
            if (!token) {
                window.location.href = 'https://platform.mapmystandards.ai/login';
                return;
            }

            // Fetch settings first (used by graph defaults), then load dashboard
            fetchSettings().finally(async () => {
                await loadDashboard();
                // Preload integrations for settings modal
                ensureIntegrations();
            });
            
            // Set up file upload handler
            document.getElementById('evidenceFile').addEventListener('change', handleFileUpload);
            setupDragAndDrop();
        });

    // Track selected doc_type for typed uploads
    let __selectedDocType = null;
    function beginGenericUpload(){ __selectedDocType = null; document.getElementById('evidenceFile').click(); }
    function startTypedUpload(docType){ __selectedDocType = docType || null; document.getElementById('evidenceFile').click(); }

    async function loadDashboard() {
            const token = localStorage.getItem('access_token') || localStorage.getItem('jwt_token');
            
            try {
                showLoading();
                
                // Bridge: persist onboarding data into settings once
                try {
                    const persistedFlag = sessionStorage.getItem('a3e_onboarding_persisted');
                    const onboardingRaw = sessionStorage.getItem('a3e_onboarding_data');
                    if (!persistedFlag && onboardingRaw) {
                        const ob = JSON.parse(onboardingRaw);
                        const payload = {};
                        if (ob && ob.institution_name) payload.organization = ob.institution_name;
                        if (ob && ob.primary_accreditor) payload.primary_accreditor = ob.primary_accreditor;
                        if (ob && ob.state) payload.state = ob.state;
                        if (ob && ob.institution_size) payload.institution_size = ob.institution_size;
                        if (ob && ob.launch_timing) payload.launch_timing = ob.launch_timing;
                        if (ob && ob.success_definition) payload.success_definition = ob.success_definition;
                        if (ob && Array.isArray(ob.goals)) payload.goals = ob.goals;
                        if (ob && ob.doc_types) {
                            payload.document_types = Array.isArray(ob.doc_types) ? ob.doc_types : String(ob.doc_types).split(',').map(s=>s.trim()).filter(Boolean);
                        }
                        if (Object.keys(payload).length > 0 && token) {
                            await saveSettings(payload);
                            await fetchSettings();
                            sessionStorage.setItem('a3e_onboarding_persisted', '1');
                        }
                    }
                } catch (e) { console.warn('Onboarding-to-settings bridge failed', e); }

                // Load dashboard overview
        const response = await fetch(`${API_BASE}/api/user/intelligence-simple/dashboard/overview`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Dashboard load failed: ${response.status}`);
                }

                dashboardData = await response.json();
                displayDashboard(dashboardData);
                // ensure suggestions reflect latest settings
                renderSuggestedUploads();
                
                // Load metrics
                await loadMetrics();
                
            } catch (error) {
                console.error('Dashboard load error:', error);
                showError(`Failed to load dashboard: ${error.message}`);
            }
        }

    async function loadMetrics() {
            const token = localStorage.getItem('access_token') || localStorage.getItem('jwt_token');
            
            try {
        const response = await fetch(`${API_BASE}/api/user/intelligence-simple/metrics/summary`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const metrics = await response.json();
                    displayMetrics(metrics);
                }
            } catch (error) {
                console.error('Metrics load error:', error);
            }
        }

        function displayDashboard(data) {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('errorState').classList.add('hidden');
            document.getElementById('dashboardContent').classList.remove('hidden');

            // Update user info
            const user = (data && data.user) || {};
            const s = (userSettings && userSettings.settings) || {};
            const institutionName = user.institution_name || s.organization || 'A³E user';
            const accreditorName = user.primary_accreditor || s.primary_accreditor || 'Accreditor';
            const lmsInfo = s.lms ? ` • LMS: ${s.lms}` : '';
            const termInfo = s.term_system ? ` • Term: ${s.term_system}` : '';
            document.getElementById('userEmail').textContent = user.email || '—';
            document.getElementById('welcomeMessage').textContent = `Welcome, ${institutionName}!`;
            document.getElementById('institutionInfo').textContent = `${accreditorName} Accreditation Management${lmsInfo}${termInfo}`;

            // Normalize compliance score percent (overview API returns metrics.compliance_score)
            const score = (data && data.metrics && typeof data.metrics.compliance_score === 'number') ? data.metrics.compliance_score : 0;
            const scorePct = (score > 1 ? score : score * 100);
            const scoreText = `${(isFinite(scorePct) ? scorePct.toFixed(1) : '0.0')}%`;
            document.getElementById('complianceScore').textContent = scoreText;
            document.getElementById('metricCompliance').textContent = scoreText;

            // Basic metrics from overview
            const standardsCount = (data && data.metrics && (data.metrics.standards_count ?? data.metrics.standards_mapped)) ?? '--';
            const gapsOrPending = (data && data.metrics && (data.metrics.pending_actions ?? data.metrics.gaps_identified)) ?? '--';
            document.getElementById('metricStandards').textContent = standardsCount;
            document.getElementById('metricGaps').textContent = gapsOrPending;
            // Documents will be filled by metrics summary if available
            document.getElementById('metricDocuments').textContent = document.getElementById('metricDocuments').textContent || '--';

            // Show guidance if personalization is missing
            try {
                const missing = (data && Array.isArray(data.missing_inputs)) ? data.missing_inputs : ((data && data.data_status && data.data_status.missing_inputs) || []);
                const panel = document.getElementById('dataStatusPanel');
                const list = document.getElementById('missingInputsList');
                if (missing.length) {
                    panel.classList.remove('hidden');
                    list.innerHTML = missing.map(m => `<li>${m}</li>`).join('');
                } else {
                    panel.classList.add('hidden');
                }
            } catch (_) {}
        }

        function displayMetrics(data) {
            // Prefer new metrics shape
            const m = data && data.metrics ? data.metrics : null;
            if (m) {
                // Immediate documents count if provided
                if (m.documents_uploaded != null) {
                    document.getElementById('metricDocuments').textContent = m.documents_uploaded;
                }
                if (m.coverage) {
                    // Only override when coverage values are positive to avoid showing placeholder counts
                    if (m.coverage.documents_processed != null && Number(m.coverage.documents_processed) > 0) {
                        document.getElementById('metricDocuments').textContent = m.coverage.documents_processed;
                    }
                    if (m.coverage.standards_analyzed != null && Number(m.coverage.standards_analyzed) > 0) {
                        document.getElementById('metricStandards').textContent = m.coverage.standards_analyzed;
                    }
                }
                // Do not overwrite compliance % unless a dedicated metric is provided
                if (typeof m.overall_percentage === 'number') {
                    document.getElementById('metricCompliance').textContent = `${m.overall_percentage}%`;
                }
                if (typeof m.gaps_identified === 'number') {
                    document.getElementById('metricGaps').textContent = m.gaps_identified;
                }
            } else if (data && data.compliance_metrics) {
                // Backward-compat support
                const cm = data.compliance_metrics;
                if (typeof cm.overall_percentage === 'number') {
                    document.getElementById('metricCompliance').textContent = `${cm.overall_percentage}%`;
                }
                if (cm.documents_analyzed != null) {
                    document.getElementById('metricDocuments').textContent = cm.documents_analyzed;
                }
                if (cm.standards_covered != null) {
                    document.getElementById('metricStandards').textContent = (cm.standards_total != null) ? `${cm.standards_covered}/${cm.standards_total}` : cm.standards_covered;
                }
                if (cm.gaps_identified != null) {
                    document.getElementById('metricGaps').textContent = cm.gaps_identified;
                }
            }
        }

    async function handleFileUpload(event) {
            const files = event.target.files || [];
            const count = files.length || 0;
            if (!count) return;

            const token = localStorage.getItem('access_token') || localStorage.getItem('jwt_token');
            const single = count === 1;
            const formData = new FormData();
            if (single) {
                formData.append('file', files[0]);
            } else {
                for (const f of files) { formData.append('files', f); }
            }
            if (__selectedDocType) { formData.append('doc_type', __selectedDocType); }

            try {
                showAnalysisLoading();

                const response = await fetch(`${API_BASE}/api/user/intelligence-simple/${single ? 'evidence/analyze' : 'evidence/analyze/bulk'}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`Analysis failed: ${response.status}`);
                }

                const result = await response.json();
                if (single) {
                    displayAnalysisResults(result);
                } else {
                    const ok = Array.isArray(result.results) ? result.results.filter(r => r.status === 'success') : [];
                    const last = ok.length ? ok[ok.length - 1] : null;
                    if (last) displayAnalysisResults(last);
                    showToast(`Analyzed ${count} documents.`, { variant: ok.length === count ? 'success' : 'warn' });
                }
                // Capture the doc_type for toast before clearing
                const justUploadedDocType = __selectedDocType;
                __selectedDocType = null;

                // Refresh dashboard metrics
                await loadMetrics();
                // Light refresh of overview without flicker
                await refreshOverview();
                // Show confirmation toast (include doc type if provided)
                const typed = justUploadedDocType ? ` (${justUploadedDocType})` : '';
                const fname = (result && result.filename) ? `: ${result.filename}` : '';
                showToast(`Upload complete${typed}${fname}. Metrics refreshed.`);
                // Reset file input to allow same-file re-uploads
                try { event.target.value = ''; } catch (_) {}

            } catch (error) {
                console.error('File analysis error:', error);
                showAnalysisError(error.message);
            }
        }

    function setupDragAndDrop(){
        const dz = document.getElementById('dropZone');
        if (!dz) return;
        const prevent = (e) => { e.preventDefault(); e.stopPropagation(); };
        ['dragenter','dragover','dragleave','drop'].forEach(evt => dz.addEventListener(evt, prevent));
        dz.addEventListener('dragover', ()=> dz.classList.add('ring','ring-blue-300'));
        dz.addEventListener('dragleave', ()=> dz.classList.remove('ring','ring-blue-300'));
        dz.addEventListener('drop', async (e)=>{
            dz.classList.remove('ring','ring-blue-300');
            const dt = e.dataTransfer;
            if (!dt || !dt.files || !dt.files.length) return;
            const input = document.getElementById('evidenceFile');
            try {
                const dataT = new DataTransfer();
                for (const f of dt.files) dataT.items.add(f);
                input.files = dataT.files;
                input.dispatchEvent(new Event('change'));
            } catch(_) {
                for (const f of dt.files) {
                    const fakeEvt = { target: { files: [f] } };
                    await handleFileUpload(fakeEvt);
                }
            }
        });
    }

    async function loadStandardsGraph() {
            const token = localStorage.getItem('access_token') || localStorage.getItem('jwt_token');
            
            try {
                document.getElementById('standardsGraphSection').classList.remove('hidden');
        const acc = (userSettings && userSettings.settings && userSettings.settings.primary_accreditor) ? `?accreditor=${encodeURIComponent(userSettings.settings.primary_accreditor)}` : '';
        const response = await fetch(`${API_BASE}/api/user/intelligence-simple/standards/graph${acc}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Standards graph load failed: ${response.status}`);
                }

                const graphData = await response.json();
                displayStandardsGraph(graphData);
                // Category coverage
                try {
                    const catRes = await fetch(`${API_BASE}/api/user/intelligence-simple/standards/categories${acc}`, { headers: { 'Authorization': `Bearer ${token}` } });
                    if (catRes.ok) {
                        const cat = await catRes.json();
                        renderCategoryCoverage(cat);
                    }
                } catch (_) {}

            } catch (error) {
                console.error('Standards graph error:', error);
                document.getElementById('standardsContent').innerHTML = `
                    <div class="text-red-600">
                        <i class="fas fa-exclamation-circle mr-2"></i>
                        Failed to load standards graph: ${error.message}
                    </div>
                `;
            }
        }
        function renderCategoryCoverage(cat) {
            if (!cat || !cat.categories) return;
            const rows = Object.entries(cat.categories).map(([name, count]) => `
                <div class="flex items-center justify-between border-b py-1">
                    <span>${name}</span>
                    <span class="text-gray-600">${count}</span>
                </div>
            `).join('');
            document.getElementById('categoryCoverage').innerHTML = `
                <h4 class="font-medium mb-2">Category Coverage</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">${rows}</div>
            `;
        }

        async function loadGapAnalysis() {
            const token = localStorage.getItem('access_token') || localStorage.getItem('jwt_token');
            
            try {
                document.getElementById('gapAnalysisSection').classList.remove('hidden');
                
                const response = await fetch(`${API_BASE}/api/user/intelligence-simple/compliance/gaps`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Gap analysis failed: ${response.status}`);
                }

                const gapData = await response.json();
                displayGapAnalysis(gapData);

            } catch (error) {
                console.error('Gap analysis error:', error);
                document.getElementById('gapContent').innerHTML = `
                    <div class="text-red-600">
                        <i class="fas fa-exclamation-circle mr-2"></i>
                        Failed to load gap analysis: ${error.message}
                    </div>
                `;
            }
        }

        // Quick action: Open Narrative panel
        async function openNarrative(){
            try {
                const sec = document.getElementById('narrativeSection');
                if (sec) {
                    sec.classList.remove('hidden');
                    // If content empty, trigger generation once
                    const out = document.getElementById('narrativeContent');
                    if (out && !out.innerHTML.trim()) {
                        const btn = document.getElementById('generateNarrativeBtn');
                        if (btn) btn.click();
                    }
                    sec.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            } catch (_) {}
        }

        function displayAnalysisResults(data) {
            document.getElementById('analysisResults').classList.remove('hidden');
            const isPdf = !!(data && data.analysis && data.analysis.is_pdf);
            const previewRaw = (data && data.analysis && data.analysis.document_preview) ? String(data.analysis.document_preview) : '';
            // Defensive: if the backend missed a PDF, suppress when magic header is present
            const looksLikePdf = /^%PDF-/.test(previewRaw.trim());
            const preview = (isPdf || looksLikePdf) ? '' : previewRaw;
            const spans = (data && data.analysis && Array.isArray(data.analysis.mappings)) ? data.analysis.mappings.flatMap(m => Array.isArray(m.rationale_spans) ? m.rationale_spans : []) : [];
            const highlightedPreview = highlightPreview(preview, spans);
            
            const mappingsHtml = data.analysis.mappings.map((mapping, idx) => `
                <div class="border rounded p-3 mb-2">
                    <div class="font-medium">${mapping.standard_id}</div>
                    <div class="text-sm text-gray-600 mb-1">${mapping.title}</div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">
                            Confidence: ${(mapping.confidence * 100).toFixed(1)}%
                        </span>
                        <span class="text-xs text-gray-500">${mapping.accreditor}</span>
                    </div>
                    <div class="mt-2 text-xs ${mapping.meets_standard ? 'text-green-700' : 'text-yellow-700'}">
                        ${mapping.meets_standard ? 'Meets standard' : 'Partially meets / needs evidence'} (${mapping.match_type})
                    </div>
                    <div class="mt-2 flex items-center gap-2">
                        <button class="text-xs text-blue-600 hover:text-blue-800 view-details" data-standard="${mapping.standard_id}">View details</button>
                    </div>
                    <div class="mt-2 flex items-center gap-3">
                        <label class="inline-flex items-center gap-2 text-xs">
                            <input type="checkbox" class="review-toggle" data-standard="${mapping.standard_id}" ${mapping.reviewed ? 'checked' : ''} />
                            Mark as reviewed
                        </label>
                        <input type="text" placeholder="Add note" value="${(mapping.note||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;')}" class="note-input text-xs border rounded px-2 py-1 flex-1" data-standard="${mapping.standard_id}" />
                        <button class="save-note text-xs bg-gray-800 text-white px-2 py-1 rounded" data-standard="${mapping.standard_id}">Save</button>
                    </div>
                    <div class="mt-2">
                        <label class="block text-xs text-gray-600">Rationale annotation</label>
                        <textarea class="rationale-input w-full text-xs border rounded px-2 py-1" rows="2" data-standard="${mapping.standard_id}" placeholder="Add context or corrections to the rationale...">${(mapping.rationale_note||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</textarea>
                        <div class="mt-1 flex items-center gap-2">
                            <button class="save-rationale text-xs bg-gray-700 text-white px-2 py-1 rounded" data-standard="${mapping.standard_id}">Save rationale</button>
                            <button class="add-selected text-xs bg-blue-600 text-white px-2 py-1 rounded" data-standard="${mapping.standard_id}">Add selected text</button>
                        </div>
                    </div>
                    ${Array.isArray(mapping.rationale_spans) && mapping.rationale_spans.length ? `
                        <details class="mt-2">
                            <summary class="text-xs text-gray-700 cursor-pointer">Show rationale excerpts</summary>
                            <ul class="list-disc list-inside text-sm mt-1">
                                ${mapping.rationale_spans.map(span => `<li>${span}</li>`).join('')}
                            </ul>
                            ${mapping.explanation ? `<div class="mt-2 text-xs text-gray-600">${mapping.explanation}</div>` : ''}
                            <div class="mt-2">
                                <a href="#" class="text-xs text-blue-600 hover:text-blue-800 view-in-preview" data-span="${(mapping.rationale_spans[0] || '').replace(/"/g, '&quot;')}">View in preview</a>
                            </div>
                        </details>
                    ` : ''}
                </div>
            `).join('');

            document.getElementById('analysisContent').innerHTML = `
                <div class="success-message">
                    <h4 class="font-semibold">Analysis Complete: ${data.filename}</h4>
                    <p>Document processed with EvidenceMapper™ and EvidenceTrust Score™</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                    <div>
                        <h5 class="font-medium mb-2">Trust Score Analysis</h5>
                        <div class="bg-gray-50 p-3 rounded text-sm">
                            <div class="flex items-center gap-2">
                                <span>Overall Score:</span>
                                <span class="font-semibold" title="Weighted blend of quality, reliability, and confidence metrics">${(data.analysis.trust_score.overall_score * 100).toFixed(1)}%</span>
                            </div>
                            <div title="Source clarity, citations, and policy alignment">Quality: ${(data.analysis.trust_score.quality_score * 100).toFixed(1)}%</div>
                            <div title="Consistency across sections and corroboration">Reliability: ${(data.analysis.trust_score.reliability_score * 100).toFixed(1)}%</div>
                            <div title="Model certainty in this context">Confidence: ${(data.analysis.trust_score.confidence_score * 100).toFixed(1)}%</div>
                        </div>
                    </div>
                    <div>
                        <h5 class="font-medium mb-2">Mapping Statistics</h5>
                        <div class="bg-gray-50 p-3 rounded">
                            <div>Standards Mapped: <span class="font-semibold">${data.analysis.standards_mapped}</span></div>
                            <div>Content Length: ${data.analysis.content_length} chars</div>
                            <div>Processing: Complete</div>
                        </div>
                    </div>
                </div>

                <div>
                    <h5 class="font-medium mb-2">Standards Mappings (Top ${data.analysis.mappings.length})</h5>
                    ${renderQuickLinks(data.analysis.mappings)}
                    <div class="max-h-64 overflow-y-auto">
                        ${mappingsHtml}
                    </div>
                </div>

                ${(!isPdf && preview) ? `
                <div class="mt-6">
                    <h5 class="font-medium mb-2">Document Preview (excerpts)</h5>
                    <div class="bg-white border rounded p-3 max-h-64 overflow-y-auto text-sm leading-relaxed" id="docPreview">${highlightedPreview}</div>
                    <p class="text-xs text-gray-500 mt-2">Highlighted text shows excerpts used as rationale.</p>
                </div>` : `
                <div class="mt-6">
                    <div class="bg-yellow-50 border border-yellow-200 text-yellow-900 rounded p-3 text-sm">
                        Document preview unavailable for PDFs. You can still use mappings and trust scores above.
                    </div>
                </div>
                `}
            `;

            // Delegate clicks to view-in-preview links and review/note actions
            const container = document.getElementById('analysisContent');
            container.querySelectorAll('.view-in-preview').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const spanText = e.currentTarget.getAttribute('data-span') || '';
                    scrollToRationale(spanText);
                });
            });
            container.querySelectorAll('.view-details').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const standard = e.currentTarget.getAttribute('data-standard');
                    await openMappingDetails(standard);
                });
            });
            container.querySelectorAll('.review-toggle').forEach(cb => {
                cb.addEventListener('change', async (e) => {
                    const standard = e.currentTarget.getAttribute('data-standard');
                    const reviewed = e.currentTarget.checked;
                    try {
                        await saveReview(data.filename, standard, { reviewed });
                    } catch (err) { console.error('Save review failed', err); }
                });
            });
            container.querySelectorAll('.save-note').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const standard = e.currentTarget.getAttribute('data-standard');
                    const input = container.querySelector(`.note-input[data-standard="${standard}"]`);
                    const note = (input && input.value) || '';
                    try {
                        await saveReview(data.filename, standard, { note });
                        btn.textContent = 'Saved';
                        setTimeout(() => btn.textContent = 'Save', 1200);
                    } catch (err) { console.error('Save note failed', err); }
                });
            });
            container.querySelectorAll('.save-rationale').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const standard = e.currentTarget.getAttribute('data-standard');
                    const input = container.querySelector(`.rationale-input[data-standard="${standard}"]`);
                    const rationale_note = (input && input.value) || '';
                    try {
                        await saveReview(data.filename, standard, { rationale_note });
                        btn.textContent = 'Saved';
                        setTimeout(() => btn.textContent = 'Save rationale', 1200);
                    } catch (err) { console.error('Save rationale failed', err); }
                });
            });
            // Add selected text as rationale span
            container.querySelectorAll('.add-selected').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const standard = e.currentTarget.getAttribute('data-standard');
                    const sel = window.getSelection ? String(window.getSelection()) : '';
                    const spanText = (sel || '').trim();
                    if (!spanText) { alert('Select text in the preview pane first.'); return; }
                    try {
                        const token = localStorage.getItem('access_token') || localStorage.getItem('jwt_token');
                        const res = await fetch(`${API_BASE}/api/user/intelligence-simple/evidence/annotate`, {
                            method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ filename: data.filename, standard_id: standard, span: spanText })
                        });
                        if (res.ok) {
                            e.currentTarget.textContent = 'Added';
                            setTimeout(() => e.currentTarget.textContent = 'Add selected text', 1200);
                        }
                    } catch (_) {}
                });
            });
            // Mark all reviewed
            const markAllBtn = document.getElementById('markAllReviewedBtn');
            markAllBtn.onclick = async () => {
                try {
                    const cards = Array.from(container.querySelectorAll('.review-toggle'));
                    await Promise.all(cards.map(async cb => {
                        const standard = cb.getAttribute('data-standard');
                        cb.checked = true;
                        await saveReview(data.filename, standard, { reviewed: true });
                    }));
                } catch (e) { console.error('Mark all reviewed failed', e); }
            };

            // Export report
            const exportBtn = document.getElementById('exportReportBtn');
            exportBtn.onclick = async () => {
                try {
                    const token = localStorage.getItem('access_token') || localStorage.getItem('jwt_token');
                    const res = await fetch(`${API_BASE}/api/user/intelligence-simple/evidence/report`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ filename: data.filename, analysis: data.analysis })
                    });
                    if (!res.ok) throw new Error('Failed to generate report');
                    const out = await res.json();
                    const w = window.open('', '_blank');
                    w.document.write(out.html || '<p>No report content</p>');
                    w.document.close();
                } catch (e) {
                    alert('Export failed');
                }
            };

            // Export CSV
            const exportCsvBtn = document.getElementById('exportCsvBtn');
            exportCsvBtn.onclick = async () => {
                try {
                    const token = localStorage.getItem('access_token') || localStorage.getItem('jwt_token');
                    const res = await fetch(`${API_BASE}/api/user/intelligence-simple/evidence/report.csv`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ filename: data.filename, analysis: data.analysis })
                    });
                    if (!res.ok) throw new Error('Failed to generate CSV');
                    const blob = await res.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `evidence_report_${(data.filename || 'document').replace(/[^\w.-]/g,'_')}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    window.URL.revokeObjectURL(url);
                } catch (e) {
                    alert('Export CSV failed');
                }
            };
        }

    function displayStandardsGraph(data) {
            document.getElementById('currentAccreditor').textContent = data.accreditor;

            // Client-side search + pagination
            const entries = Object.entries(data.standards);
            let filtered = entries;
            let page = 1;
            const pageSize = 20;

            function renderList() {
                const start = (page - 1) * pageSize;
                const slice = filtered.slice(start, start + pageSize);
                const listHtml = slice.map(([id, standard]) => `
                    <div class="border rounded p-3 mb-2 hover:bg-gray-50">
                        <div class="font-medium text-sm">${id}</div>
                        <div class="text-sm text-gray-600">${standard.title}</div>
                        <div class="text-xs text-gray-500 mt-1">
                            Category: ${standard.category} | Domain: ${standard.domain}
                        </div>
                    </div>
                `).join('');
                document.getElementById('standardsList').innerHTML = listHtml || '<div class="text-sm text-gray-500">No standards</div>';
                const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
                document.getElementById('standardsPageInfo').textContent = `Page ${page} of ${totalPages}`;
                (document.getElementById('prevStandardsPage')).disabled = page <= 1;
                (document.getElementById('nextStandardsPage')).disabled = page >= totalPages;
                document.getElementById('standardsShowing').textContent = `${slice.length} of ${filtered.length}`;
            }

            const accChips = (data.available_accreditors || []).map(acc => `
                <button data-acc="${acc}" class="px-3 py-1 rounded-full text-sm border ${acc === data.accreditor ? 'bg-blue-600 text-white border-blue-600' : 'bg-gray-100 text-gray-800 border-gray-300'} hover:opacity-90 acc-chip">${acc}</button>
            `).join('');

            document.getElementById('standardsContent').innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="bg-blue-50 p-4 rounded">
                        <div class="text-2xl font-bold text-blue-600">${data.total_standards}</div>
                        <div class="text-sm text-gray-600">Total Standards</div>
                    </div>
                    <div class="bg-green-50 p-4 rounded">
                        <div class="text-2xl font-bold text-green-600">${data.relationships.length}</div>
                        <div class="text-sm text-gray-600">Relationships</div>
                    </div>
                    <div class="bg-purple-50 p-4 rounded">
                        <div class="text-2xl font-bold text-purple-600">${data.available_accreditors.length}</div>
                        <div class="text-sm text-gray-600">Accreditors</div>
                    </div>
                </div>

                <div class="mb-4">
                    <h5 class="font-medium mb-2">Available Accreditors</h5>
                    <div class="flex flex-wrap gap-2">${accChips}</div>
                    <div class="mt-2 text-xs text-gray-500">Click to switch accreditor; selection will be saved to your settings.</div>
                </div>

                <div>
                    <div class="flex items-center justify-between mb-2">
                        <h5 class="font-medium">Standards (<span id="standardsShowing"></span> of ${data.total_standards})</h5>
                        <div class="flex items-center gap-2">
                            <input id="standardsSearch" type="text" placeholder="Search by code or title" class="border rounded px-2 py-1 text-sm" />
                            <button id="prevStandardsPage" class="px-2 py-1 border rounded text-sm">Prev</button>
                            <span id="standardsPageInfo" class="text-xs text-gray-600"></span>
                            <button id="nextStandardsPage" class="px-2 py-1 border rounded text-sm">Next</button>
                        </div>
                    </div>
                    <div id="standardsList" class="max-h-96 overflow-y-auto"></div>
                </div>
            `;

            // Attach click handlers to accreditor chips
            document.querySelectorAll('#standardsContent .acc-chip').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const acc = e.currentTarget.getAttribute('data-acc');
                    try {
                        await saveSettings({ primary_accreditor: acc });
                        await fetchSettings();
                        await loadStandardsGraph();
                    } catch (err) {
                        console.error('Failed to save accreditor setting', err);
                    }
                });
            });

            // Search & pagination handlers
            const searchInput = document.getElementById('standardsSearch');
            searchInput.addEventListener('input', () => {
                const q = (searchInput.value || '').toLowerCase();
                filtered = entries.filter(([id, st]) => id.toLowerCase().includes(q) || (st.title || '').toLowerCase().includes(q));
                page = 1;
                renderList();
            });
            document.getElementById('prevStandardsPage').addEventListener('click', () => { if (page > 1) { page--; renderList(); } });
            document.getElementById('nextStandardsPage').addEventListener('click', () => { const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize)); if (page < totalPages) { page++; renderList(); } });

            // Initial render
            renderList();

            // Interactive force graph
            try {
                const svg = d3.select('#standardsGraphSvg');
                if (svg.node()) {
                    svg.selectAll('*').remove();
                    const width = svg.node().clientWidth || 600;
                    const height = +svg.attr('height') || 360;
                    const nodes = Object.keys(data.standards).map((id) => ({ id }));
                    const links = data.relationships.map(r => ({ source: r.source, target: r.target }));
                    // Preload evidence map for tooltips
                    let evidenceMap = {};
                    // track accreditors per standard from evidence map for cross-accreditor filter
                    let accreditorsByStandard = {};
                    (async () => {
                        try {
                            const token = localStorage.getItem('access_token') || localStorage.getItem('jwt_token');
                            const emRes = await fetch(`${API_BASE}/api/user/intelligence-simple/standards/evidence-map`, { headers: { 'Authorization': `Bearer ${token}` } });
                            if (emRes.ok) {
                                const em = await emRes.json();
                                evidenceMap = em && em.mapping ? em.mapping : {};
                                accreditorsByStandard = {};
                                Object.entries(evidenceMap).forEach(([sid, items]) => {
                                    const set = new Set();
                                    (items||[]).forEach(it => { if (it && it.accreditor) set.add(it.accreditor); });
                                    accreditorsByStandard[sid] = set;
                                });
                                // recompute reuse edges now that evidence map is loaded
                                if (typeof updateReuse === 'function') updateReuse();
                            }
                        } catch(_) {}
                    })();

                    const sim = d3.forceSimulation(nodes)
                        .force('link', d3.forceLink(links).id(d => d.id).distance(60))
                        .force('charge', d3.forceManyBody().strength(-120))
                        .force('center', d3.forceCenter(width/2, height/2));
                    const link = svg.append('g').attr('stroke', '#d1d5db').selectAll('line').data(links).enter().append('line').attr('stroke-width', 1);
                    const node = svg.append('g').selectAll('circle').data(nodes).enter().append('circle')
                        .attr('r', 5).attr('fill', '#3b82f6').attr('aria-label','standard node')
                        .call(d3.drag().on('start', dragstarted).on('drag', dragged).on('end', dragended));

                    // Reuse links layer (dashed green) between standards that share evidence
                    const nodeById = Object.fromEntries(nodes.map(n => [n.id, n]));
                    let reuse = svg.append('g').attr('class','reuse-links').selectAll('line');
                    function computeReuseEdges(){
                        const byFile = {};
                        Object.entries(evidenceMap || {}).forEach(([sid, items]) => {
                            (items || []).forEach(it => {
                                const f = it && it.filename; if (!f) return;
                                if (!byFile[f]) byFile[f] = new Set();
                                byFile[f].add(sid);
                            });
                        });
                        const seen = new Set();
                        const edges = [];
                        Object.values(byFile).forEach(set => {
                            const arr = Array.from(set);
                            for (let i=0;i<arr.length;i++){
                                for (let j=i+1;j<arr.length;j++){
                                    const a = arr[i], b = arr[j];
                                    const key = a < b ? a+'|'+b : b+'|'+a;
                                    if (!seen.has(key)) {
                                        seen.add(key);
                                        // optional cross-accreditor-only filter
                                        const crossOnly = !!document.getElementById('toggleCrossAccOnly')?.checked;
                                        if (crossOnly) {
                                            const setA = accreditorsByStandard[a] || new Set();
                                            const setB = accreditorsByStandard[b] || new Set();
                                            // keep only if disjoint or no intersection
                                            let intersects = false;
                                            for (const val of setA) { if (setB.has(val)) { intersects = true; break; } }
                                            if (intersects) continue;
                                        }
                                        edges.push({ source:a, target:b });
                                    }
                                }
                            }
                        });
                        return edges;
                    }
                    function applyReuseVisibility(){
                        const on = !!document.getElementById('toggleReuseLinks')?.checked;
                        reuse.style('display', on ? null : 'none');
                    }
                    function updateReuse(){
                        const edges = computeReuseEdges();
                        reuse = reuse.data(edges, d => d.source + '|' + d.target);
                        reuse.exit().remove();
                        reuse = reuse.enter().append('line')
                            .attr('stroke', '#16a34a')
                            .attr('stroke-dasharray', '3,3')
                            .attr('stroke-width', 1)
                            .merge(reuse);
                        applyReuseVisibility();
                    }
                    document.getElementById('toggleReuseLinks')?.addEventListener('change', applyReuseVisibility);
                    document.getElementById('toggleCrossAccOnly')?.addEventListener('change', () => updateReuse());
                    node.on('mousemove', (event, d) => {
                        const t = document.getElementById('graphTooltip');
                        if (!t) return;
                        const items = (evidenceMap[d.id] || []).slice(0, 6);
                        const list = items.length ? items.map(it => `
                            <div class='flex items-center justify-between gap-2'>
                                <div class='truncate' title='${it.filename || ''}'>${(it.filename || '').replace(/&/g,'&amp;').replace(/</g,'&lt;')}</div>
                                <div class='text-gray-500 whitespace-nowrap'>${(it.doc_type||'').slice(0,16)}</div>
                                <div class='text-gray-700 font-medium whitespace-nowrap'>${typeof it.confidence==='number' ? Math.round(it.confidence*100)+'%' : ''}</div>
                            </div>`).join('') : "<div class='text-gray-500'>No evidence yet</div>";
                        t.innerHTML = `<div class='text-[11px] text-gray-500 mb-1'>${d.id}</div>${list}`;
                        t.style.left = Math.min(event.pageX + 16, window.scrollX + window.innerWidth - 280) + 'px';
                        t.style.top = Math.min(event.pageY + 16, window.scrollY + window.innerHeight - 120) + 'px';
                        t.classList.remove('hidden');
                        // highlight connected
                        link.attr('stroke', l => (l.source.id===d.id || l.target.id===d.id) ? '#60a5fa' : '#e5e7eb').attr('stroke-width', l => (l.source.id===d.id || l.target.id===d.id) ? 2 : 1);
                        // highlight reuse edges
                        reuse.attr('stroke', l => (l.source===d.id || l.target===d.id) ? '#16a34a' : '#bbf7d0');
                    }).on('mouseleave', () => {
                        const t = document.getElementById('graphTooltip');
                        if (t) t.classList.add('hidden');
                        link.attr('stroke', '#d1d5db').attr('stroke-width', 1);
                        reuse.attr('stroke', '#16a34a');
                    }).on('click', (event, d) => {
                        // open details modal if available
                        if (typeof openMappingDetails === 'function') {
                            openMappingDetails(d.id);
                        }
                    });
                    node.append('title').text(d => d.id);
                    sim.on('tick', () => {
                        link.attr('x1', d => d.source.x).attr('y1', d => d.source.y).attr('x2', d => d.target.x).attr('y2', d => d.target.y);
                        node.attr('cx', d => d.x).attr('cy', d => d.y);
                        // position reuse links using node positions
                        reuse.attr('x1', d => (nodeById[d.source]||{}).x)
                             .attr('y1', d => (nodeById[d.source]||{}).y)
                             .attr('x2', d => (nodeById[d.target]||{}).x)
                             .attr('y2', d => (nodeById[d.target]||{}).y);
                    });
                    function dragstarted(event, d){ if (!event.active) sim.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; }
                    function dragged(event, d){ d.fx = event.x; d.fy = event.y; }
                    function dragended(event, d){ if (!event.active) sim.alphaTarget(0); d.fx = null; d.fy = null; }
                }
            } catch (_) { /* ignore graph errors */ }
        }

        function displayGapAnalysis(data) {
            const riskColor = data.risk_assessment.risk_level === 'Low' ? 'green' : 
                            data.risk_assessment.risk_level === 'Medium' ? 'yellow' : 'red';


        // ----- Enhancements: Standards search, Narrative, Risk transparency -----
        document.addEventListener('DOMContentLoaded', () => {
            // Standards global search
            const searchBtn = document.getElementById('standardsSearchBtn');
            const searchInput = document.getElementById('standardsSearchGlobal');
            const searchOut = document.getElementById('standardsSearchResults');
            if (searchBtn && searchInput && searchOut) {
                const runSearch = async () => {
                    const q = (searchInput.value || '').trim();
                    if (!q) { searchOut.innerHTML = ''; return; }
                    try {
                        const token = localStorage.getItem('access_token') || localStorage.getItem('jwt_token');
                        const res = await fetch(`${API_BASE}/api/user/intelligence-simple/standards/search?q=${encodeURIComponent(q)}`, { headers: { 'Authorization': `Bearer ${token}` } });
                        if (!res.ok) throw new Error(`HTTP ${res.status}`);
                        const data = await res.json();
                        searchOut.innerHTML = (data.results || []).map(r => `
                            <div class='border rounded p-2 mb-1 hover:bg-gray-50 cursor-pointer' data-sid='${r.id}'>
                                <div class='text-sm font-medium'>${r.code}</div>
                                <div class='text-xs text-gray-600'>${r.title}</div>
                                ${r.snippet ? `<div class='text-xs text-gray-500 mt-1'>${r.snippet}</div>` : ''}
                            </div>
                        `).join('');
                        searchOut.querySelectorAll('[data-sid]').forEach(el => {
                            el.addEventListener('click', () => {
                                loadStandardsGraph();
                            });
                        });
                    } catch (e) {
                        searchOut.innerHTML = `<div class='text-xs text-red-600'>Search failed</div>`;
                    }
                };
                searchBtn.addEventListener('click', runSearch);
                searchInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') runSearch(); });
            }

            // Narrative generation (CiteGuard-lite)
            const genBtn = document.getElementById('generateNarrativeBtn');
            const narOut = document.getElementById('narrativeContent');
            if (genBtn && narOut) {
                genBtn.addEventListener('click', async () => {
                    narOut.innerHTML = '<div class="text-gray-500 text-sm">Generating narrative…</div>';
                    try {
                        const token = localStorage.getItem('access_token') || localStorage.getItem('jwt_token');
                        const res = await fetch(`${API_BASE}/api/user/intelligence-simple/narrative/generate`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: '{}' });
                        if (!res.ok) throw new Error(`HTTP ${res.status}`);
                        const data = await res.json();
                        narOut.innerHTML = data.html || '<div class="text-sm text-gray-600">No content</div>';
                    } catch (e) {
                        narOut.innerHTML = '<div class="text-sm text-red-600">Failed to generate narrative</div>';
                    }
                });
            }

            // Export Narrative as DOCX
            const exportDocxBtn = document.getElementById('exportNarrativeDocxBtn');
            if (exportDocxBtn && narOut) {
                exportDocxBtn.addEventListener('click', async () => {
                    try {
                        const token = localStorage.getItem('access_token') || localStorage.getItem('jwt_token');
                        const payload = { html: narOut.innerHTML };
                        const res = await fetch(`${API_BASE}/api/user/intelligence-simple/narrative/export.docx`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                        if (!res.ok) throw new Error(`HTTP ${res.status}`);
                        const blob = await res.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url; a.download = 'accreditation_narrative.docx';
                        document.body.appendChild(a); a.click(); a.remove();
                        window.URL.revokeObjectURL(url);
                    } catch (e) {
                        alert('DOCX export failed');
                    }
                });
            }

            // Risk transparency
            const riskOut = document.getElementById('riskFactorsContent');
            const editWeightsLink = document.getElementById('editRiskWeightsLink');
            const loadRisk = async () => {
                if (!riskOut) return;
                try {
                    const token = localStorage.getItem('access_token') || localStorage.getItem('jwt_token');
                    const res = await fetch(`${API_BASE}/api/user/intelligence-simple/risk/factors`, { headers: { 'Authorization': `Bearer ${token}` } });
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    const data = await res.json();
                    const weights = data.weights || {};
                    riskOut.innerHTML = `
                        <div class='grid grid-cols-1 md:grid-cols-2 gap-3'>
                            ${(data.factors||[]).map(f => `
                                <div class='border rounded p-3'>
                                    <div class='flex items-center justify-between'>
                                        <div class='font-medium'>${f.name}</div>
                                        <div class='text-xs text-gray-600'>w=${(weights[f.key] ?? 1.0).toFixed(2)}</div>
                                    </div>
                                    <div class='text-xs text-gray-600 mt-1'>${f.description}</div>
                                </div>`).join('')}
                        </div>
                        <div class='text-xs text-gray-500 mt-2'>Formula: ${data.formula}</div>
                    `;
                } catch (e) {
                    riskOut.innerHTML = '<div class="text-sm text-red-600">Failed to load risk model</div>';
                }
            };
            if (riskOut) loadRisk();
            if (editWeightsLink) {
                editWeightsLink.addEventListener('click', async (e) => {
                    e.preventDefault();
                    try {
                        const token = localStorage.getItem('access_token') || localStorage.getItem('jwt_token');
                        const res = await fetch(`${API_BASE}/api/user/intelligence-simple/risk/weights`, { headers: { 'Authorization': `Bearer ${token}` } });
                        const data = await res.json();
                        const weights = data.weights || {};
                        const newVals = {};
                        for (const [k,v] of Object.entries(weights)) {
                            const nv = prompt(`Weight for ${k}`, String(v));
                            if (nv === null) continue;
                            const f = parseFloat(nv);
                            if (!isNaN(f)) newVals[k] = f;
                        }
                        const save = await fetch(`${API_BASE}/api/user/intelligence-simple/risk/weights`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ weights: newVals }) });
                        if (save.ok) loadRisk();
                    } catch (_) {}
                });
            }
        });
            const categoriesHtml = Object.entries(data.category_risks).map(([category, risk]) => `
                <div class="border rounded p-3 mb-2">
                    <div class="flex justify-between items-center">
                        <span class="font-medium">${category}</span>
                        <span class="bg-${risk > 0.7 ? 'red' : risk > 0.4 ? 'yellow' : 'green'}-100 text-${risk > 0.7 ? 'red' : risk > 0.4 ? 'yellow' : 'green'}-800 px-2 py-1 rounded text-xs">
                            ${(risk * 100).toFixed(1)}% Risk
                        </span>
                    </div>
                </div>
            `).join('');

            document.getElementById('gapContent').innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-${riskColor}-50 p-4 rounded border border-${riskColor}-200">
                        <div class="text-2xl font-bold text-${riskColor}-600">${data.risk_assessment.risk_level}</div>
                        <div class="text-sm text-gray-600">Overall Risk Level</div>
                    </div>
                    <div class="bg-blue-50 p-4 rounded">
                        <div class="text-2xl font-bold text-blue-600">${(data.risk_assessment.confidence * 100).toFixed(1)}%</div>
                        <div class="text-sm text-gray-600">Confidence</div>
                    </div>
                    <div class="bg-purple-50 p-4 rounded">
                        <div class="text-2xl font-bold text-purple-600">${data.risk_assessment.timeline_months}</div>
                        <div class="text-sm text-gray-600">Months to Address</div>
                    </div>
                </div>

                <div class="mb-6">
                    <h5 class="font-medium mb-3">Category Risk Assessment</h5>
                    <div class="space-y-2">
                        ${categoriesHtml}
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h5 class="font-medium mb-3">Recommendations</h5>
                        <ul class="space-y-2">
                            ${data.recommendations.map(rec => `
                                <li class="flex items-start">
                                    <i class="fas fa-check-circle text-green-500 mt-1 mr-2"></i>
                                    <span class="text-sm">${rec}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                    <div>
                        <h5 class="font-medium mb-3">Next Actions</h5>
                        <ul class="space-y-2">
                            ${data.next_actions.map(action => `
                                <li class="flex items-start">
                                    <i class="fas fa-arrow-right text-blue-500 mt-1 mr-2"></i>
                                    <span class="text-sm">${action}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                </div>
            `;
        }

        function showLoading() {
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('errorState').classList.add('hidden');
            document.getElementById('dashboardContent').classList.add('hidden');
        }

        function showError(message) {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('errorState').classList.remove('hidden');
            document.getElementById('dashboardContent').classList.add('hidden');
            document.getElementById('errorMessage').textContent = message;
        }

        // Light refresh of overview card (no loading state flicker)
        async function refreshOverview() {
            const token = localStorage.getItem('access_token') || localStorage.getItem('jwt_token');
            try {
                const response = await fetch(`${API_BASE}/api/user/intelligence-simple/dashboard/overview`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                if (response.ok) {
                    const data = await response.json();
                    displayDashboard(data);
                }
            } catch (e) {
                console.warn('Overview refresh failed', e);
            }
        }

        // Toast helper
        let __toastTimer = null;
        function showToast(message, opts={}){
            const el = document.getElementById('uploadToast');
            if (!el) return;
            el.textContent = message || 'Done';
            // color variants (success|warn|error)
            const v = (opts.variant||'success');
            const bg = v==='error' ? '#dc2626' : v==='warn' ? '#ca8a04' : '#16a34a';
            el.style.background = bg;
            el.classList.remove('hidden');
            clearTimeout(__toastTimer);
            __toastTimer = setTimeout(()=>{ el.classList.add('hidden'); }, opts.duration || 2000);
        }

        function showAnalysisLoading() {
            document.getElementById('analysisResults').classList.remove('hidden');
            document.getElementById('analysisContent').innerHTML = `
                <div class="text-center py-8">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <p class="text-gray-600">Analyzing document with AI algorithms...</p>
                    <p class="text-sm text-gray-500 mt-2">Processing with EvidenceMapper™ and EvidenceTrust Score™</p>
                </div>
            `;
        }

        function showAnalysisError(message) {
            document.getElementById('analysisResults').classList.remove('hidden');
            document.getElementById('analysisContent').innerHTML = `
                <div class="error-message">
                    <h4 class="font-semibold">Analysis Failed</h4>
                    <p>${message}</p>
                </div>
            `;
        }

        // Settings helpers
    async function fetchSettings() {
            const token = localStorage.getItem('access_token') || localStorage.getItem('jwt_token');
            try {
                const res = await fetch(`${API_BASE}/api/user/intelligence-simple/settings`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (res.ok) {
            const data = await res.json();
            // Normalize to always have { settings: {...} }
            userSettings = (data && data.settings) ? data : { settings: data };
            return userSettings;
                }
            } catch (e) {
                console.warn('Settings fetch failed', e);
            }
            return null;
        }

        async function saveSettings(payload) {
            const token = localStorage.getItem('access_token') || localStorage.getItem('jwt_token');
            const res = await fetch(`${API_BASE}/api/user/intelligence-simple/settings`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });
            if (!res.ok) throw new Error('Failed to save settings');
            return res.json();
        }

    async function saveReview(filename, standard_id, payload = {}) {
            const token = localStorage.getItem('access_token') || localStorage.getItem('jwt_token');
            const res = await fetch(`${API_BASE}/api/user/intelligence-simple/evidence/review`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
        body: JSON.stringify({ filename, standard_id, ...payload })
            });
            if (!res.ok) throw new Error('Failed to save review');
            return res.json();
        }

        // Highlight helper for document preview
        function escapeHtml(str) {
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function highlightPreview(text, spans) {
            if (!text) return '';
            let html = escapeHtml(text);
            if (!Array.isArray(spans) || !spans.length) return html;
            // De-duplicate and sort by length desc to avoid nested replacements breaking
            const uniq = Array.from(new Set(spans.filter(s => s && s.trim()))).sort((a, b) => b.length - a.length);
            for (const s of uniq) {
                const esc = escapeHtml(s).replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                try {
                    const re = new RegExp(esc, 'gi');
                    html = html.replace(re, match => `<mark class="bg-yellow-200">${match}</mark>`);
                } catch (_) {
                    // ignore malformed regex
                }
            }
            return html;
        }

        function scrollToRationale(text) {
            if (!text) return;
            const previewEl = document.getElementById('docPreview');
            if (!previewEl) return;
            const marks = Array.from(previewEl.querySelectorAll('mark'));
            const target = marks.find(m => (m.textContent || '').toLowerCase().includes(String(text).toLowerCase()));
            if (target) {
                target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Flash effect
                target.classList.add('ring', 'ring-offset-2', 'ring-yellow-400');
                setTimeout(() => {
                    target.classList.remove('ring', 'ring-offset-2', 'ring-yellow-400');
                }, 1500);
            }
        }

        function renderQuickLinks(mappings) {
            const low = mappings.filter(m => (m.confidence || 0) < 0.7 || (m.match_type || '').toLowerCase() === 'partial').slice(0, 5);
            if (!low.length) return '';
            const buttons = low.map(m => `<button class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded mr-2 quick-link" data-standard="${m.standard_id}">${m.standard_id}</button>`).join('');
            return `<div class="mb-2">Review low-confidence mappings: ${buttons}</div>`;
        }

        async function openMappingDetails(standardId) {
            const token = localStorage.getItem('access_token') || localStorage.getItem('jwt_token');
            const modal = document.getElementById('mappingDetailsModal');
            const content = document.getElementById('mappingDetailsContent');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            content.innerHTML = `<div class='text-center py-6 text-gray-500'>Loading…</div>`;
            try {
                const res = await fetch(`${API_BASE}/api/user/intelligence-simple/standards/detail?standard_id=${encodeURIComponent(standardId)}`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (res.ok) {
                    const d = await res.json();
                    content.innerHTML = `
                        <div>
                            <div class="text-sm text-gray-500">${d.code || d.id}</div>
                            <div class="text-lg font-semibold">${d.title || ''}</div>
                            <div class="text-xs text-gray-600">Category: ${d.category || ''} | Domain: ${d.domain || ''}</div>
                            ${d.description ? `<div class="mt-3">${d.description}</div>` : ''}
                        </div>
                    `;
                } else {
                    content.innerHTML = `<div class='text-red-600'>Failed to load details</div>`;
                }
            } catch (_) {
                content.innerHTML = `<div class='text-red-600'>Error loading details</div>`;
            }
        }

        // Close mapping details modal
        document.addEventListener('click', (e) => {
            if (e.target && e.target.id === 'closeMappingDetailsBtn') {
                const modal = document.getElementById('mappingDetailsModal');
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
            if (e.target && e.target.id === 'mappingDetailsModal') {
                const modal = document.getElementById('mappingDetailsModal');
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        });

        // Settings modal behavior
        const settingsModal = () => document.getElementById('settingsModal');
        function openSettingsModal() {
            populateSettingsForm();
            settingsModal().classList.remove('hidden');
            settingsModal().classList.add('flex');
        }
        function closeSettingsModal() {
            settingsModal().classList.add('hidden');
            settingsModal().classList.remove('flex');
        }
        async function populateSettingsForm() {
            if (!userSettings) await fetchSettings();
            const s = (userSettings && userSettings.settings) || {};
            document.getElementById('orgInput').value = s.organization || '';
            document.getElementById('stateInput').value = s.state || '';
            document.getElementById('sizeSelect').value = s.institution_size || '';
            document.getElementById('lmsInput').value = s.lms || '';
            document.getElementById('termSelect').value = s.term_system || '';
            // Populate accreditors
            const select = document.getElementById('accreditorSelect');
            const accs = await ensureAccreditors();
            select.innerHTML = (accs && accs.length ? accs : ['HLC','SACSCOC','MSCHE','WASC','ABET'])
                .map(a => `<option ${a === (s.primary_accreditor || '') ? 'selected' : ''}>${a}</option>`)
                .join('');
        }
        async function ensureAccreditors() {
            if (window.__availableAccreditors && Array.isArray(window.__availableAccreditors)) return window.__availableAccreditors;
            const token = localStorage.getItem('access_token') || localStorage.getItem('jwt_token');
            try {
                const res = await fetch(`${API_BASE}/api/user/intelligence-simple/standards/graph`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const data = await res.json();
                    window.__availableAccreditors = data.available_accreditors || [];
                    return window.__availableAccreditors;
                }
            } catch (e) {
                console.warn('Accreditors fetch failed', e);
            }
            return [];
        }

        async function ensureIntegrations() {
            const token = localStorage.getItem('access_token') || localStorage.getItem('jwt_token');
            try {
                const res = await fetch(`${API_BASE}/api/user/intelligence-simple/integrations/status`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (res.ok) {
                    const data = await res.json();
                    const modal = document.getElementById('settingsForm');
                    const integrations = document.createElement('div');
                    integrations.className = 'text-xs text-gray-600';
                    integrations.innerHTML = `
                        <div class="grid grid-cols-2 gap-2 pt-1">
                            <div>Google Drive: <span class="${data.google_drive_available ? 'text-green-600' : 'text-gray-500'}">${data.google_drive_available ? 'Available' : 'Unavailable'}</span></div>
                            <div>OneDrive: <span class="${data.onedrive_available ? 'text-green-600' : 'text-gray-500'}">${data.onedrive_available ? 'Available' : 'Unavailable'}</span></div>
                            <div>Canvas: <span class="${data.canvas_available ? 'text-green-600' : 'text-gray-500'}">${data.canvas_available ? 'Available' : 'Unavailable'}</span></div>
                            <div>Microsoft: <span class="${data.microsoft_available ? 'text-green-600' : 'text-gray-500'}">${data.microsoft_available ? 'Available' : 'Unavailable'}</span></div>
                        </div>
                    `;
                    // Avoid duplicates
                    if (!document.getElementById('integrationStatusBlock')) {
                        const wrapper = document.createElement('div');
                        wrapper.id = 'integrationStatusBlock';
                        const label = document.createElement('div');
                        label.className = 'text-sm font-medium text-gray-700';
                        label.textContent = 'Integration Status';
                        wrapper.appendChild(label);
                        wrapper.appendChild(integrations);
                        modal.appendChild(wrapper);
                    }
                }
            } catch (_) {}
        }

        // Crosswalk loader
        async function loadCrosswalk(){
            const token = localStorage.getItem('access_token') || localStorage.getItem('jwt_token');
            document.getElementById('crosswalkSection').classList.remove('hidden');
            const table = document.getElementById('crosswalkTable');
            table.innerHTML = '<tbody><tr><td class="py-8 text-gray-600">Loading crosswalk…</td></tr></tbody>';
            try {
                const res = await fetch(`${API_BASE}/api/user/intelligence-simple/evidence/crosswalk`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!res.ok) throw new Error('Failed');
                const data = await res.json();
                const headers = ['Evidence'].concat(data.standards);
                const thead = '<thead><tr>'+ headers.map(h=>`<th class="text-left border px-2 py-1 bg-gray-50">${h}</th>`).join('') + '</tr></thead>';
                const rows = data.evidence.map(fname => {
                    const cells = data.standards.map(sid => data.matrix[fname] && data.matrix[fname][sid] ? '<td class="border px-2 py-1 text-center">✓</td>' : '<td class="border px-2 py-1"></td>').join('');
                    return `<tr><td class="border px-2 py-1 font-medium">${fname}</td>${cells}</tr>`;
                }).join('');
                table.innerHTML = thead + '<tbody>'+rows+'</tbody>';
                const summary = document.getElementById('crosswalkSummary');
                summary.textContent = `Reuse: ${data.reuse_percentage}% • Multi-use evidence: ${data.multi_use_count}`;
            } catch (e) {
                table.innerHTML = '<tbody><tr><td class="py-8 text-red-600">Failed to load crosswalk.</td></tr></tbody>';
            }
        }
        document.addEventListener('click', (e) => {
            if (e.target && e.target.id === 'openSettingsBtn') openSettingsModal();
            if (e.target && (e.target.id === 'closeSettingsBtn' || e.target.id === 'cancelSettingsBtn')) closeSettingsModal();
            // backdrop click
            if (e.target && e.target.id === 'settingsModal') closeSettingsModal();
        });
        document.getElementById('settingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const payload = {
                organization: document.getElementById('orgInput').value,
                primary_accreditor: document.getElementById('accreditorSelect').value,
                term_system: document.getElementById('termSelect').value,
                lms: document.getElementById('lmsInput').value,
                state: document.getElementById('stateInput').value,
                institution_size: document.getElementById('sizeSelect').value,
            };
            try {
                await saveSettings(payload);
                await fetchSettings();
                closeSettingsModal();
                await loadDashboard();
                renderSuggestedUploads();
                // If graph is open, reload it too
                if (!document.getElementById('standardsGraphSection').classList.contains('hidden')) {
                    await loadStandardsGraph();
                }
            } catch (err) {
                alert('Failed to save settings');
                console.error(err);
            }
        });

        // Render Suggested Uploads based on settings.document_types (safe, no inline JSON in attrs)
        function renderSuggestedUploads() {
            try {
                const el = document.getElementById('suggestedUploads');
                const chips = document.getElementById('suggestedUploadsChips');
                const types = (userSettings && userSettings.settings && Array.isArray(userSettings.settings.document_types)) ? userSettings.settings.document_types : [];
                if (!types || types.length === 0) { el.classList.add('hidden'); return; }
                const top = types.slice(0, 8);
                chips.innerHTML = top.map(t => `
                    <button class="px-3 py-1 rounded-full text-sm border bg-gray-100 hover:bg-gray-200 suggested-chip" data-doc-type="${String(t).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}">Upload ${String(t).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</button>
                `).join('');
                // Attach click handlers
                chips.querySelectorAll('.suggested-chip').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const dt = e.currentTarget.getAttribute('data-doc-type') || '';
                        startTypedUpload(dt);
                    });
                });
                el.classList.remove('hidden');
            } catch (e) { /* no-op */ }
        }

        // Initial suggestions render after settings load and dashboard init
        (async function initSuggestions(){
            // Wait a bit to allow fetchSettings to populate
            setTimeout(renderSuggestedUploads, 400);
        })();
    </script>
</body>
</html>
