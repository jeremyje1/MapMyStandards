<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Real-Time Dashboard - MapMyStandards (LIVE BACKEND DATA)</title>
    
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
            font-weight: 300;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .status-connected {
            background: #d4edda;
            color: #155724;
        }

        .status-disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-3px);
        }

        .metric-value {
            font-size: 2.2em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 0.9em;
            color: #6c757d;
            font-weight: 500;
        }

        .metric-change {
            font-size: 0.8em;
            margin-top: 5px;
            padding: 3px 8px;
            border-radius: 12px;
            display: inline-block;
        }

        .metric-change.positive {
            background: #d4edda;
            color: #155724;
        }

        .metric-change.negative {
            background: #f8d7da;
            color: #721c24;
        }

        .dashboard-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .card-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .activity-feed {
            max-height: 300px;
            overflow-y: auto;
        }

        .feed-item {
            padding: 12px;
            border-left: 4px solid #667eea;
            margin-bottom: 15px;
            background: #f8f9fa;
            border-radius: 0 8px 8px 0;
        }

        .feed-time {
            font-size: 0.8em;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .feed-content {
            font-size: 0.9em;
            color: #2c3e50;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üöÄ Real-Time Analytics Dashboard</h1>
            <div class="status-bar">
                <p>Live data from MapMyStandards Backend API</p>
                <div id="connectionStatus" class="status-indicator status-disconnected">
                    <span>Connecting...</span>
                </div>
            </div>
        </div>

        <!-- Real-time Metrics -->
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-value" id="complianceScore">--</div>
                <div class="metric-label">Compliance Score</div>
                <div class="metric-change positive" id="complianceChange">--</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="documentsAnalyzed">--</div>
                <div class="metric-label">Documents Analyzed</div>
                <div class="metric-change negative" id="documentsChange">--</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="standardsMapped">--</div>
                <div class="metric-label">Standards Mapped</div>
                <div class="metric-change positive" id="standardsChange">--</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="reportsGenerated">--</div>
                <div class="metric-label">Reports Generated</div>
                <div class="metric-change positive" id="reportsChange">--</div>
            </div>
        </div>

        <!-- Live Chart -->
        <div class="dashboard-card">
            <div class="card-title">üìà Live Metrics Chart</div>
            <canvas id="liveChart" width="400" height="150"></canvas>
        </div>

        <!-- Activity Feed -->
        <div class="dashboard-card">
            <div class="card-title">üì° Live Activity Feed</div>
            <div id="activityFeed" class="activity-feed">
                <div class="loading">Loading real-time data...</div>
            </div>
        </div>

        <!-- API Response Display -->
        <div class="dashboard-card">
            <div class="card-title">üîç API Response (Debug)</div>
            <pre id="apiResponse" style="background: #f8f9fa; padding: 15px; border-radius: 8px; overflow-x: auto; font-size: 0.85em;">
Waiting for API response...
            </pre>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'http://localhost:8000';
        const REFRESH_INTERVAL = 5000; // 5 seconds
        
        let chart = null;
        let updateInterval = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Initializing Real-Time Dashboard...');
            initializeChart();
            loadMetrics();
            startRealtimeUpdates();
        });

        // Load metrics from backend
        async function loadMetrics() {
            const statusElement = document.getElementById('connectionStatus');
            
            try {
                console.log('üìä Fetching metrics from backend...');
                const response = await fetch(`${API_BASE_URL}/api/v1/sample-data/welcome-dashboard`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ Received data from backend:', data);
                
                // Update API response display
                document.getElementById('apiResponse').textContent = JSON.stringify(data, null, 2);
                
                // Update metrics if data is available
                if (data && data.dashboard_data && data.dashboard_data.sample_metrics) {
                    const metrics = data.dashboard_data.sample_metrics;
                    
                    // Update metric displays
                    document.getElementById('complianceScore').textContent = metrics.compliance_score + '%';
                    document.getElementById('documentsAnalyzed').textContent = metrics.documents_analyzed;
                    document.getElementById('standardsMapped').textContent = metrics.standards_mapped;
                    document.getElementById('reportsGenerated').textContent = metrics.reports_generated;
                    
                    // Update status
                    statusElement.className = 'status-indicator status-connected';
                    statusElement.innerHTML = '<span>‚úÖ Connected - Live Data</span>';
                    
                    // Add to activity feed
                    addActivityItem(`Metrics updated: Compliance ${metrics.compliance_score}%, Documents ${metrics.documents_analyzed}, Standards ${metrics.standards_mapped}`);
                    
                    // Update chart
                    updateChart(metrics.compliance_score);
                    
                    return true;
                } else {
                    throw new Error('Invalid data structure received');
                }
                
            } catch (error) {
                console.error('‚ùå Failed to load metrics:', error);
                statusElement.className = 'status-indicator status-disconnected';
                statusElement.innerHTML = '<span>‚ùå Error: ' + error.message + '</span>';
                
                // Show error in API response
                document.getElementById('apiResponse').textContent = 'Error: ' + error.toString();
                
                // Add error to activity feed
                addActivityItem('Error loading metrics: ' + error.message, 'error');
                
                return false;
            }
        }

        // Initialize chart
        function initializeChart() {
            const ctx = document.getElementById('liveChart');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Compliance Score',
                        data: [],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        // Update chart with new data
        function updateChart(value) {
            if (!chart) return;
            
            const now = new Date().toLocaleTimeString();
            chart.data.labels.push(now);
            chart.data.datasets[0].data.push(value);
            
            // Keep only last 10 data points
            if (chart.data.labels.length > 10) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
            }
            
            chart.update('none');
        }

        // Add item to activity feed
        function addActivityItem(message, type = 'info') {
            const feed = document.getElementById('activityFeed');
            const item = document.createElement('div');
            item.className = 'feed-item';
            
            const time = new Date().toLocaleTimeString();
            item.innerHTML = `
                <div class="feed-time">${time}</div>
                <div class="feed-content">${message}</div>
            `;
            
            // Remove loading message if present
            const loading = feed.querySelector('.loading');
            if (loading) {
                loading.remove();
            }
            
            // Add new item at the top
            feed.insertBefore(item, feed.firstChild);
            
            // Keep only last 10 items
            while (feed.children.length > 10) {
                feed.removeChild(feed.lastChild);
            }
        }

        // Start real-time updates
        function startRealtimeUpdates() {
            console.log('‚è∞ Starting real-time updates every ' + REFRESH_INTERVAL + 'ms');
            
            updateInterval = setInterval(() => {
                loadMetrics();
            }, REFRESH_INTERVAL);
            
            addActivityItem('Real-time updates started (5 second intervals)');
        }

        // Stop updates (for cleanup)
        function stopRealtimeUpdates() {
            if (updateInterval) {
                clearInterval(updateInterval);
                updateInterval = null;
                addActivityItem('Real-time updates stopped');
            }
        }
    </script>
</body>
</html>