<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Configuration Test - MapMyStandards</title>
    <script src="/js/config.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 { color: #333; }
        h2 { color: #666; font-size: 1.2em; }
        .config-value {
            background: #f0f0f0;
            padding: 8px 12px;
            border-radius: 4px;
            font-family: monospace;
            word-break: break-all;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success { background: #d4f4dd; color: #1a7f37; }
        .error { background: #fdd; color: #d73502; }
        .pending { background: #fef3cd; color: #856404; }
        button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover { background: #0052a3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #0066cc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <h1>ðŸ”§ API Configuration Test</h1>
    
    <div class="test-section">
        <h2>1. Configuration Loaded</h2>
        <p>Checking if config.js loaded successfully:</p>
        <div id="config-status" class="test-result pending">Checking...</div>
        <div class="config-value" id="config-values" style="margin-top: 10px;"></div>
    </div>

    <div class="test-section">
        <h2>2. Build API URL Function</h2>
        <p>Testing URL building with different inputs:</p>
        <div id="url-tests"></div>
    </div>

    <div class="test-section">
        <h2>3. API Endpoints Test</h2>
        <button onclick="runApiTests()" id="api-test-btn">Run API Tests</button>
        <div id="api-results" style="margin-top: 20px;"></div>
    </div>

    <div class="test-section">
        <h2>4. Authentication Test</h2>
        <button onclick="runAuthTest()" id="auth-test-btn">Test Auth Endpoints</button>
        <div id="auth-results" style="margin-top: 20px;"></div>
    </div>

    <script>
        // Helper function implementations
        const API_BASE = (window.MMS_CONFIG && window.MMS_CONFIG.API_BASE_URL) || '';
        
        function buildApiUrl(path){
            if (typeof path !== 'string') return path;
            if (path.startsWith('http')) return path;
            if (!API_BASE) return path;
            if (API_BASE.endsWith('/api') && path.startsWith('/api/')) return API_BASE + path.slice(4);
            return API_BASE + path;
        }
        
        async function authFetch(path, options={}){
            const url = buildApiUrl(path);
            const opts = Object.assign({ credentials:'include' }, options);
            let r = await fetch(url, opts);
            if (r.status === 401 && window.MMS_AUTH && typeof window.MMS_AUTH.silentRefresh === 'function'){
                await window.MMS_AUTH.silentRefresh();
                r = await fetch(url, opts);
            }
            return r;
        }

        // Test functions
        function checkConfig() {
            const configDiv = document.getElementById('config-status');
            const valuesDiv = document.getElementById('config-values');
            
            if (window.MMS_CONFIG) {
                configDiv.className = 'test-result success';
                configDiv.textContent = 'âœ“ Configuration loaded successfully';
                
                valuesDiv.innerHTML = `
                    <strong>API_BASE_URL:</strong> ${window.MMS_CONFIG.API_BASE_URL || '(empty - using relative paths)'}<br>
                    <strong>PLATFORM_BASE_URL:</strong> ${window.MMS_CONFIG.PLATFORM_BASE_URL}<br>
                    <strong>Feature Flags:</strong> ${JSON.stringify(window.MMS_CONFIG.FEATURE_FLAGS, null, 2)}
                `;
            } else {
                configDiv.className = 'test-result error';
                configDiv.textContent = 'âœ— Configuration not found';
                valuesDiv.textContent = 'window.MMS_CONFIG is undefined';
            }
        }

        function testUrlBuilding() {
            const testCases = [
                { input: '/api/health', expected: `${API_BASE}/health` },
                { input: '/api/user/test', expected: `${API_BASE}/user/test` },
                { input: '/other/path', expected: `${API_BASE}/other/path` },
                { input: 'https://example.com/api', expected: 'https://example.com/api' },
                { input: '', expected: '' }
            ];

            const resultsDiv = document.getElementById('url-tests');
            resultsDiv.innerHTML = '';

            testCases.forEach(test => {
                const result = buildApiUrl(test.input);
                const isCorrect = result === test.expected || 
                                 (API_BASE === '' && result === test.input) ||
                                 (API_BASE.endsWith('/api') && test.input.startsWith('/api/') && 
                                  result === API_BASE + test.input.slice(4));
                
                const div = document.createElement('div');
                div.className = `test-result ${isCorrect ? 'success' : 'error'}`;
                div.innerHTML = `
                    ${isCorrect ? 'âœ“' : 'âœ—'} 
                    <code>${test.input}</code> â†’ 
                    <code>${result}</code>
                `;
                resultsDiv.appendChild(div);
            });
        }

        async function runApiTests() {
            const btn = document.getElementById('api-test-btn');
            const results = document.getElementById('api-results');
            
            btn.disabled = true;
            btn.innerHTML = 'Testing...<span class="spinner"></span>';
            results.innerHTML = '';

            const endpoints = [
                { path: '/health', name: 'Health Check', expectData: false },
                { path: '/api/user/intelligence-simple/standards/metadata', name: 'Standards Metadata', expectData: true },
                { path: '/api/v1/billing/config/stripe-key', name: 'Stripe Config', expectData: true }
            ];

            for (const endpoint of endpoints) {
                const div = document.createElement('div');
                div.className = 'test-result pending';
                div.textContent = `Testing ${endpoint.name}...`;
                results.appendChild(div);

                try {
                    const url = buildApiUrl(endpoint.path);
                    const response = await fetch(url);
                    const text = await response.text();
                    
                    let data;
                    try {
                        data = JSON.parse(text);
                    } catch {
                        data = text;
                    }

                    if (response.ok) {
                        div.className = 'test-result success';
                        div.innerHTML = `âœ“ ${endpoint.name}: ${response.status} OK<br>
                            <small>URL: ${url}</small>`;
                        
                        if (endpoint.expectData && data) {
                            div.innerHTML += `<br><small>Data received: ${
                                typeof data === 'object' ? Object.keys(data).join(', ') : 'yes'
                            }</small>`;
                        }
                    } else {
                        div.className = 'test-result error';
                        div.innerHTML = `âœ— ${endpoint.name}: ${response.status} ${response.statusText}<br>
                            <small>URL: ${url}</small>`;
                    }
                } catch (error) {
                    div.className = 'test-result error';
                    div.innerHTML = `âœ— ${endpoint.name}: ${error.message}<br>
                        <small>This might be normal if CORS is not configured for this origin</small>`;
                }
            }

            btn.disabled = false;
            btn.textContent = 'Run API Tests';
        }

        async function runAuthTest() {
            const btn = document.getElementById('auth-test-btn');
            const results = document.getElementById('auth-results');
            
            btn.disabled = true;
            btn.innerHTML = 'Testing...<span class="spinner"></span>';
            results.innerHTML = '';

            const endpoints = [
                { path: '/api/user/intelligence-simple/dashboard/overview', name: 'Dashboard (Protected)', auth: true },
                { path: '/api/user/intelligence-simple/settings', name: 'Settings (Protected)', auth: true }
            ];

            for (const endpoint of endpoints) {
                const div = document.createElement('div');
                div.className = 'test-result pending';
                div.textContent = `Testing ${endpoint.name}...`;
                results.appendChild(div);

                try {
                    const response = await authFetch(endpoint.path);
                    
                    if (response.status === 401) {
                        div.className = 'test-result pending';
                        div.innerHTML = `âš  ${endpoint.name}: 401 Unauthorized<br>
                            <small>This is expected if you're not logged in</small>`;
                    } else if (response.ok) {
                        div.className = 'test-result success';
                        div.innerHTML = `âœ“ ${endpoint.name}: ${response.status} OK - You are authenticated!`;
                    } else {
                        div.className = 'test-result error';
                        div.innerHTML = `âœ— ${endpoint.name}: ${response.status} ${response.statusText}`;
                    }
                } catch (error) {
                    div.className = 'test-result error';
                    div.innerHTML = `âœ— ${endpoint.name}: ${error.message}`;
                }
            }

            btn.disabled = false;
            btn.textContent = 'Test Auth Endpoints';
        }

        // Run tests on load
        window.addEventListener('DOMContentLoaded', () => {
            checkConfig();
            testUrlBuilding();
        });
    </script>
</body>
</html>