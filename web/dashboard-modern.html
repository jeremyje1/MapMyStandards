<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - MapMyStandards AI</title>
    <script src="/js/ux.js"></script>
    <meta name="description" content="Your AI-powered accreditation dashboard. Track compliance, analyze documents, and generate reports.">
    
    <style>
        /* Modern CSS Reset */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* Design System Variables */
        :root {
            /* Colors */
            --primary-blue: #1e40af;
            --primary-blue-light: #3b82f6;
            --primary-blue-dark: #1e3a8a;
            --accent-green: #10b981;
            --accent-green-light: #34d399;
            --accent-orange: #f59e0b;
            --accent-purple: #8b5cf6;
            --accent-red: #ef4444;
            
            /* Neutrals */
            --white: #ffffff;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            
            /* Gradients */
            --gradient-primary: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-light) 100%);
            --gradient-success: linear-gradient(135deg, var(--accent-green) 0%, var(--accent-green-light) 100%);
            --gradient-warning: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
            --gradient-hero: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            
            /* Typography */
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', 'Helvetica Neue', Arial, sans-serif;
            --font-size-xs: 0.75rem;
            --font-size-sm: 0.875rem;
            --font-size-base: 1rem;
            --font-size-lg: 1.125rem;
            --font-size-xl: 1.25rem;
            --font-size-2xl: 1.5rem;
            --font-size-3xl: 1.875rem;
            --font-size-4xl: 2.25rem;
            
            /* Spacing */
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-5: 1.25rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
            --space-10: 2.5rem;
            --space-12: 3rem;
            --space-16: 4rem;
            --space-20: 5rem;
            
            /* Borders & Radius */
            --border-radius-sm: 0.375rem;
            --border-radius: 0.5rem;
            --border-radius-lg: 0.75rem;
            --border-radius-xl: 1rem;
            --border-radius-2xl: 1.5rem;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            
            /* Animations */
            --transition: all 0.2s ease-in-out;
            --transition-slow: all 0.3s ease-in-out;
        }

        /* Base Styles */
        body {
            font-family: var(--font-family);
            background: var(--gray-50);
            color: var(--gray-800);
            line-height: 1.6;
            font-size: var(--font-size-base);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: var(--white);
            border-bottom: 1px solid var(--gray-200);
            position: sticky;
            top: 0;
            z-index: 50;
            backdrop-filter: blur(12px);
            background: rgba(255, 255, 255, 0.95);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--space-4) var(--space-6);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .logo {
            font-size: var(--font-size-xl);
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-decoration: none;
        }

        .header-nav {
            display: flex;
            align-items: center;
            gap: var(--space-8);
        }

        .nav-links {
            display: flex;
            gap: var(--space-6);
        }

        .nav-links a {
            color: var(--gray-600);
            text-decoration: none;
            font-weight: 500;
            padding: var(--space-2) var(--space-3);
            border-radius: var(--border-radius);
            transition: var(--transition);
            position: relative;
        }

        .nav-links a:hover,
        .nav-links a.active {
            color: var(--primary-blue);
            background: rgba(59, 130, 246, 0.1);
        }

        .nav-links a.active::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            background: var(--primary-blue);
            border-radius: 50%;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }

        .trial-status {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            background: var(--gradient-success);
            color: white;
            padding: var(--space-2) var(--space-4);
            border-radius: var(--border-radius-lg);
            font-size: var(--font-size-sm);
            font-weight: 600;
        }

        .user-menu {
            position: relative;
        }

        .user-button {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            background: var(--gray-100);
            border: none;
            padding: var(--space-2) var(--space-3);
            border-radius: var(--border-radius-lg);
            cursor: pointer;
            transition: var(--transition);
        }

        .user-button:hover {
            background: var(--gray-200);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: var(--font-size-sm);
        }

        /* Main Container */
        .main {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--space-8) var(--space-6);
        }

        /* Welcome Section */
        .welcome-section {
            background: var(--gradient-hero);
            color: white;
            padding: var(--space-10);
            border-radius: var(--border-radius-2xl);
            margin-bottom: var(--space-8);
            position: relative;
            overflow: hidden;
        }

        .welcome-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Ccircle cx='30' cy='30' r='4'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E") repeat;
        }

        .welcome-content {
            position: relative;
            z-index: 2;
        }

        .welcome-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: var(--space-6);
            margin-bottom: var(--space-6);
        }

        .welcome-text {
            flex: 1;
            min-width: 300px;
        }

        .welcome-title {
            font-size: var(--font-size-3xl);
            font-weight: 800;
            margin-bottom: var(--space-3);
            line-height: 1.1;
        }

        .welcome-subtitle {
            font-size: var(--font-size-lg);
            opacity: 0.9;
            line-height: 1.5;
        }

        .trial-info {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius-xl);
            padding: var(--space-6);
            min-width: 280px;
        }

        .trial-days {
            font-size: var(--font-size-4xl);
            font-weight: 800;
            margin-bottom: var(--space-2);
        }

        .trial-label {
            opacity: 0.9;
            font-size: var(--font-size-sm);
        }

        .quick-actions {
            display: flex;
            gap: var(--space-4);
            flex-wrap: wrap;
        }

        .action-btn {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: var(--space-3) var(--space-5);
            border-radius: var(--border-radius-lg);
            text-decoration: none;
            font-weight: 600;
            transition: var(--transition);
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .action-btn-primary {
            background: white;
            color: var(--primary-blue);
            border-color: white;
        }

        .action-btn-primary:hover {
            background: var(--gray-100);
            color: var(--primary-blue-dark);
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-6);
            margin-bottom: var(--space-8);
        }

        .metric-card {
            background: white;
            border-radius: var(--border-radius-xl);
            padding: var(--space-6);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--gray-200);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }
        
        .metric-card:hover {
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
            border-color: var(--primary-blue-light);
        }
        
        .metric-card::after {
            content: 'Click for details';
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-size: 11px;
            color: var(--gray-400);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .metric-card:hover::after {
            opacity: 1;
        }
        
        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 5px solid #f3f4f6;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Enhanced tooltips */
        [data-tooltip] {
            position: relative;
        }
        
        [data-tooltip]::before,
        [data-tooltip]::after {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            pointer-events: none;
            z-index: 1000;
        }
        
        [data-tooltip]::before {
            content: attr(data-tooltip);
            bottom: calc(100% + 12px);
            background: var(--gray-900);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        [data-tooltip]::after {
            content: '';
            bottom: calc(100% + 6px);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid var(--gray-900);
        }
        
        [data-tooltip]:hover::before,
        [data-tooltip]:hover::after {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(-2px);
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .metric-card.success::before {
            background: var(--gradient-success);
        }

        .metric-card.warning::before {
            background: var(--gradient-warning);
        }

        .metric-card.info::before {
            background: var(--gradient-primary);
        }

        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-4);
        }

        .metric-label {
            font-size: var(--font-size-sm);
            color: var(--gray-600);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-icon {
            width: 40px;
            height: 40px;
            background: var(--gray-100);
            border-radius: var(--border-radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-xl);
        }

        .metric-icon.success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--accent-green);
        }

        .metric-icon.warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--accent-orange);
        }

        .metric-icon.info {
            background: rgba(59, 130, 246, 0.1);
            color: var(--primary-blue);
        }

        .metric-value {
            font-size: var(--font-size-3xl);
            font-weight: 800;
            color: var(--gray-900);
            line-height: 1;
            margin-bottom: var(--space-2);
        }

        .metric-description {
            font-size: var(--font-size-sm);
            color: var(--gray-600);
            line-height: 1.4;
        }

        .metric-trend {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            margin-top: var(--space-3);
            padding-top: var(--space-3);
            border-top: 1px solid var(--gray-200);
        }

        .trend-indicator {
            font-size: var(--font-size-sm);
            font-weight: 600;
        }

        .trend-up {
            color: var(--accent-green);
        }

        .trend-down {
            color: var(--accent-red);
        }

        .trend-neutral {
            color: var(--gray-500);
        }

        /* Content Grid */
        .content-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: var(--space-8);
            margin-bottom: var(--space-8);
        }

        /* Activity Section */
        .activity-section {
            background: white;
            border-radius: var(--border-radius-xl);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--gray-200);
            overflow: hidden;
            animation: fadeInUp 0.6s ease-out backwards;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .activity-section:nth-child(1) { animation-delay: 0.1s; }
        .activity-section:nth-child(2) { animation-delay: 0.2s; }
        .activity-section:nth-child(3) { animation-delay: 0.3s; }
        .activity-section:nth-child(4) { animation-delay: 0.4s; }
        
        .activity-section:hover {
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section-header {
            padding: var(--space-6);
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            font-size: var(--font-size-xl);
            font-weight: 700;
            color: var(--gray-900);
        }

        .section-action {
            color: var(--primary-blue);
            text-decoration: none;
            font-weight: 600;
            font-size: var(--font-size-sm);
        }

        .section-action:hover {
            text-decoration: underline;
        }

        .activity-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .activity-item {
            display: flex;
            align-items: flex-start;
            gap: var(--space-4);
            padding: var(--space-4) var(--space-6);
            border-bottom: 1px solid var(--gray-100);
            transition: var(--transition);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-item:hover {
            background: var(--gray-50);
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-lg);
            flex-shrink: 0;
            margin-top: var(--space-1);
        }

        .activity-icon.upload {
            background: rgba(59, 130, 246, 0.1);
            color: var(--primary-blue);
        }

        .activity-icon.analysis {
            background: rgba(16, 185, 129, 0.1);
            color: var(--accent-green);
        }

        .activity-icon.report {
            background: rgba(139, 92, 246, 0.1);
            color: var(--accent-purple);
        }

        .activity-content {
            flex: 1;
            min-width: 0;
        }

        .activity-title {
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: var(--space-1);
            line-height: 1.4;
        }

        .activity-description {
            font-size: var(--font-size-sm);
            color: var(--gray-600);
            margin-bottom: var(--space-2);
        }

        .activity-meta {
            display: flex;
            align-items: center;
            gap: var(--space-4);
            font-size: var(--font-size-xs);
            color: var(--gray-500);
        }

        /* Progress Section */
        .progress-section {
            background: white;
            border-radius: var(--border-radius-xl);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--gray-200);
            padding: var(--space-6);
        }

        .progress-item {
            margin-bottom: var(--space-6);
        }

        .progress-item:last-child {
            margin-bottom: 0;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-3);
        }

        .progress-label {
            font-weight: 600;
            color: var(--gray-900);
        }

        .progress-value {
            font-size: var(--font-size-sm);
            font-weight: 600;
            color: var(--primary-blue);
        }

        .progress-bar {
            height: 8px;
            background: var(--gray-200);
            border-radius: var(--border-radius-sm);
            overflow: hidden;
            margin-bottom: var(--space-2);
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-primary);
            border-radius: var(--border-radius-sm);
            transition: width 0.6s ease-out;
        }

        .progress-fill.success {
            background: var(--gradient-success);
        }

        .progress-fill.warning {
            background: var(--gradient-warning);
        }

        .progress-description {
            font-size: var(--font-size-sm);
            color: var(--gray-600);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: var(--space-12) var(--space-6);
            color: var(--gray-500);
        }

        .empty-icon {
            font-size: var(--font-size-4xl);
            margin-bottom: var(--space-4);
            opacity: 0.5;
        }

        .empty-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            margin-bottom: var(--space-2);
            color: var(--gray-700);
        }

        .empty-description {
            font-size: var(--font-size-base);
            margin-bottom: var(--space-6);
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .empty-action {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            background: var(--gradient-primary);
            color: white;
            padding: var(--space-3) var(--space-6);
            border-radius: var(--border-radius-lg);
            text-decoration: none;
            font-weight: 600;
            transition: var(--transition);
        }

        .empty-action:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--gray-300);
            border-radius: 50%;
            border-top-color: var(--primary-blue);
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .skeleton {
            background: linear-gradient(90deg, var(--gray-200) 25%, var(--gray-100) 50%, var(--gray-200) 75%);
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .content-grid {
                grid-template-columns: 1fr;
                gap: var(--space-6);
            }
            
            .metrics-grid {
                grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .header-content {
                padding: var(--space-3) var(--space-4);
            }
            
            .nav-links {
                display: none;
            }
            
            .main {
                padding: var(--space-6) var(--space-4);
            }
            
            .welcome-header {
                flex-direction: column;
            }
            
            .trial-info {
                min-width: auto;
                width: 100%;
            }
            
            .quick-actions {
                width: 100%;
            }
            
            .action-btn {
                flex: 1;
                justify-content: center;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
                gap: var(--space-4);
            }
            
            .welcome-section {
                padding: var(--space-8) var(--space-6);
            }
        }

        @media (max-width: 480px) {
            .header-actions {
                gap: var(--space-2);
            }
            
            .trial-status {
                padding: var(--space-1) var(--space-3);
                font-size: var(--font-size-xs);
            }
            
            .welcome-title {
                font-size: var(--font-size-2xl);
            }
            
            .metric-card {
                padding: var(--space-4);
            }
        }
    </style>
</head>
<body>
    <!-- Redacted mode banner removed - full standards access is now available -->
    <!-- <div id="redacted-banner" style="display:none;background:#FEF3C7;color:#92400E;padding:12px;text-align:center;border-bottom:1px solid #F59E0B;">
        Standards are displayed in Redacted Mode due to licensing. <a href="mailto:support@mapmystandards.ai" style="color:#1e40af;text-decoration:underline;">Request full-text access</a> or upload your licensed corpus.
    </div> -->
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo-container">
                <a href="/" class="logo">MapMyStandards</a>
            </div>
            
            <div class="header-nav">
                <nav class="nav-links">
                    <a href="/dashboard-modern" class="active">Dashboard</a>
                    <a href="/upload-working.html">Upload</a>
                    <a href="/standards-modern">Standards</a>
                    <a href="/reports-modern">Reports</a>
                    <a href="/reviewer-portal">Reviewer Portal</a>
                    <a href="/admin-standards">Admin Standards</a>
                    <a href="/crosswalkx">CrosswalkX</a>
                    <a href="/documentation">User Guide</a>
                </nav>
                
                <div class="header-actions">
                    <div class="user-menu">
                        <button class="user-button" id="userMenuButton">
                            <div class="user-avatar" id="userAvatar">JD</div>
                            <span id="userDisplayName">John Doe</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main">
        <!-- Welcome Section -->
        <section class="welcome-section">
            <div class="welcome-content">
                <div class="welcome-header">
                    <div class="welcome-text">
                        <h1 class="welcome-title" id="welcomeTitle">Welcome back! 👋</h1>
                        <p class="welcome-subtitle">Your accreditation analysis is running smoothly. Here's your progress overview.</p>
                    </div>
                    
                </div>
                
                <!-- Progress Indicator -->
                <div class="onboarding-progress" style="margin-top: 24px; padding: 20px; background: var(--gradient-primary); border-radius: 12px; color: white;">
                    <h3 style="font-size: 16px; margin-bottom: 12px; font-weight: 600;">Getting Started Progress</h3>
                    <div style="background: rgba(255,255,255,0.2); height: 8px; border-radius: 4px; overflow: hidden;">
                        <div id="progressBar" style="height: 100%; background: white; width: 0%; transition: width 0.5s ease; border-radius: 4px;"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 12px; font-size: 14px;">
                        <span id="progressText">0% Complete</span>
                        <span id="progressSteps">0 of 4 steps completed</span>
                    </div>
                </div>
                
                <div class="quick-actions">
                    <a href="/upload-working.html" class="action-btn action-btn-primary" data-tooltip="Start by uploading your accreditation documents">
                        <span>📁</span>
                        Upload Documents
                    </a>
                    <a href="/standards-modern" class="action-btn" data-tooltip="Browse and search accreditation standards">
                        <span>📋</span>
                        View Standards
                    </a>
                    <a href="/reports-modern" class="action-btn" data-tooltip="Generate compliance reports and analytics">
                        <span>📊</span>
                        Generate Report
                    </a>
                    <a href="#ai-evidence" class="action-btn" data-tooltip="AI-powered document analysis and mapping">
                        <span>🧠</span>
                        AI Evidence Analysis
                    </a>
                    <a href="#standards-graph" class="action-btn" data-tooltip="Visualize relationships between standards">
                        <span>🕸️</span>
                        Standards Graph
                    </a>
                    <a href="/gap-analysis" class="action-btn" data-tooltip="Identify compliance gaps and risks">
                        <span>⚠️</span>
                        Gap Analysis
                    </a>
                    <a href="/narrative" class="action-btn" data-tooltip="Generate accreditation narratives with citations">
                        <span>📖</span>
                        Narrative (CiteGuard)
                    </a>
                </div>
            </div>
        </section>

        <!-- Next Steps / First Time Guide -->
        <section class="activity-section" id="nextSteps" style="display:none">
            <div class="section-header">
                <h2 class="section-title">🚀 Getting Started Guide</h2>
            </div>
            <div id="nextStepsBody" style="padding: var(--space-6);">
                <ul id="nextStepsList" style="list-style:none; padding:0; display:grid; gap:12px">
                    <li style="display:flex; align-items:start; gap:12px; padding:16px; background:var(--gray-50); border-radius:12px; border:1px solid var(--gray-200);">
                        <div style="flex-shrink:0; width:40px; height:40px; background:var(--primary-blue-light); color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700;">1</div>
                        <div>
                            <h4 style="font-weight:600; margin-bottom:4px;">Upload Your Documents</h4>
                            <p style="font-size:14px; color:var(--gray-600); margin-bottom:8px;">Start by uploading your institutional documents, policies, and evidence.</p>
                            <a href="/upload-working.html" class="action-btn action-btn-primary" style="font-size:14px; padding:8px 16px;">Upload Now →</a>
                        </div>
                    </li>
                    <li style="display:flex; align-items:start; gap:12px; padding:16px; background:var(--gray-50); border-radius:12px; border:1px solid var(--gray-200);">
                        <div style="flex-shrink:0; width:40px; height:40px; background:var(--gray-400); color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700;">2</div>
                        <div>
                            <h4 style="font-weight:600; margin-bottom:4px;">AI Analysis</h4>
                            <p style="font-size:14px; color:var(--gray-600);">Our AI will automatically analyze and map your documents to standards.</p>
                        </div>
                    </li>
                    <li style="display:flex; align-items:start; gap:12px; padding:16px; background:var(--gray-50); border-radius:12px; border:1px solid var(--gray-200);">
                        <div style="flex-shrink:0; width:40px; height:40px; background:var(--gray-400); color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700;">3</div>
                        <div>
                            <h4 style="font-weight:600; margin-bottom:4px;">Review Compliance</h4>
                            <p style="font-size:14px; color:var(--gray-600);">Check your compliance scores and identify any gaps.</p>
                        </div>
                    </li>
                    <li style="display:flex; align-items:start; gap:12px; padding:16px; background:var(--gray-50); border-radius:12px; border:1px solid var(--gray-200);">
                        <div style="flex-shrink:0; width:40px; height:40px; background:var(--gray-400); color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700;">4</div>
                        <div>
                            <h4 style="font-weight:600; margin-bottom:4px;">Generate Reports</h4>
                            <p style="font-size:14px; color:var(--gray-600);">Create comprehensive reports and narratives for your accreditation.</p>
                        </div>
                    </li>
                </ul>
            </div>
        </section>

        <!-- Metrics Grid -->
        <section class="metrics-grid" id="metricsGrid">
            <!-- Metrics will be populated by JavaScript -->
            <div class="metric-card success">
                <div class="skeleton" style="height: 120px; border-radius: var(--border-radius-lg);"></div>
            </div>
            <div class="metric-card info">
                <div class="skeleton" style="height: 120px; border-radius: var(--border-radius-lg);"></div>
            </div>
            <div class="metric-card warning">
                <div class="skeleton" style="height: 120px; border-radius: var(--border-radius-lg);"></div>
            </div>
            <div class="metric-card success">
                <div class="skeleton" style="height: 120px; border-radius: var(--border-radius-lg);"></div>
            </div>
        </section>

        <!-- Content Grid -->
        <div class="content-grid">
            <!-- Recent Activity -->
            <section class="activity-section">
                <div class="section-header">
                    <h2 class="section-title">Recent Activity</h2>
                    <a href="/activity" class="section-action">View All</a>
                </div>
                
                <div class="activity-list" id="activityList">
                    <!-- Activity items will be populated by JavaScript -->
                    <div class="empty-state">
                        <div class="empty-icon">🔄</div>
                        <div class="spinner"></div>
                        <div class="empty-description">Loading your recent activity...</div>
                    </div>
                </div>
            </section>

            <!-- Progress Overview -->
            <section class="progress-section">
                <div class="section-header" style="padding: 0; border: none; margin-bottom: var(--space-6);">
                    <h2 class="section-title">Compliance Progress</h2>
                </div>
                
                <div id="progressOverview">
                    <!-- Progress items will be populated by JavaScript -->
                    <div class="progress-item">
                        <div class="skeleton" style="height: 60px; border-radius: var(--border-radius);"></div>
                    </div>
                    <div class="progress-item">
                        <div class="skeleton" style="height: 60px; border-radius: var(--border-radius);"></div>
                    </div>
                    <div class="progress-item">
                        <div class="skeleton" style="height: 60px; border-radius: var(--border-radius);"></div>
                    </div>
                </div>
            </section>
        </main>

    <script src="/js/onboarding.js?v=20250921a"></script>

        <script>
            // Display mode check commented out - full standards access is now available
            // async function checkDisplayMode() {
            //     try {
            //         const API_BASE = (window.mmsAPI && window.mmsAPI.getBaseUrl && window.mmsAPI.getBaseUrl()) || (location.hostname.includes('api.mapmystandards.ai') ? '' : 'https://api.mapmystandards.ai');
            //         const token = localStorage.getItem('a3e_api_key') || localStorage.getItem('access_token') || localStorage.getItem('jwt_token');
            //         const headers = {
            //             'Content-Type': 'application/json'
            //         };
            //         if (token) {
            //             headers['Authorization'] = `Bearer ${token}`;
            //         }
            //         const res = await fetch(`${API_BASE}/api/user/intelligence-simple/standards/list`, { 
            //             credentials: 'include',
            //             headers: headers
            //         });
            //         const data = await res.json();
            //         if (data && data.display_mode === 'redacted') {
            //             document.getElementById('redacted-banner').style.display = 'block';
            //         }
            //     } catch (e) {}
            // }
            // checkDisplayMode();
        </script>
        <script>
            // Dashboard functionality
        // Dashboard functionality
        (function bootstrapTokenFromUrl(){
            try {
                const u = new URL(window.location.href);
                const t = u.searchParams.get('token') || u.searchParams.get('api_key') || u.searchParams.get('access_token');
                if (t) {
                    localStorage.setItem('a3e_api_key', t);
                    sessionStorage.setItem('a3e_api_key', t);
                    localStorage.setItem('access_token', t);
                    localStorage.setItem('jwt_token', t);
                    u.searchParams.delete('token');
                    u.searchParams.delete('api_key');
                    u.searchParams.delete('access_token');
                    history.replaceState({}, '', u.toString());
                }
            } catch (_) {}
        })();

        class Dashboard {
            constructor() {
                this.API_BASE = (window.mmsAPI && window.mmsAPI.getBaseUrl && window.mmsAPI.getBaseUrl()) ||
                                 (location.hostname.includes('api.mapmystandards.ai') ? '' : 'https://api.mapmystandards.ai');
                this.metricsEndpoint = `${this.API_BASE}/api/user/intelligence-simple/dashboard/metrics`;
                this.init();
            }

            applyPersonalization() {
                try {
                    const s = this.settings || {};
                    const el = document.getElementById('welcomeTitle');
                    if (!el) return;
                    const org = s.organization || s.institution_name || '';
                    const accr = s.primary_accreditor || s.accreditor || '';
                    if (org && accr) {
                        el.textContent = `Welcome back, ${org} • ${accr} 👋`;
                    } else if (org) {
                        el.textContent = `Welcome back, ${org} 👋`;
                    } else if (accr) {
                        el.textContent = `Welcome back • ${accr} 👋`;
                    }
                } catch(_) { /* ignore */ }
            }

            async init() {
                try { if (window.MMS_ONBOARDING && window.MMS_ONBOARDING.maybePrompt) window.MMS_ONBOARDING.maybePrompt(); } catch(_){}
                try { this.settings = window.MMS_ONBOARDING && window.MMS_ONBOARDING.loadSettings ? await window.MMS_ONBOARDING.loadSettings() : {}; } catch(_) { this.settings = {}; }
                try { this.applyPersonalization(); } catch(_) {}
                await this.loadMetrics();
                await this.loadActivity();
                await this.loadProgress();
                await this.loadGapAnalysis();
                renderRecentUploads();
                this.updateOnboardingProgress();
                
                // Auto-refresh every 30 seconds
                setInterval(() => {
                    this.loadMetrics();
                    this.loadActivity();
                    this.loadProgress();
                    this.loadGapAnalysis();
                    renderRecentUploads();
                }, 30000);

                // Listen for upload/analysis events from other tabs
                window.addEventListener('storage', (e) => {
                    if (!e) return;
                    if (e.key === 'mms:lastUploadAt' || e.key === 'mms:lastAnalysisCompleteAt') {
                        this.loadMetrics().catch(()=>{});
                    } else if (e.key === 'mms:selectedStandards' || e.key === 'selectedStandards') {
                        this.renderNextSteps();
                    }
                });
                // Same-tab selection updates
                window.addEventListener('mms:selected-standards-updated', () => {
                    try { this.renderNextSteps(); } catch(_) {}
                });
                // Onboarding updates should update personalization immediately
                window.addEventListener('mms:onboarding-updated', async (e) => {
                    try {
                        this.settings = (e && e.detail) ? e.detail : (await (window.MMS_ONBOARDING && window.MMS_ONBOARDING.loadSettings ? window.MMS_ONBOARDING.loadSettings() : {}));
                    } catch(_) { /* ignore */ }
                    try { this.applyPersonalization(); } catch(_) {}
                    try { if (this.lastMetrics) this.renderMetrics(this.lastMetrics); } catch(_) {}
                    try { this.renderNextSteps(); } catch(_) {}
                });
            }

            async loadMetrics() {
                try {
                    const token = this.getAuthToken();
                    const headers = {
                        'Content-Type': 'application/json'
                    };
                    if (token) {
                        headers['Authorization'] = `Bearer ${token}`;
                    }
                    
                    const response = await fetch(this.metricsEndpoint, {
                        credentials: 'include',
                        headers: headers
                    });
                    
                    if (!response.ok) {
                        const err = new Error(`HTTP ${response.status}`);
                        // attach status for downstream UI
                        err.status = response.status;
                        if (response.status === 401) {
                            this.renderAuthRequired();
                        }
                        throw err;
                    }
                    
                    const payload = await response.json();
                    if (!payload || !payload.data || !payload.data.core_metrics) {
                        const err = new Error('Invalid metrics payload');
                        err.status = 'InvalidPayload';
                        throw err;
                    }
                    this._metricsOk = true;
                    this.lastMetrics = payload.data;
                    this.renderMetrics(payload.data);
                    this.renderNextSteps();
                } catch (error) {
                    console.error('Failed to load metrics:', error);
                    this._metricsOk = false;
                    const status = (error && (error.status || error.code)) || '';
                                        if (status === 401) {
                                                // already rendered auth prompt
                                        } else {
                                                this.renderMetricsError(status);
                                        }
                    this.lastMetrics = null;
                    this.renderNextSteps();
                }
            }

                        renderAuthRequired() {
                                try {
                                        const main = document.querySelector('main');
                                        if (!main) return;
                                        const baseHost = (location.hostname.includes('platform.mapmystandards.ai') ? '' : 'https://platform.mapmystandards.ai');
                                        const returnPath = encodeURIComponent(location.pathname.replace(/\/index\.html$/, '')) || encodeURIComponent('/dashboard');
                                        const loginUrl = `${baseHost}/login?return=${returnPath}`;
                                        main.innerHTML = `
                                                <section class="section">
                                                    <div class="card" style="text-align:center;padding:32px;">
                                                        <div class="empty-icon">🔒</div>
                                                        <h2 class="section-title">You’re not signed in</h2>
                                                        <p class="section-desc">Sign in to view your personalized dashboard and metrics.</p>
                                                        <div style="margin-top:16px; display:flex; gap:12px; justify-content:center; flex-wrap:wrap;">
                                                            <a class="button" href="${loginUrl}">Sign in</a>
                                                            <button class="button" id="pasteTokenBtn" type="button">Paste Access Token</button>
                                                        </div>
                                                        <div id="pasteTokenArea" style="display:none; margin-top:16px; max-width:560px; margin-inline:auto;">
                                                            <input id="tokenInput" type="text" placeholder="Paste access token (JWT)" style="width:100%; padding:12px; border-radius:8px; border:1px solid #e5e7eb;" />
                                                            <div style="margin-top:8px; display:flex; gap:8px; justify-content:center;">
                                                                <button class="button" id="saveTokenBtn" type="button">Save Token</button>
                                                                <button class="button" id="cancelTokenBtn" type="button">Cancel</button>
                                                            </div>
                                                            <p class="section-desc" style="margin-top:8px;">Tip: You can also open this page with <code>?access_token=&lt;token&gt;</code> and we’ll save it automatically.</p>
                                                        </div>
                                                    </div>
                                                </section>`;
                                        const pasteBtn = document.getElementById('pasteTokenBtn');
                                        const area = document.getElementById('pasteTokenArea');
                                        const saveBtn = document.getElementById('saveTokenBtn');
                                        const cancelBtn = document.getElementById('cancelTokenBtn');
                                        pasteBtn?.addEventListener('click', ()=>{ area.style.display = 'block'; });
                                        cancelBtn?.addEventListener('click', ()=>{ area.style.display = 'none'; });
                                        saveBtn?.addEventListener('click', ()=>{
                                                const input = document.getElementById('tokenInput');
                                                const v = (input && input.value) ? input.value : '';
                                                if (!v.trim()) return;
                                                try { localStorage.setItem('access_token', v.trim()); localStorage.setItem('a3e_api_key', v.trim()); } catch(_){}
                                                location.reload();
                                        });
                                } catch(_) {}
                        }

            renderMetrics(data) {
                if (!data || !data.core_metrics || !data.performance_metrics || !data.account_info) {
                    return this.renderMetricsError('Invalid');
                }
                
                // Store metrics for onboarding progress
                this.metrics = data.core_metrics;
                
                const metricsGrid = document.getElementById('metricsGrid');
                const metrics = data.core_metrics;
                const performance = data.performance_metrics;
                const account = data.account_info;
                const explain = (performance && performance.explanations) || {};
                // Prefer onboarding settings over account defaults for accreditor naming
                const accName = (this.settings && (this.settings.primary_accreditor || this.settings.accreditor)) || (account && (account.primary_accreditor || account.accreditor)) || 'Standards';

                metricsGrid.innerHTML = `
                    <div class="metric-card success" onclick="navigateToSection('evidence-upload')" style="cursor: pointer;">
                        <div class="metric-header">
                            <div class="metric-label">Documents Analyzed</div>
                            <div class="metric-icon success">📄</div>
                        </div>
                        <div class="metric-value">${metrics.documents_analyzed}</div>
                        <div class="metric-description">Successfully processed and mapped to standards</div>
                        <div class="metric-trend">
                            <span class="trend-indicator trend-up">↗ ${metrics.documents_processing} in progress</span>
                        </div>
                    </div>

                    <div class="metric-card info" onclick="window.location.href='standards-modern.html'" style="cursor: pointer;" title="${(explain.coverage || '').replace(/\"/g,'"')}">
                        <div class="metric-header">
                            <div class="metric-label">Standards Mapped <span style="cursor:help;font-size:14px" title="${(explain.coverage || '').replace(/\"/g,'"')}">ℹ️</span></div>
                            <div class="metric-icon info">🎯</div>
                        </div>
                        <div class="metric-value">${metrics.standards_mapped}/${metrics.total_standards}</div>
                        <div class="metric-description">${accName} standards coverage achieved</div>
                        <div class="metric-trend">
                            <span class="trend-indicator trend-${performance.coverage_percentage >= 75 ? 'up' : 'neutral'}">
                                ${performance.coverage_percentage}% coverage
                            </span>
                        </div>
                        <div id="coverageSpark" style="margin-top:6px;height:36px"></div>
                    </div>

                    <div class="metric-card warning" onclick="navigateToSection('compliance-overview')" style="cursor: pointer;" title="${(explain.compliance || '').replace(/\"/g,'"')}">
                        <div class="metric-header">
                            <div class="metric-label">Compliance Score <span style="cursor:help;font-size:14px" title="${(explain.compliance || '').replace(/\"/g,'"')}">ℹ️</span></div>
                            <div class="metric-icon warning">⚡</div>
                        </div>
                        <div class="metric-value">${performance.compliance_score}%</div>
                        <div class="metric-description">Overall accreditation readiness</div>
                        <div class="metric-trend">
                            <span class="trend-indicator trend-${performance.compliance_score >= 75 ? 'up' : 'neutral'}">
                                ${performance.compliance_score >= 75 ? 'Strong' : 'Needs improvement'}
                            </span>
                        </div>
                        <div id="complianceSpark" style="margin-top:6px;height:36px"></div>
                    </div>

                    <div class="metric-card success" onclick="window.location.href='reports-modern.html'" style="cursor: pointer;">
                        <div class="metric-header">
                            <div class="metric-label">Reports Generated</div>
                            <div class="metric-icon success">📊</div>
                        </div>
                        <div class="metric-value">${metrics.reports_generated}</div>
                        <div class="metric-description">Professional compliance reports ready</div>
                        <div class="metric-trend">
                            <span class="trend-indicator trend-${metrics.reports_pending > 0 ? 'up' : 'neutral'}">
                                ${metrics.reports_pending > 0 ? `${metrics.reports_pending} generating` : 'All up to date'}
                            </span>
                        </div>
                    </div>
                    <div class="metric-card info" onclick="navigateToSection('evidence-upload')" style="cursor: pointer;" title="${(explain.average_trust || '').replace(/\"/g,'"')}">
                        <div class="metric-header">
                            <div class="metric-label">Evidence Trust <span style="cursor:help;font-size:14px" title="${(explain.average_trust || '').replace(/\"/g,'"')}">ℹ️</span></div>
                            <div class="metric-icon info">🔒</div>
                        </div>
                        <div class="metric-value">${Math.round((performance.average_trust ?? 0) * 100)}%</div>
                        <div class="metric-description">Mean EvidenceTrust (0–100%)</div>
                        <div class="metric-trend">
                            <span class="trend-indicator trend-${(performance.average_trust ?? 0) >= 0.75 ? 'up' : ((performance.average_trust ?? 0) >= 0.55 ? 'neutral' : 'down')}">
                                ${(performance.average_trust ?? 0) >= 0.75 ? 'Healthy' : ((performance.average_trust ?? 0) >= 0.55 ? 'Moderate' : 'Low')}
                            </span>
                        </div>
                        <div id="trustSpark" style="margin-top:6px;height:36px"></div>
                    </div>

                    <div class="metric-card danger" onclick="window.location.href='gap-analysis.html'" style="cursor: pointer;" title="${(explain.average_risk || '').replace(/\"/g,'"')}">
                        <div class="metric-header">
                            <div class="metric-label">Gap Risk <span style="cursor:help;font-size:14px" title="${(explain.average_risk || '').replace(/\"/g,'"')}">ℹ️</span></div>
                            <div class="metric-icon danger">🛑</div>
                        </div>
                        <div class="metric-value">${Math.round((performance.average_risk ?? 0) * 100)}%</div>
                        <div class="metric-description">Avg calibrated risk (0–100%)</div>
                        <div class="metric-trend">
                            <span class="trend-indicator trend-${(performance.average_risk ?? 0) <= 0.25 ? 'up' : ((performance.average_risk ?? 0) <= 0.5 ? 'neutral' : 'down')}">
                                ${(performance.average_risk ?? 0) <= 0.25 ? 'Low' : ((performance.average_risk ?? 0) <= 0.5 ? 'Moderate' : 'Elevated')}
                            </span>
                        </div>
                        <div style="margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                            <button id="openRiskFactorsBtn" class="user-button" style="padding:6px 10px;background:#fee2e2;color:#991b1b;border:1px solid #fecaca" title="View factor breakdown">
                                🔎 Risk Factors
                            </button>
                            <a href="/TRANSPARENCY_METRICS.md" target="_blank" style="font-size:12px;color:#2563eb;text-decoration:none">Transparency ↗</a>
                        </div>
                        <div style="margin-top:8px">
                            ${(() => {
                                const dist = performance.risk_distribution || {};
                                const order = ['critical','high','medium','low','minimal'];
                                const total = order.reduce((s,k)=> s + (dist[k]||0),0) || 1;
                                return `<div style='display:flex;gap:4px;align-items:flex-end;height:40px'>` +
                                    order.map(k=>{
                                        const v = dist[k]||0;const pct = (v/total)*100;
                                        const color = k==='critical'? '#ef4444': k==='high'? '#f97316': k==='medium'? '#f59e0b': k==='low'? '#10b981':'#3b82f6';
                                        return `<div title='${k}: ${v}' style='flex:1;display:flex;flex-direction:column;align-items:center;font-size:10px'>
                                            <div style='width:100%;background:${color};height:${Math.max(4,Math.round(pct/4))}px;border-radius:3px'></div>
                                            <div style='margin-top:2px;color:#555'>${v}</div>
                                        </div>`;
                                    }).join('') + `</div>`;
                            })()}
                        </div>
                        <div style="margin-top:6px;font-size:12px;color:#4b5563">
                            ${(() => {
                                const d = performance.risk_distribution || {};
                                const label = (k)=>({critical:'Critical',high:'High',medium:'Medium',low:'Low',minimal:'Minimal'})[k]||k;
                                const keys = ['low','medium','high'];
                                const parts = keys.map(k=>`${label(k)}:${d[k]||0}`);
                                return parts.join(' · ');
                            })()}
                        </div>
                        <div id="riskSpark" style="margin-top:6px;height:36px"></div>
                    </div>
                `;

                

                // Render trend sparklines using timeseries endpoint (throttled)
                // Prefer onboarding settings for accreditor selection
                this.ensureTimeseries((this.settings && this.settings.primary_accreditor) || account.primary_accreditor).then(series => {
                    try {
                        const coverageVals = (series||[]).map(s => Number(s.coverage_percentage || 0));
                        const complianceVals = (series||[]).map(s => Number(s.compliance_score || 0));
                        const trustVals = (series||[]).map(s => Number(s.average_trust || 0));
                        const riskVals = (series||[]).map(s => Number(s.average_risk || 0));
                        const covEl = document.getElementById('coverageSpark');
                        const compEl = document.getElementById('complianceSpark');
                        const trustEl = document.getElementById('trustSpark');
                        const riskEl = document.getElementById('riskSpark');
                        // Build latest value labels for tooltips
                        const last = (series && series.length) ? series[series.length-1] : null;
                        const lastDate = last && last.timestamp ? new Date(last.timestamp) : null;
                        const fmtDate = lastDate ? `${lastDate.toISOString().slice(0,19).replace('T',' ') }Z` : '';
                        const covLabel = last ? `Latest coverage: ${Number(last.coverage_percentage||0).toFixed(1)}%${fmtDate? ' • '+fmtDate:''}` : 'Coverage trend';
                        const compLabel = last ? `Latest compliance: ${Number(last.compliance_score||0).toFixed(1)}%${fmtDate? ' • '+fmtDate:''}` : 'Compliance trend';
                        const trustLabel = last ? `Latest trust: ${(Number(last.average_trust||0)).toFixed(2)}${fmtDate? ' • '+fmtDate:''}` : 'Trust trend';
                        const riskLabel = last ? `Latest risk: ${(Number(last.average_risk||0)).toFixed(3)}${fmtDate? ' • '+fmtDate:''}` : 'Risk trend';
                        if (covEl){
                            covEl.title = covLabel;
                            covEl.setAttribute('aria-label', covLabel);
                            covEl.innerHTML = this.renderSparkline(coverageVals, 220, 36, '#10b981', covLabel);
                        }
                        if (compEl){
                            compEl.title = compLabel;
                            compEl.setAttribute('aria-label', compLabel);
                            compEl.innerHTML = this.renderSparkline(complianceVals, 220, 36, '#f59e0b', compLabel);
                        }
                        if (trustEl){
                            trustEl.title = trustLabel;
                            trustEl.setAttribute('aria-label', trustLabel);
                            trustEl.innerHTML = this.renderSparkline(trustVals, 220, 36, '#3b82f6', trustLabel);
                        }
                        if (riskEl){
                            riskEl.title = riskLabel;
                            riskEl.setAttribute('aria-label', riskLabel);
                            riskEl.innerHTML = this.renderSparkline(riskVals, 220, 36, '#ef4444', riskLabel);
                        }
                    } catch (e) { /* ignore */ }
                }).catch(()=>{});
                // Wire Risk Factors button
                const rfBtn = document.getElementById('openRiskFactorsBtn');
                if (rfBtn) {
                    rfBtn.addEventListener('click', () => openDashboardRiskModal(this.getAuthToken()));
                }
                
                // Update onboarding progress
                this.updateOnboardingProgress();
                
                // Show/hide getting started guide based on data
                const nextStepsSection = document.getElementById('nextSteps');
                if (nextStepsSection) {
                    if (metrics.documents_analyzed === 0) {
                        nextStepsSection.style.display = 'block';
                    } else {
                        nextStepsSection.style.display = 'none';
                    }
                }
            }

            renderMetricsError(status) {
                const metricsGrid = document.getElementById('metricsGrid');
                const token = this.getAuthToken();
                const code = String(status || '');
                const needsLogin = code.includes('401') || code.includes('403') || !token;
                const desc = needsLogin ? 'You may need to sign in to view your metrics.' : 'Please refresh the page to try again.';
                const action = needsLogin ? `<a href="/login-enhanced-v2.html" class="action-btn" style="margin-top:8px">Sign In</a>` : '';
                metricsGrid.innerHTML = `
                    <div class="metric-card">
                        <div class="empty-state">
                            <div class="empty-icon">⚠️</div>
                            <div class="empty-title">Unable to load metrics${code? ` (HTTP ${code})`: ''}</div>
                            <div class="empty-description">${desc}</div>
                            ${action}
                        </div>
                    </div>
                `;
            }

            selectedCount() {
                try {
                    const raw = localStorage.getItem('mms:selectedStandards') || localStorage.getItem('selectedStandards') || '[]';
                    const arr = JSON.parse(raw); return Array.isArray(arr) ? arr.length : 0;
                } catch(_) { return 0; }
            }

            renderNextSteps() {
                const el = document.getElementById('nextSteps');
                const list = document.getElementById('nextStepsList');
                if (!el || !list) return;
                const settings = this.settings || {};
                const metrics = this.lastMetrics || null;
                const core = metrics && metrics.core_metrics ? metrics.core_metrics : {};
                const docs = Number(core.documents_analyzed || core.total_documents || 0);
                const hasOrg = !!(settings.organization || settings.institution_name);
                const hasAccr = !!(settings.primary_accreditor);
                const size = settings.institution_size || settings.enrollment || '';
                const programs = settings.programs || settings.program_list || [];
                const progCount = Array.isArray(programs) ? programs.length : (typeof programs === 'string' ? programs.split(',').filter(Boolean).length : 0);
                const sel = this.selectedCount();

                const items = [];
                if (!(hasOrg && hasAccr)) items.push({ id:'onboarding', text:'Complete onboarding to personalize your dashboard', href:'#', action: () => window.MMS_ONBOARDING && window.MMS_ONBOARDING.openWizard && window.MMS_ONBOARDING.openWizard(settings) });
                if (!docs) items.push({ id:'upload', text:`Upload evidence documents${size? ` • target ${size}+ pages or key policies`:''}`, href:'/upload-working.html' });
                if (!sel) items.push({ id:'standards', text:'Browse and select standards to focus on', href:'/standards-modern' });
                const reportHint = progCount ? `Generate reports • include ${progCount} program${progCount>1?'s':''}` : 'Generate reports when you’re ready';
                items.push({ id:'reports', text: reportHint, href:'/reports-modern' });

                if (!items.length) { el.style.display = 'none'; return; }
                list.innerHTML = '';
                for (const it of items) {
                    const li = document.createElement('li');
                    li.innerHTML = `<a class="section-action" href="${it.href||'#'}" aria-label="${it.text}">${it.text}</a>`;
                    const a = li.querySelector('a');
                    if (it.action) a.addEventListener('click', (e) => { e.preventDefault(); it.action(); });
                    try { if (window.MMS_UX && MMS_UX.attachTooltip) MMS_UX.attachTooltip(a, it.text); } catch(_){ }
                    list.appendChild(li);
                }
                el.style.display = '';
            }

            async loadActivity() {
                const activityList = document.getElementById('activityList');
                try {
                    // Show loading state
                    activityList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">🔄</div>
                            <div class="spinner"></div>
                            <div class="empty-description">Loading your recent activity...</div>
                        </div>`;
                    
                    // Fetch activity data
                    const token = this.getAuthToken();
                    const response = await fetch('https://api.mapmystandards.ai/api/user/intelligence-simple/documents/recent', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (!response.ok) throw new Error('Failed to fetch activity');
                    
                    const data = await response.json();
                    const activities = data.activities || data.documents || [];
                    
                    if (activities.length === 0) {
                        activityList.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-icon">📁</div>
                                <div class="empty-title">No recent activity</div>
                                <div class="empty-description">Upload documents to see processing and mapping activity here.</div>
                                <a class="empty-action" href="/upload-working.html">Upload Documents</a>
                            </div>`;
                    } else {
                        // Render activity items
                        activityList.innerHTML = activities.slice(0, 5).map(activity => {
                            const date = new Date(activity.created_at || activity.upload_date).toLocaleDateString();
                            const icon = activity.status === 'completed' ? '✅' : 
                                        activity.status === 'processing' ? '⏳' : '📄';
                            return `
                                <div class="activity-item">
                                    <div class="activity-icon">${icon}</div>
                                    <div class="activity-content">
                                        <div class="activity-title">${activity.filename || activity.name || 'Document'}</div>
                                        <div class="activity-meta">${activity.status || 'Uploaded'} • ${date}</div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                } catch (error) {
                    console.error('Error loading activity:', error);
                    activityList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">📁</div>
                            <div class="empty-title">No recent activity</div>
                            <div class="empty-description">Upload documents to see processing and mapping activity here.</div>
                            <a class="empty-action" href="/upload-working.html">Upload Documents</a>
                        </div>`;
                }
            }

            async loadProgress() {
                const progressOverview = document.getElementById('progressOverview');
                try {
                    // Show loading state
                    progressOverview.innerHTML = `
                        <div class="progress-item">
                            <div class="skeleton" style="height: 60px; border-radius: var(--border-radius);"></div>
                        </div>`;
                    
                    // Fetch compliance data
                    const token = this.getAuthToken();
                    const response = await fetch('https://api.mapmystandards.ai/api/user/intelligence-simple/compliance/summary', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (!response.ok) throw new Error('Failed to fetch progress');
                    
                    const data = await response.json();
                    
                    if (!data.total_standards || data.total_standards === 0) {
                        progressOverview.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-icon">🧭</div>
                                <div class="empty-title">No progress to show yet</div>
                                <div class="empty-description">Once your documents are analyzed, compliance progress will appear here.</div>
                                <a class="empty-action" href="/upload-working.html">Start by Uploading</a>
                            </div>`;
                    } else {
                        // Calculate percentages
                        const mappedPercent = Math.round((data.mapped_standards / data.total_standards) * 100);
                        const compliantPercent = Math.round(data.compliance_score || 0);
                        
                        progressOverview.innerHTML = `
                            <div class="progress-item">
                                <div class="progress-header">
                                    <span class="progress-label">Standards Coverage</span>
                                    <span class="progress-value">${mappedPercent}%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${mappedPercent}%"></div>
                                </div>
                                <div class="progress-meta">${data.mapped_standards} of ${data.total_standards} standards mapped</div>
                            </div>
                            
                            <div class="progress-item">
                                <div class="progress-header">
                                    <span class="progress-label">Compliance Score</span>
                                    <span class="progress-value">${compliantPercent}%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${compliantPercent}%; background: var(--green-500);"></div>
                                </div>
                                <div class="progress-meta">${data.compliant_standards || 0} standards fully compliant</div>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('Error loading progress:', error);
                    progressOverview.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">🧭</div>
                            <div class="empty-title">No progress to show yet</div>
                            <div class="empty-description">Once your documents are analyzed, compliance progress will appear here.</div>
                            <a class="empty-action" href="/upload-working.html">Start by Uploading</a>
                        </div>`;
                }
            }
            
            async loadGapAnalysis() {
                const gapSummary = document.getElementById('gapAnalysisSummary');
                if (!gapSummary) return;
                
                try {
                    const token = this.getAuthToken();
                    const response = await fetch('https://api.mapmystandards.ai/api/user/intelligence-simple/risk/summary', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.total_gaps > 0) {
                            const highRisk = data.high_risk_gaps || 0;
                            const medRisk = data.medium_risk_gaps || 0;
                            const lowRisk = data.low_risk_gaps || 0;
                            
                            gapSummary.innerHTML = `
                                <div style="background:#fef3c7; border:1px solid #fbbf24; border-radius:8px; padding:12px; margin-bottom:8px;">
                                    <div style="display:flex; justify-content:space-between; align-items:center;">
                                        <div>
                                            <div style="font-weight:600; color:#92400e;">${data.total_gaps} Compliance Gaps Found</div>
                                            <div style="font-size:14px; color:#78350f; margin-top:4px;">
                                                High Risk: ${highRisk} • Medium: ${medRisk} • Low: ${lowRisk}
                                            </div>
                                        </div>
                                        <div style="font-size:24px;">⚠️</div>
                                    </div>
                                </div>
                            `;
                        } else if (data.documents_analyzed > 0) {
                            gapSummary.innerHTML = `
                                <div style="background:#d1fae5; border:1px solid #34d399; border-radius:8px; padding:12px;">
                                    <div style="display:flex; justify-content:space-between; align-items:center;">
                                        <div>
                                            <div style="font-weight:600; color:#065f46;">No Gaps Detected</div>
                                            <div style="font-size:14px; color:#047857; margin-top:4px;">
                                                All analyzed standards are compliant
                                            </div>
                                        </div>
                                        <div style="font-size:24px;">✅</div>
                                    </div>
                                </div>
                            `;
                        } else {
                            gapSummary.innerHTML = '';
                        }
                    }
                } catch (error) {
                    console.error('Error loading gap analysis:', error);
                    gapSummary.innerHTML = '';
                }
            }

            updateOnboardingProgress() {
                // Check completion status
                let completedSteps = 0;
                const totalSteps = 4;
                
                // Check if user has uploaded documents
                if (this.metrics && this.metrics.documents_analyzed > 0) completedSteps++;
                
                // Check if standards are mapped
                if (this.metrics && this.metrics.standards_mapped > 0) completedSteps++;
                
                // Check if compliance score exists
                if (this.metrics && this.metrics.compliance_score > 0) completedSteps++;
                
                // Check if user has generated any reports
                if (this.metrics && this.metrics.reports_generated > 0) completedSteps++;
                
                // Update progress bar
                const percentage = Math.round((completedSteps / totalSteps) * 100);
                const progressBar = document.getElementById('progressBar');
                const progressText = document.getElementById('progressText');
                const progressSteps = document.getElementById('progressSteps');
                
                if (progressBar) {
                    progressBar.style.width = percentage + '%';
                }
                if (progressText) {
                    progressText.textContent = percentage + '% Complete';
                }
                if (progressSteps) {
                    progressSteps.textContent = `${completedSteps} of ${totalSteps} steps completed`;
                }
                
                // Hide progress indicator if fully complete
                if (percentage === 100) {
                    setTimeout(() => {
                        const progressContainer = document.querySelector('.onboarding-progress');
                        if (progressContainer) {
                            progressContainer.style.transition = 'opacity 0.5s ease';
                            progressContainer.style.opacity = '0';
                            setTimeout(() => {
                                progressContainer.style.display = 'none';
                            }, 500);
                        }
                    }, 3000);
                }
            }
            
            getAuthToken() {
                return localStorage.getItem('a3e_api_key') ||
                       sessionStorage.getItem('a3e_api_key') ||
                       localStorage.getItem('token') ||
                       localStorage.getItem('access_token') ||
                       localStorage.getItem('jwt_token') ||
                       '';
            }

            async ensureTimeseries(accreditor) {
                const now = Date.now();
                this._tsCache = this._tsCache || { acc: null, t: 0, series: [] };
                const stale = (now - this._tsCache.t) > 5*60*1000; // 5 minutes
                if (!stale && this._tsCache.acc === accreditor && (this._tsCache.series||[]).length) {
                    return this._tsCache.series;
                }
                const url = `${this.API_BASE}/api/user/intelligence-simple/metrics/timeseries/${encodeURIComponent(accreditor||'')}`;
                const token = this.getAuthToken();
                const headers = {
                    'Content-Type': 'application/json'
                };
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                const res = await fetch(url + '?days=30&limit=200', { 
                    credentials: 'include',
                    headers: headers
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                const series = (data && data.series) || [];
                this._tsCache = { acc: accreditor, t: now, series };
                return series;
            }

            renderSparkline(values, width=200, height=36, color='#3b82f6', tooltipLabel='') {
                if (!values || values.length < 2) {
                    return `<div style="font-size:12px;color:#6b7280">No trend yet</div>`;
                }
                const w = width, h = height, pad = 2;
                const min = Math.min(...values);
                const max = Math.max(...values);
                const range = (max - min) || 1;
                const stepX = (w - pad*2) / (values.length - 1);
                const points = values.map((v, i) => {
                    const x = pad + i * stepX;
                    const y = pad + (h - pad*2) * (1 - (v - min) / range);
                    return `${x.toFixed(1)},${y.toFixed(1)}`;
                }).join(' ');
                // Last value marker and gradient fill under line
                const last = values[values.length - 1];
                const lastX = pad + (values.length - 1) * stepX;
                const lastY = pad + (h - pad*2) * (1 - (last - min) / range);
                const areaPoints = ` ${pad},${h-pad} ` + points + ` ${lastX},${h-pad}`;
                const fill = color === '#10b981' ? 'rgba(16,185,129,0.15)' : 'rgba(245,158,11,0.18)';
                return `
                <svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}">
                    ${tooltipLabel ? `<title>${tooltipLabel.replace(/</g,'&lt;')}</title>` : ''}
                    <polyline points="${areaPoints}" fill="${fill}" stroke="none"></polyline>
                    <polyline points="${points}" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></polyline>
                    <circle cx="${lastX.toFixed(1)}" cy="${lastY.toFixed(1)}" r="2.5" fill="${color}" />
                </svg>`;
            }
        }

        // Risk Factors Modal (Dashboard)
        function ensureDashboardRiskModal(){
            if(document.getElementById('dashRiskModalBackdrop')) return;
            const backdrop = document.createElement('div');
            backdrop.id = 'dashRiskModalBackdrop';
            backdrop.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.35);display:none;align-items:center;justify-content:center;z-index:1000;';
            backdrop.innerHTML = `
                <div role="dialog" aria-modal="true" aria-labelledby="dashRiskTitle" style="background:#fff;width:min(720px,92vw);max-height:88vh;border-radius:12px;box-shadow:0 20px 40px rgba(0,0,0,0.2);overflow:hidden">
                    <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #eee;background:#f8fafc">
                        <div id="dashRiskTitle" style="font-weight:700;color:#111827">Gap Risk – Factor Breakdown</div>
                        <button id="dashRiskClose" style="background:#f3f4f6;border:1px solid #e5e7eb;border-radius:8px;padding:6px 10px;cursor:pointer">Close</button>
                    </div>
                    <div id="dashRiskBody" style="padding:12px 14px;font-size:14px;color:#111827">
                        <div>Loading factors…</div>
                    </div>
                    <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-top:1px solid #eee;background:#f9fafb">
                        <a href="/TRANSPARENCY_METRICS.md" target="_blank" style="font-size:12px;color:#2563eb;text-decoration:none">Transparency Reference ↗</a>
                        <button id="dashRiskRefresh" style="background:#2563eb;color:#fff;border:none;border-radius:8px;padding:6px 10px;cursor:pointer">Refresh</button>
                    </div>
                </div>`;
            backdrop.addEventListener('click', (e)=>{ if(e.target===backdrop) closeDashboardRiskModal(); });
            document.body.appendChild(backdrop);
            document.getElementById('dashRiskClose').onclick = closeDashboardRiskModal;
            document.getElementById('dashRiskRefresh').onclick = () => openDashboardRiskModal();
        }

        function openDashboardRiskModal(token){
            ensureDashboardRiskModal();
            const el = document.getElementById('dashRiskModalBackdrop');
            const body = document.getElementById('dashRiskBody');
            el.style.display = 'flex';
            body.innerHTML = '<div>Loading factors…</div>';
            const guessJwt = (t)=>{ try{ return typeof t==='string' && t.split('.').length===3 && t.length>40; }catch{return false;} };
            const auth = token || localStorage.getItem('a3e_api_key') || sessionStorage.getItem('a3e_api_key') || localStorage.getItem('access_token') || localStorage.getItem('jwt_token') || '';
            const hdrs = guessJwt(auth) ? { 'Authorization': `Bearer ${auth}` } : {};
            const base = ((window.mmsAPI&&window.mmsAPI.getBaseUrl&&window.mmsAPI.getBaseUrl())||(location.hostname.includes('api.mapmystandards.ai')?'':'https://api.mapmystandards.ai'));
            Promise.all([
                fetch(base + '/api/user/intelligence-simple/risk/aggregate', { credentials:'include', headers: hdrs }).then(async r=>{ if(r.status===401) throw new Error('401 Unauthorized'); return r.json(); }).catch(()=>({})),
                fetch(base + '/api/user/intelligence-simple/risk/factors', { credentials:'include', headers: hdrs }).then(async r=>{ if(r.status===401) throw new Error('401 Unauthorized'); return r.json(); }).catch(()=>({}))
            ]).then(([agg, fac])=>{
                const data = (agg && agg.data) || {};
                const weights = (fac && fac.weights) || {};
                const factors = (fac && fac.factors) || [];
                const top = (data.top_factors || []).slice(0,5);
                const items = top.length ? top : factors.map(f=>({ name: f.name, contribution: 0 }));
                const list = items.map(it=>{
                    const w = weights[it.name] ?? weights[it.key] ?? 0;
                    const contrib = (it.contribution ?? 0);
                    const pct = Math.round(Math.min(100, Math.max(0, contrib*100)));
                    return `<div style='display:flex;align-items:center;justify-content:space-between;margin:6px 0'>
                        <div style='min-width:180px'>${it.name || it.key}</div>
                        <div style='flex:1;height:8px;background:#f3f4f6;border-radius:999px;overflow:hidden;margin:0 10px'><div style='width:${pct}%;height:100%;background:#f59e0b'></div></div>
                        <div style='min-width:60px;text-align:right;color:#6b7280'>${pct}%</div>
                    </div>`;
                }).join('');
                body.innerHTML = `
                    <div style='margin-bottom:8px;color:#374151'>Top factor contributions across scored standards</div>
                    ${list || '<div style="color:#6b7280">No factor data yet. Score some standards to populate.</div>'}
                `;
            }).catch(()=>{
                body.innerHTML = '<div style="color:#dc2626">Failed to load risk data.</div>';
            });
        }

        function closeDashboardRiskModal(){
            const el = document.getElementById('dashRiskModalBackdrop');
            if (el) el.style.display = 'none';
        }

                // Inject AI action sections near end of body
        // Keyboard shortcuts for power users
        document.addEventListener('keydown', (e) => {
            // Check if no input is focused
            if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA') return;
            
            // Ctrl/Cmd + U = Upload
            if ((e.ctrlKey || e.metaKey) && e.key === 'u') {
                e.preventDefault();
                window.location.href = '/upload-working.html';
            }
            
            // Ctrl/Cmd + R = Reports
            if ((e.ctrlKey || e.metaKey) && e.key === 'r' && !e.shiftKey) {
                e.preventDefault();
                window.location.href = '/reports-modern';
            }
            
            // Ctrl/Cmd + S = Standards
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                window.location.href = '/standards-modern';
            }
            
            // ? = Show shortcuts
            if (e.key === '?' && !e.ctrlKey && !e.metaKey && !e.shiftKey) {
                e.preventDefault();
                showKeyboardShortcuts();
            }
        });
        
        // Show keyboard shortcuts modal
        function showKeyboardShortcuts() {
            const existingModal = document.getElementById('shortcutsModal');
            if (existingModal) existingModal.remove();
            
            const modal = document.createElement('div');
            modal.id = 'shortcutsModal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;display:flex;align-items:center;justify-content:center;animation:fadeIn 0.3s ease;';
            modal.onclick = () => modal.remove();
            
            const content = document.createElement('div');
            content.style.cssText = 'background:white;border-radius:16px;padding:32px;max-width:400px;box-shadow:0 20px 25px -5px rgba(0,0,0,0.1);animation:slideIn 0.3s ease;';
            content.onclick = (e) => e.stopPropagation();
            content.innerHTML = `
                <h2 style="margin-bottom:20px;font-size:24px;font-weight:700;">⌨️ Keyboard Shortcuts</h2>
                <div style="display:grid;gap:12px;">
                    <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #e5e7eb;">
                        <span>Upload Documents</span>
                        <kbd style="background:#f3f4f6;padding:4px 8px;border-radius:4px;font-family:monospace;font-size:12px;">${navigator.platform.includes('Mac') ? 'Cmd' : 'Ctrl'}+U</kbd>
                    </div>
                    <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #e5e7eb;">
                        <span>View Standards</span>
                        <kbd style="background:#f3f4f6;padding:4px 8px;border-radius:4px;font-family:monospace;font-size:12px;">${navigator.platform.includes('Mac') ? 'Cmd' : 'Ctrl'}+S</kbd>
                    </div>
                    <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #e5e7eb;">
                        <span>Generate Reports</span>
                        <kbd style="background:#f3f4f6;padding:4px 8px;border-radius:4px;font-family:monospace;font-size:12px;">${navigator.platform.includes('Mac') ? 'Cmd' : 'Ctrl'}+R</kbd>
                    </div>
                    <div style="display:flex;justify-content:space-between;padding:8px 0;">
                        <span>Show this help</span>
                        <kbd style="background:#f3f4f6;padding:4px 8px;border-radius:4px;font-family:monospace;font-size:12px;">?</kbd>
                    </div>
                </div>
                <button onclick="this.parentElement.parentElement.remove()" style="margin-top:24px;width:100%;padding:12px;background:#3b82f6;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;transition:background 0.2s;">Got it!</button>
            `;
            
            // Add animations
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
                @keyframes slideIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
            `;
            document.head.appendChild(style);
            
            modal.appendChild(content);
            document.body.appendChild(modal);
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // Personalize header from local data
            (function personalizeUser(){
                function parseJwt(token){ try{ const p = JSON.parse(atob(token.split('.')[1])); return p||{}; }catch{return {}} }
                const stored = (()=>{ try{return JSON.parse(localStorage.getItem('user')||'null')}catch{return null} })();
                const email = localStorage.getItem('a3e_user_email') || stored?.email || '';
                const token = localStorage.getItem('a3e_api_key') || localStorage.getItem('access_token') || localStorage.getItem('jwt_token') || '';
                const claims = token && token.split('.').length===3 ? parseJwt(token) : {};
                const fullName = stored?.name || claims.name || claims.full_name || claims.given_name && claims.family_name ? `${claims.given_name||''} ${claims.family_name||''}`.trim() : '';
                const display = fullName || (email ? email.split('@')[0] : 'User');
                const initials = (function(name){ const parts = (name||'').trim().split(/\s+/).filter(Boolean); if(!parts.length) return (email? email[0] : 'U').toUpperCase(); const first = parts[0][0]||''; const last = parts.length>1 ? parts[parts.length-1][0] : ''; return (first+last).toUpperCase(); })(fullName||display);
                const avatar = document.getElementById('userAvatar'); if (avatar) avatar.textContent = initials;
                const nameEl = document.getElementById('userDisplayName'); if (nameEl) nameEl.textContent = display;
                const welcome = document.getElementById('welcomeTitle'); if (welcome) welcome.textContent = `Welcome back, ${display}! 👋`;
            })();

            new Dashboard();

                        const container = document.querySelector('main');
                        if (container && !document.getElementById('ai-evidence')) {
                                const wrapper = document.createElement('div');
                                wrapper.className = 'content-grid';
                                wrapper.style.gridTemplateColumns = '1fr 1fr';
                                                wrapper.innerHTML = `
                                    <section id="ai-evidence" class="activity-section" aria-labelledby="aiEvidenceTitle">
                                        <div class="section-header">
                                            <h2 id="aiEvidenceTitle" class="section-title">AI Evidence Analysis</h2>
                                            <button id="dashViewAnalysis" class="section-action" onclick="window.open('/web/dashboard-evidence-analysis.html', '_blank')">View Analysis</button>
                                        </div>
                                        <div style="padding: var(--space-6);">
                                            <p class="section-description">Upload documents for intelligent standards mapping</p>
                                            <div id="dashDropZone" role="button" tabindex="0" aria-label="Upload area" style="margin-top:12px;border:2px dashed var(--gray-300);border-radius:12px;padding:20px;text-align:center;color:var(--gray-600)">
                                                Drag & drop files here or
                                                <button type="button" id="dashBrowseBtn" class="action-btn action-btn-primary" style="margin-left:8px">Browse files</button>
                                                <div style="margin-top:6px;font-size:12px;color:var(--gray-500)">PDF, Word, Text. You can drop multiple files.</div>
                                            </div>
                                            <input type="file" id="dashFileInput" accept=".pdf,.doc,.docx,.txt" multiple style="display:none" />
                                                            <div id="dashRecentUploadsContainer" style="margin-top:12px;text-align:left">
                                                                <div style="font-weight:600;color:#1f2937">Recent uploads</div>
                                                                <ul id="dashRecentUploads" style="margin-top:6px;list-style:none;padding:0;color:#374151"></ul>
                                                            </div>
                                        </div>
                                    </section>
                                    <section id="standards-graph" class="activity-section" aria-labelledby="standardsGraphTitle">
                                        <div class="section-header">
                                            <h2 id="standardsGraphTitle" class="section-title">Standards Graph™</h2>
                                            <button id="dashViewGraph" class="section-action">View Graph</button>
                                        </div>
                                        <div style="padding: var(--space-6);">
                                            <p class="section-description">Explore standards relationships</p>
                                            <div style="margin-top:10px;display:flex;gap:8px">
                                                <input id="dashStandardsSearch" type="text" placeholder="Search standard, clause, indicator" style="flex:1;border:1px solid var(--gray-300);border-radius:8px;padding:8px 10px" />
                                                <button id="dashStandardsSearchBtn" class="action-btn">Search</button>
                                            </div>
                                        </div>
                                    </section>
                                    <section id="gap-analysis" class="activity-section" aria-labelledby="gapAnalysisTitle">
                                        <div class="section-header">
                                            <h2 id="gapAnalysisTitle" class="section-title">Gap Analysis</h2>
                                        </div>
                                        <div style="padding: var(--space-6);">
                                            <p class="section-description">AI-powered compliance gap detection</p>
                                            <div id="gapAnalysisSummary" style="margin-top:12px;">
                                                <!-- Gap summary will be loaded here -->
                                            </div>
                                            <button id="dashAnalyzeGaps" class="action-btn action-btn-primary" style="margin-top:10px">Analyze Gaps</button>
                                        </div>
                                    </section>
                                    <section id="narrative" class="activity-section" aria-labelledby="narrativeTitle">
                                        <div class="section-header">
                                            <h2 id="narrativeTitle" class="section-title">Narrative (CiteGuard)</h2>
                                        </div>
                                        <div style="padding: var(--space-6);">
                                            <p class="section-description">Generate and export your accreditation narrative</p>
                                            <button id="dashOpenNarrative" class="action-btn" style="margin-top:10px">Open Narrative</button>
                                        </div>
                                    </section>`;
                                container.appendChild(wrapper);
                        }

                        // Wire AI Evidence drag/drop
                        const dz = document.getElementById('dashDropZone');
                        const fi = document.getElementById('dashFileInput');
                        const br = document.getElementById('dashBrowseBtn');
                        if (br && fi) br.addEventListener('click', ()=> fi.click());
                        if (dz) {
                                ['dragenter','dragover'].forEach(evt => dz.addEventListener(evt, e=>{ e.preventDefault(); dz.style.background = '#f8fafc'; }));
                                ['dragleave','drop'].forEach(evt => dz.addEventListener(evt, e=>{ e.preventDefault(); dz.style.background = ''; }));
                                dz.addEventListener('drop', e=>{ const files = e.dataTransfer?.files; if (files && files.length) handleDashboardFiles(files); });
                                dz.addEventListener('keydown', e=>{ if(e.key==='Enter' && fi) fi.click(); });
                        }
                        if (fi) fi.addEventListener('change', ()=> handleDashboardFiles(fi.files));
                        // Render any stored recent uploads
                        renderRecentUploads();
                        
                        // Periodic refresh to check for stuck files
                        setInterval(async () => {
                            await checkAndUpdateQueuedFiles();
                            renderRecentUploads();
                        }, 10000); // Check every 10 seconds

                        // Wire Graph/Gaps/Narrative
                        const vg = document.getElementById('dashViewGraph'); 
                        if (vg) vg.addEventListener('click', () => {
                            // Navigate to standards page and trigger graph view
                            window.location.href='/standards-modern?showGraph=true';
                        });
                        const sb = document.getElementById('dashStandardsSearchBtn');
                        const si = document.getElementById('dashStandardsSearch');
                        if (sb && si) sb.addEventListener('click', ()=> { const q=encodeURIComponent(si.value||''); window.location.href = '/standards-modern?q=' + q; });
                        const gaps = document.getElementById('dashAnalyzeGaps'); 
                        if (gaps) gaps.addEventListener('click', generateGapAnalysisFromDashboard);
                        const narr = document.getElementById('dashOpenNarrative'); 
                        if (narr) narr.addEventListener('click', generateNarrativeFromDashboard);
                });

                function getStoredRecentUploads(){
                    try { return JSON.parse(localStorage.getItem('mms:recentUploads')||'[]') || []; } catch { return []; }
                }

                function setStoredRecentUploads(items){
                    try { localStorage.setItem('mms:recentUploads', JSON.stringify(items.slice(0,5))); } catch {}
                }

                async function renderRecentUploads(){
                    const list = document.getElementById('dashRecentUploads');
                    if (!list) return;
                    
                    try {
                        // Fetch actual document data from API
                        const token = localStorage.getItem('a3e_api_key') || localStorage.getItem('access_token') || localStorage.getItem('jwt_token');
                        const response = await fetch('https://api.mapmystandards.ai/api/user/intelligence-simple/documents/list', {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            const documents = (data.documents || []).slice(0, 5); // Show last 5
                            
                            if (documents.length > 0) {
                                list.innerHTML = documents.map(doc => {
                                    const statusColor = doc.status === 'completed' ? '#065f46' : '#92400e';
                                    const statusBg = doc.status === 'completed' ? '#ecfdf5' : '#fffbeb';
                                    const statusBorder = doc.status === 'completed' ? '#a7f3d0' : '#fde68a';
                                    const displayStatus = doc.status === 'completed' ? 'analyzed' : 
                                                        doc.status === 'processing' ? 'processing' : 'queued';
                                    
                                    return `<li style='display:flex;justify-content:space-between;gap:8px;border:1px solid #e5e7eb;border-radius:8px;padding:6px 8px;margin-top:6px'>
                                        <span style='overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:70%'>${doc.filename || doc.name}</span>
                                        <span style='font-size:12px;color:${statusColor};background:${statusBg};border:1px solid ${statusBorder};padding:2px 6px;border-radius:999px'>${displayStatus}</span>
                                    </li>`;
                                }).join('');
                                return;
                            }
                        }
                    } catch (error) {
                        console.error('Error fetching recent uploads:', error);
                    }
                    
                    // Fall back to localStorage data if API fails
                    const items = getStoredRecentUploads();
                    list.innerHTML = items.length ? items.map(it => {
                        let statusColor = '#6b7280';
                        let statusBg = '#f9fafb';
                        let statusBorder = '#e5e7eb';
                        let displayStatus = it.status;
                        
                        if (it.status === 'complete' || it.status === 'completed') {
                            statusColor = '#065f46';
                            statusBg = '#ecfdf5';
                            statusBorder = '#a7f3d0';
                            displayStatus = 'analyzed';
                        } else if (it.status === 'processing' || it.status === 'uploading') {
                            statusColor = '#1e40af';
                            statusBg = '#dbeafe';
                            statusBorder = '#93c5fd';
                            displayStatus = 'processing';
                        } else if (it.status === 'queued' || it.status === 'submitted') {
                            statusColor = '#92400e';
                            statusBg = '#fffbeb';
                            statusBorder = '#fde68a';
                            displayStatus = 'queued';
                        } else if (it.status === 'error' || it.status === 'failed') {
                            statusColor = '#991b1b';
                            statusBg = '#fee2e2';
                            statusBorder = '#fecaca';
                            displayStatus = 'failed';
                        }
                        
                        return `<li style='border:1px solid #e5e7eb;border-radius:8px;padding:8px;margin-top:6px'>
                            <div style='display:flex;justify-content:space-between;align-items:center;gap:8px'>
                                <span style='overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;font-size:14px'>${it.name}</span>
                                <span style='font-size:12px;color:${statusColor};background:${statusBg};border:1px solid ${statusBorder};padding:2px 8px;border-radius:999px;white-space:nowrap'>${displayStatus}</span>
                            </div>
                            ${it.trustScore !== undefined ? `
                                <div style='margin-top:6px;display:flex;gap:12px;font-size:12px;color:#6b7280'>
                                    <span>Trust Score: <strong style='color:#059669'>${it.trustScore}%</strong></span>
                                    ${it.standardsMapped !== undefined ? `<span>Standards: <strong>${it.standardsMapped}</strong></span>` : ''}
                                </div>
                            ` : ''}
                            ${(it.status === 'complete' || it.status === 'processed') ? `
                                <div style='margin-top:6px;display:flex;gap:8px'>
                                    <button onclick="mapEvidenceForFile('${it.name}')" class="action-btn action-btn-primary" style="font-size:12px;padding:4px 12px">
                                        🔗 Map to Standards
                                    </button>
                                    ${it.standardsMapped ? `
                                        <button onclick="viewMappedStandards('${it.name}')" class="action-btn" style="font-size:12px;padding:4px 12px">
                                            👁️ View Mappings
                                        </button>
                                    ` : ''}
                                </div>
                            ` : ''}
                            ${(it.status === 'processing' || it.status === 'queued') ? `
                                <div style='margin-top:6px;display:flex;gap:8px'>
                                    <button onclick="triggerAnalysis('${it.fileId || ''}', '${it.name}')" class="action-btn action-btn-primary" 
                                            style="font-size:12px;padding:4px 12px;background:var(--accent-orange)">
                                        ⚡ Trigger Analysis
                                    </button>
                                    <button onclick="checkAnalysisStatus('${it.fileId || ''}', '${it.name}')" class="action-btn" 
                                            style="font-size:12px;padding:4px 12px">
                                        🔄 Check Status
                                    </button>
                                </div>
                            ` : ''}
                            ${it.status === 'error' || it.status === 'failed' ? `
                                <div style='margin-top:6px;font-size:12px;color:var(--accent-red)'>
                                    Analysis failed. Please try re-uploading the document.
                                </div>
                            ` : ''}
                        </li>`;
                    }).join('') : `<li style='color:#6b7280;margin-top:6px'>No recent uploads</li>`;
                }

                async function handleDashboardFiles(fileList){
                        try {
                                if (!fileList || fileList.length===0) return;
                                const form = new FormData();
                        const recent = getStoredRecentUploads();
                        for (const f of fileList) {
                            form.append('files', f);
                            recent.unshift({ name: f.name, status: 'uploading', ts: Date.now() });
                        }
                        
                        // Add accreditor (default to SACSCOC for now)
                        form.append('accreditor', 'SACSCOC');
                        form.append('auto_analyze', 'true');
                        
                        setStoredRecentUploads(recent);
                        renderRecentUploads();
                                const base = ((window.mmsAPI&&window.mmsAPI.getBaseUrl&&window.mmsAPI.getBaseUrl())||(location.hostname.includes('api.mapmystandards.ai')?'':'https://api.mapmystandards.ai'));
                                const token = localStorage.getItem('a3e_api_key') || localStorage.getItem('access_token') || localStorage.getItem('jwt_token');
                                const headers = {};
                                if (token) {
                                    headers['Authorization'] = `Bearer ${token}`;
                                }
                                
                                // Try the new evidence analysis endpoint first
                                let res = await fetch(base + '/api/evidence-analysis/upload', { 
                                    method:'POST', 
                                    body: form, 
                                    credentials:'include',
                                    headers: headers
                                });
                                
                                if (!res.ok && (res.status === 404 || res.status === 405)) {
                                    // Fall back to the simple intelligence upload
                                    form.delete('accreditor');
                                    form.delete('auto_analyze');
                                    res = await fetch(base + '/api/user/intelligence-simple/evidence/upload', { 
                                        method:'POST', 
                                        body: form, 
                                        credentials:'include',
                                        headers: headers
                                    });
                                }
                                
                                if (!res.ok) {
                                    // If both new routes fail, fall back to documents upload (one-by-one)
                                    if (res.status === 404 || res.status === 405) {
                                        await (async function uploadViaDocumentsRoute(files){
                                            for (const f of files) {
                                                const fd = new FormData();
                                                fd.append('file', f);
                                                const token = localStorage.getItem('a3e_api_key') || localStorage.getItem('access_token') || localStorage.getItem('jwt_token');
                                                const headers = {};
                                                if (token) {
                                                    headers['Authorization'] = `Bearer ${token}`;
                                                }
                                                const r = await fetch(base + '/documents/upload', { 
                                                    method:'POST', 
                                                    body: fd, 
                                                    credentials:'include',
                                                    headers: headers
                                                });
                                                if (!r.ok) throw new Error('Fallback upload failed');
                                            }
                                        })(fileList);
                                    } else {
                                        throw new Error('Upload failed');
                                    }
                                } else {
                                    // Successfully uploaded via evidence analysis endpoint
                                    const data = await res.json();
                                    console.log('Upload response:', data);
                                    
                                    if (data.files && Array.isArray(data.files)) {
                                        // Handle array of files response
                                        data.files.forEach((file, index) => {
                                            const originalFile = fileList[index];
                                            if (originalFile) {
                                                const fileId = file.id || file.file_id || `local_${Date.now()}_${index}`;
                                                syncUploadStatus(originalFile.name, 'processing', { 
                                                    fileId: fileId,
                                                    size: originalFile.size,
                                                    type: originalFile.type
                                                });
                                                
                                                // If analysis wasn't auto-triggered, trigger it manually
                                                if (file.status === 'uploaded' || file.status === 'queued') {
                                                    setTimeout(() => {
                                                        triggerAnalysis(fileId, originalFile.name);
                                                    }, 1000);
                                                } else {
                                                    // Poll for results
                                                    pollAnalysisStatus(fileId, originalFile.name);
                                                }
                                            }
                                        });
                                    } else if (data.id || data.file_id) {
                                        // Handle single file response
                                        const fileId = data.id || data.file_id || `local_${Date.now()}`;
                                        fileList.forEach((file, index) => {
                                            syncUploadStatus(file.name, 'complete', { 
                                                fileId: fileId + (index > 0 ? `_${index}` : ''),
                                                size: file.size,
                                                type: file.type
                                            });
                                        });
                                    } else {
                                        // Fallback: generate local IDs
                                        console.warn('No file IDs in response, generating local IDs');
                                        fileList.forEach((file, index) => {
                                            const fileId = `local_${Date.now()}_${index}`;
                                            syncUploadStatus(file.name, 'complete', { 
                                                fileId: fileId,
                                                size: file.size,
                                                type: file.type
                                            });
                                        });
                                    }
                                }
                        // Mark files as queued/processing
                        const ok = getStoredRecentUploads().map((it,i)=> i<fileList.length ? { ...it, status: 'processing' } : it);
                        setStoredRecentUploads(ok);
                        renderRecentUploads();
                        } catch (e) { 
                            console.error('Upload error:', e);
                            alert('Unable to upload files. Please sign in and try again.'); 
                        }
                }
                
                // Sync upload status with main upload system
                async function syncUploadStatus(fileName, status, data = {}) {
                    try {
                        // Update local storage for dashboard
                        const recent = getStoredRecentUploads();
                        const idx = recent.findIndex(r => r.name === fileName);
                        if (idx !== -1) {
                            recent[idx] = { ...recent[idx], status, ...data };
                            setStoredRecentUploads(recent);
                            renderRecentUploads();
                        }
                        
                        // Also update main upload system storage
                        const uploadHistory = JSON.parse(localStorage.getItem('mms:uploadHistory') || '[]');
                        uploadHistory.unshift({
                            fileName,
                            status,
                            timestamp: Date.now(),
                            source: 'dashboard',
                            ...data
                        });
                        localStorage.setItem('mms:uploadHistory', JSON.stringify(uploadHistory.slice(0, 50)));
                        
                        // CRITICAL: Sync with main uploadedFiles array used by standards browser
                        const uploadedFiles = JSON.parse(localStorage.getItem('uploadedFiles') || '[]');
                        const existingFile = uploadedFiles.find(f => f.name === fileName);
                        
                        if (!existingFile) {
                            // Add to uploadedFiles
                            uploadedFiles.push({
                                name: fileName,
                                filename: fileName, // Some parts expect 'filename' instead of 'name'
                                id: data.fileId || `local_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                                fileId: data.fileId, // Duplicate for compatibility
                                uploadDate: new Date().toISOString(),
                                status: status,
                                mappingStatus: 'not_mapped',
                                source: 'dashboard_ai_evidence',
                                size: data.size || 0,
                                type: data.type || 'application/octet-stream',
                                ...data
                            });
                            localStorage.setItem('uploadedFiles', JSON.stringify(uploadedFiles));
                        } else if (existingFile) {
                            // Update existing file status and ensure it has an ID
                            existingFile.status = status;
                            if (data.fileId && !existingFile.id) {
                                existingFile.id = data.fileId;
                                existingFile.fileId = data.fileId;
                            }
                            Object.assign(existingFile, data);
                            localStorage.setItem('uploadedFiles', JSON.stringify(uploadedFiles));
                            existingFile.status = status;
                            Object.assign(existingFile, data);
                            localStorage.setItem('uploadedFiles', JSON.stringify(uploadedFiles));
                        }
                        
                        // Emit custom event for other pages to listen
                        window.dispatchEvent(new CustomEvent('fileUploadUpdate', { 
                            detail: { fileName, status, ...data } 
                        }));
                    } catch (e) {
                        console.error('Error syncing upload status:', e);
                    }
                }
                
                // Poll for analysis status
                async function pollAnalysisStatus(fileId, fileName) {
                    const base = ((window.mmsAPI&&window.mmsAPI.getBaseUrl&&window.mmsAPI.getBaseUrl())||(location.hostname.includes('api.mapmystandards.ai')?'':'https://api.mapmystandards.ai'));
                    const token = localStorage.getItem('a3e_api_key') || localStorage.getItem('access_token') || localStorage.getItem('jwt_token');
                    const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
                    
                    const maxAttempts = 60;
                    let attempts = 0;
                    let lastStatus = 'queued';
                    
                    const poll = async () => {
                        try {
                            const response = await fetch(`${base}/api/evidence-analysis/status/${fileId}`, {
                                headers: headers,
                                credentials: 'include'
                            });
                            
                            if (!response.ok) {
                                // If 404, file might be already processed, check document list
                                if (response.status === 404) {
                                    const listResponse = await fetch(`${base}/api/user/intelligence-simple/documents/list`, {
                                        headers: headers,
                                        credentials: 'include'
                                    });
                                    if (listResponse.ok) {
                                        const docs = await listResponse.json();
                                        const foundDoc = (docs.documents || []).find(d => 
                                            d.id === fileId || d.filename === fileName
                                        );
                                        if (foundDoc) {
                                            syncUploadStatus(fileName, 'complete', {
                                                fileId: fileId,
                                                trustScore: foundDoc.trust_score,
                                                standardsMapped: foundDoc.standard_mappings
                                            });
                                            return;
                                        }
                                    }
                                }
                                
                                // If still processing, continue polling
                                if (lastStatus === 'processing' && attempts < maxAttempts) {
                                    attempts++;
                                    // Use progressive delays: faster at first, slower later
                                    const delay = attempts < 10 ? 2000 : attempts < 30 ? 3000 : 5000;
                                    setTimeout(poll, delay);
                                }
                                return;
                            }
                            
                            const data = await response.json();
                            
                            // Update file status in recent uploads
                            const status = data.status === 'completed' ? 'complete' : 
                                          data.status === 'failed' ? 'error' : 'processing';
                            
                            lastStatus = status;
                            
                            const updateData = {
                                fileId: fileId,
                                trustScore: data.trust_score,
                                standardsMapped: data.mapped_standards_count
                            };
                            
                            // Use sync function to update both dashboard and main upload system
                            syncUploadStatus(fileName || data.filename, status, updateData);
                            
                            // Continue polling if not completed
                            if (data.status !== 'completed' && data.status !== 'failed' && attempts < maxAttempts) {
                                attempts++;
                                // Use progressive delays
                                const delay = attempts < 10 ? 2000 : attempts < 30 ? 3000 : 5000;
                                setTimeout(poll, delay);
                            }
                            
                        } catch (error) {
                            console.error('Poll error:', error);
                            attempts++;
                            if (attempts < maxAttempts) {
                                // Progressive retry delays
                                const delay = attempts < 10 ? 3000 : 5000;
                                setTimeout(poll, delay);
                            } else {
                                // After max attempts, try one final check in the document list
                                try {
                                    const listResponse = await fetch(`${base}/api/user/intelligence-simple/documents/list`, {
                                        headers: headers,
                                        credentials: 'include'
                                    });
                                    if (listResponse.ok) {
                                        const docs = await listResponse.json();
                                        const foundDoc = (docs.documents || []).find(d => 
                                            d.id === fileId || d.filename === fileName
                                        );
                                        if (foundDoc && foundDoc.trust_score !== undefined) {
                                            syncUploadStatus(fileName, 'complete', {
                                                fileId: fileId,
                                                trustScore: foundDoc.trust_score,
                                                standardsMapped: foundDoc.standard_mappings ? foundDoc.standard_mappings.length : 0
                                            });
                                            return;
                                        }
                                    }
                                } catch (e) {
                                    console.error('Final check error:', e);
                                }
                                
                                // Mark as complete with helpful message
                                syncUploadStatus(fileName, 'complete', { 
                                    fileId: fileId,
                                    message: 'Analysis may still be processing. Use "Check Status" button to verify.',
                                    trustScore: 0,
                                    standardsMapped: 0
                                });
                            }
                        }
                    };
                    
                    // Start polling immediately with faster initial checks
                    setTimeout(poll, 1000);
                }

                // Check and update queued files
                async function checkAndUpdateQueuedFiles() {
                    try {
                        const base = ((window.mmsAPI&&window.mmsAPI.getBaseUrl&&window.mmsAPI.getBaseUrl())||(location.hostname.includes('api.mapmystandards.ai')?'':'https://api.mapmystandards.ai'));
                        const token = localStorage.getItem('a3e_api_key') || localStorage.getItem('access_token') || localStorage.getItem('jwt_token');
                        const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
                        
                        // Get current queued files from localStorage
                        const recent = getStoredRecentUploads();
                        const queuedFiles = recent.filter(f => f.status === 'queued' || f.status === 'processing');
                        
                        if (queuedFiles.length === 0) return;
                        
                        // Check actual status from API
                        const listResponse = await fetch(`${base}/api/user/intelligence-simple/documents/list`, {
                            headers: headers,
                            credentials: 'include'
                        });
                        
                        if (listResponse.ok) {
                            const docs = await listResponse.json();
                            const docMap = new Map((docs.documents || []).map(d => [d.filename, d]));
                            
                            // Update statuses
                            queuedFiles.forEach(file => {
                                const doc = docMap.get(file.name);
                                if (doc) {
                                    const newStatus = doc.status === 'completed' ? 'complete' : 
                                                     doc.status === 'failed' ? 'error' : 'processing';
                                    
                                    if (newStatus !== file.status) {
                                        syncUploadStatus(file.name, newStatus, {
                                            fileId: doc.id,
                                            trustScore: doc.trust_score,
                                            standardsMapped: doc.standard_mappings
                                        });
                                    }
                                } else {
                                    // File not found in API, might be processed
                                    // Check if it's been queued for too long (> 2 minutes)
                                    if (file.ts && Date.now() - file.ts > 120000) {
                                        syncUploadStatus(file.name, 'complete', {});
                                    }
                                }
                            });
                        }
                    } catch (error) {
                        console.error('Error checking queued files:', error);
                    }
                }

                // Evidence Mapping Functions
                function mapEvidenceForFile(fileName) {
                    // Navigate to standards page with evidence ready for mapping
                    const params = new URLSearchParams();
                    params.set('evidence', fileName);
                    params.set('action', 'map');
                    window.location.href = `/standards-modern?${params.toString()}`;
                }

                function viewMappedStandards(fileName) {
                    // Find the file in recent uploads to get its ID and info
                    const recent = localStorage.getItem('recentUploads');
                    let fileInfo = null;
                    
                    if (recent) {
                        const uploads = JSON.parse(recent);
                        fileInfo = uploads.find(u => u.name === fileName);
                    }
                    
                    if (fileInfo && fileInfo.fileId) {
                        // Navigate to evidence library with file pre-selected
                        window.location.href = '/web/standards-modern.html#evidence-library';
                        
                        // Store file ID to auto-open details after navigation
                        localStorage.setItem('autoOpenEvidenceDetail', fileInfo.fileId);
                    } else {
                        // Fallback to evidence analysis page
                        const params = new URLSearchParams();
                        params.set('file', fileName);
                        window.location.href = `/web/dashboard-evidence-analysis.html?${params.toString()}`;
                    }
                }

                // Update file processing to track mapping status
                async function updateFileProcessingStatus(fileName) {
                    try {
                        const base = ((window.mmsAPI&&window.mmsAPI.getBaseUrl&&window.mmsAPI.getBaseUrl())||(location.hostname.includes('api.mapmystandards.ai')?'':'https://api.mapmystandards.ai'));
                        const token = localStorage.getItem('a3e_api_key') || localStorage.getItem('access_token') || localStorage.getItem('jwt_token');
                        
                        const response = await fetch(base + `/api/intelligence/evidence/status?filename=${encodeURIComponent(fileName)}`, {
                            headers: token ? { 'Authorization': `Bearer ${token}` } : {},
                            credentials: 'include'
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            const recent = getStoredRecentUploads();
                            const idx = recent.findIndex(r => r.name === fileName);
                            if (idx !== -1) {
                                recent[idx].status = data.status || 'complete';
                                recent[idx].trustScore = data.trust_score;
                                recent[idx].standardsMapped = data.mapped_standards_count;
                                setStoredRecentUploads(recent);
                                renderRecentUploads();
                            }
                        }
                    } catch (error) {
                        console.error('Error updating file status:', error);
                    }
                }

                // Add real-time status indicator
                function showMappingProgress(fileName, status) {
                    const notification = document.createElement('div');
                    notification.style.cssText = `
                        position: fixed;
                        bottom: 20px;
                        right: 20px;
                        background: white;
                        padding: 16px 24px;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        z-index: 1000;
                        animation: slideIn 0.3s ease;
                    `;
                    
                    const spinner = status === 'processing' ? `<div class="spinner" style="width: 20px; height: 20px; border-width: 2px;"></div>` : '';
                    const icon = status === 'complete' ? '✅' : status === 'error' ? '❌' : '';
                    
                    notification.innerHTML = `
                        ${spinner}
                        ${icon ? `<span style="font-size: 20px;">${icon}</span>` : ''}
                        <div>
                            <div style="font-weight: 600; color: #111827;">Evidence Mapping</div>
                            <div style="font-size: 14px; color: #6b7280;">
                                ${status === 'processing' ? `Processing ${fileName}...` : 
                                  status === 'complete' ? `Successfully mapped ${fileName}` :
                                  status === 'error' ? `Failed to map ${fileName}` : ''}
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(notification);
                    
                    if (status !== 'processing') {
                        setTimeout(() => notification.remove(), 5000);
                    }
                    
                    return notification;
                }

        </script>
        
        <!-- Metrics Detail Modal -->
        <div id="metricsDetailModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000;">
            <div style="position:relative; max-width:800px; margin:50px auto; background:white; border-radius:12px; box-shadow:0 10px 25px rgba(0,0,0,0.1); max-height:80vh; overflow-y:auto;">
                <div style="padding:24px; border-bottom:1px solid #e5e7eb;">
                    <h2 id="modalTitle" style="font-size:24px; font-weight:700; color:#111827; margin:0;">Metric Details</h2>
                    <button onclick="closeMetricsModal()" style="position:absolute; top:24px; right:24px; background:none; border:none; font-size:24px; cursor:pointer; color:#6b7280;">×</button>
                </div>
                <div id="modalContent" style="padding:24px;">
                    <!-- Dynamic content will be inserted here -->
                </div>
            </div>
        </div>
        
        <script>
            // Make metric cards clickable
            function addMetricCardClickHandlers() {
                setTimeout(() => {
                    const metricCards = document.querySelectorAll('.metric-card');
                    metricCards.forEach((card, index) => {
                        card.style.cursor = 'pointer';
                        card.addEventListener('click', () => {
                            const labels = ['documents', 'standards', 'compliance', 'reports', 'trust', 'risk'];
                            const label = labels[index] || 'metric';
                            showMetricDetails(label);
                        });
                    });
                }, 100);
            }
            
            // Show metric details modal
            async function showMetricDetails(metricType) {
                const modal = document.getElementById('metricsDetailModal');
                const title = document.getElementById('modalTitle');
                const content = document.getElementById('modalContent');
                
                // Set title based on metric type
                const titles = {
                    'documents': 'Document Analysis Details',
                    'standards': 'Standards Mapping Details',
                    'compliance': 'Compliance Score Breakdown',
                    'reports': 'Generated Reports',
                    'trust': 'Evidence Trust Analysis',
                    'risk': 'Gap Risk Assessment'
                };
                
                title.textContent = titles[metricType] || 'Metric Details';
                
                // Show loading state
                content.innerHTML = '<div style="text-align:center; padding:40px;"><div class="loading-spinner"></div><p style="color:#6b7280; margin-top:16px;">Loading details...</p></div>';
                modal.style.display = 'block';
                
                try {
                    // Fetch detailed data based on metric type
                    const token = dashboard.getAuthToken();
                    const headers = { 'Authorization': `Bearer ${token}` };
                    let endpoint = '';
                    
                    switch(metricType) {
                        case 'documents':
                            endpoint = '/api/user/intelligence-simple/documents/list';
                            break;
                        case 'standards':
                            endpoint = '/api/user/intelligence-simple/mappings/summary';
                            break;
                        case 'compliance':
                            endpoint = '/api/user/intelligence-simple/compliance/details';
                            break;
                        case 'trust':
                            endpoint = '/api/user/intelligence-simple/evidence/trust-analysis';
                            break;
                        case 'risk':
                            endpoint = '/api/user/intelligence-simple/risk/analysis';
                            break;
                    }
                    
                    if (endpoint) {
                        const response = await fetch(endpoint, { headers });
                        const data = await response.json();
                        
                        // Render detailed content based on metric type
                        content.innerHTML = renderMetricDetailsContent(metricType, data);
                    }
                } catch (error) {
                    content.innerHTML = `
                        <div style="text-align:center; padding:40px; color:#ef4444;">
                            <p>Unable to load details. Please try again.</p>
                            <button onclick="closeMetricsModal()" style="margin-top:16px; padding:8px 16px; background:#3b82f6; color:white; border:none; border-radius:6px; cursor:pointer;">Close</button>
                        </div>
                    `;
                }
            }
            
            // Render content based on metric type
            function renderMetricDetailsContent(type, data) {
                switch(type) {
                    case 'documents':
                        const docs = data.documents || [];
                        if (docs.length === 0) {
                            return '<p style="color:#6b7280;">No documents uploaded yet.</p>';
                        }
                        return `
                            <div>
                                <h3 style="font-size:18px; font-weight:600; margin-bottom:16px;">Analyzed Documents</h3>
                                <div style="display:flex; flex-direction:column; gap:12px;">
                                    ${docs.map(doc => `
                                        <div style="padding:16px; border:1px solid #e5e7eb; border-radius:8px;">
                                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                                <div>
                                                    <h4 style="font-weight:600; color:#111827;">${doc.filename || 'Untitled'}</h4>
                                                    <p style="font-size:14px; color:#6b7280; margin-top:4px;">
                                                        Uploaded: ${new Date(doc.upload_date).toLocaleDateString()} • 
                                                        Standards mapped: ${doc.standards_count || 0}
                                                    </p>
                                                </div>
                                                <div style="text-align:right;">
                                                    <span style="display:inline-block; padding:4px 12px; background:#10b981; color:white; border-radius:12px; font-size:12px;">
                                                        ${doc.status || 'Analyzed'}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    
                    case 'standards':
                        const mappings = data.mappings || [];
                        const grouped = {};
                        mappings.forEach(m => {
                            const std = m.standard_id || 'Unknown';
                            if (!grouped[std]) grouped[std] = [];
                            grouped[std].push(m);
                        });
                        
                        return `
                            <div>
                                <h3 style="font-size:18px; font-weight:600; margin-bottom:16px;">Standards Coverage</h3>
                                <div style="display:flex; flex-direction:column; gap:12px;">
                                    ${Object.entries(grouped).map(([stdId, maps]) => `
                                        <div style="padding:16px; border:1px solid #e5e7eb; border-radius:8px;">
                                            <h4 style="font-weight:600; color:#111827;">${stdId}: ${maps[0]?.standard_title || 'Standard'}</h4>
                                            <p style="font-size:14px; color:#6b7280; margin-top:4px;">
                                                ${maps.length} document${maps.length > 1 ? 's' : ''} mapped
                                            </p>
                                            <div style="margin-top:8px;">
                                                ${maps.map(m => `
                                                    <div style="padding:8px; background:#f3f4f6; border-radius:4px; margin-top:4px;">
                                                        <span style="font-size:13px;">${m.document_name || 'Document'}</span>
                                                        <span style="float:right; color:#10b981; font-weight:500;">${Math.round(m.confidence * 100)}% match</span>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    
                    default:
                        return '<p style="color:#6b7280;">Details view coming soon...</p>';
                }
            }
            
            // Close modal
            function closeMetricsModal() {
                document.getElementById('metricsDetailModal').style.display = 'none';
            }
            
            // Close modal on outside click
            document.getElementById('metricsDetailModal').addEventListener('click', (e) => {
                if (e.target.id === 'metricsDetailModal') {
                    closeMetricsModal();
                }
            });
            
            // Update the renderMetrics function to call addMetricCardClickHandlers
            // This will be handled inside the Dashboard class initialization
        </script>
        
        <!-- Service worker registration for offline support -->
        <script>
        // Navigate to section helper
        function navigateToSection(sectionId) {
            // Check if section exists on current page
            const section = document.getElementById(sectionId);
            if (section) {
                // Smooth scroll to section
                section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                // Flash the section to highlight it
                section.style.transition = 'background-color 0.3s ease';
                section.style.backgroundColor = 'rgba(59, 130, 246, 0.1)';
                setTimeout(() => {
                    section.style.backgroundColor = '';
                }, 1500);
            } else {
                // Navigate to appropriate page based on section
                switch(sectionId) {
                    case 'evidence-upload':
                        // Scroll to upload section if on same page, otherwise show notification
                        const uploadSection = document.querySelector('.upload-section');
                        if (uploadSection) {
                            uploadSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        } else {
                            showNotification('View your uploaded documents in the Evidence Upload section below', 'info');
                        }
                        break;
                    case 'compliance-overview':
                        // Show compliance details modal or section
                        const complianceSection = document.querySelector('[data-section="compliance"]');
                        if (complianceSection) {
                            complianceSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        } else {
                            showNotification('View detailed compliance analysis in the overview below', 'info');
                        }
                        break;
                    default:
                        showNotification('Loading detailed view...', 'info');
                }
            }
        }

        // Show notification helper
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = 'notification notification-' + type;
            notification.textContent = message;
            
            // Style the notification
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : type === 'warning' ? '#f59e0b' : '#3b82f6'};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 0.5rem;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                z-index: 1000;
                max-width: 400px;
                animation: slideIn 0.3s ease-out;
            `;
            
            // Add animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }
        
        // Manual trigger for evidence analysis
        async function triggerAnalysis(fileId, fileName) {
            if (!fileId) {
                showNotification('File ID not available. Please wait for upload to complete.', 'warning');
                return;
            }
            
            try {
                const base = getBaseUrl();
                const token = getAuthToken();
                const headers = {
                    'Content-Type': 'application/json'
                };
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                // Show loading state
                showNotification('Triggering analysis for ' + fileName + '...', 'info');
                
                const response = await fetch(`${base}/api/evidence-analysis/analyze/${fileId}`, {
                    method: 'POST',
                    headers: headers,
                    credentials: 'include',
                    body: JSON.stringify({
                        accreditor: 'SACSCOC' // Default accreditor
                    })
                });
                
                if (response.ok) {
                    showNotification('Analysis triggered successfully! Results will appear shortly.', 'success');
                    
                    // Update status to processing
                    syncUploadStatus(fileName, 'processing', { fileId: fileId });
                    
                    // Start polling for results
                    pollAnalysisStatus(fileId, fileName);
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to trigger analysis');
                }
                
            } catch (error) {
                console.error('Error triggering analysis:', error);
                showNotification('Failed to trigger analysis: ' + error.message, 'error');
            }
        }
        
        // Check analysis status manually
        async function checkAnalysisStatus(fileId, fileName) {
            if (!fileId) {
                showNotification('File ID not available. Please wait for upload to complete.', 'warning');
                return;
            }
            
            try {
                const base = getBaseUrl();
                const token = getAuthToken();
                const headers = {};
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                const response = await fetch(`${base}/api/evidence-analysis/status/${fileId}`, {
                    headers: headers,
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.status === 'completed') {
                        showNotification(`Analysis complete! Trust Score: ${data.trust_score || 0}%, Standards Mapped: ${data.total_standards_mapped || 0}`, 'success');
                        
                        // Update status
                        syncUploadStatus(fileName, 'complete', {
                            fileId: fileId,
                            trustScore: data.trust_score,
                            standardsMapped: data.total_standards_mapped
                        });
                    } else if (data.status === 'failed') {
                        showNotification('Analysis failed: ' + (data.message || 'Unknown error'), 'error');
                        syncUploadStatus(fileName, 'error');
                    } else {
                        showNotification(`Analysis ${data.status || 'in progress'}: ${data.progress || 0}% complete`, 'info');
                        
                        // Continue polling if still processing
                        if (data.status === 'processing') {
                            setTimeout(() => checkAnalysisStatus(fileId, fileName), 3000);
                        }
                    }
                } else {
                    // Check if document exists in the system
                    const listResponse = await fetch(`${base}/api/user/intelligence-simple/documents/list`, {
                        headers: headers,
                        credentials: 'include'
                    });
                    
                    if (listResponse.ok) {
                        const docs = await listResponse.json();
                        const foundDoc = (docs.documents || []).find(d => 
                            d.id === fileId || d.filename === fileName
                        );
                        
                        if (foundDoc) {
                            showNotification(`Document found! Trust Score: ${foundDoc.trust_score || 0}%`, 'success');
                            syncUploadStatus(fileName, 'complete', {
                                fileId: fileId,
                                trustScore: foundDoc.trust_score,
                                standardsMapped: foundDoc.standard_mappings ? foundDoc.standard_mappings.length : 0
                            });
                        } else {
                            showNotification('Document not found in system. It may still be processing.', 'warning');
                        }
                    } else {
                        throw new Error('Unable to check document status');
                    }
                }
                
            } catch (error) {
                console.error('Error checking status:', error);
                showNotification('Failed to check status: ' + error.message, 'error');
            }
        }
        
        // Gap Analysis and Narrative Generation Functions
        async function generateGapAnalysisFromDashboard() {
            const btn = document.getElementById('dashAnalyzeGaps');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Analyzing...';
            
            try {
                // Get selected standards from localStorage
                const selectedStandards = JSON.parse(localStorage.getItem('mms:selectedStandards') || '[]');
                if (selectedStandards.length === 0) {
                    showNotification('Please select standards on the Standards page first', 'warning');
                    window.location.href = '/standards-modern';
                    return;
                }
                
                // Fetch evidence data
                const token = localStorage.getItem('auth_token');
                const docsResponse = await fetch(`${window.API_BASE_URL}/api/v1/evidence/documents`, {
                    headers: { 'Authorization': `Bearer ${token}` },
                    credentials: 'include'
                });
                
                if (!docsResponse.ok) throw new Error('Failed to fetch evidence');
                
                const docsData = await docsResponse.json();
                const evidenceMap = {};
                
                // Map evidence to standards
                if (docsData.success && Array.isArray(docsData.data)) {
                    docsData.data.forEach(doc => {
                        if (doc.mapped_standards) {
                            doc.mapped_standards.forEach(std => {
                                const stdId = std.code || std.id;
                                if (!evidenceMap[stdId]) evidenceMap[stdId] = [];
                                evidenceMap[stdId].push({ document: doc, mapping: std });
                            });
                        }
                    });
                }
                
                // Generate gap analysis report
                const reportHtml = generateDashboardGapAnalysis(selectedStandards, evidenceMap);
                const w = window.open('', '_blank');
                if (w) {
                    w.document.write(reportHtml);
                    w.document.close();
                }
                
                showNotification('Gap Analysis generated successfully!', 'success');
                
                // Update gap summary on dashboard
                updateGapSummary(selectedStandards, evidenceMap);
                
            } catch (error) {
                console.error('Error generating gap analysis:', error);
                showNotification('Failed to generate gap analysis', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }
        
        async function generateNarrativeFromDashboard() {
            const btn = document.getElementById('dashOpenNarrative');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Generating...';
            
            try {
                // Get selected standards
                const selectedStandards = JSON.parse(localStorage.getItem('mms:selectedStandards') || '[]');
                if (selectedStandards.length === 0) {
                    showNotification('Please select standards on the Standards page first', 'warning');
                    window.location.href = '/standards-modern';
                    return;
                }
                
                // Fetch evidence documents
                const token = localStorage.getItem('auth_token');
                const docsRes = await fetch(`${window.API_BASE_URL}/api/v1/evidence/documents`, { 
                    headers:{ 'Authorization': `Bearer ${token}` }, 
                    credentials:'include' 
                });
                
                let evidenceDocs = [];
                if (docsRes.ok) {
                    const docsData = await docsRes.json();
                    if (docsData.success && Array.isArray(docsData.data)) {
                        const mappedDocs = docsData.data.filter(doc => 
                            doc.mapped_standards && 
                            doc.mapped_standards.some(std => 
                                selectedStandards.includes(std.code || std.id)
                            )
                        );
                        evidenceDocs = mappedDocs.slice(0, 8).map(doc => ({
                            title: doc.filename || 'Evidence',
                            summary: doc.summary || `${doc.file_type} document uploaded ${new Date(doc.uploaded_at).toLocaleDateString()}`
                        }));
                    }
                }
                
                if (evidenceDocs.length === 0) {
                    showNotification('No mapped evidence found. Please map evidence to standards first.', 'warning');
                    return;
                }
                
                // Generate narrative
                const institution = localStorage.getItem('mms:institution') || 'Your Institution';
                const accreditor = localStorage.getItem('mms:lastSelectedAccreditor') || 'SACSCOC';
                
                const narrativeHtml = generateDashboardNarrative(selectedStandards[0], evidenceDocs, institution, accreditor);
                const w = window.open('', '_blank');
                if (w) {
                    w.document.write(narrativeHtml);
                    w.document.close();
                }
                
                showNotification('CiteGuard narrative generated successfully!', 'success');
                
            } catch (error) {
                console.error('Error generating narrative:', error);
                showNotification('Failed to generate narrative', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }
        
        function generateDashboardGapAnalysis(standardIds, evidenceData) {
            const reportDate = new Date().toLocaleDateString();
            const institution = localStorage.getItem('mms:institution') || 'Your Institution';
            const gaps = standardIds.filter(id => !evidenceData[id] || evidenceData[id].length === 0);
            
            return `<!DOCTYPE html>
            <html lang="en">
            <head>
                <meta charset="UTF-8">
                <title>Gap Analysis Report - Dashboard Generated</title>
                <style>
                    body { font-family: Arial, sans-serif; line-height: 1.6; margin: 40px; color: #333; }
                    h1 { color: #ef4444; border-bottom: 3px solid #ef4444; padding-bottom: 10px; }
                    h2 { color: #ef4444; margin-top: 30px; }
                    .header { margin-bottom: 30px; }
                    .summary { background: #fef2f2; padding: 20px; border-radius: 8px; margin: 20px 0; }
                    .gap { background: #fffbeb; border: 1px solid #fcd34d; padding: 20px; margin: 15px 0; border-radius: 8px; }
                    .critical { border-color: #ef4444; background: #fef2f2; }
                    .priority { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.85em; }
                    .high { background: #ef4444; color: white; }
                    .medium { background: #f59e0b; color: white; }
                    .low { background: #fbbf24; color: #1f2937; }
                    .meta { color: #6b7280; font-size: 0.9em; }
                </style>
            </head>
            <body>
                <div class="header">
                    <h1>⚠️ Gap Analysis Report</h1>
                    <div class="meta">
                        <p><strong>Institution:</strong> ${institution}</p>
                        <p><strong>Generated from:</strong> Dashboard</p>
                        <p><strong>Date:</strong> ${reportDate}</p>
                    </div>
                </div>
                
                <div class="summary">
                    <h2>Gap Summary</h2>
                    <p><strong>Total Standards Analyzed:</strong> ${standardIds.length}</p>
                    <p><strong>Standards with Evidence:</strong> ${standardIds.length - gaps.length}</p>
                    <p><strong>Standards with Gaps:</strong> ${gaps.length}</p>
                    <p><strong>Compliance Coverage:</strong> ${Math.round(((standardIds.length - gaps.length) / standardIds.length) * 100)}%</p>
                    <p><strong>Risk Level:</strong> ${gaps.length > standardIds.length * 0.3 ? 'HIGH' : gaps.length > standardIds.length * 0.1 ? 'MEDIUM' : 'LOW'}</p>
                </div>
                
                <h2>Standards with Evidence (${standardIds.length - gaps.length})</h2>
                ${standardIds.filter(id => evidenceData[id] && evidenceData[id].length > 0).map(stdId => {
                    const evidence = evidenceData[stdId];
                    return `
                        <div style="background: #f0fdf4; border: 1px solid #86efac; padding: 15px; margin: 10px 0; border-radius: 8px;">
                            <h3 style="color: #059669;">✓ ${stdId}</h3>
                            <p><strong>Evidence Count:</strong> ${evidence.length} document(s)</p>
                            <ul style="margin-top: 10px;">
                                ${evidence.slice(0, 3).map(e => `
                                    <li>${e.document.filename} (${e.mapping.relevance_score || 75}% relevance)</li>
                                `).join('')}
                                ${evidence.length > 3 ? `<li><em>...and ${evidence.length - 3} more</em></li>` : ''}
                            </ul>
                        </div>
                    `;
                }).join('')}
                
                <h2>Identified Compliance Gaps (${gaps.length})</h2>
                ${gaps.length === 0 ? '<p style="color: #059669;">🎉 No gaps identified! All selected standards have supporting evidence.</p>' : 
                gaps.map((gapId, index) => `
                    <div class="gap ${index < 5 ? 'critical' : ''}">
                        <h3>${gapId} <span class="priority ${index < 5 ? 'high' : index < 10 ? 'medium' : 'low'}">
                            ${index < 5 ? 'HIGH PRIORITY' : index < 10 ? 'MEDIUM PRIORITY' : 'LOW PRIORITY'}
                        </span></h3>
                        <p><strong>Status:</strong> No evidence currently mapped</p>
                        <p><strong>Action Required:</strong> Upload and map relevant documentation</p>
                        <p><strong>Suggested Evidence Types:</strong></p>
                        <ul>
                            <li>Policy documents related to ${gapId}</li>
                            <li>Meeting minutes demonstrating compliance</li>
                            <li>Assessment reports and data</li>
                            <li>Program documentation and procedures</li>
                        </ul>
                    </div>
                `).join('')}
                
                <h2>Quick Actions</h2>
                <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; margin-top: 20px;">
                    <h3>Immediate Steps to Close Gaps:</h3>
                    <ol>
                        <li><strong>Review existing documents:</strong> Check if you already have evidence that hasn't been uploaded</li>
                        <li><strong>Upload evidence:</strong> Use the dashboard upload feature to add documents</li>
                        <li><strong>Map to standards:</strong> Use the evidence mapping tool to connect documents to standards</li>
                        <li><strong>Generate reports:</strong> Create comprehensive compliance reports once gaps are addressed</li>
                    </ol>
                    
                    <p style="margin-top: 20px;">
                        <strong>Pro tip:</strong> Focus on high-priority gaps first. These are typically required standards or those with significant compliance impact.
                    </p>
                </div>
            </body>
            </html>`;
        }
        
        function generateDashboardNarrative(standardId, evidenceDocs, institution, accreditor) {
            const reportDate = new Date().toLocaleDateString();
            
            return `<!DOCTYPE html>
            <html lang="en">
            <head>
                <meta charset="UTF-8">
                <title>CiteGuard Narrative - ${standardId}</title>
                <style>
                    body { font-family: 'Times New Roman', serif; line-height: 2; margin: 40px 60px; color: #000; }
                    h1 { text-align: center; font-size: 24px; margin-bottom: 40px; }
                    .meta { text-align: center; margin-bottom: 40px; font-style: italic; }
                    .narrative { text-align: justify; margin: 20px 0; }
                    .citation { color: #1e40af; font-weight: bold; }
                    .evidence-list { margin-top: 40px; border-top: 2px solid #333; padding-top: 20px; }
                    .evidence-item { margin: 10px 0; }
                    @media print {
                        body { margin: 1in; }
                    }
                </style>
            </head>
            <body>
                <h1>Accreditation Narrative</h1>
                <div class="meta">
                    <p>${institution}<br>
                    Standard ${standardId}<br>
                    ${accreditor} Accreditation<br>
                    ${reportDate}</p>
                </div>
                
                <div class="narrative">
                    <p>
                        ${institution} demonstrates comprehensive compliance with Standard ${standardId} through 
                        systematic implementation of policies, procedures, and practices that align with ${accreditor} 
                        requirements. Our institutional commitment to excellence is evidenced through multiple 
                        supporting documents and established processes.
                    </p>
                    
                    <p>
                        The institution maintains robust documentation <span class="citation">[${evidenceDocs[0]?.title || 'Document 1'}]</span> 
                        that clearly demonstrates adherence to the standard's requirements. Through regular assessment 
                        and continuous improvement cycles, we ensure that our practices not only meet but exceed 
                        accreditation expectations ${evidenceDocs[1] ? `<span class="citation">[${evidenceDocs[1].title}]</span>` : ''}.
                    </p>
                    
                    <p>
                        Our evidence portfolio includes ${evidenceDocs.length} key documents that collectively 
                        demonstrate full compliance with this standard. These documents span various institutional 
                        areas and provide comprehensive coverage of all standard requirements 
                        ${evidenceDocs[2] ? `<span class="citation">[${evidenceDocs[2].title}]</span>` : ''}.
                    </p>
                    
                    <p>
                        The institution's commitment to this standard is further evidenced through:
                    </p>
                    <ul>
                        <li>Regular review and updates of relevant policies ${evidenceDocs[3] ? `<span class="citation">[${evidenceDocs[3].title}]</span>` : ''}</li>
                        <li>Systematic data collection and analysis processes</li>
                        <li>Stakeholder engagement and feedback mechanisms ${evidenceDocs[4] ? `<span class="citation">[${evidenceDocs[4].title}]</span>` : ''}</li>
                        <li>Continuous improvement initiatives based on assessment results</li>
                    </ul>
                    
                    <p>
                        In conclusion, ${institution} has established and maintains effective systems and processes 
                        that ensure ongoing compliance with Standard ${standardId}. Our comprehensive documentation, 
                        coupled with active monitoring and improvement practices, demonstrates our unwavering 
                        commitment to meeting ${accreditor} standards and advancing our institutional mission.
                    </p>
                </div>
                
                <div class="evidence-list">
                    <h2>Evidence Documents</h2>
                    ${evidenceDocs.map((doc, index) => `
                        <div class="evidence-item">
                            <strong>[${doc.title}]:</strong> ${doc.summary}
                        </div>
                    `).join('')}
                </div>
                
                <div style="margin-top: 40px; padding: 20px; background: #f0f9ff; border-radius: 8px;">
                    <p><strong>Note:</strong> This narrative was generated from the dashboard using mapped evidence. 
                    For a more comprehensive narrative with additional customization options, please use the 
                    Reports page narrative generator.</p>
                </div>
            </body>
            </html>`;
        }
        
        function updateGapSummary(standardIds, evidenceMap) {
            const summaryDiv = document.getElementById('gapAnalysisSummary');
            if (!summaryDiv) return;
            
            const gaps = standardIds.filter(id => !evidenceMap[id] || evidenceMap[id].length === 0);
            const coverage = Math.round(((standardIds.length - gaps.length) / standardIds.length) * 100);
            
            summaryDiv.innerHTML = `
                <div style="background: var(--bg-light); padding: 12px; border-radius: 8px; border: 1px solid var(--border-light);">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>Coverage:</span>
                        <strong>${coverage}%</strong>
                    </div>
                    <div style="width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden;">
                        <div style="width: ${coverage}%; height: 100%; background: ${coverage > 80 ? '#10b981' : coverage > 60 ? '#f59e0b' : '#ef4444'};"></div>
                    </div>
                    <div style="margin-top: 8px; font-size: 0.875rem; color: var(--text-medium);">
                        ${gaps.length} gap${gaps.length !== 1 ? 's' : ''} identified in ${standardIds.length} standard${standardIds.length !== 1 ? 's' : ''}
                    </div>
                </div>
            `;
        }
        
        // Service worker registration for offline support
        if ('serviceWorker' in navigator) {
            const v = '20250920-1';
            const rootSw = `/sw.js?v=${v}`;
            navigator.serviceWorker.register(rootSw).catch(() => {});
        }
    </script>
    
    <!-- Info Banner Component -->
    <script src="/web/banner-component.js"></script>
</body>
</html>