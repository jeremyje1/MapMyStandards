<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Upload - MapMyStandards</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <style>
        /* Enhanced Upload Styles */
        .upload-container {
            background: #ffffff;
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            padding: 40px;
            margin: 0 auto 30px;
            max-width: 900px;
        }

        .upload-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .upload-header h1 {
            font-size: 2.5rem;
            color: #0F3875;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .upload-header p {
            font-size: 1.1rem;
            color: #666;
        }

        .upload-zone {
            border: 3px dashed #d1d5db;
            border-radius: 12px;
            padding: 60px 40px;
            text-align: center;
            background: #f8fafc;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .upload-zone.drag-over {
            border-color: #0F3875;
            background: #eef4ff;
            transform: scale(1.02);
        }

        .upload-zone.uploading {
            pointer-events: none;
            opacity: 0.7;
        }

        .upload-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: #eef4ff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .upload-zone.drag-over .upload-icon {
            background: #0F3875;
            transform: scale(1.1);
        }

        .upload-icon svg {
            width: 40px;
            height: 40px;
            fill: #0F3875;
            transition: all 0.3s ease;
        }

        .upload-zone.drag-over .upload-icon svg {
            fill: white;
        }

        .upload-text h3 {
            font-size: 1.5rem;
            color: #0F3875;
            margin-bottom: 10px;
        }

        .upload-text p {
            color: #666;
            margin-bottom: 20px;
        }

        .file-input {
            display: none;
        }

        .browse-button {
            background: #0F3875;
            color: white;
            padding: 12px 30px;
            border-radius: 8px;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .browse-button:hover {
            background: #0d2f5f;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(15, 56, 117, 0.3);
        }

        /* File List Styles */
        .files-section {
            margin-top: 40px;
        }

        .files-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }

        .files-header h2 {
            font-size: 1.8rem;
            color: #0F3875;
            margin: 0;
        }

        .file-count {
            background: #eef4ff;
            color: #0F3875;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .files-list {
            display: grid;
            gap: 15px;
        }

        .file-item {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .file-item:hover {
            transform: translateX(5px);
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.1);
            border-color: #0F3875;
        }

        .file-icon {
            width: 50px;
            height: 50px;
            background: #eef4ff;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .file-details {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 5px;
            font-size: 1.1rem;
        }

        .file-meta {
            display: flex;
            gap: 20px;
            font-size: 0.9rem;
            color: #6b7280;
        }

        .file-actions {
            display: flex;
            gap: 10px;
        }

        .file-action-button {
            background: white;
            border: 1px solid #e5e7eb;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .file-action-button:hover {
            background: #f3f4f6;
            border-color: #0F3875;
            color: #0F3875;
        }

        .file-action-button.download {
            background: #0F3875;
            color: white;
            border-color: #0F3875;
        }

        .file-action-button.download:hover {
            background: #0d2f5f;
        }

        /* Progress Bar */
        .upload-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: #e5e7eb;
            border-radius: 0 0 12px 12px;
            overflow: hidden;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .upload-progress.active {
            opacity: 1;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #0F3875 0%, #1e56a0 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state h3 {
            font-size: 1.3rem;
            margin-bottom: 10px;
            color: #4b5563;
        }

        /* Success Animation */
        @keyframes successPulse {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .success-indicator {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 100px;
            background: #10b981;
            border-radius: 50%;
            align-items: center;
            justify-content: center;
            animation: successPulse 0.6s ease-out;
        }

        .success-indicator svg {
            width: 60px;
            height: 60px;
            fill: white;
        }

        /* Notification Banner */
        .notification-banner {
            position: fixed;
            top: 20px;
            right: 20px;
            max-width: 400px;
            padding: 16px 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 15px;
            transform: translateX(120%);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .notification-banner.show {
            transform: translateX(0);
        }

        .notification-banner.success {
            border-left: 4px solid #10b981;
        }

        .notification-banner.error {
            border-left: 4px solid #ef4444;
        }

        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .notification-banner.success .notification-icon {
            background: #d1fae5;
            color: #10b981;
        }

        .notification-banner.error .notification-icon {
            background: #fee2e2;
            color: #ef4444;
        }

        .notification-content h4 {
            margin: 0 0 5px;
            font-size: 1rem;
            font-weight: 600;
        }

        .notification-content p {
            margin: 0;
            font-size: 0.9rem;
            color: #6b7280;
        }

        /* Page Layout Styles */
        body {
            margin: 0;
            padding: 0;
        }
        
        .main-content {
            min-height: calc(100vh - 200px);
            padding: 40px 0;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .upload-container {
                padding: 20px;
            }

            .upload-zone {
                padding: 40px 20px;
            }

            .files-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }

            .file-item {
                flex-direction: column;
                text-align: center;
            }

            .file-actions {
                width: 100%;
                justify-content: center;
            }

            .notification-banner {
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <!-- Simple Header -->
    <header style="background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 20px 0;">
        <div class="container">
            <h2 style="margin: 0; color: #0F3875;">MapMyStandards - Document Upload</h2>
        </div>
    </header>

    <main class="main-content">
        <div class="container">
            <div class="upload-container">
                <div class="upload-header">
                    <h1>Document Upload</h1>
                    <p>Upload your accreditation documents for AI-powered analysis</p>
                </div>

                <div class="upload-zone" id="uploadZone">
                    <div class="upload-icon">
                        <svg viewBox="0 0 24 24">
                            <path d="M14,13V17H10V13H7L12,8L17,13M19.35,10.03C18.67,6.59 15.64,4 12,4C9.11,4 6.6,5.64 5.35,8.03C2.34,8.36 0,10.9 0,14A6,6 0 0,0 6,20H19A5,5 0 0,0 24,15C24,12.36 21.95,10.22 19.35,10.03Z" />
                        </svg>
                    </div>
                    <div class="upload-text">
                        <h3>Drag & Drop your files here</h3>
                        <p>or click to browse from your computer</p>
                        <button class="browse-button" onclick="document.getElementById('fileInput').click()">
                            Browse Files
                        </button>
                    </div>
                    <input type="file" id="fileInput" class="file-input" multiple accept=".pdf,.docx,.doc,.xlsx,.xls,.csv,.txt,.md,.png,.jpg,.jpeg,.gif,.pptx,.ppt">
                    <div class="upload-progress" id="uploadProgress">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                    <div class="success-indicator" id="successIndicator">
                        <svg viewBox="0 0 24 24">
                            <path d="M9,20.42L2.79,14.21L5.62,11.38L9,14.77L18.88,4.88L21.71,7.71L9,20.42Z" />
                        </svg>
                    </div>
                </div>
            </div>

            <div class="files-section">
                <div class="files-header">
                    <h2>Your Documents</h2>
                    <div class="file-count" id="fileCount">0 files</div>
                </div>
                <div class="files-list" id="filesList">
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24">
                            <path fill="currentColor" d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />
                        </svg>
                        <h3>No documents yet</h3>
                        <p>Upload your first document to get started</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Simple Footer -->
    <footer style="background: #f8f9fa; padding: 40px 0; margin-top: 60px; border-top: 1px solid #e5e7eb;">
        <div class="container" style="text-align: center; color: #6b7280;">
            <p>Â© 2025 MapMyStandards. All rights reserved.</p>
        </div>
    </footer>

    <!-- Notification Banner -->
    <div class="notification-banner" id="notificationBanner">
        <div class="notification-icon">
            <svg viewBox="0 0 24 24" width="24" height="24">
                <path fill="currentColor" d="M9,20.42L2.79,14.21L5.62,11.38L9,14.77L18.88,4.88L21.71,7.71L9,20.42Z" />
            </svg>
        </div>
        <div class="notification-content">
            <h4 id="notificationTitle">Success!</h4>
            <p id="notificationMessage">File uploaded successfully</p>
        </div>
    </div>

    <!-- Inline auth and common functions -->
    <script>
        // Check if user is authenticated
        function checkAuth() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = '/login.html';
                return false;
            }
            return true;
        }
        
        // Initialize auth check
        if (!checkAuth()) {
            // Stop execution if not authenticated
            throw new Error('Not authenticated');
        }
    </script>
    <script>
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, fetching documents...');
            loadUserFiles();
            setupUploadHandlers();
            
            // Also expose loadUserFiles globally for debugging
            window.loadUserFiles = loadUserFiles;
        });

        // Setup upload handlers
        function setupUploadHandlers() {
            const uploadZone = document.getElementById('uploadZone');
            const fileInput = document.getElementById('fileInput');

            // Drag and drop handlers
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('drag-over');
            });

            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('drag-over');
            });

            uploadZone.addEventListener('drop', async (e) => {
                e.preventDefault();
                uploadZone.classList.remove('drag-over');
                const files = Array.from(e.dataTransfer.files);
                await handleFiles(files);
            });

            // File input handler
            fileInput.addEventListener('change', async (e) => {
                const files = Array.from(e.target.files);
                await handleFiles(files);
            });

            // Click to upload
            uploadZone.addEventListener('click', (e) => {
                if (e.target.closest('button') || e.target.closest('input')) return;
                fileInput.click();
            });
        }

        // Handle file upload
        async function handleFiles(files) {
            for (const file of files) {
                await uploadFile(file);
            }
            await loadUserFiles();
        }

        // Upload single file using the working endpoint
        async function uploadFile(file) {
            const uploadZone = document.getElementById('uploadZone');
            const progressBar = document.getElementById('progressBar');
            const uploadProgress = document.getElementById('uploadProgress');
            const successIndicator = document.getElementById('successIndicator');

            const token = localStorage.getItem('access_token');
            if (!token) {
                showNotification('error', 'Not Authenticated', 'Please log in to upload documents');
                setTimeout(() => {
                    window.location.href = '/login-enhanced-v2.html';
                }, 2000);
                return;
            }

            try {
                // Show upload state
                uploadZone.classList.add('uploading');
                uploadProgress.classList.add('active');
                progressBar.style.width = '0%';

                const formData = new FormData();
                formData.append('files', file);

                // Simulate progress (since we can't track real upload progress with fetch)
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += Math.random() * 30;
                    if (progress > 90) progress = 90;
                    progressBar.style.width = progress + '%';
                }, 300);

                // Use the working intelligence-simple upload endpoint
                const response = await fetch('https://api.mapmystandards.ai/api/user/intelligence-simple/evidence/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData,
                    credentials: 'include'
                });

                clearInterval(progressInterval);
                progressBar.style.width = '100%';

                if (response.status === 401) {
                    // Token expired or invalid
                    localStorage.removeItem('access_token');
                    localStorage.removeItem('refresh_token');
                    showNotification('error', 'Session Expired', 'Please log in again');
                    setTimeout(() => {
                        window.location.href = '/login-enhanced-v2.html';
                    }, 2000);
                    uploadZone.classList.remove('uploading');
                    uploadProgress.classList.remove('active');
                    return;
                }

                if (!response.ok) {
                    const error = await response.json().catch(() => ({ detail: 'Upload failed' }));
                    throw new Error(error.detail || `Upload failed: ${response.status}`);
                }

                const result = await response.json();
                
                // Show success
                setTimeout(() => {
                    uploadProgress.classList.remove('active');
                    successIndicator.style.display = 'flex';
                    setTimeout(() => {
                        successIndicator.style.display = 'none';
                        uploadZone.classList.remove('uploading');
                    }, 1500);
                }, 500);

                showNotification('success', 'Upload Successful', `${file.name} has been uploaded`);
                
                // Reload the documents list after successful upload
                console.log('Upload complete, refreshing documents list...');
                // Add a small delay to ensure backend has processed the upload
                setTimeout(async () => {
                    await loadUserFiles();
                    console.log('Documents list refreshed');
                }, 1000);
                
            } catch (error) {
                console.error('Upload error:', error);
                uploadProgress.classList.remove('active');
                uploadZone.classList.remove('uploading');
                showNotification('error', 'Upload Failed', error.message);
            }
        }

        // Load user files using the working endpoint
        async function loadUserFiles() {
            try {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    console.log('No access token found, redirecting to login...');
                    window.location.href = '/login-enhanced-v2.html';
                    return;
                }

                const response = await fetch('https://api.mapmystandards.ai/api/user/intelligence-simple/uploads', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    credentials: 'include'
                });

                if (response.status === 401) {
                    // Token expired or invalid
                    console.log('Authentication failed (401), redirecting to login...');
                    localStorage.removeItem('access_token');
                    localStorage.removeItem('refresh_token');
                    window.location.href = '/login-enhanced-v2.html';
                    return;
                }

                if (!response.ok) {
                    throw new Error(`Failed to load files: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log('API Response:', data);
                
                // The API returns documents in the 'evidence' array
                const files = data.evidence || data.documents || [];
                console.log(`Found ${files.length} documents`);
                displayFiles(files);
                
            } catch (error) {
                console.error('Error loading files:', error);
                // Don't display empty list on error, just show error message
                showNotification('error', 'Failed to load documents', 'Please try refreshing the page');
            }
        }

        // Display files
        function displayFiles(files) {
            const filesList = document.getElementById('filesList');
            const fileCount = document.getElementById('fileCount');
            
            fileCount.textContent = `${files.length} file${files.length !== 1 ? 's' : ''}`;
            
            if (files.length === 0) {
                filesList.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24">
                            <path fill="currentColor" d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />
                        </svg>
                        <h3>No documents yet</h3>
                        <p>Upload your first document to get started</p>
                    </div>
                `;
                return;
            }

            filesList.innerHTML = files.map(file => `
                <div class="file-item" data-file-id="${file.id}">
                    <div class="file-icon">
                        <svg viewBox="0 0 24 24">
                            <path fill="#0F3875" d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />
                        </svg>
                    </div>
                    <div class="file-details">
                        <div class="file-name">${file.filename}</div>
                        <div class="file-meta">
                            <span>${formatFileSize(file.size || 0)}</span>
                            <span>${formatDate(file.uploaded_at)}</span>
                        </div>
                    </div>
                    <div class="file-actions">
                        <button class="file-action-button download" onclick="downloadFile('${file.id}', '${file.filename}')">
                            <svg viewBox="0 0 24 24" width="16" height="16">
                                <path fill="currentColor" d="M5,20H19V18H5M19,9H15V3H9V9H5L12,16L19,9Z" />
                            </svg>
                            Download
                        </button>
                        <button class="file-action-button" onclick="deleteFile('${file.id}')">
                            <svg viewBox="0 0 24 24" width="16" height="16">
                                <path fill="currentColor" d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z" />
                            </svg>
                            Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Download file
        async function downloadFile(fileId, filename) {
            try {
                const response = await fetch(`https://api.mapmystandards.ai/api/user/intelligence-simple/uploads/${fileId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    },
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Download failed');
                }

                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showNotification('success', 'Download Started', `${filename} is being downloaded`);
            } catch (error) {
                console.error('Download error:', error);
                showNotification('error', 'Download Failed', error.message);
            }
        }

        // Delete file
        async function deleteFile(fileId) {
            if (!confirm('Are you sure you want to delete this file?')) return;

            try {
                const response = await fetch(`https://api.mapmystandards.ai/api/user/intelligence-simple/uploads/${fileId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    },
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Delete failed');
                }

                showNotification('success', 'File Deleted', 'The file has been removed');
                await loadUserFiles();
            } catch (error) {
                console.error('Delete error:', error);
                showNotification('error', 'Delete Failed', error.message);
            }
        }

        // Show notification
        function showNotification(type, title, message) {
            const banner = document.getElementById('notificationBanner');
            const titleEl = document.getElementById('notificationTitle');
            const messageEl = document.getElementById('notificationMessage');
            const icon = banner.querySelector('.notification-icon svg');
            
            banner.className = `notification-banner ${type}`;
            titleEl.textContent = title;
            messageEl.textContent = message;
            
            if (type === 'error') {
                icon.innerHTML = '<path fill="currentColor" d="M12,2C17.53,2 22,6.47 22,12C22,17.53 17.53,22 12,22C6.47,22 2,17.53 2,12C2,6.47 6.47,2 12,2M15.59,7L12,10.59L8.41,7L7,8.41L10.59,12L7,15.59L8.41,17L12,13.41L15.59,17L17,15.59L13.41,12L17,8.41L15.59,7Z" />';
            } else {
                icon.innerHTML = '<path fill="currentColor" d="M9,20.42L2.79,14.21L5.62,11.38L9,14.77L18.88,4.88L21.71,7.71L9,20.42Z" />';
            }
            
            banner.classList.add('show');
            setTimeout(() => {
                banner.classList.remove('show');
            }, 5000);
        }

        // Utility functions
        function formatFileSize(bytes) {
            if (!bytes || bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDate(dateString) {
            if (!dateString) return 'Unknown';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }
    </script>
</body>
</html>