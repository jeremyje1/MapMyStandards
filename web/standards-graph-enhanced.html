<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Standards Graph - MapMyStandards</title>
        <script src="js/common.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3@7.8.5/dist/d3.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f7fa;
            color: #333;
        }

        .nav-header {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .nav-header h1 {
            color: #2c5aa0;
            font-size: 1.5rem;
            margin: 0;
        }

        .nav-links {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .nav-links a {
            color: #555;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            transition: background 0.3s;
        }

        .nav-links a:hover {
            background: #f0f0f0;
        }

        .nav-links .active {
            color: #2c5aa0;
            font-weight: 600;
        }

        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .graph-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 2rem;
            min-height: 600px;
        }

        .controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .controls select, .controls input {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .controls button {
            padding: 0.5rem 1rem;
            background: #2c5aa0;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
        }

        .controls button:hover {
            background: #1e3d6f;
        }

        #graph {
            width: 100%;
            height: 600px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .tooltip {
            position: absolute;
            text-align: left;
            padding: 10px;
            font-size: 14px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 5px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 1rem;
            border-radius: 5px;
            margin: 1rem 0;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .nav-header {
                padding: 1rem;
            }
            
            .nav-links {
                width: 100%;
                margin-top: 1rem;
                justify-content: center;
            }
            
            .graph-container {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <nav class="nav-header">
        <h1>StandardsGraphâ„¢</h1>
        <div class="nav-links">
            <a href="dashboard-enhanced.html">Dashboard</a>
            <a href="upload-enhanced-v2.html">Upload Evidence</a>
            <a href="standards-graph-enhanced.html" class="active">Standards Graph</a>
            <a href="compliance-dashboard-enhanced.html">Compliance</a>
            <a href="reports-enhanced.html">Reports</a>
            <a href="settings-enhanced.html">Settings</a>
            <a href="#" onclick="logout()">Logout</a>
        </div>
    </nav>

    <div class="container">
        <div class="graph-container">
            <div class="controls">
                <select id="accreditorSelect">
                    <option value="">Loading accreditors...</option>
                </select>
                <input type="text" id="searchInput" placeholder="Search standards...">
                <button onclick="resetGraph()">Reset View</button>
                <button onclick="expandAll()">Expand All</button>
                <button onclick="collapseAll()">Collapse All</button>
            </div>
            <div id="loading" class="loading">Loading standards graph...</div>
            <div id="error" class="error" style="display: none;"></div>
            <div id="graph"></div>
            <div class="tooltip"></div>
        </div>
    </div>

    <script>
        // Check authentication
        const token = localStorage.getItem('access_token');
        if (!token) {
            window.location.href = 'login-enhanced.html';
        }

        // Global variables
        let graphData = null;
        let simulation = null;
        let svg = null;

        // API Configuration
        const API_BASE_URL = 'https://api.mapmystandards.ai/api';

        // Load standards graph data
        async function loadStandardsGraph() {
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const graphEl = document.getElementById('graph');

            try {
                loadingEl.style.display = 'block';
                errorEl.style.display = 'none';
                graphEl.style.display = 'none';

                const response = await fetch(`${API_BASE_URL}/standards-graph`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                graphData = await response.json();
                console.log('Graph data loaded:', graphData);

                // Populate accreditor select
                populateAccreditors();
                
                // Render the graph
                renderGraph();
                
                loadingEl.style.display = 'none';
                graphEl.style.display = 'block';

            } catch (error) {
                console.error('Error loading graph:', error);
                loadingEl.style.display = 'none';
                errorEl.style.display = 'block';
                errorEl.textContent = `Error loading standards graph: ${error.message}`;
            }
        }

        function populateAccreditors() {
            const select = document.getElementById('accreditorSelect');
            select.innerHTML = '<option value="">All Accreditors</option>';
            
            if (graphData && graphData.metadata && graphData.metadata.accreditors) {
                graphData.metadata.accreditors.forEach(acc => {
                    const option = document.createElement('option');
                    option.value = acc;
                    option.textContent = acc;
                    select.appendChild(option);
                });
            }
        }

        function renderGraph() {
            if (!graphData || !graphData.nodes || !graphData.links) {
                console.error('Invalid graph data');
                return;
            }

            // Clear existing graph
            d3.select("#graph").selectAll("*").remove();

            // Set dimensions
            const width = document.getElementById('graph').clientWidth;
            const height = 600;

            // Create SVG
            svg = d3.select("#graph")
                .append("svg")
                .attr("width", width)
                .attr("height", height);

            // Create force simulation
            simulation = d3.forceSimulation(graphData.nodes)
                .force("link", d3.forceLink(graphData.links).id(d => d.id).distance(100))
                .force("charge", d3.forceManyBody().strength(-300))
                .force("center", d3.forceCenter(width / 2, height / 2))
                .force("collision", d3.forceCollide().radius(30));

            // Create links
            const link = svg.append("g")
                .selectAll("line")
                .data(graphData.links)
                .enter().append("line")
                .attr("stroke", "#999")
                .attr("stroke-opacity", 0.6)
                .attr("stroke-width", d => Math.sqrt(d.value || 1));

            // Create nodes
            const node = svg.append("g")
                .selectAll("circle")
                .data(graphData.nodes)
                .enter().append("circle")
                .attr("r", d => d.size || 10)
                .attr("fill", d => d.color || "#2c5aa0")
                .call(drag(simulation));

            // Add labels
            const label = svg.append("g")
                .selectAll("text")
                .data(graphData.nodes)
                .enter().append("text")
                .text(d => d.label || d.id)
                .attr("font-size", "12px")
                .attr("text-anchor", "middle")
                .attr("dy", -15);

            // Add tooltips
            const tooltip = d3.select(".tooltip");
            
            node.on("mouseover", function(event, d) {
                tooltip.transition().duration(200).style("opacity", .9);
                tooltip.html(`<strong>${d.label || d.id}</strong><br/>
                    Type: ${d.type || 'Standard'}<br/>
                    ${d.description || ''}`)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 28) + "px");
            })
            .on("mouseout", function() {
                tooltip.transition().duration(500).style("opacity", 0);
            });

            // Update positions on tick
            simulation.on("tick", () => {
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                node
                    .attr("cx", d => d.x)
                    .attr("cy", d => d.y);

                label
                    .attr("x", d => d.x)
                    .attr("y", d => d.y);
            });
        }

        // Drag functionality
        function drag(simulation) {
            function dragstarted(event) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                event.subject.fx = event.subject.x;
                event.subject.fy = event.subject.y;
            }
            
            function dragged(event) {
                event.subject.fx = event.x;
                event.subject.fy = event.y;
            }
            
            function dragended(event) {
                if (!event.active) simulation.alphaTarget(0);
                event.subject.fx = null;
                event.subject.fy = null;
            }
            
            return d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended);
        }

        // Control functions
        function resetGraph() {
            if (simulation) {
                simulation.alpha(1).restart();
            }
        }

        function expandAll() {
            // Implementation for expanding all nodes
            console.log('Expand all nodes');
        }

        function collapseAll() {
            // Implementation for collapsing all nodes
            console.log('Collapse all nodes');
        }

        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('user_email');
            window.location.href = 'login-enhanced.html';
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            d3.selectAll("circle").style("opacity", d => {
                const label = (d.label || d.id).toLowerCase();
                return label.includes(searchTerm) ? 1 : 0.3;
            });
        });

        // Accreditor filter
        document.getElementById('accreditorSelect').addEventListener('change', (e) => {
            const selectedAccreditor = e.target.value;
            if (selectedAccreditor) {
                // Filter nodes and links based on accreditor
                console.log('Filter by accreditor:', selectedAccreditor);
            } else {
                // Show all
                renderGraph();
            }
        });

        // Initialize
        loadStandardsGraph();
    </script>
</body>
</html>