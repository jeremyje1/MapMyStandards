<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subscription Manager - A³E | MapMyStandards.ai</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Tailwind (built) -->
    <link rel="stylesheet" href="/assets/styles.css">
    <script src="https://js.stripe.com/v3/"></script>
    <style>body { font-family: 'Inter', sans-serif; }</style>
</head>
<body class="bg-gray-50">
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div class="flex items-center">
                    <img src="https://mapmystandards.ai/wp-content/uploads/2025/07/Original-Logo.png" alt="MapMyStandards.ai" class="h-12 w-auto">
                    <h1 class="ml-4 text-xl font-semibold">Subscription Manager</h1>
                </div>
                <a href="javascript:history.back()" class="text-gray-600 hover:text-gray-900">← Back</a>
            </div>
        </div>
    </header>

    <div class="max-w-4xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
        <div id="trialStatusCard" class="bg-white rounded-2xl shadow-sm p-8 mb-8">
            <h2 class="text-2xl font-bold mb-6">Your Trial Status</h2>
            <div id="trialInfo"></div>
        </div>

        <div id="paymentCard" class="bg-white rounded-2xl shadow-sm p-8" style="display: none;">
            <h2 class="text-2xl font-bold mb-6">Continue with Paid Subscription</h2>
            <div id="paymentContent"></div>
        </div>

        <div id="successCard" class="bg-white rounded-2xl shadow-sm p-8" style="display: none;">
            <div class="text-center">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
                <h3 class="text-xl font-semibold mb-2">Subscription Activated!</h3>
                <p class="text-gray-600 mb-4">Your subscription is now active and you have full access to A³E.</p>
                <button onclick="goToDashboard()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700">Go to Dashboard</button>
            </div>
        </div>
    </div>

    <script>
        let stripe = null, elements = null;

        document.addEventListener('DOMContentLoaded', async function() {
            await initializeStripe();
            checkTrialStatus();
        });

        async function initializeStripe() {
            try {
                const response = await fetch('https://api.mapmystandards.ai/config/stripe-key');
                const data = await response.json();
                if (data.publishable_key) {
                    stripe = Stripe(data.publishable_key);
                    elements = stripe.elements();
                }
            } catch (error) {
                console.error('Failed to load Stripe key:', error);
            }
        }

        function checkTrialStatus() {
            const trialId = localStorage.getItem('mms_trial_id');
            const expiresAt = localStorage.getItem('mms_expires_at');
            const userEmail = localStorage.getItem('user_email');

            if (!trialId || !expiresAt) {
                showError('Trial information not found. Please sign up again.');
                return;
            }

            const expiryDate = new Date(expiresAt);
            const now = new Date();
            const daysRemaining = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));

            let statusHtml = '';
            
            if (daysRemaining > 0) {
                statusHtml = `
                    <div class="border-l-4 border-blue-500 bg-blue-50 p-4 rounded-r-lg">
                        <h3 class="text-sm font-medium text-blue-800">Trial Active</h3>
                        <div class="mt-2 text-sm text-blue-700">
                            <p><strong>${daysRemaining} days remaining</strong> in your free trial</p>
                            <p>Trial expires: ${expiryDate.toLocaleDateString()}</p>
                            <p>Email: ${userEmail}</p>
                        </div>
                    </div>
                    <div class="mt-6 flex space-x-4">
                        <button onclick="continueToPayment()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700">Set Up Payment Now</button>
                        <button onclick="goToDashboard()" class="bg-gray-200 text-gray-800 px-6 py-3 rounded-lg hover:bg-gray-300">Continue Trial</button>
                    </div>
                `;
            } else {
                statusHtml = `
                    <div class="border-l-4 border-red-500 bg-red-50 p-4 rounded-r-lg">
                        <h3 class="text-sm font-medium text-red-800">Trial Expired</h3>
                        <div class="mt-2 text-sm text-red-700">
                            <p>Your trial expired on ${expiryDate.toLocaleDateString()}</p>
                            <p>Upgrade to continue using A³E</p>
                        </div>
                    </div>
                    <div class="mt-6">
                        <button onclick="continueToPayment()" class="bg-red-600 text-white px-8 py-3 rounded-lg hover:bg-red-700 text-lg">Upgrade Now to Continue</button>
                    </div>
                `;
            }

            document.getElementById('trialInfo').innerHTML = statusHtml;
        }

        function continueToPayment() {
            const planType = localStorage.getItem('mms_plan_type') || 'college_monthly';
            const planPricing = {
                college_monthly: { name: 'A³E College Plan', price: 29700, interval: 'month' },
                college_yearly: { name: 'A³E College Plan (Annual)', price: 297000, interval: 'year' },
                multicampus_monthly: { name: 'A³E Multi-Campus Plan', price: 89700, interval: 'month' },
                multicampus_yearly: { name: 'A³E Multi-Campus Plan (Annual)', price: 807300, interval: 'year' }
            };

            const selectedPlan = planPricing[planType] || planPricing.college_monthly;
            const priceDisplay = (selectedPlan.price / 100).toLocaleString('en-US', { style: 'currency', currency: 'USD' });

            document.getElementById('trialStatusCard').style.display = 'none';
            document.getElementById('paymentCard').style.display = 'block';

            document.getElementById('paymentContent').innerHTML = `
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-2">${selectedPlan.name}</h3>
                    <p class="text-2xl font-bold text-blue-600">${priceDisplay} <span class="text-sm text-gray-600">per ${selectedPlan.interval}</span></p>
                </div>
                
                <form id="payment-form" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Card Information</label>
                        <div id="card-element" class="p-3 border border-gray-300 rounded-lg"></div>
                        <div id="card-errors" role="alert" class="text-red-600 text-sm mt-2"></div>
                    </div>
                    <button type="submit" id="submit-payment" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700">Subscribe for ${priceDisplay}/${selectedPlan.interval}</button>
                </form>
                
                <div class="mt-4 text-center">
                    <button onclick="goBack()" class="text-gray-600 hover:text-gray-800 text-sm">← Back to trial status</button>
                </div>
            `;

            if (stripe) {
                const cardElement = elements.create('card', {
                    style: { base: { fontSize: '16px', color: '#424770', '::placeholder': { color: '#aab7c4' } } }
                });
                cardElement.mount('#card-element');
                document.getElementById('payment-form').addEventListener('submit', handlePayment);
            }
        }

        async function handlePayment(e) {
            e.preventDefault();
            const submitBtn = document.getElementById('submit-payment');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = 'Processing...';

            try {
                const {error, paymentMethod} = await stripe.createPaymentMethod({
                    type: 'card',
                    card: elements.getElement('card'),
                    billing_details: { email: localStorage.getItem('user_email') }
                });

                if (error) throw new Error(error.message);

                localStorage.setItem('mms_payment_method', paymentMethod.id);
                localStorage.setItem('mms_subscription_status', 'active');
                localStorage.setItem('mms_subscription_date', new Date().toISOString());

                document.getElementById('paymentCard').style.display = 'none';
                document.getElementById('successCard').style.display = 'block';

            } catch (error) {
                console.error('Payment error:', error);
                showError('Payment failed: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }

        function goBack() {
            document.getElementById('paymentCard').style.display = 'none';
            document.getElementById('trialStatusCard').style.display = 'block';
        }

        function goToDashboard() {
            const trialId = localStorage.getItem('mms_trial_id');
            if (trialId) {
                window.location.href = `https://platform.mapmystandards.ai/dashboard-modern?trial_id=${trialId}`;
            } else {
                window.location.href = '/dashboard-modern';
            }
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'bg-red-50 border border-red-200 rounded-lg p-4 mb-4';
            errorDiv.innerHTML = `<div class="text-red-600"><strong>Error:</strong> ${message}</div>`;
            document.body.insertBefore(errorDiv, document.body.firstChild);
            setTimeout(() => errorDiv.remove(), 5000);
        }
    </script>
</body>
</html>
