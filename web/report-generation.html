<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generate Accreditation Report - MapMyStandards AI</title>
    <script src="/js/ux.js"></script>
    <script src="/js/metrics-store.js?v=20251009"></script>
    
    <style>
        /* Import base styles */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --primary-blue: #1e40af;
            --primary-blue-light: #3b82f6;
            --primary-blue-dark: #1e3a8a;
            --accent-green: #10b981;
            --accent-green-light: #34d399;
            --accent-orange: #f59e0b;
            --accent-purple: #8b5cf6;
            --accent-red: #ef4444;
            --white: #ffffff;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --gradient-primary: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-light) 100%);
            --gradient-success: linear-gradient(135deg, var(--accent-green) 0%, var(--accent-green-light) 100%);
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', 'Helvetica Neue', Arial, sans-serif;
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
            --space-12: 3rem;
            --border-radius: 0.5rem;
            --border-radius-lg: 0.75rem;
            --border-radius-xl: 1rem;
        }

        body {
            font-family: var(--font-family);
            background: var(--gray-50);
            color: var(--gray-800);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 var(--space-6);
        }

        /* Progress Steps */
        .progress-container {
            background: white;
            border-bottom: 1px solid var(--gray-200);
            padding: var(--space-6) 0;
        }

        .progress-steps {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: var(--space-2);
            max-width: 600px;
            margin: 0 auto;
        }

        .step {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            transition: all 0.3s ease;
        }

        .step.completed .step-circle {
            background: var(--accent-green);
            color: white;
        }

        .step.active .step-circle {
            background: var(--primary-blue);
            color: white;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); }
            50% { box-shadow: 0 0 0 8px rgba(59, 130, 246, 0.1); }
            100% { box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); }
        }

        .step.inactive .step-circle {
            background: var(--gray-200);
            color: var(--gray-500);
        }

        .step-line {
            width: 60px;
            height: 2px;
            background: var(--gray-200);
            transition: all 0.3s ease;
        }

        .step.completed + .step-line {
            background: var(--accent-green);
        }

        /* Generation States */
        .generation-container {
            max-width: 800px;
            margin: var(--space-12) auto;
        }

        /* Generating State */
        .generating-state {
            background: white;
            border-radius: var(--border-radius-xl);
            padding: var(--space-12);
            text-align: center;
            box-shadow: var(--shadow-lg);
        }

        .generating-icon {
            width: 120px;
            height: 120px;
            margin: 0 auto var(--space-6);
            position: relative;
        }

        .spinner {
            width: 100%;
            height: 100%;
            border: 4px solid var(--gray-200);
            border-top-color: var(--primary-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .generating-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: var(--space-4);
        }

        .generating-subtitle {
            font-size: 1.25rem;
            color: var(--gray-600);
            margin-bottom: var(--space-8);
        }

        .generation-steps {
            text-align: left;
            max-width: 400px;
            margin: 0 auto;
        }

        .gen-step {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-4);
            padding: var(--space-3);
            border-radius: var(--border-radius);
            transition: all 0.3s ease;
        }

        .gen-step.active {
            background: rgba(59, 130, 246, 0.1);
        }

        .gen-step.completed {
            opacity: 0.6;
        }

        .gen-step-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gen-step-text {
            flex: 1;
            font-weight: 500;
        }

        /* Success State */
        .success-state {
            background: white;
            border-radius: var(--border-radius-xl);
            padding: var(--space-8);
            box-shadow: var(--shadow-lg);
        }

        .success-header {
            text-align: center;
            margin-bottom: var(--space-8);
        }

        .success-icon {
            width: 80px;
            height: 80px;
            background: var(--gradient-success);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto var(--space-4);
            font-size: 2.5rem;
            color: white;
            animation: scaleIn 0.3s ease-out;
        }

        @keyframes scaleIn {
            from { transform: scale(0); }
            to { transform: scale(1); }
        }

        .success-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: var(--space-2);
        }

        .success-subtitle {
            color: var(--gray-600);
            font-size: 1.125rem;
        }

        /* Report Summary */
        .report-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-8);
        }

        .summary-card {
            background: var(--gray-50);
            border-radius: var(--border-radius-lg);
            padding: var(--space-6);
            text-align: center;
        }

        .summary-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-blue);
            margin-bottom: var(--space-2);
        }

        .summary-label {
            color: var(--gray-600);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Report Actions */
        .report-actions {
            display: flex;
            gap: var(--space-4);
            justify-content: center;
            margin-bottom: var(--space-8);
        }

        .btn {
            padding: var(--space-4) var(--space-8);
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            font-size: 1.125rem;
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
        }

        .btn[disabled] {
            cursor: not-allowed;
            opacity: 0.6;
            box-shadow: none;
        }

        .btn-primary[disabled]:hover,
        .btn-secondary[disabled]:hover {
            transform: none;
            box-shadow: none;
            background: inherit;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: white;
            color: var(--primary-blue);
            border: 2px solid var(--primary-blue);
        }

        .btn-secondary:hover {
            background: var(--gray-50);
        }

        /* Report Preview */
        .report-preview {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .preview-header {
            background: var(--gray-50);
            padding: var(--space-4) var(--space-6);
            border-bottom: 1px solid var(--gray-200);
        }

        .preview-title {
            font-weight: 600;
            color: var(--gray-900);
        }

        .preview-content {
            padding: var(--space-6);
            max-height: 400px;
            overflow-y: auto;
        }

        .preview-section {
            margin-bottom: var(--space-6);
        }

        .preview-section-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: var(--space-3);
        }

        .coverage-bar {
            background: var(--gray-200);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: var(--space-2);
        }

        .coverage-fill {
            height: 100%;
            background: var(--gradient-success);
            transition: width 0.3s ease;
        }

        /* What's Next */
        .whats-next {
            background: rgba(59, 130, 246, 0.05);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: var(--border-radius-lg);
            padding: var(--space-6);
            margin-top: var(--space-8);
        }

        .whats-next-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-blue);
            margin-bottom: var(--space-4);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .next-steps {
            display: grid;
            gap: var(--space-3);
        }

        .next-step {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .next-step-icon {
            color: var(--primary-blue);
            flex-shrink: 0;
        }
    </style>
</head>
<body>
    <!-- Progress Steps -->
    <div class="progress-container">
        <div class="container">
            <div class="progress-steps">
                <div class="step completed">
                    <div class="step-circle">‚úì</div>
                    <span class="step-label">Upload</span>
                </div>
                <div class="step-line"></div>
                <div class="step completed">
                    <div class="step-circle">‚úì</div>
                    <span class="step-label">Select Standards</span>
                </div>
                <div class="step-line"></div>
                <div class="step completed">
                    <div class="step-circle">‚úì</div>
                    <span class="step-label">Map Evidence</span>
                </div>
                <div class="step-line"></div>
                <div class="step active">
                    <div class="step-circle">4</div>
                    <span class="step-label">Generate Report</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main>
        <div class="container">
            <div class="generation-container">
                <!-- Generating State (shown initially) -->
                <div class="generating-state" id="generatingState">
                    <div class="generating-icon">
                        <div class="spinner"></div>
                    </div>
                    <h1 class="generating-title">Generating Your Report</h1>
                    <p class="generating-subtitle">Our AI is analyzing your mappings and creating a comprehensive accreditation report</p>
                    
                    <div class="generation-steps">
                        <div class="gen-step active" id="step1">
                            <div class="gen-step-icon">‚ö°</div>
                            <div class="gen-step-text">Analyzing evidence mappings...</div>
                        </div>
                        <div class="gen-step" id="step2">
                            <div class="gen-step-icon">üìä</div>
                            <div class="gen-step-text">Calculating coverage metrics...</div>
                        </div>
                        <div class="gen-step" id="step3">
                            <div class="gen-step-icon">‚úçÔ∏è</div>
                            <div class="gen-step-text">Writing executive summary...</div>
                        </div>
                        <div class="gen-step" id="step4">
                            <div class="gen-step-icon">üìã</div>
                            <div class="gen-step-text">Compiling final report...</div>
                        </div>
                    </div>
                </div>

                <!-- Success State (shown after generation) -->
                <div class="success-state" id="successState" style="display: none;">
                    <div class="success-header">
                        <div class="success-icon">‚úì</div>
                        <h1 class="success-title">Report Generated Successfully!</h1>
                        <p class="success-subtitle">Your accreditation readiness report is ready</p>
                    </div>

                    <!-- Report Summary -->
                    <div class="report-summary">
                        <div class="summary-card">
                            <div class="summary-value" id="coverageValue">--</div>
                            <div class="summary-label">Overall Coverage</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-value" id="standardsValue">--</div>
                            <div class="summary-label">Standards Mapped</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-value" id="documentsValue">--</div>
                            <div class="summary-label">Evidence Documents</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-value" id="gapsValue">--</div>
                            <div class="summary-label">Gap Areas</div>
                        </div>
                    </div>

                    <!-- Report Actions -->
                    <div class="report-actions">
                        <button class="btn btn-primary" id="downloadReportBtn" onclick="downloadReport()">
                            <span>üì•</span>
                            Download Full Report
                        </button>
                        <button class="btn btn-secondary" id="viewReportBtn" onclick="viewOnline()">
                            <span>üëÅÔ∏è</span>
                            View Online
                        </button>
                        <button class="btn btn-secondary" id="shareReportBtn" onclick="shareReport()">
                            <span>üì§</span>
                            Share
                        </button>
                    </div>

                    <p id="reportStatusMessage" style="text-align: center; color: var(--gray-600); font-size: 0.95rem; margin-bottom: var(--space-6);"></p>

                    <!-- Report Preview -->
                    <div class="report-preview">
                        <div class="preview-header">
                            <div class="preview-title">Report Preview</div>
                        </div>
                        <div class="preview-content">
                            <div class="preview-section">
                                <h3 class="preview-section-title">Executive Summary</h3>
                                <p id="executiveSummaryText">Based on our analysis of your uploaded documentation, your institution demonstrates 
                                strong alignment with SACSCOC accreditation standards, achieving an overall coverage 
                                rate of 87%. The evidence provided effectively addresses the majority of Core Requirements 
                                and Comprehensive Standards.</p>
                            </div>
                            
                            <div class="preview-section">
                                <h3 class="preview-section-title">Coverage by Category</h3>
                                <div style="margin-bottom: 1rem;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <span>Mission & Governance</span>
                                        <span id="coverageOverallLabel" style="color: var(--accent-green); font-weight: 600;">95%</span>
                                    </div>
                                    <div class="coverage-bar">
                                        <div class="coverage-fill" style="width: 95%"></div>
                                    </div>
                                </div>
                                <div style="margin-bottom: 1rem;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <span>Academic Programs</span>
                                        <span style="color: var(--accent-green); font-weight: 600;">88%</span>
                                    </div>
                                    <div class="coverage-bar">
                                        <div class="coverage-fill" style="width: 88%"></div>
                                    </div>
                                </div>
                                <div style="margin-bottom: 1rem;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <span>Student Support</span>
                                        <span style="color: var(--accent-orange); font-weight: 600;">72%</span>
                                    </div>
                                    <div class="coverage-bar">
                                        <div class="coverage-fill" style="width: 72%; background: var(--accent-orange);"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="preview-section">
                                <h3 class="preview-section-title">Key Strengths</h3>
                                <ul style="padding-left: 1.5rem; color: var(--gray-700);">
                                    <li>Comprehensive strategic planning documentation</li>
                                    <li>Strong evidence of assessment practices</li>
                                    <li>Clear institutional policies and procedures</li>
                                    <li>Well-documented faculty qualifications</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- What's Next -->
                    <div class="whats-next">
                        <h3 class="whats-next-title">
                            <span>üéØ</span>
                            What's Next?
                        </h3>
                        <div class="next-steps">
                            <div class="next-step">
                                <span class="next-step-icon">üìã</span>
                                <span>Review the gap analysis to identify areas needing additional evidence</span>
                            </div>
                            <div class="next-step">
                                <span class="next-step-icon">üìÅ</span>
                                <span>Upload additional documents to improve coverage scores</span>
                            </div>
                            <div class="next-step">
                                <span class="next-step-icon">üë•</span>
                                <span>Share this report with your accreditation team for review</span>
                            </div>
                            <div class="next-step">
                                <span class="next-step-icon">üìÖ</span>
                                <span>Schedule a follow-up review session with stakeholders and assign next actions</span>
                            </div>
                        </div> <!-- next-steps -->
                    </div> <!-- whats-next -->
                </div> <!-- success-state -->
            </div> <!-- generation-container -->
        </div> <!-- container -->
    </main>

    <script>
    (function () {
        'use strict';

    const STEP_DELAY_MS = 1200;
    const EXPORT_KEY = 'mms:generatedReport';
    const EXPORT_META_KEY = 'mms:generatedReportMeta';

    let latestSnapshot = null;
    let latestSummary = null;
        let latestExportHtml = null;
        let reportActionState = {
            ready: false,
            reason: 'Loading live metrics‚Ä¶',
        };

        function byId(id) {
            return document.getElementById(id);
        }

        function formatNumber(value, fallback = '0') {
            if (typeof value === 'number' && Number.isFinite(value)) {
                return value.toLocaleString(undefined, { maximumFractionDigits: 0 });
            }
            return fallback;
        }

        function clampPercentage(value) {
            if (typeof value !== 'number' || Number.isNaN(value)) {
                return 0;
            }
            return Math.max(0, Math.min(100, value));
        }

        function showFallbackNote(message) {
            const summaryContainer = document.querySelector('.report-summary');
            if (!summaryContainer) {
                return;
            }
            let note = document.getElementById('exampleNote');
            if (!note) {
                note = document.createElement('p');
                note.id = 'exampleNote';
                note.style.cssText = 'text-align: center; color: #6b7280; font-size: 0.875rem; margin-top: 1rem;';
                summaryContainer.appendChild(note);
            }
            note.textContent = message;
        }

        function clearFallbackNote() {
            const note = document.getElementById('exampleNote');
            if (note && note.parentNode) {
                note.parentNode.removeChild(note);
            }
        }

        function metricsStoreAvailable() {
            return typeof window.A3EMetricsStore !== 'undefined' &&
                window.A3EMetricsStore &&
                typeof window.A3EMetricsStore.ensure === 'function';
        }

        function setReportActionState(ready, message) {
            reportActionState = {
                ready,
                reason: message,
            };

            const statusEl = byId('reportStatusMessage');
            if (statusEl) {
                statusEl.textContent = message || '';
            }

            const buttons = [
                byId('downloadReportBtn'),
                byId('viewReportBtn'),
                byId('shareReportBtn'),
            ];

            buttons.forEach((btn) => {
                if (!btn) {
                    return;
                }
                if (ready) {
                    btn.removeAttribute('disabled');
                    btn.setAttribute('aria-disabled', 'false');
                } else {
                    btn.setAttribute('disabled', 'true');
                    btn.setAttribute('aria-disabled', 'true');
                }
            });
        }

        function buildExecutiveNarrative(summary) {
            const coverageText = summary.coverage !== null ? `${summary.coverage}%` : 'your current';
            const standardsText = summary.standards !== null ? formatNumber(summary.standards) : 'key';
            const documentsText = summary.documents !== null ? formatNumber(summary.documents) : 'your';
            const documentSuffix = summary.documents === 1 ? '' : 's';
            return `Based on the latest evidence snapshot, your institution demonstrates an overall coverage rate of ${coverageText} across ${standardsText} mapped standards supported by ${documentsText} evidence document${documentSuffix}.`;
        }

        function computeSummary(snapshot) {
            const core = snapshot?.coreMetrics || {};
            const performance = snapshot?.performanceMetrics || {};
            const evidenceStats = snapshot?.evidenceStats || {};
            const metricsData = snapshot?.metrics || {};
            const gapSource = snapshot?.gapAnalysis?.gap_analysis || snapshot?.gapAnalysis || {};

            const summary = {
                coverage: null,
                coverageDisplay: '0%',
                standards: null,
                standardsDisplay: '0',
                documents: null,
                documentsDisplay: '0',
                gaps: null,
                gapsDisplay: '0',
                gapBreakdown: {
                    high: Number(gapSource.high_risk || 0),
                    medium: Number(gapSource.medium_risk || 0),
                    low: Number(gapSource.low_risk || 0),
                },
                totalStandards: typeof evidenceStats.totalStandards === 'number' ? evidenceStats.totalStandards : null,
                highConfidenceCount: typeof evidenceStats.highConfidenceCount === 'number' ? evidenceStats.highConfidenceCount : null,
                recommendationCount: Array.isArray(snapshot?.gapAnalysis?.recommendations)
                    ? snapshot.gapAnalysis.recommendations.length
                    : null,
                missing: [],
                narrative: '',
                generatedAt: new Date().toISOString(),
                lastUpdated: snapshot?.lastUpdated || Date.now(),
            };

            const coverageCandidates = [
                typeof performance.coverage_percentage === 'number' ? performance.coverage_percentage : null,
                typeof evidenceStats.coveragePercentage === 'number' ? evidenceStats.coveragePercentage : null,
                typeof performance.compliance_score === 'number' ? performance.compliance_score : null,
            ].filter((value) => typeof value === 'number' && !Number.isNaN(value));

            if (coverageCandidates.length > 0) {
                summary.coverage = Math.round(coverageCandidates[0]);
                summary.coverageDisplay = `${summary.coverage}%`;
            } else {
                summary.missing.push('coverage');
            }

            const standardsCandidates = [
                typeof core.standards_mapped === 'number' ? core.standards_mapped : null,
                typeof evidenceStats.mappedCount === 'number' ? evidenceStats.mappedCount : null,
            ].filter((value) => typeof value === 'number' && !Number.isNaN(value));

            if (standardsCandidates.length > 0) {
                summary.standards = standardsCandidates[0];
                summary.standardsDisplay = formatNumber(summary.standards);
            } else {
                summary.missing.push('mapped standards');
            }

            const documentsCandidates = [
                typeof core.documents_analyzed === 'number' ? core.documents_analyzed : null,
                Array.isArray(metricsData?.documents) ? metricsData.documents.length : null,
                typeof metricsData?.core_metrics?.documents_analyzed === 'number'
                    ? metricsData.core_metrics.documents_analyzed
                    : null,
            ].filter((value) => typeof value === 'number' && !Number.isNaN(value));

            if (documentsCandidates.length > 0) {
                summary.documents = documentsCandidates[0];
                summary.documentsDisplay = formatNumber(summary.documents);
            } else {
                summary.missing.push('documents analyzed');
            }

            let gaps = null;
            if (typeof gapSource.total_gaps === 'number' && !Number.isNaN(gapSource.total_gaps)) {
                gaps = gapSource.total_gaps;
            } else if (Array.isArray(gapSource.gaps)) {
                gaps = gapSource.gaps.length;
            } else {
                const inferred = summary.gapBreakdown.high + summary.gapBreakdown.medium + summary.gapBreakdown.low;
                if (inferred > 0) {
                    gaps = inferred;
                }
            }

            if (typeof gaps === 'number' && !Number.isNaN(gaps)) {
                summary.gaps = gaps;
                summary.gapsDisplay = formatNumber(summary.gaps);
            } else {
                summary.gaps = 0;
                summary.gapsDisplay = '0';
                summary.missing.push('gap count');
            }

            summary.hasCompleteData = summary.missing.length === 0;
            summary.narrative = buildExecutiveNarrative(summary);
            return summary;
        }

        function applySummary(summary) {
            const coverageElement = byId('coverageValue');
            if (coverageElement) {
                coverageElement.textContent = summary.coverageDisplay;
            }
            const coverageLabel = byId('coverageOverallLabel');
            if (coverageLabel) {
                coverageLabel.textContent = summary.coverageDisplay;
            }
            const standardsElement = byId('standardsValue');
            if (standardsElement) {
                standardsElement.textContent = summary.standardsDisplay;
            }
            const documentsElement = byId('documentsValue');
            if (documentsElement) {
                documentsElement.textContent = summary.documentsDisplay;
            }
            const gapsElement = byId('gapsValue');
            if (gapsElement) {
                gapsElement.textContent = summary.gapsDisplay;
            }

            const summaryText = byId('executiveSummaryText');
            if (summaryText) {
                summaryText.textContent = summary.narrative;
            }

            const coverageFill = document.querySelector('.coverage-fill');
            if (coverageFill && summary.coverage !== null) {
                coverageFill.style.width = `${clampPercentage(summary.coverage)}%`;
            }

            if (summary.hasCompleteData) {
                clearFallbackNote();
            } else {
                showFallbackNote('Some live metrics were unavailable; missing values default to zero.');
            }

            const hasMappedStandards = typeof summary.standards === 'number' && summary.standards > 0;
            const hasDocuments = typeof summary.documents === 'number' && summary.documents > 0;
            const hasCoverage = typeof summary.coverage === 'number' && summary.coverage > 0;

            if (hasMappedStandards && hasDocuments) {
                setReportActionState(true, 'Report ready based on the latest mapped standards and evidence.');
            } else {
                const reason = !hasMappedStandards && !hasDocuments
                    ? 'Upload evidence and map it to standards to generate your report.'
                    : !hasMappedStandards
                        ? 'Map your evidence to standards to generate an accreditation report.'
                        : 'Upload at least one evidence document to generate your report.';
                setReportActionState(false, reason);
            }
        }

    function buildExportHTML(summary) {
            const generatedAtDisplay = new Date(summary.generatedAt).toLocaleString(undefined, {
                dateStyle: 'long',
                timeStyle: 'short',
            });

            const totalStandardsDisplay = summary.totalStandards !== null
                ? formatNumber(summary.totalStandards)
                : 'Not available';
            const highConfidenceDisplay = summary.highConfidenceCount !== null
                ? formatNumber(summary.highConfidenceCount)
                : 'Not available';
            const recommendationDisplay = summary.recommendationCount !== null
                ? formatNumber(summary.recommendationCount)
                : 'Not available';

            const gapHighDisplay = formatNumber(summary.gapBreakdown.high);
            const gapMediumDisplay = formatNumber(summary.gapBreakdown.medium);
            const gapLowDisplay = formatNumber(summary.gapBreakdown.low);

            return `<!DOCTYPE html>\n<html lang="en">\n<head>\n<meta charset="UTF-8" />\n<title>MapMyStandards Accreditation Report</title>\n<style>\n    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', sans-serif; margin: 0; padding: 2rem; background: #f9fafb; color: #1f2937; }\n    main { max-width: 900px; margin: 0 auto; background: #ffffff; border-radius: 16px; box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08); overflow: hidden; }\n    header, section { padding: 2.5rem 3rem; border-bottom: 1px solid #e5e7eb; }\n    header { background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: #ffffff; text-align: center; }\n    header h1 { margin-bottom: 0.75rem; font-size: 2.5rem; }\n    header p { margin: 0; font-size: 1rem; opacity: 0.9; }\n    h2 { font-size: 1.5rem; margin-bottom: 1.5rem; color: #1f2937; }\n    .metric-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; list-style: none; padding: 0; margin: 0; }\n    .metric-card { background: #f3f4f6; border-radius: 12px; padding: 1.5rem; display: flex; flex-direction: column; gap: 0.5rem; }\n    .metric-card .label { font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.08em; color: #6b7280; }\n    .metric-card .value { font-size: 2rem; font-weight: 700; color: #1e40af; }\n    ul.detail-list { list-style: none; padding: 0; margin: 0; display: grid; gap: 0.75rem; }\n    ul.detail-list li { padding: 1rem 1.25rem; background: #f9fafb; border-radius: 10px; border: 1px solid #e5e7eb; }\n    .gap-breakdown { display: flex; flex-wrap: wrap; gap: 1rem; }\n    .gap-tile { flex: 1 1 160px; background: #f9fafb; padding: 1.25rem; border-radius: 12px; border: 1px solid #e5e7eb; text-align: center; }\n    .gap-tile span { display: block; }\n    .gap-tile .label { font-size: 0.875rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.08em; }\n    .gap-tile .score { font-size: 1.75rem; font-weight: 700; color: #ef4444; }\n    .gap-tile.gap-medium .score { color: #f59e0b; }\n    .gap-tile.gap-low .score { color: #10b981; }\n    section.notes p { line-height: 1.6; margin: 0; color: #374151; }\n    footer { text-align: center; padding: 1.5rem; font-size: 0.875rem; color: #6b7280; background: #f3f4f6; }\n</style>\n</head>\n<body>\n<main>\n<header>\n<h1>Accreditation Readiness Report</h1>\n<p class="timestamp">Generated on ${generatedAtDisplay}</p>\n</header>\n<section>\n<h2>Summary Metrics</h2>\n<ul class="metric-grid">\n<li class="metric-card"><span class="label">Overall Coverage</span><span class="value">${summary.coverageDisplay}</span></li>\n<li class="metric-card"><span class="label">Standards Mapped</span><span class="value">${summary.standardsDisplay}</span></li>\n<li class="metric-card"><span class="label">Evidence Documents</span><span class="value">${summary.documentsDisplay}</span></li>\n<li class="metric-card"><span class="label">Gap Areas</span><span class="value">${summary.gapsDisplay}</span></li>\n</ul>\n</section>\n<section>\n<h2>Evidence Overview</h2>\n<ul class="detail-list">\n<li>Total Standards Tracked: <strong>${totalStandardsDisplay}</strong></li>\n<li>High-Confidence Standards: <strong>${highConfidenceDisplay}</strong></li>\n<li>Recommendations Generated: <strong>${recommendationDisplay}</strong></li>\n</ul>\n</section>\n<section>\n<h2>Gap Breakdown</h2>\n<div class="gap-breakdown">\n<div class="gap-tile gap-high"><span class="label">High Risk</span><span class="score">${gapHighDisplay}</span></div>\n<div class="gap-tile gap-medium"><span class="label">Medium Risk</span><span class="score">${gapMediumDisplay}</span></div>\n<div class="gap-tile gap-low"><span class="label">Low Risk</span><span class="score">${gapLowDisplay}</span></div>\n</div>\n</section>\n<section class="notes">\n<h2>Executive Summary</h2>\n<p>${summary.narrative}</p>\n</section>\n</main>\n<footer>\n<p>Prepared with MapMyStandards &mdash; ${new Date().getFullYear()}</p>\n</footer>\n</body>\n</html>`;
        }

        function persistExport(summary) {
            const exportHtml = buildExportHTML(summary);
            try {
                sessionStorage.setItem(EXPORT_KEY, exportHtml);
                sessionStorage.setItem(EXPORT_META_KEY, JSON.stringify({
                    generatedAt: summary.generatedAt,
                    missing: summary.missing,
                    hasCompleteData: summary.hasCompleteData,
                    lastUpdated: summary.lastUpdated,
                }));
            } catch (error) {
                console.warn('Unable to persist report export payload', error);
            }
            latestExportHtml = exportHtml;
            return exportHtml;
        }
        const ReportExportManager = (() => {
            function getStoredHtml() {
                return latestExportHtml || sessionStorage.getItem(EXPORT_KEY) || null;
            }

            function ensureCache(summary, snapshot, html) {
                latestSummary = summary;
                latestSnapshot = snapshot;
                if (html) {
                    latestExportHtml = html;
                }
            }

            async function ensure(options = {}) {
                if (!metricsStoreAvailable()) {
                    showFallbackNote('Connect your account to load live accreditation metrics.');
                    latestSnapshot = null;
                    latestSummary = null;
                    latestExportHtml = null;
                    return { summary: null, snapshot: null, html: null };
                }

                const snapshot = await window.A3EMetricsStore.ensure({
                    includeEvidenceMap: true,
                    includeGapAnalysis: true,
                    ...options,
                });

                const summary = computeSummary(snapshot);
                const html = persistExport(summary);
                ensureCache(summary, snapshot, html);

                return { summary, snapshot, html };
            }

            function getLatestSummary() {
                return latestSummary;
            }

            function getLatestSnapshot() {
                return latestSnapshot;
            }

            function getExportHtml() {
                return getStoredHtml();
            }

            function buildCsvRows(summary = latestSummary) {
                if (!summary) {
                    return [];
                }
                return [
                    ['Metric', 'Value'],
                    ['Generated At', summary.generatedAt],
                    ['Coverage', summary.coverageDisplay],
                    ['Standards Mapped', summary.standardsDisplay],
                    ['Evidence Documents', summary.documentsDisplay],
                    ['Gap Areas', summary.gapsDisplay],
                    ['High-Risk Gaps', summary.gapBreakdown.high],
                    ['Medium-Risk Gaps', summary.gapBreakdown.medium],
                    ['Low-Risk Gaps', summary.gapBreakdown.low],
                    ['High Confidence Standards', summary.highConfidenceCount ?? 'n/a'],
                    ['Recommendations Generated', summary.recommendationCount ?? 'n/a'],
                ];
            }

            function buildPdfContext(summary = latestSummary, snapshot = latestSnapshot) {
                if (!summary) {
                    return null;
                }
                return {
                    summary,
                    snapshot,
                    exportHtml: getStoredHtml(),
                };
            }

            return {
                ensure,
                getLatestSummary,
                getLatestSnapshot,
                getExportHtml,
                buildCsvRows,
                buildPdfContext,
            };
        })();

        window.A3EReportExports = ReportExportManager;

        async function updateWithRealMetrics(options = {}) {
            const { summary } = await ReportExportManager.ensure(options);
            if (summary) {
                applySummary(summary);
            } else {
                showFallbackNote('Live metrics were unavailable; showing zero placeholders.');
                const defaults = {
                    coverageValue: '0%',
                    standardsValue: '0',
                    documentsValue: '0',
                    gapsValue: '0',
                    coverageOverallLabel: '0%',
                };
                Object.entries(defaults).forEach(([id, value]) => {
                    const el = byId(id);
                    if (el) {
                        el.textContent = value;
                    }
                });
                setReportActionState(false, 'We could not load your live metrics. Refresh or revisit after uploading evidence.');
            }
            return summary;
        }

        async function ensureExportHtml(options = {}) {
            const existingHtml = ReportExportManager.getExportHtml();
            const hasSummary = !!ReportExportManager.getLatestSummary();
            if (existingHtml && hasSummary && !options.force) {
                return existingHtml;
            }
            const { html } = await ReportExportManager.ensure(options);
            return html;
        }

        async function handleDownload() {
            try {
                if (!reportActionState.ready) {
                    alert(reportActionState.reason || 'Your report is not ready yet.');
                    return;
                }
                const html = await ensureExportHtml();
                if (!html) {
                    throw new Error('Report export is not available');
                }
                const blob = new Blob([html], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const anchor = document.createElement('a');
                anchor.href = url;
                anchor.download = `accreditation-report-${new Date().toISOString().split('T')[0]}.html`;
                document.body.appendChild(anchor);
                anchor.click();
                document.body.removeChild(anchor);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Unable to export report:', error);
                alert('We were unable to prepare your report download. Please refresh the page and try again.');
            }
        }

        function handleViewOnline() {
            if (!reportActionState.ready) {
                alert(reportActionState.reason || 'Your report is not ready yet.');
                return;
            }
            window.location.href = '/dashboard';
        }

        function handleShare() {
            if (!reportActionState.ready) {
                alert(reportActionState.reason || 'Your report is not ready yet.');
                return;
            }
            alert('Share functionality coming soon! You can download the report and share it manually.');
        }

        function celebrateCompletion() {
            console.log('üéâ Report generation complete!');
        }

        function startJourney() {
            const generatingState = byId('generatingState');
            const successState = byId('successState');
            const steps = ['step1', 'step2', 'step3', 'step4']
                .map(byId)
                .filter(Boolean);

            steps.forEach((step, index) => {
                setTimeout(() => {
                    step.classList.add('active');
                    if (index > 0) {
                        steps[index - 1].classList.remove('active');
                        steps[index - 1].classList.add('completed');
                    }
                }, STEP_DELAY_MS * index);
            });

            const totalDuration = STEP_DELAY_MS * steps.length + 600;
            setTimeout(() => {
                if (generatingState) {
                    generatingState.style.display = 'none';
                }
                if (successState) {
                    successState.style.display = 'block';
                }
                celebrateCompletion();
            }, totalDuration);

            setReportActionState(false, 'Loading live metrics‚Ä¶');
            updateWithRealMetrics().catch((error) => {
                console.error('Failed to update metrics:', error);
                setReportActionState(false, 'Unable to load metrics. Please refresh the page once data is available.');
            });
        }

        document.addEventListener('DOMContentLoaded', startJourney);
        window.downloadReport = handleDownload;
        window.viewOnline = handleViewOnline;
        window.shareReport = handleShare;
        window.__refreshReportMetrics = () => updateWithRealMetrics({ force: true });
    })();
    </script>
</body>
</html>