<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sign in • MapMyStandards</title>
  <script>
    // Redirect to enhanced login
    window.location.replace('/login-enhanced.html' + window.location.search);
  </script>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#0f172a; --muted:#94a3b8; --primary:#3b82f6; --accent:#8b5cf6; --ring:#60a5fa }
    *{ box-sizing:border-box }
    body{ margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:radial-gradient(1000px 600px at 10% -10%, rgba(59,130,246,.15), transparent 60%), radial-gradient(800px 500px at 110% 10%, rgba(139,92,246,.18), transparent 60%), var(--bg); color:#e5e7eb; min-height:100vh; display:grid; place-items:center; padding:24px }
    .wrap{ display:grid; grid-template-columns:1.2fr 1fr; gap:28px; max-width:1100px; width:100% }
    .hero{ background:linear-gradient(180deg, rgba(148,163,184,.08), rgba(148,163,184,.02)); border:1px solid rgba(148,163,184,.16); border-radius:16px; padding:28px }
  .hero h1{ font-size:28px; margin:0 0 8px; background:linear-gradient(90deg,#fff,#c7d2fe 60%,#93c5fd); background-clip:text; -webkit-background-clip:text; -webkit-text-fill-color:transparent }
    .hero p{ color:var(--muted); margin:0 0 18px }
    .badges{ display:flex; gap:8px; flex-wrap:wrap; margin-top:6px }
    .badge{ font-size:11px; color:#e2e8f0; border:1px solid rgba(148,163,184,.2); background:rgba(148,163,184,.06); padding:4px 8px; border-radius:999px }
    .cta{ margin-top:16px; color:#93c5fd; font-size:13px }
    .card{ background:linear-gradient(180deg, rgba(148,163,184,.10), rgba(148,163,184,.03)); border:1px solid rgba(148,163,184,.16); border-radius:16px; padding:24px }
    .logo{ display:flex; align-items:center; gap:10px; margin-bottom:18px }
    .dot{ width:10px; height:10px; border-radius:50%; background:linear-gradient(135deg,#60a5fa,#a78bfa) }
    label{ display:block; font-size:13px; color:#cbd5e1; margin:12px 0 6px }
    .field{ position:relative }
    input[type=email],input[type=password]{ width:100%; background:#0b1220; border:1px solid rgba(148,163,184,.25); color:#e5e7eb; border-radius:10px; padding:12px 40px 12px 12px; font-size:14px; outline:none; transition:border .2s }
    input:focus{ border-color:var(--ring); box-shadow:0 0 0 3px rgba(96,165,250,.15) }
    .toggle{ position:absolute; right:10px; top:50%; transform:translateY(-50%); background:none; border:none; color:#93c5fd; font-size:12px; cursor:pointer }
    .row{ display:flex; align-items:center; justify-content:space-between; margin-top:10px }
    .row a{ color:#93c5fd; text-decoration:none; font-size:12px }
    .row a:hover{ text-decoration:underline }
    .btn{ width:100%; margin-top:16px; background:linear-gradient(90deg,var(--primary),var(--accent)); border:none; color:#fff; padding:12px 14px; border-radius:10px; font-weight:700; cursor:pointer; transition:transform .12s ease,opacity .12s ease }
    .btn:disabled{ opacity:.6; cursor:not-allowed }
    .btn:hover{ transform:translateY(-1px) }
    .alert{ display:none; margin-bottom:10px; padding:10px 12px; border-radius:10px; font-size:13px }
    .alert.show{ display:block }
    .alert.error{ background:rgba(239,68,68,.12); border:1px solid rgba(239,68,68,.3); color:#fecaca }
    .alert.success{ background:rgba(16,185,129,.12); border:1px solid rgba(16,185,129,.3); color:#bbf7d0 }
    .divider{ text-align:center; color:#94a3b8; font-size:12px; margin:14px 0; position:relative }
    .divider:before,.divider:after{ content:""; position:absolute; top:50%; width:40%; height:1px; background:rgba(148,163,184,.2) }
    .divider:before{ left:0 } .divider:after{ right:0 }
    .muted{ color:#94a3b8; font-size:12px; margin-top:10px }
    .sso{ display:flex; gap:10px }
    .sso button{ flex:1; background:#0b1220; border:1px solid rgba(148,163,184,.25); color:#e5e7eb; border-radius:10px; padding:10px; font-size:13px; cursor:not-allowed; opacity:.7 }
    @media (max-width: 900px){ .wrap{ grid-template-columns:1fr } .hero{ order:2 } }
  </style>
</head>
<body>
  <div class="wrap" role="main">
    <section class="hero" aria-labelledby="welcome">
      <div class="logo"><span class="dot" aria-hidden="true"></span><strong>MapMyStandards</strong></div>
      <h1 id="welcome">Welcome back</h1>
      <p>Sign in to access your AI-powered accreditation workspace: Standards Graph, Evidence Mapping, Risk Insights, and Narrative Reports.</p>
      <div class="badges">
        <span class="badge">Secure session cookies</span>
        <span class="badge">No tokens to manage</span>
        <span class="badge">SSO-ready</span>
      </div>
  <div class="cta">Need an account? <a href="/trial-signup-stripe.html" style="color:#93c5fd">Start a free trial</a>.</div>
    </section>
    <section class="card" aria-label="Sign in form">
      <h2 style="margin:0 0 12px">Sign in to your account</h2>
      <div id="errorMessage" class="alert" role="alert"></div>
      <div id="successMessage" class="alert" role="status"></div>
      <form id="loginForm" novalidate>
        <label for="email">Email</label>
  <div class="field"><input type="email" id="email" name="email" autocomplete="username" required placeholder="you@example.edu" aria-required="true" autofocus></div>
        <label for="password">Password</label>
        <div class="field">
          <input type="password" id="password" name="password" autocomplete="current-password" required placeholder="Enter your password" aria-required="true">
          <button type="button" id="togglePwd" class="toggle" aria-controls="password" aria-label="Show password">Show</button>
        </div>
        <div class="row">
          <label style="display:inline-flex;gap:8px;align-items:center"><input type="checkbox" id="remember" name="remember"><span>Remember me</span></label>
          <a href="/forgot-password.html">Forgot password?</a>
        </div>
  <button type="submit" class="btn" id="loginButton"><span id="buttonText">Sign in</span></button>
        <div class="divider">or continue with</div>
        <div class="sso">
          <button type="button" aria-disabled="true" title="Coming soon">Google</button>
          <button type="button" aria-disabled="true" title="Coming soon">Microsoft</button>
        </div>
        <p class="muted">By continuing you agree to our <a href="/terms" style="color:#93c5fd">Terms</a> and <a href="/privacy" style="color:#93c5fd">Privacy</a>.</p>
      </form>
    </section>
  </div>

  <script src="/js/config.js"></script>
  <script src="/js/auth-bridge.js"></script>
  <script>
    const API_BASE_URL = (window.MMS_CONFIG && window.MMS_CONFIG.API_BASE_URL) || '/api';
    const buildUrl = (path) => {
      if (path.startsWith('http')) return path;
      const base = API_BASE_URL || '';
      if (!base) return path;
      if (base === '/api' && path.startsWith('/api/')) return path;
      if (base.endsWith('/api') && path.startsWith('/api/')) return base + path.slice(4);
      return base + (path.startsWith('/') ? path : '/' + path);
    };
    const errEl = document.getElementById('errorMessage');
    const okEl = document.getElementById('successMessage');
    function showError(message){ errEl.textContent = message; errEl.className = 'alert error show'; }
    function showSuccess(message){ okEl.textContent = message; okEl.className = 'alert success show'; }
  function setLoading(loading){ const b=document.getElementById('loginButton'); const t=document.getElementById('buttonText'); b.disabled=!!loading; t.textContent = loading?'Signing in…':'Sign in'; }

    document.getElementById('togglePwd').addEventListener('click', ()=>{
      const input = document.getElementById('password');
      const btn = document.getElementById('togglePwd');
      const vis = input.getAttribute('type') === 'password' ? 'text' : 'password';
      input.setAttribute('type', vis);
      btn.textContent = vis === 'password' ? 'Show' : 'Hide';
      btn.setAttribute('aria-label', vis === 'password' ? 'Show password' : 'Hide password');
    });

    // Clear error when user edits fields
    ;['email','password'].forEach(id=>{
      const el = document.getElementById(id);
      el.addEventListener('input', ()=>{ errEl.className='alert'; errEl.textContent=''; });
    });

    document.getElementById('loginForm').addEventListener('submit', async (e)=>{
      e.preventDefault(); errEl.className='alert'; okEl.className='alert';
      const fd = new FormData(e.currentTarget);
      const email = fd.get('email'); const password = fd.get('password'); const remember = fd.get('remember')==='on';
      if (!email || !password) { showError('Please enter your email and password.'); return; }
      setLoading(true);
      try{
        // Prefer `${API_BASE_URL}/api/auth/login` to use the session auth router
        let response = await fetch(buildUrl('/api/auth/login'), { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify({ email, password, rememberMe: remember })});
        if (response.status === 404 || response.status === 405 || response.status === 422){
          response = await fetch(buildUrl('/auth/login'), { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify({ email, password, rememberMe: remember })});
        }
        const result = await response.json().catch(()=>({}));
        if (response.ok && (result.success || result.access_token || (result.data && result.data.access_token))){
          showSuccess('Login successful! Redirecting…');
          // Persist tokens if present
          try {
            const access = (result && (result.access_token || (result.data && result.data.access_token))) || '';
            if (access) {
              const store = remember ? localStorage : sessionStorage;
              store.setItem('access_token', access);
              store.setItem('jwt_token', access);
              // compatibility with other pages
              try { localStorage.setItem('a3e_api_key', access); } catch(_){}
            }
          } catch(_){}

          // Store auth data in sessionStorage for cross-domain access
          if (window.MMS_AUTH_BRIDGE && result) {
            window.MMS_AUTH_BRIDGE.storeAuth(result.data || result);
          }
          
          const params = new URLSearchParams(window.location.search);
          const ret = params.get('return');
          let dest = '/dashboard-modern';
          if (ret){
            try {
              const u = new URL(ret, window.location.origin);
              if (u.origin === window.location.origin) {
                // Map legacy standards routes to modern page
                const p = u.pathname.replace(/\/index\.html$/,'');
                if (p === '/standards' || p === '/standards.html') {
                  dest = '/standards-modern?v=now5';
                } else if (p === '/standards-modern' || p === '/standards-modern.html') {
                  dest = '/standards-modern?v=now5';
                } else {
                  dest = u.toString();
                }
              }
            } catch(_) { /* ignore invalid return */ }
          } else {
            // No explicit return: if user came from standards-modern, send them back there
            try {
              const ref = document.referrer ? new URL(document.referrer) : null;
              if (ref && ref.origin === window.location.origin && /\/standards-modern(\.html)?/.test(ref.pathname)) {
                dest = '/standards-modern?v=now5';
              }
            } catch(_) { /* ignore */ }
          }
          setTimeout(()=>{ window.location.href = dest; }, 500);
        } else {
          showError((result && (result.message || result.detail)) || 'Invalid email or password');
          setLoading(false);
        }
      }catch(err){
        if (email === 'demo@example.com' && password === 'demo123'){
          showSuccess('Demo login successful! Redirecting…');
          // Store demo token for header-based auth where supported
          try { localStorage.setItem('access_token', 'demo-token'); localStorage.setItem('jwt_token', 'demo-token'); localStorage.setItem('a3e_api_key', 'demo-token'); } catch(_){}

          // Store demo auth data
          if (window.MMS_AUTH_BRIDGE) {
            window.MMS_AUTH_BRIDGE.storeAuth({
              user: { email: 'demo@example.com', name: 'Demo User' },
              access_token: 'demo-token',
              is_demo: true
            });
          }
          
          const params = new URLSearchParams(window.location.search);
          const ret = params.get('return');
          const dest = ret ? (new URL(ret, window.location.origin)).toString() : '/dashboard-modern';
          setTimeout(()=>{ window.location.href = dest; }, 500);
        } else {
          showError('Unable to connect to server. Please try again.');
          setLoading(false);
        }
      }
    });
  </script>
</body>
</html>