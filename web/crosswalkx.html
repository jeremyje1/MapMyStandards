<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>CrosswalkX</title>
  <style>
    body { font-family: -apple-system, Inter, sans-serif; margin:0; background:#f8fafc; color:#0f172a; }
    header { background:#0f172a; color:white; padding:12px 16px; }
    .container { max-width: 1100px; margin: 20px auto; padding: 0 16px; }
    .card { background:white; border:1px solid #e2e8f0; border-radius:10px; box-shadow:0 1px 2px rgba(0,0,0,0.05); padding:16px; margin-bottom:16px; }
    .row { display:flex; gap:8px; align-items:center; }
    .input { padding:8px; border:1px solid #cbd5e1; border-radius:8px; }
    .btn { padding:8px 12px; border-radius:8px; border:1px solid #0ea5e9; background:#0ea5e9; color:white; cursor:pointer; }
    .list { max-height:70vh; overflow:auto; }
    .pill { background:#f1f5f9; border:1px solid #e2e8f0; padding:4px 8px; border-radius:999px; font-size:12px; }
    .muted { color:#475569; font-size:13px; }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h2>CrosswalkX <span class="muted">Find overlap across accreditors</span></h2>
    </div>
  </header>
  <div class="container">
    <div class="card">
      <div class="row">
        <input id="a" class="input" placeholder="Accreditor A e.g., SACSCOC"/>
        <input id="b" class="input" placeholder="Accreditor B e.g., MSCHE"/>
        <button id="go" class="btn">Compute</button>
      </div>
    </div>
    <div class="card">
      <h3>Matches</h3>
      <div id="out" class="list"></div>
    </div>
  </div>
  <script>
    const API = '/api/user/intelligence-simple';

    function ensureTokenFromQuery(){
      try {
        const u = new URL(window.location.href);
        const t = u.searchParams.get('token') || u.searchParams.get('api_key') || u.searchParams.get('access_token');
        if (t) {
          try { localStorage.setItem('access_token', t); sessionStorage.setItem('access_token', t); localStorage.setItem('access_token', t); localStorage.setItem('jwt_token', t); } catch(_e) {}
          u.searchParams.delete('token'); u.searchParams.delete('api_key'); u.searchParams.delete('access_token');
          history.replaceState(null, '', u.toString());
        }
      } catch(_e) {}
    }

    function getToken(){
      return localStorage.getItem('access_token') || sessionStorage.getItem('access_token') || localStorage.getItem('access_token') || localStorage.getItem('jwt_token') || '';
    }

    function authHeaders(extra){
      const h = Object.assign({}, extra || {});
      const t = getToken();
      if (t) h['Authorization'] = `Bearer ${t}`;
      return h;
    }

    async function compute() {
      const a = document.getElementById('a').value.trim().toUpperCase();
      const b = document.getElementById('b').value.trim().toUpperCase();
      if (!a || !b) return alert('Enter both accreditors');
      if (a === b) return alert('Please enter different accreditors for comparison');
      
      const out = document.getElementById('out');
      out.innerHTML = '<div class="muted">Computing CrosswalkXâ„¢ mappings...</div>';
      
      let j;
      try {
        const r = await fetch(`${API}/standards/cross-accreditor-matches?source=${encodeURIComponent(a)}&target=${encodeURIComponent(b)}&threshold=0.3&top_k=10`, { 
          headers: authHeaders(),
          credentials: 'include' 
        });
        if (!r.ok) {
          const text = await r.text();
          j = { error: `Request failed (${r.status}) - ${text || 'ensure you\'re logged in and corpus is loaded.'}` };
        } else {
          j = await r.json();
        }
      } catch(e){ j = { error: String(e) }; }
      render(j);
    }
    function render(j) {
      const out = document.getElementById('out');
      out.innerHTML = '';
      
      if (j.error) {
        out.innerHTML = `<div style="color:#ef4444; padding: 12px; background-color: #fee; border-radius: 6px;">Error: ${j.error}</div>`;
        return;
      }
      
      const matches = j.matches || j.results || [];
      if (matches.length === 0) {
        out.innerHTML = '<div class="muted">No overlaps found. Try different accreditors or ensure the standards corpus is loaded.</div>';
        return;
      }
      
      // Group results by source standard
      const grouped = {};
      matches.forEach(m => {
        const sourceKey = m.source_code || m.standardA?.id || 'Unknown';
        if (!grouped[sourceKey]) grouped[sourceKey] = [];
        grouped[sourceKey].push(m);
      });
      
      out.innerHTML = `<div style="margin-bottom: 15px; color: #64748b;">Found ${matches.length} potential matches across ${Object.keys(grouped).length} source standards</div>`;
      
      Object.entries(grouped).forEach(([sourceKey, items]) => {
        const groupDiv = document.createElement('div');
        groupDiv.style.cssText = 'border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 16px; overflow: hidden;';
        
        // Source header
        const firstItem = items[0];
        const sourceTitle = firstItem.source_title || firstItem.standardA?.title || '';
        groupDiv.innerHTML = `
          <div style="background-color: #0066cc; color: white; padding: 12px; font-weight: 600;">
            ${sourceKey}${sourceTitle ? ' - ' + sourceTitle : ''}
          </div>
          <div style="padding: 12px;">`;
        
        // Target matches
        items.forEach(m => {
          const targetCode = m.target_code || m.standardB?.id || 'Unknown';
          const targetTitle = m.target_title || m.standardB?.title || '';
          const similarity = m.similarity || 0;
          const simPercent = (similarity * 100).toFixed(1);
          const progressColor = simPercent >= 70 ? '#10b981' : simPercent >= 50 ? '#f59e0b' : '#ef4444';
          
          const matchDiv = document.createElement('div');
          matchDiv.style.cssText = 'border-left: 4px solid ' + progressColor + '; padding-left: 12px; margin-bottom: 12px;';
          
          let html = `
            <div style="font-weight: 500; margin-bottom: 4px;">${targetCode}${targetTitle ? ' - ' + targetTitle : ''}</div>
            <div style="display: flex; align-items: center; gap: 12px; margin-top: 8px;">
              <span style="min-width: 80px; color: #64748b;">Similarity:</span>
              <div style="flex: 1; height: 8px; background-color: #e5e7eb; border-radius: 4px; overflow: hidden;">
                <div style="height: 100%; background-color: ${progressColor}; width: ${simPercent}%; transition: width 0.3s;"></div>
              </div>
              <span style="min-width: 50px; text-align: right; font-weight: 600; color: ${progressColor};">${simPercent}%</span>
            </div>`;
          
          // Keywords if available
          const keywords = m.keywords_overlap || m.common_keywords || [];
          if (keywords.length > 0) {
            html += '<div style="margin-top: 8px;"><span style="color: #64748b;">Common keywords:</span> ';
            keywords.forEach(kw => {
              html += `<span class="pill" style="background-color: #dbeafe; color: #1e40af; margin-right: 4px;">${kw}</span>`;
            });
            html += '</div>';
          }
          
          matchDiv.innerHTML = html;
          groupDiv.querySelector('div:last-child').appendChild(matchDiv);
        });
        
        groupDiv.innerHTML += '</div>';
        out.appendChild(groupDiv);
      });
    }
    document.getElementById('go').addEventListener('click', compute);
    ensureTokenFromQuery();
  </script>
</body>
</html>
