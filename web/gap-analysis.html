<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gap Analysis - A³E | MapMyStandards.ai</title>
    <script src="/js/config.js"></script>
    <link rel="stylesheet" href="/css/accessibility.css">
    <script src="/js/ux.js"></script>
    
    <style>
        :root {
            --primary-blue: #1e40af;
            --primary-blue-light: #3b82f6;
            --primary-blue-dark: #1e3a8a;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-orange: #f59e0b;
            --text-dark: #1f2937;
            --text-medium: #6b7280;
            --bg-light: #f8fafc;
            --bg-white: #ffffff;
            --border-light: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --border-radius: 0.75rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .page-header {
            background: var(--bg-white);
            border-radius: var(--border-radius);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
        }

        .page-header h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .page-header p {
            color: var(--text-medium);
            font-size: 1rem;
        }

        .nav-buttons {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .nav-btn {
            padding: 0.75rem 1.5rem;
            background: var(--bg-white);
            border: 1px solid var(--border-light);
            border-radius: 0.5rem;
            color: var(--text-dark);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
        }

        .nav-btn:hover {
            background: var(--primary-blue-light);
            color: white;
            border-color: var(--primary-blue-light);
        }

        .gap-section {
            background: var(--bg-white);
            border-radius: var(--border-radius);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
        }

        .gap-section h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
            border: 1px solid var(--border-light);
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.2s;
        }

        .metric-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .metric-label {
            color: var(--text-medium);
            font-size: 0.875rem;
        }

        .metric-card.critical { border-left: 4px solid var(--accent-red); }
        .metric-card.warning { border-left: 4px solid var(--accent-orange); }
        .metric-card.good { border-left: 4px solid var(--accent-green); }

        .gap-list {
            list-style: none;
            padding: 0;
        }

        .gap-item {
            background: #f8fafc;
            border: 1px solid var(--border-light);
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }

        .gap-item:hover {
            box-shadow: var(--shadow-sm);
        }

        .gap-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .gap-standard {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .gap-severity {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .gap-severity.critical {
            background: #fee2e2;
            color: #991b1b;
        }

        .gap-severity.high {
            background: #fed7aa;
            color: #9a3412;
        }

        .gap-severity.medium {
            background: #fef3c7;
            color: #92400e;
        }

        .gap-severity.low {
            background: #dbeafe;
            color: #1e40af;
        }

        .gap-description {
            color: var(--text-medium);
            margin-bottom: 1rem;
        }

        .gap-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 0.5rem 1rem;
            background: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        /* Recommendations Styles */
        .recommendations-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .recommendation-item {
            background: var(--bg-white);
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius);
            padding: 1.5rem;
        }
        
        .recommendation-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.75rem;
        }
        
        .recommendation-header h4 {
            margin: 0;
            color: var(--text-dark);
        }
        
        .priority-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .priority-badge.priority-high {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .priority-badge.priority-medium {
            background: #fed7aa;
            color: #92400e;
        }
        
        .priority-badge.priority-low {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .action-steps {
            margin-top: 0.75rem;
            margin-left: 1.5rem;
            color: var(--text-medium);
        }
        
        .action-steps li {
            margin-bottom: 0.5rem;
        }

        .action-btn:hover {
            background: var(--primary-blue-dark);
        }

        .action-btn.secondary {
            background: var(--bg-white);
            color: var(--text-dark);
            border: 1px solid var(--border-light);
        }

        .action-btn.secondary:hover {
            background: var(--bg-light);
        }

        .loading-state {
            text-align: center;
            padding: 4rem;
            color: var(--text-medium);
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-light);
            border-top-color: var(--primary-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 4rem;
            color: var(--text-medium);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .report-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            justify-content: center;
        }

        .export-btn {
            padding: 0.75rem 2rem;
            background: var(--accent-green);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .export-btn:hover {
            background: #059669;
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <h1>Gap Analysis</h1>
            <p>Identify compliance gaps and create action plans for accreditation readiness</p>
        </div>

        <!-- Navigation -->
        <div class="nav-buttons">
            <a href="/dashboard" class="nav-btn">← Back to Dashboard</a>
            <a href="/report-generation.html" class="nav-btn">Reports & Analytics</a>
            <a href="/narrative" class="nav-btn">Narrative Generator</a>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="loading-state">
            <div class="loading-spinner"></div>
            <p>Analyzing compliance gaps...</p>
        </div>

        <!-- Main Content -->
        <div id="mainContent" style="display: none;">
            <!-- Overview Section -->
            <div class="gap-section">
                <h2>⚠️ Gap Analysis Overview</h2>
                <div class="metrics-grid" id="metricsGrid">
                    <!-- Metrics will be populated here -->
                </div>
            </div>

            <!-- Critical Gaps -->
            <div class="gap-section">
                <h2>🚨 Critical Gaps</h2>
                <p style="color: var(--text-medium); margin-bottom: 1.5rem;">
                    Standards with no evidence or very low compliance that require immediate attention
                </p>
                <ul class="gap-list" id="criticalGaps">
                    <!-- Critical gaps will be populated here -->
                </ul>
            </div>

            <!-- Action Items -->
            <div class="gap-section">
                <h2>📋 Recommended Actions</h2>
                <p style="color: var(--text-medium); margin-bottom: 1.5rem;">
                    Prioritized action items to address compliance gaps
                </p>
                <ul class="gap-list" id="actionItems">
                    <!-- Action items will be populated here -->
                </ul>
            </div>

            <!-- Export Actions -->
            <div class="report-actions">
                <button class="export-btn" onclick="exportGapAnalysis()">
                    📄 Export Gap Analysis Report
                </button>
                <button class="export-btn secondary" onclick="createActionPlan()">
                    📋 Create Action Plan
                </button>
            </div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="empty-state" style="display: none;">
            <div class="empty-state-icon">📊</div>
            <h2>No Evidence Mapped Yet</h2>
            <p>Upload and map evidence to standards to see gap analysis</p>
            <a href="/evidence-upload" class="action-btn" style="margin-top: 1.5rem;">
                Upload Evidence
            </a>
        </div>
    </div>

    <script>
        // Check authentication
        const authToken = localStorage.getItem('access_token') || 
                         localStorage.getItem('access_token') || 
                         sessionStorage.getItem('access_token');
        if (!authToken) {
            window.location.href = "/login-enhanced.html";
        }

        // Load gap analysis data
        async function loadGapAnalysis() {
            try {
                // Get the gap analysis data from the correct endpoint
                const gapResponse = await fetch('/api/gaps/analysis', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!gapResponse.ok) {
                    throw new Error('Failed to load gap analysis');
                }

                const gapData = await gapResponse.json();
                
                // Also get evidence mappings to show what standards are covered
                const evidenceResponse = await fetch('/api/standards/evidence-map', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                let mappedStandards = new Set();
                let hasEvidence = false;
                
                if (evidenceResponse.ok) {
                    const evidenceData = await evidenceResponse.json();
                    if (evidenceData.mapping && Object.keys(evidenceData.mapping).length > 0) {
                        mappedStandards = new Set(Object.keys(evidenceData.mapping));
                        hasEvidence = true;
                    }
                }

                // Check if we have any data to show
                if (!hasEvidence && (!gapData.gap_analysis || gapData.gap_analysis.total_gaps === 0)) {
                    showEmptyState();
                    return;
                }

                // Display the gap analysis
                displayGapAnalysis(gapData, mappedStandards);
                
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
            } catch (error) {
                console.error('Error loading gap analysis:', error);
                showError('Failed to load gap analysis. Please try again.');
            }
        }

        function showEmptyState() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
        }

        function showError(message) {
            document.getElementById('loadingState').innerHTML = `
                <div style="color: var(--accent-red);">
                    <p>❌ ${message}</p>
                    <button class="action-btn" onclick="location.reload()">Retry</button>
                </div>
            `;
        }

        function analyzeGaps(data) {
            const standards = data.evidence || {};
            const totalStandards = Object.keys(standards).length;
            let mappedCount = 0;
            let highConfidenceCount = 0;
            let criticalGaps = [];
            let mediumGaps = [];
            let lowGaps = [];

            // Analyze each standard
            Object.entries(standards).forEach(([standardId, standardData]) => {
                const documents = standardData.documents || [];
                const avgConfidence = documents.length > 0
                    ? documents.reduce((sum, doc) => sum + (doc.confidence_score || 0), 0) / documents.length
                    : 0;

                if (documents.length > 0) {
                    mappedCount++;
                    if (avgConfidence >= 0.8) {
                        highConfidenceCount++;
                    }
                }

                // Categorize gaps
                if (documents.length === 0) {
                    criticalGaps.push({
                        standardId,
                        title: standardData.title || standardId,
                        description: standardData.description || 'No description available',
                        severity: 'critical',
                        reason: 'No evidence mapped'
                    });
                } else if (avgConfidence < 0.5) {
                    mediumGaps.push({
                        standardId,
                        title: standardData.title || standardId,
                        description: standardData.description || 'No description available',
                        severity: 'high',
                        reason: `Low confidence (${Math.round(avgConfidence * 100)}%)`,
                        confidence: avgConfidence
                    });
                } else if (avgConfidence < 0.8) {
                    lowGaps.push({
                        standardId,
                        title: standardData.title || standardId,
                        description: standardData.description || 'No description available',
                        severity: 'medium',
                        reason: `Moderate confidence (${Math.round(avgConfidence * 100)}%)`,
                        confidence: avgConfidence
                    });
                }
            });

            // Update metrics
            updateMetrics(totalStandards, mappedCount, highConfidenceCount, criticalGaps.length);

            // Display gaps
            displayCriticalGaps([...criticalGaps, ...mediumGaps]);
            displayActionItems(criticalGaps, mediumGaps, lowGaps);
        }

        function displayGapAnalysis(gapData, mappedStandards) {
            // Handle the actual API response format
            if (gapData.gap_analysis) {
                const analysis = gapData.gap_analysis;
                const gaps = analysis.gaps || [];
                
                // Categorize gaps by risk level
                const criticalGaps = gaps.filter(g => g.risk_level === 'High' || g.risk_score >= 0.7);
                const mediumGaps = gaps.filter(g => g.risk_level === 'Medium' || (g.risk_score >= 0.5 && g.risk_score < 0.7));
                const lowGaps = gaps.filter(g => g.risk_level === 'Low' || g.risk_score < 0.5);
                
                // Update metrics
                const totalStandards = 73; // Default for HLC
                const mappedCount = mappedStandards ? mappedStandards.size : 0;
                updateMetrics(
                    totalStandards,
                    mappedCount,
                    mappedCount, // high confidence count (simplified)
                    analysis.high_risk || criticalGaps.length
                );
                
                // Display gaps
                displayCriticalGaps(gaps.slice(0, 5)); // Show top 5 gaps
                displayActionItems(criticalGaps, mediumGaps, lowGaps);
                
                // Display recommendations if available
                if (gapData.recommendations && gapData.recommendations.length > 0) {
                    displayRecommendations(gapData.recommendations);
                }
            } else {
                // No gap data - show empty state
                showEmptyState();
            }
        }

        function displayRecommendations(recommendations) {
            const container = document.getElementById('actionItems');
            if (!container) return;
            
            const recSection = document.createElement('div');
            recSection.className = 'action-section';
            recSection.innerHTML = `
                <h3>AI Recommendations</h3>
                <div class="recommendations-list">
                    ${recommendations.map(rec => `
                        <div class="recommendation-item">
                            <div class="recommendation-header">
                                <span class="priority-badge priority-${rec.priority || 'medium'}">${rec.priority || 'Medium'} Priority</span>
                                <h4>${rec.title || rec.standard_id}</h4>
                            </div>
                            <p>${rec.recommendation || rec.description}</p>
                            ${rec.actions ? `
                                <ul class="action-steps">
                                    ${rec.actions.map(action => `<li>${action}</li>`).join('')}
                                </ul>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
            
            container.appendChild(recSection);
        }

        function updateMetrics(total, mapped, highConfidence, critical) {
            const metricsGrid = document.getElementById('metricsGrid');
            const compliance = total > 0 ? Math.round((mapped / total) * 100) : 0;
            const readiness = total > 0 ? Math.round((highConfidence / total) * 100) : 0;

            metricsGrid.innerHTML = `
                <div class="metric-card ${compliance >= 80 ? 'good' : compliance >= 50 ? 'warning' : 'critical'}">
                    <div class="metric-value">${compliance}%</div>
                    <div class="metric-label">Overall Compliance</div>
                </div>
                <div class="metric-card ${readiness >= 70 ? 'good' : readiness >= 40 ? 'warning' : 'critical'}">
                    <div class="metric-value">${readiness}%</div>
                    <div class="metric-label">Accreditation Readiness</div>
                </div>
                <div class="metric-card ${critical === 0 ? 'good' : critical <= 5 ? 'warning' : 'critical'}">
                    <div class="metric-value">${critical}</div>
                    <div class="metric-label">Critical Gaps</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${mapped}/${total}</div>
                    <div class="metric-label">Standards Mapped</div>
                </div>
            `;
        }

        function displayCriticalGaps(gaps) {
            const container = document.getElementById('criticalGaps');
            
            if (gaps.length === 0) {
                container.innerHTML = '<p style="color: var(--accent-green); text-align: center;">✅ No critical gaps found!</p>';
                return;
            }

            container.innerHTML = gaps.slice(0, 10).map(gap => `
                <li class="gap-item">
                    <div class="gap-header">
                        <div class="gap-standard">${gap.standard.code}: ${gap.standard.title}</div>
                        <span class="gap-severity ${gap.risk_level.toLowerCase()}">${gap.risk_level.toUpperCase()}</span>
                    </div>
                    <p class="gap-description">Risk Score: ${(gap.risk_score * 100).toFixed(0)}%</p>
                    <p style="color: var(--accent-red); font-size: 0.875rem; margin-bottom: 1rem;">
                        ⚠️ ${gap.recommendation}
                    </p>
                    <div class="gap-actions">
                        <button class="action-btn" onclick="uploadEvidence('${gap.standard.code}')">
                            Upload Evidence
                        </button>
                        <button class="action-btn secondary" onclick="viewStandard('${gap.standard.code}')">
                            View Requirements
                        </button>
                    </div>
                </li>
            `).join('');
        }

        function displayActionItems(critical, medium, low) {
            const container = document.getElementById('actionItems');
            const actions = [];

            // Generate action items based on gaps
            if (critical.length > 0) {
                actions.push({
                    priority: 'HIGH',
                    title: 'Address Critical Gaps',
                    description: `${critical.length} standards have no evidence mapped. These require immediate attention.`,
                    action: 'Start uploading evidence for unmapped standards'
                });
            }

            if (medium.length > 0) {
                actions.push({
                    priority: 'MEDIUM',
                    title: 'Improve Low Confidence Mappings',
                    description: `${medium.length} standards have low confidence scores. Additional evidence needed.`,
                    action: 'Review and supplement evidence for low-confidence standards'
                });
            }

            if (low.length > 0) {
                actions.push({
                    priority: 'LOW',
                    title: 'Enhance Documentation Quality',
                    description: `${low.length} standards have moderate confidence. Could benefit from stronger evidence.`,
                    action: 'Add supporting documentation to increase confidence scores'
                });
            }

            container.innerHTML = actions.map((action, index) => `
                <li class="gap-item">
                    <div class="gap-header">
                        <div class="gap-standard">Action ${index + 1}: ${action.title}</div>
                        <span class="gap-severity ${action.priority.toLowerCase()}">${action.priority}</span>
                    </div>
                    <p class="gap-description">${action.description}</p>
                    <p style="color: var(--primary-blue); font-size: 0.875rem; margin-bottom: 1rem;">
                        ✓ ${action.action}
                    </p>
                    <div class="gap-actions">
                        <button class="action-btn" onclick="startAction('${action.priority}')">
                            Start This Action
                        </button>
                    </div>
                </li>
            `).join('');
        }

        // Action handlers
        function uploadEvidence(standardId) {
            localStorage.setItem('targetStandard', standardId);
            window.location.href = '/upload-working.html';
        }

        function viewStandard(standardId) {
            window.location.href = `/standards-selection-wizard.html#${standardId}`;
        }

        function startAction(priority) {
            if (priority === 'HIGH') {
                window.location.href = '/evidence-upload';
            } else {
                window.location.href = '/evidence-mapping';
            }
        }

        async function exportGapAnalysis() {
            try {
                const response = await fetch('/api/v1/reports/gap-analysis-database', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to generate report');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `gap-analysis-${new Date().toISOString().split('T')[0]}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Error exporting gap analysis:', error);
                alert('Failed to export gap analysis report');
            }
        }

        function createActionPlan() {
            // Navigate to action plan creator (future feature)
            alert('Action plan creation feature coming soon!');
        }

        // Initialize page
        loadGapAnalysis();
    </script>
</body>
</html>