<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gap Analysis - AÂ³E | MapMyStandards.ai</title>
    <script src="/js/config.js"></script>
    <script src="/js/metrics-store.js?v=20251009"></script>
    <link rel="stylesheet" href="/css/accessibility.css">
    <script src="/js/ux.js"></script>
    
    <style>
        :root {
            --primary-blue: #1e40af;
            --primary-blue-light: #3b82f6;
            --primary-blue-dark: #1e3a8a;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-orange: #f59e0b;
            --text-dark: #1f2937;
            --text-medium: #6b7280;
            --bg-light: #f8fafc;
            --bg-white: #ffffff;
            --border-light: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --border-radius: 0.75rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .page-header {
            background: var(--bg-white);
            border-radius: var(--border-radius);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
        }

        .page-header h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .page-header p {
            color: var(--text-medium);
            font-size: 1rem;
        }

        .nav-buttons {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .nav-btn {
            padding: 0.75rem 1.5rem;
            background: var(--bg-white);
            border: 1px solid var(--border-light);
            border-radius: 0.5rem;
            color: var(--text-dark);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
        }

        .nav-btn:hover {
            background: var(--primary-blue-light);
            color: white;
            border-color: var(--primary-blue-light);
        }

        .gap-section {
            background: var(--bg-white);
            border-radius: var(--border-radius);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
        }

        .gap-section h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-subtitle {
            color: var(--text-medium);
            margin-top: -0.5rem;
            margin-bottom: 1.5rem;
            font-size: 0.95rem;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
            border: 1px solid var(--border-light);
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.2s;
        }

        .metric-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .metric-label {
            color: var(--text-medium);
            font-size: 0.875rem;
        }

        .metric-card.critical { border-left: 4px solid var(--accent-red); }
        .metric-card.warning { border-left: 4px solid var(--accent-orange); }
        .metric-card.good { border-left: 4px solid var(--accent-green); }

        .gap-list {
            list-style: none;
            padding: 0;
        }

        .gap-item {
            background: #f8fafc;
            border: 1px solid var(--border-light);
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }

        .gap-item:hover {
            box-shadow: var(--shadow-sm);
        }

        .gap-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .gap-standard {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .gap-severity {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .gap-severity.critical {
            background: #fee2e2;
            color: #991b1b;
        }

        .gap-severity.high {
            background: #fed7aa;
            color: #9a3412;
        }

        .gap-severity.medium {
            background: #fef3c7;
            color: #92400e;
        }

        .gap-severity.low {
            background: #dbeafe;
            color: #1e40af;
        }

        .gap-description {
            color: var(--text-medium);
            margin-bottom: 1rem;
        }

        .gap-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 0.5rem 1rem;
            background: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        /* Recommendations Styles */
        .recommendations-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .recommendation-item {
            background: var(--bg-white);
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius);
            padding: 1.5rem;
        }
        
        .recommendation-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.75rem;
        }
        
        .recommendation-header h4 {
            margin: 0;
            color: var(--text-dark);
        }
        
        .priority-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .priority-badge.priority-high {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .priority-badge.priority-medium {
            background: #fed7aa;
            color: #92400e;
        }
        
        .priority-badge.priority-low {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .action-steps {
            margin-top: 0.75rem;
            margin-left: 1.5rem;
            color: var(--text-medium);
        }
        
        .action-steps li {
            margin-bottom: 0.5rem;
        }

        .action-btn:hover {
            background: var(--primary-blue-dark);
        }

        .action-btn.secondary {
            background: var(--bg-white);
            color: var(--text-dark);
            border: 1px solid var(--border-light);
        }

        .action-btn.secondary:hover {
            background: var(--bg-light);
        }

        .crosswalk-highlight-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .crosswalk-highlight-card {
            background: #eef2ff;
            border: 1px solid #c7d2fe;
            color: #1e3a8a;
            border-radius: 999px;
            padding: 0.6rem 1rem;
            font-size: 0.9rem;
            display: inline-flex;
            gap: 0.45rem;
            align-items: center;
        }

        .crosswalk-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 1.25rem;
        }

        .crosswalk-card {
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
            border: 1px solid #dbe4ff;
            border-radius: 0.75rem;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            box-shadow: var(--shadow-sm);
        }

        .crosswalk-card h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary-blue);
            margin: 0;
        }

        .reuse-badge {
            background: #e0f2fe;
            color: #0369a1;
            border-radius: 999px;
            padding: 0.3rem 0.75rem;
            font-size: 0.8rem;
            font-weight: 600;
            align-self: flex-start;
        }

        .crosswalk-meta {
            color: var(--text-medium);
            font-size: 0.9rem;
        }

        .crosswalk-standards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 0.75rem;
        }

        .crosswalk-standards ul {
            list-style: none;
            padding: 0.4rem 0 0 0;
            margin: 0;
            display: grid;
            gap: 0.25rem;
        }

        .crosswalk-standards li {
            font-size: 0.85rem;
            color: var(--text-medium);
            padding-left: 0.35rem;
            border-left: 2px solid #bfdbfe;
        }

        .crosswalk-accreditor {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--primary-blue);
        }

        .crosswalk-empty {
            background: #f1f5f9;
            border: 1px dashed #cbd5e1;
            border-radius: 0.75rem;
            padding: 1.25rem;
            text-align: center;
            color: #64748b;
            font-size: 0.95rem;
        }

        .loading-state {
            text-align: center;
            padding: 4rem;
            color: var(--text-medium);
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-light);
            border-top-color: var(--primary-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 4rem;
            color: var(--text-medium);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .report-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            justify-content: center;
        }

        .export-btn {
            padding: 0.75rem 2rem;
            background: var(--accent-green);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .export-btn:hover {
            background: #059669;
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <h1>Gap Analysis</h1>
            <p>Identify compliance gaps and create action plans for accreditation readiness</p>
        </div>

        <!-- Navigation -->
        <div class="nav-buttons">
            <a href="/dashboard" class="nav-btn">â Back to Dashboard</a>
            <a href="/report-generation" class="nav-btn">Reports & Analytics</a>
            <a href="/narrative" class="nav-btn">Narrative Generator</a>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="loading-state">
            <div class="loading-spinner"></div>
            <p>Analyzing compliance gaps...</p>
        </div>

        <!-- Main Content -->
        <div id="mainContent" style="display: none;">
            <!-- Overview Section -->
            <div class="gap-section">
                <h2>â ï¸ Gap Analysis Overview</h2>
                <div class="metrics-grid" id="metricsGrid">
                    <!-- Metrics will be populated here -->
                </div>
            </div>

            <div class="gap-section" id="crosswalkInsights" style="display: none;">
                <h2>ð Cross-accreditor Reuse (CrosswalkXâ¢)</h2>
                <p class="section-subtitle" id="crosswalkSummary"></p>
                <div id="crosswalkPairChips" class="crosswalk-highlight-grid"></div>
                <div id="crosswalkOpportunities" class="crosswalk-grid"></div>
            </div>

            <!-- Critical Gaps -->
            <div class="gap-section">
                <h2>ð¨ Critical Gaps</h2>
                <p style="color: var(--text-medium); margin-bottom: 1.5rem;">
                    Standards with no evidence or very low compliance that require immediate attention
                </p>
                <ul class="gap-list" id="criticalGaps">
                    <!-- Critical gaps will be populated here -->
                </ul>
            </div>

            <!-- Action Items -->
            <div class="gap-section">
                <h2>ð Recommended Actions</h2>
                <p style="color: var(--text-medium); margin-bottom: 1.5rem;">
                    Prioritized action items to address compliance gaps
                </p>
                <ul class="gap-list" id="actionItems">
                    <!-- Action items will be populated here -->
                </ul>
            </div>

            <!-- Export Actions -->
            <div class="report-actions">
                <button class="export-btn" onclick="exportGapAnalysis()">
                    ð Export Gap Analysis Report
                </button>
                <button class="export-btn secondary" onclick="createActionPlan()">
                    ð Create Action Plan
                </button>
            </div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="empty-state" style="display: none;">
            <div class="empty-state-icon">ð</div>
            <h2>No Evidence Mapped Yet</h2>
            <p>Upload and map evidence to standards to see gap analysis</p>
            <a href="/upload" class="action-btn" style="margin-top: 1.5rem;">
                Upload Evidence
            </a>
        </div>
    </div>

    <script>
        // Check authentication
        const authToken = localStorage.getItem('access_token') || 
                         localStorage.getItem('access_token') || 
                         sessionStorage.getItem('access_token');
        if (!authToken) {
            window.location.href = "/login-enhanced.html";
        }

        // Load gap analysis data
        async function loadGapAnalysis() {
            try {
                // Get the gap analysis data from the correct endpoint
                const gapResponse = await fetch('/api/user/intelligence-simple/gaps/analysis', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!gapResponse.ok) {
                    throw new Error('Failed to load gap analysis');
                }

                const gapData = await gapResponse.json();

                // Normalize evidence and standards metrics via shared store
                const metricsSnapshot = await window.A3EMetricsStore.ensure({
                    includeEvidenceMap: true,
                });

                const snapshotStats = metricsSnapshot.evidenceStats || {};
                const evidenceMap = metricsSnapshot.evidenceMap || {};
                const coverageFromPerformance =
                    typeof metricsSnapshot.performanceMetrics?.coverage_percentage === 'number'
                        ? metricsSnapshot.performanceMetrics.coverage_percentage
                        : null;

                const evidenceStats = {
                    mappedCount: snapshotStats.mappedCount ?? 0,
                    totalStandards: snapshotStats.totalStandards,
                    highConfidenceCount: snapshotStats.highConfidenceCount ?? null,
                    coveragePercentage: snapshotStats.coveragePercentage ?? coverageFromPerformance,
                };

                if (evidenceStats.highConfidenceCount === null && Array.isArray(evidenceMap?.standards)) {
                    evidenceStats.highConfidenceCount = evidenceMap.standards.filter((standard) => {
                        const value = typeof standard?.avg_confidence === 'number' ? standard.avg_confidence : 0;
                        return value >= 0.75;
                    }).length;
                }

                if (evidenceStats.coveragePercentage === null && typeof evidenceMap?.coverage_percentage === 'number') {
                    evidenceStats.coveragePercentage = evidenceMap.coverage_percentage;
                }

                if (evidenceStats.totalStandards === null && typeof metricsSnapshot.coreMetrics?.total_standards === 'number') {
                    evidenceStats.totalStandards = metricsSnapshot.coreMetrics.total_standards;
                }

                if (typeof evidenceStats.highConfidenceCount !== 'number') {
                    evidenceStats.highConfidenceCount = Math.round((evidenceStats.mappedCount || 0) * 0.6);
                }

                if (typeof evidenceStats.coveragePercentage !== 'number' || Number.isNaN(evidenceStats.coveragePercentage)) {
                    evidenceStats.coveragePercentage = 0;
                }

                const documentsAnalyzed = metricsSnapshot.coreMetrics?.documents_analyzed ?? 0;
                const hasEvidence = evidenceStats.mappedCount > 0 || documentsAnalyzed > 0;

                let crosswalkData = null;
                try {
                    const crosswalkResponse = await fetch('/api/user/intelligence-simple/evidence/crosswalk', {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });

                    if (crosswalkResponse.ok) {
                        crosswalkData = await crosswalkResponse.json();
                    }
                } catch (crosswalkError) {
                    console.error('Crosswalk load error:', crosswalkError);
                }

                // Check if we have any data to show
                if (!hasEvidence && (!gapData.gap_analysis || gapData.gap_analysis.total_gaps === 0)) {
                    showEmptyState();
                    return;
                }

                // Display the gap analysis
                displayGapAnalysis(gapData, evidenceStats, crosswalkData);
                
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
            } catch (error) {
                console.error('Error loading gap analysis:', error);
                showError('Failed to load gap analysis. Please try again.');
            }
        }

        function showEmptyState() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
        }

        function showError(message) {
            document.getElementById('loadingState').innerHTML = `
                <div style="color: var(--accent-red);">
                    <p>â ${message}</p>
                    <button class="action-btn" onclick="location.reload()">Retry</button>
                </div>
            `;
        }

        function analyzeGaps(data) {
            const standards = data.evidence || {};
            const totalStandards = Object.keys(standards).length;
            let mappedCount = 0;
            let highConfidenceCount = 0;
            let criticalGaps = [];
            let mediumGaps = [];
            let lowGaps = [];

            // Analyze each standard
            Object.entries(standards).forEach(([standardId, standardData]) => {
                const documents = standardData.documents || [];
                const avgConfidence = documents.length > 0
                    ? documents.reduce((sum, doc) => sum + (doc.confidence_score || 0), 0) / documents.length
                    : 0;

                if (documents.length > 0) {
                    mappedCount++;
                    if (avgConfidence >= 0.8) {
                        highConfidenceCount++;
                    }
                }

                // Categorize gaps
                if (documents.length === 0) {
                    criticalGaps.push({
                        standardId,
                        title: standardData.title || standardId,
                        description: standardData.description || 'No description available',
                        severity: 'critical',
                        reason: 'No evidence mapped'
                    });
                } else if (avgConfidence < 0.5) {
                    mediumGaps.push({
                        standardId,
                        title: standardData.title || standardId,
                        description: standardData.description || 'No description available',
                        severity: 'high',
                        reason: `Low confidence (${Math.round(avgConfidence * 100)}%)`,
                        confidence: avgConfidence
                    });
                } else if (avgConfidence < 0.8) {
                    lowGaps.push({
                        standardId,
                        title: standardData.title || standardId,
                        description: standardData.description || 'No description available',
                        severity: 'medium',
                        reason: `Moderate confidence (${Math.round(avgConfidence * 100)}%)`,
                        confidence: avgConfidence
                    });
                }
            });

            // Update metrics
            updateMetrics(totalStandards, mappedCount, highConfidenceCount, criticalGaps.length, null);

            // Display gaps
            displayCriticalGaps([...criticalGaps, ...mediumGaps]);
            displayActionItems(criticalGaps, mediumGaps, lowGaps);
        }

        function displayGapAnalysis(gapData, evidenceStats, crosswalkData) {
            // Handle the actual API response format
            if (gapData.gap_analysis) {
                const analysis = gapData.gap_analysis;
                const gaps = analysis.gaps || [];
                
                // Categorize gaps by risk level
                const criticalGaps = gaps.filter(g => g.risk_level === 'High' || g.risk_score >= 0.7);
                const mediumGaps = gaps.filter(g => g.risk_level === 'Medium' || (g.risk_score >= 0.5 && g.risk_score < 0.7));
                const lowGaps = gaps.filter(g => g.risk_level === 'Low' || g.risk_score < 0.5);
                
                // Update metrics
                let totalStandards = typeof evidenceStats?.totalStandards === 'number' && evidenceStats.totalStandards > 0
                    ? evidenceStats.totalStandards
                    : null;

                const mappedCount = typeof evidenceStats?.mappedCount === 'number'
                    ? evidenceStats.mappedCount
                    : 0;

                if (!totalStandards && typeof analysis.total_standards === 'number' && analysis.total_standards > 0) {
                    totalStandards = analysis.total_standards;
                }

                if (!totalStandards && mappedCount > 0 && typeof evidenceStats?.coveragePercentage === 'number' && evidenceStats.coveragePercentage > 0) {
                    const coverageRatio = evidenceStats.coveragePercentage / 100;
                    if (coverageRatio > 0) {
                        totalStandards = Math.round(mappedCount / coverageRatio);
                    }
                }

                if (!totalStandards) {
                    totalStandards = 73; // Fallback default for HLC
                }

                const highConfidenceCount = typeof evidenceStats?.highConfidenceCount === 'number'
                    ? evidenceStats.highConfidenceCount
                    : Math.round(mappedCount * 0.6);

                updateMetrics(
                    totalStandards,
                    mappedCount,
                    highConfidenceCount,
                    analysis.high_risk || criticalGaps.length,
                    crosswalkData
                );
                
                // Display gaps
                displayCriticalGaps(gaps.slice(0, 5)); // Show top 5 gaps
                displayActionItems(criticalGaps, mediumGaps, lowGaps);
                
                // Display recommendations if available
                if (gapData.recommendations && gapData.recommendations.length > 0) {
                    displayRecommendations(gapData.recommendations);
                }

                renderCrosswalkInsights(crosswalkData);
            } else {
                // No gap data - show empty state
                showEmptyState();
            }
        }

        function displayRecommendations(recommendations) {
            const container = document.getElementById('actionItems');
            if (!container || !Array.isArray(recommendations)) {
                return;
            }

            // Remove any existing recommendation sections before rendering a fresh one
            container.querySelectorAll('.action-section').forEach(section => section.remove());

            const normalized = recommendations
                .map((rec, index) => {
                    if (!rec) {
                        return null;
                    }

                    if (typeof rec === 'string') {
                        const priority = index === 0 ? 'high' : index === 1 ? 'medium' : 'low';
                        return {
                            priority,
                            title: `Recommendation ${index + 1}`,
                            body: rec,
                            actions: [],
                        };
                    }

                    if (typeof rec === 'object') {
                        const rawPriority = String(rec.priority || 'medium').toLowerCase();
                        const allowedPriorities = ['critical', 'high', 'medium', 'low'];
                        const priority = allowedPriorities.includes(rawPriority) ? rawPriority : 'medium';
                        const title = rec.title || rec.standard_id || `Recommendation ${index + 1}`;
                        const body = rec.recommendation || rec.description || rec.summary || '';
                        const actions = Array.isArray(rec.actions) ? rec.actions.filter(Boolean) : [];

                        if (!body) {
                            return null;
                        }

                        return {
                            priority,
                            title,
                            body,
                            actions,
                        };
                    }

                    return null;
                })
                .filter((rec) => rec && rec.body);

            if (normalized.length === 0) {
                const emptySection = document.createElement('div');
                emptySection.className = 'action-section';
                emptySection.innerHTML = `
                    <h3>AI Recommendations</h3>
                    <div class="empty-state" style="margin-top: 1rem;">
                        <div class="empty-state-icon">ð¤</div>
                        <h3>No AI recommendations yet</h3>
                        <p style="color: #6b7280; font-size: 0.95rem;">Upload evidence and map it to standards to unlock tailored guidance.</p>
                    </div>
                `;
                container.appendChild(emptySection);
                return;
            }

            const recSection = document.createElement('div');
            recSection.className = 'action-section';
            recSection.innerHTML = `
                <h3>AI Recommendations</h3>
                <div class="recommendations-list">
                    ${normalized
                        .map((rec) => `
                            <div class="recommendation-item">
                                <div class="recommendation-header">
                                    <span class="priority-badge priority-${escapeHtml(rec.priority)}">${escapeHtml(rec.priority.charAt(0).toUpperCase() + rec.priority.slice(1))} Priority</span>
                                    <h4>${escapeHtml(rec.title)}</h4>
                                </div>
                                <p>${escapeHtml(rec.body)}</p>
                                ${rec.actions.length > 0
                                    ? `
                                        <ul class="action-steps">
                                            ${rec.actions
                                                .map((action) => `<li>${escapeHtml(action)}</li>`)
                                                .join('')}
                                        </ul>
                                    `
                                    : ''}
                            </div>
                        `)
                        .join('')}
                </div>
            `;

            container.appendChild(recSection);
        }

        function updateMetrics(total, mapped, highConfidence, critical, crosswalkData) {
            const metricsGrid = document.getElementById('metricsGrid');
            const compliance = total > 0 ? Math.round((mapped / total) * 100) : 0;
            const readiness = total > 0 ? Math.round((highConfidence / total) * 100) : 0;
            const reusePercent = typeof crosswalkData?.reuse_percentage === 'number' ? crosswalkData.reuse_percentage : 0;
            const reuseClass = reusePercent >= 60 ? 'good' : reusePercent >= 30 ? 'warning' : 'critical';
            const multiUse = crosswalkData?.multi_use_count ?? 0;

            const cardData = [
                {
                    className: compliance >= 80 ? 'good' : compliance >= 50 ? 'warning' : 'critical',
                    value: `${compliance}%`,
                    label: 'Overall Compliance',
                    description: 'Mapped standards divided by total standards. Higher percentages mean more requirements are covered.',
                    aria: `Overall compliance ${compliance} percent. ${mapped} of ${total} standards have mapped evidence.`
                },
                {
                    className: readiness >= 70 ? 'good' : readiness >= 40 ? 'warning' : 'critical',
                    value: `${readiness}%`,
                    label: 'Accreditation Readiness',
                    description: 'Share of standards backed by high-confidence evidence. Indicates preparedness for reviews.',
                    aria: `Accreditation readiness ${readiness} percent. ${highConfidence} high confidence standards out of ${total}.`
                },
                {
                    className: critical === 0 ? 'good' : critical <= 5 ? 'warning' : 'critical',
                    value: `${critical}`,
                    label: 'Critical Gaps',
                    description: 'Number of standards that remain high risk and need remediation before accreditation.',
                    aria: `${critical} critical gaps remain that require remediation.`
                },
                {
                    className: '',
                    value: `${mapped}/${total}`,
                    label: 'Standards Mapped',
                    description: 'Total standards mapped compared to the total standards in scope.',
                    aria: `${mapped} of ${total} standards currently mapped.`
                },
                {
                    className: reuseClass,
                    value: `${reusePercent}%`,
                    label: 'Evidence Reuse Rate',
                    description: 'Percent of standards supported by evidence that can be reused across frameworks.',
                    aria: `Evidence reuse rate ${reusePercent} percent based on cross-accreditor mapping.`
                },
                {
                    className: multiUse === 0 ? 'warning' : 'good',
                    value: `${multiUse}`,
                    label: 'Multi-Accreditor Artifacts',
                    description: 'Count of artifacts supporting more than one accreditor.',
                    aria: `${multiUse} artifacts currently support multiple accreditors.`
                }
            ];

            metricsGrid.innerHTML = cardData.map(card => `
                <div class="metric-card ${card.className}" role="group" aria-label="${card.aria}" title="${card.description}">
                    <div class="metric-value" aria-hidden="true">${card.value}</div>
                    <div class="metric-label">${card.label}</div>
                </div>
            `).join('');
        }

        function renderCrosswalkInsights(crosswalkData) {
            const section = document.getElementById('crosswalkInsights');
            const summaryEl = document.getElementById('crosswalkSummary');
            const chipsEl = document.getElementById('crosswalkPairChips');
            const listEl = document.getElementById('crosswalkOpportunities');

            if (!section) {
                return;
            }

            if (!crosswalkData) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            const entries = Object.entries(crosswalkData.matrix || {});
            const reusable = entries.filter(([_, standards]) => standards && Object.keys(standards).length > 1);

            if (!reusable.length) {
                if (summaryEl) {
                    summaryEl.textContent = 'No overlapping evidence detected yet. Map artifacts to multiple frameworks to trigger CrosswalkXâ¢ insights.';
                }
                if (chipsEl) {
                    chipsEl.innerHTML = '';
                }
                if (listEl) {
                    listEl.innerHTML = '<div class="crosswalk-empty">Once evidence supports multiple accreditors, reuse opportunities will appear here.</div>';
                }
                return;
            }

            const accreditorSet = new Set();
            reusable.forEach(([_, standards]) => {
                Object.keys(standards || {}).forEach(code => accreditorSet.add(getAccreditorLabel(code)));
            });

            const avgReuse = reusable.reduce((sum, [_, standards]) => sum + Object.keys(standards || {}).length, 0) / reusable.length;
            if (summaryEl) {
                summaryEl.textContent = `Identified ${reusable.length} reusable artifacts spanning ${accreditorSet.size} accreditors with an average of ${avgReuse.toFixed(1)} standards supported per artifact.`;
            }

            const pairCounts = {};
            reusable.forEach(([_, standards]) => {
                const accreds = Array.from(new Set(Object.keys(standards || {}).map(getAccreditorLabel))).filter(Boolean);
                for (let i = 0; i < accreds.length; i++) {
                    for (let j = i + 1; j < accreds.length; j++) {
                        const key = [accreds[i], accreds[j]].sort().join(' â ');
                        pairCounts[key] = (pairCounts[key] || 0) + 1;
                    }
                }
            });

            if (chipsEl) {
                const topPairs = Object.entries(pairCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);
                chipsEl.innerHTML = topPairs.length ? topPairs.map(([pair, count]) => `
                    <div class="crosswalk-highlight-card">
                        <span>${pair}</span>
                        <span style="color:#1d4ed8; font-weight:600;">${count} artifacts</span>
                    </div>
                `).join('') : '<div class="crosswalk-highlight-card" style="background:#f8fafc; color:#475569; border-color:#e2e8f0;">Cross-accreditor overlaps will appear here once detected.</div>';
            }

            if (listEl) {
                listEl.innerHTML = reusable.map(([filename, standards]) => {
                    const grouped = groupByAccreditor(standards);
                    const totalStandards = Object.values(grouped).reduce((sum, arr) => sum + arr.length, 0);
                    const accreditorCount = Object.keys(grouped).length;
                    return `
                        <div class="crosswalk-card">
                            <h3>${escapeHtml(filename)}</h3>
                            <span class="reuse-badge">${totalStandards} standards</span>
                            <p class="crosswalk-meta">Supports ${accreditorCount} ${accreditorCount === 1 ? 'accreditor' : 'accreditors'}</p>
                            <div class="crosswalk-standards">
                                ${Object.entries(grouped).map(([acc, values]) => `
                                    <div>
                                        <div class="crosswalk-accreditor">${escapeHtml(acc)}</div>
                                        <ul>
                                            ${values.map(code => `<li>${escapeHtml(code)}</li>`).join('')}
                                        </ul>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        function groupByAccreditor(standards) {
            const grouped = {};
            Object.keys(standards || {}).forEach(code => {
                const label = getAccreditorLabel(code);
                grouped[label] = grouped[label] || [];
                grouped[label].push(code);
            });
            return grouped;
        }

        function getAccreditorLabel(code) {
            if (!code) return 'Unknown';
            const cleaned = String(code).replace(/_/g, ' ').trim();
            if (!cleaned) return 'Unknown';
            const match = cleaned.match(/^[A-Za-z]+/);
            if (match && match[0]) {
                return match[0].toUpperCase();
            }
            const parts = cleaned.split(/[:\s-]+/);
            return (parts[0] || 'Unknown').toUpperCase();
        }

        function escapeHtml(value) {
            return String(value || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function displayCriticalGaps(gaps) {
            const container = document.getElementById('criticalGaps');
            
            if (gaps.length === 0) {
                container.innerHTML = '<p style="color: var(--accent-green); text-align: center;">â No critical gaps found!</p>';
                return;
            }

            container.innerHTML = gaps.slice(0, 10).map(gap => `
                <li class="gap-item">
                    <div class="gap-header">
                        <div class="gap-standard">${gap.standard.code}: ${gap.standard.title}</div>
                        <span class="gap-severity ${gap.risk_level.toLowerCase()}">${gap.risk_level.toUpperCase()}</span>
                    </div>
                    <p class="gap-description">Risk Score: ${(gap.risk_score * 100).toFixed(0)}%</p>
                    <p style="color: var(--accent-red); font-size: 0.875rem; margin-bottom: 1rem;">
                        â ï¸ ${gap.recommendation}
                    </p>
                    <div class="gap-actions">
                        <button class="action-btn" onclick="uploadEvidence('${gap.standard.code}')">
                            Upload Evidence
                        </button>
                        <button class="action-btn secondary" onclick="viewStandard('${gap.standard.code}')">
                            View Requirements
                        </button>
                    </div>
                </li>
            `).join('');
        }

        function displayActionItems(critical, medium, low) {
            const container = document.getElementById('actionItems');
            const actions = [];

            // Generate action items based on gaps
            if (critical.length > 0) {
                actions.push({
                    priority: 'HIGH',
                    title: 'Address Critical Gaps',
                    description: `${critical.length} standards have no evidence mapped. These require immediate attention.`,
                    action: 'Start uploading evidence for unmapped standards'
                });
            }

            if (medium.length > 0) {
                actions.push({
                    priority: 'MEDIUM',
                    title: 'Improve Low Confidence Mappings',
                    description: `${medium.length} standards have low confidence scores. Additional evidence needed.`,
                    action: 'Review and supplement evidence for low-confidence standards'
                });
            }

            if (low.length > 0) {
                actions.push({
                    priority: 'LOW',
                    title: 'Enhance Documentation Quality',
                    description: `${low.length} standards have moderate confidence. Could benefit from stronger evidence.`,
                    action: 'Add supporting documentation to increase confidence scores'
                });
            }

            container.innerHTML = actions.map((action, index) => `
                <li class="gap-item">
                    <div class="gap-header">
                        <div class="gap-standard">Action ${index + 1}: ${action.title}</div>
                        <span class="gap-severity ${action.priority.toLowerCase()}">${action.priority}</span>
                    </div>
                    <p class="gap-description">${action.description}</p>
                    <p style="color: var(--primary-blue); font-size: 0.875rem; margin-bottom: 1rem;">
                        â ${action.action}
                    </p>
                    <div class="gap-actions">
                        <button class="action-btn" onclick="startAction('${action.priority}')">
                            Start This Action
                        </button>
                    </div>
                </li>
            `).join('');
        }

        // Action handlers
        function uploadEvidence(standardId) {
            localStorage.setItem('targetStandard', standardId);
            window.location.href = '/upload-working.html';
        }

        function viewStandard(standardId) {
            window.location.href = `/standards-selection-wizard.html#${standardId}`;
        }

        function startAction(priority) {
            if (priority === 'HIGH') {
                window.location.href = '/evidence-upload';
            } else {
                window.location.href = '/evidence-mapping';
            }
        }

        async function exportGapAnalysis() {
            try {
                const response = await fetch('/api/v1/reports/gap-analysis-database', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to generate report');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `gap-analysis-${new Date().toISOString().split('T')[0]}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Error exporting gap analysis:', error);
                alert('Failed to export gap analysis report');
            }
        }

        function createActionPlan() {
            // Navigate to action plan creator (future feature)
            alert('Action plan creation feature coming soon!');
        }

        // Initialize page
        loadGapAnalysis();
    </script>
</body>
</html>